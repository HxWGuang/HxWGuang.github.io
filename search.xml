<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hexo-NexTä¸»é¢˜ç¾åŒ–</title>
    <url>/post/Hexo-NexT%E4%B8%BB%E9%A2%98%E7%BE%8E%E5%8C%96/</url>
    <content><![CDATA[<p>è¿™é‡ŒåŒ…æ‹¬äº†æœ¬ç«™æ‰€æœ‰æœ‰å…³NexTä¸»é¢˜ç¾åŒ–çš„æ•™ç¨‹ã€‚</p>
<a id="more"></a>
<ul>
<li><a href="https://hxwguang.github.io/post/%E7%BB%99%E6%96%87%E7%AB%A0%E6%B7%BB%E5%8A%A0%E7%BD%AE%E9%A1%B6/">ç»™æ–‡ç« æ·»åŠ ç½®é¡¶åŠŸèƒ½</a></li>
<li><a href="https://hxwguang.github.io/post/Hexo-Next%E4%B8%BB%E9%A2%98%E4%B8%AD%E6%B7%BB%E5%8A%A0aplayer%E6%92%AD%E6%94%BE%E5%99%A8/">æ·»åŠ AplayeréŸ³ä¹æ’­æ”¾å™¨</a></li>
<li><a href="https://hxwguang.github.io/post/Hexo%E4%B8%AD%E4%BD%BF%E7%94%A8emoji%E8%A1%A8%E6%83%85/">åœ¨Hexoä¸­ä½¿ç”¨emojiè¡¨æƒ…</a></li>
</ul>
<hr />
<ol>
<li>å‚è€ƒï¼š<a href="https://io-oi.me/tech/hexo-next-optimization" target="_blank" rel="noopener">https://io-oi.me/tech/hexo-next-optimization</a></li>
<li>å‚è€ƒï¼š<a href="https://juejin.im/post/5bcd2d395188255c3b7dc1db" target="_blank" rel="noopener">https://juejin.im/post/5bcd2d395188255c3b7dc1db</a></li>
</ol>
]]></content>
      <categories>
        <category>ç¾åŒ–</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
        <tag>ç¾åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo Nextä¸»é¢˜ä¸­æ·»åŠ aplayeræ’­æ”¾å™¨</title>
    <url>/post/Hexo-Next%E4%B8%BB%E9%A2%98%E4%B8%AD%E6%B7%BB%E5%8A%A0aplayer%E6%92%AD%E6%94%BE%E5%99%A8/</url>
    <content><![CDATA[<h1>è¯´åœ¨å‰é¢</h1>
<p>æœ¬ç¯‡è¦è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š<br />
<input type="checkbox" checked="checked" onclick="return false;"/>åœ¨åšå®¢ä¸­æ·»åŠ aplayer<br />
<input type="checkbox" checked="checked" onclick="return false;"/>è§£å†³åˆ‡æ¢é¡µé¢æ—¶ä¸æ‰“æ–­æ’­æ”¾</p>
<p>å› ä¸ºæˆ‘ä¸æ˜¯å¤§ç¥ï¼Œçœ‹ä¸æ‡‚<a href="https://aplayer.js.org/#/zh-Hans/" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªé—®é¢˜ä¹Ÿæ˜¯å‡ ç»æ³¢æŠ˜èŠ±äº†å¾ˆé•¿æ—¶é—´æ‰ç»ˆäºå¼„å¥½äº†ã€‚</p>
<a id="more"></a>
<h1>æ·»åŠ Aplayeræ’­æ”¾å™¨</h1>
<h2>ä¸‹è½½</h2>
<p>åœ¨Githubä¸Šä¸‹è½½<a href="https://github.com/MoePlayer/APlayer" target="_blank" rel="noopener">Aplayer</a> ã€‚è§£å‹åå°†<code>dist</code>æ–‡ä»¶å¤åˆ¶åˆ°<code>~\themes\next\source</code>æ–‡ä»¶å¤¹ä¸‹ã€‚</p>
<h2>æ–°å»ºmusic.js</h2>
<p>åœ¨<code>~\themes\next\source\dist\</code>ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª<code>music.js</code>æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„å†…å®¹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> ap = <span class="keyword">new</span> APlayer(&#123;</span><br><span class="line">    container: <span class="built_in">document</span>.getElementById(<span class="string">'aplayer'</span>),</span><br><span class="line">    fixed: <span class="literal">true</span>,</span><br><span class="line">    autoplay: <span class="literal">false</span>,</span><br><span class="line">    audio: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: <span class="string">"PDDæ´ªè’ä¹‹åŠ›"</span>,</span><br><span class="line">        artist: <span class="string">'å¾æ¢¦åœ†'</span>,</span><br><span class="line">        url: <span class="string">'http://up.mcyt.net/?down/39868.mp3'</span>,</span><br><span class="line">        cover: <span class="string">'http://oeff2vktt.bkt.clouddn.com/image/84.jpg'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: <span class="string">'9420'</span>,</span><br><span class="line">        artist: <span class="string">'éº¦å°å…œ'</span>,</span><br><span class="line">        url: <span class="string">'http://up.mcyt.net/?down/45967.mp3'</span>,</span><br><span class="line">        cover: <span class="string">'http://oeff2vktt.bkt.clouddn.com/image/8.jpg'</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸­å¯¹åº”å‚æ•°çš„è§£é‡Šï¼Œè¯·æŸ¥çœ‹ï¼š<a href="%5Bhttps://aplayer.js.org/#/zh-Hans/?id=%E5%85%A5%E9%97%A8%5D(https://aplayer.js.org/#/zh-Hans/?id=%E5%85%A5%E9%97%A8)">Aplayerä¸­æ–‡æ–‡æ¡£</a></p>
<p><code>audio</code>å¯¹åº”çš„æ˜¯éŸ³é¢‘æ–‡ä»¶çš„ä¿¡æ¯å‚æ•°ï¼Œéœ€è¦è‡ªå·±é…ç½®ç›¸å…³çš„ä¿¡æ¯ï¼ˆå¦‚æ­Œåï¼Œæ­Œæ‰‹ï¼ŒéŸ³é¢‘é“¾æ¥ï¼Œå°é¢ç­‰ï¼‰çš„é…ç½®ã€‚</p>
<div class="note info no-icon">
            <p><code>url</code>å’Œ<code>cover</code>ä¸¤ä¸ªå‚æ•°ä¹Ÿå¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶çš„ç›¸å¯¹åœ°å€ï¼Œå¦‚ï¼š<code>url: '/dist/assets/song1.mp3'</code><br />å¿«é€Ÿç”ŸæˆéŸ³ä¹å¤–é“¾çš„æ–¹æ³•å¯ä»¥å‚è€ƒæˆ‘çš„<a href="https://hxwguang.github.io/2020/01/26/%E4%B8%80%E4%B8%AA%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E9%9F%B3%E4%B9%90%E5%A4%96%E9%93%BE%E7%9A%84%E6%96%B9%E6%B3%95/">å¦ä¸€ç¯‡æ–‡ç« </a>ã€‚</p><p>å¦å¤–ï¼šç”±äºæˆ‘æ²¡æœ‰é…ç½®æ­Œè¯çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æ’­æ”¾å™¨åœ¨æ’­æ”¾éŸ³ä¹çš„æ—¶å€™ç‚¹å‡»æ­Œè¯æ˜¯æ²¡æœ‰æ˜¾ç¤ºçš„</p>
          </div>
<h2>åœ¨_layout.swigä¸­æ·»åŠ ä¿¡æ¯</h2>
<p>æ‰“å¼€<code>~\themes\next\layout\_layout.swig</code>æ–‡ä»¶ï¼Œå°†</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;&#x2F;dist&#x2F;APlayer.min.css&quot;&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;aplayer&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;&#x2F;dist&#x2F;APlayer.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;&#x2F;dist&#x2F;music.js&quot;&gt;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ åˆ°<code>&lt;div class=&quot;container&quot;&gt;</code>æ ‡ç­¾çš„åé¢ï¼Œå³æ·»åŠ åˆ°<code>&lt;body&gt; &lt;/body&gt;</code>çš„ä¸‹ä¸€çº§å­æ ‡ç­¾é‡Œé¢ã€‚</p>
<p>é‡æ–°ç”Ÿæˆï¼Œéƒ¨ç½²ï¼Œå†è®¿é—®å°±å¯ä»¥çœ‹åˆ°å·¦ä¸‹è§’çš„éŸ³ä¹æ’­æ”¾å™¨äº†ã€‚</p>
<div class="note danger no-icon">
            <p><strong>æ³¨æ„ï¼š</strong> ä¸Šé¢é‚£æ®µä»£ç ä¸€å®šè¦æ”¾åˆ°<code>&lt;body&gt; &lt;/body&gt;</code>çš„ä¸‹ä¸€çº§å­æ ‡ç­¾é‡Œé¢ï¼å¦‚æœæ”¾åˆ°<code>&lt;body&gt; &lt;/body&gt;</code>é‡Œé¢å°±ä¼šå‡ºç°åº•éƒ¨æ»‘å‡ºçš„æƒ…å†µ<br /><img src="https://i.loli.net/2020/01/26/x3XGbeAp7SokDPL.png" alt="åº•éƒ¨æ»‘å‡º.png" /></p>
          </div>
<hr />
<h1>è§£å†³åˆ‡æ¢é¡µé¢æ’­æ”¾ä¸­æ–­é—®é¢˜</h1>
<p>è¿™ä¸ªé—®é¢˜ä¹Ÿå›°æ‰°äº†æˆ‘å¾ˆä¹…ï¼Œä½†å…¶å®å¾ˆå®¹æ˜“è§£å†³ã€‚ç°åœ¨çš„Nextä¸»é¢˜é‡Œå·²ç»é›†æˆäº†pjaxæ’ä»¶ï¼Œåˆ©ç”¨å®ƒå°±å¯ä»¥è§£å†³é—®é¢˜ï¼Œè¿™ä¸ªæ’ä»¶ä¸»è¦åŠŸèƒ½æ˜¯åŠ é€Ÿé¡µé¢çš„åˆ‡æ¢é€Ÿåº¦ï¼Œå»ºè®®å¯ç”¨ï¼</p>
<h2>å®‰è£…</h2>
<p>åœ¨<code>~/themes/next/</code>ç›®å½•ä¸‹å³é”®<code>git bash here</code>ï¼Œè¾“å…¥å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;theme-next&#x2F;theme-next-pjax source&#x2F;lib&#x2F;pjax</span><br></pre></td></tr></table></figure>
<p>ä¸‹è½½å®Œæˆåæ‰“å¼€ä¸»é¢˜ç›®å½•ä¸‹çš„<code>_config.yml</code>æ–‡ä»¶ï¼Œå®šä½åˆ°<code>pjax</code>å¤„ï¼Œå¯ç”¨å°±å¯ä»¥äº†ï¼š</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">pjax:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>ç¾åŒ–</category>
        <category>è®°å½•</category>
        <category>æ£é¼“</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
        <tag>ç¾åŒ–</tag>
        <tag>aplayer</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexoä¸­ä½¿ç”¨emojiè¡¨æƒ…</title>
    <url>/post/Hexo%E4%B8%AD%E4%BD%BF%E7%94%A8emoji%E8%A1%A8%E6%83%85/</url>
    <content><![CDATA[<div class="note danger no-icon">
            <p><strong>æ³¨æ„ï¼š</strong> <s>è¿™ä¸ªæ–¹æ³•æˆ‘å°è¯•äº†ä½†æ˜¯æ²¡æœ‰æ•ˆæœï¼Œè¿˜æ˜¯æ²¡èƒ½æ˜¾ç¤ºemojiï¼Œä½†æˆ‘è¿˜æ˜¯å‘å‡ºæ¥è¿™ä¸ªæ–¹æ³•ï¼Œä¹Ÿè®¸ä½ ä»¬å¯ä»¥</s><br /><s>è¿™ä¸ªæ–¹æ³•ç”¨çš„æ˜¯npmåé¢æˆ‘è‡ªå·±æ”¹ç”¨äº†yarnå†é‡å¤æœ¬æ–¹æ³•çš„æ“ä½œå°±åˆå¯ä»¥äº†ã€‚ã€‚</s><br />å…¶å®å®‰è£…å®Œ<code>hexo-renderer-markdown-it</code>å’Œ<code>markdown-it-emoji</code>æ’ä»¶åå°±å¯ä»¥äº†ï¼Œä½†æ˜¯ä¸ä¼šç«‹å³çœ‹åˆ°æ•ˆæœï¼Œç»è¿‡åå¤å°è¯•ï¼Œéƒ½æ˜¯å‡ å°æ—¶åæ‰ç”Ÿæ•ˆã€‚ã€‚</p>
          </div>
<p>Hexoå¼€å¯æ¬¢ä¹çš„emojiä¹‹æ—…ğŸ’›<br />
å†…å®¹è½¬è½½è‡ªï¼š<a href="https://geek-space.cn/post/emoji.html" target="_blank" rel="noopener">Hexoä¸­ä½¿ç”¨emojiè¡¨æƒ…</a><br />
å°†markdownè½¬åŒ–ä¸ºhtmlçš„è½¬åŒ–å™¨å«åšmarkdownæ¸²æŸ“å™¨ã€‚<br />
åœ¨Hexoä¸­é»˜è®¤çš„markdownæ¸²æŸ“å™¨æ˜¯<code>hexo-renderer-marked</code>ï¼Œè¿™ä¸ªæ¸²æŸ“å™¨æ˜¯ä¸æ”¯æŒemojiè¡¨æƒ…çš„ã€‚æˆ‘ä»¬æ¢ä¸€ä¸ªæ”¯æŒemojiçš„å¼•æ“ï¼Œå†å¢åŠ ä¸€ä¸ªemojiæ’ä»¶å³å¯ã€‚</p>
<a id="more"></a>
<h1>å®‰è£…</h1>
<p>å‘½ä»¤è¡Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm un hexo-renderer-marked --save</span><br><span class="line">npm i hexo-renderer-markdown-it --save</span><br><span class="line">npm i markdown-it-emoji --save</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Tips:</strong> æ®è¯´hexo-renderer-markdown-itçš„é€Ÿåº¦è¦æ¯”HexoåŸè£…æ’ä»¶è¦å¿«ï¼Œè€Œä¸”åŠŸèƒ½æ›´å¤š</p>
</blockquote>
<h1>é…ç½®</h1>
<p>å®Œæˆæ’ä»¶å®‰è£…åè¿˜éœ€è¦ä¿®æ”¹Hexoç«™ç‚¹é…ç½®æ–‡ä»¶<code>_config.yml</code>(ä¸æ˜¯ä¸»é¢˜é…ç½®æ–‡ä»¶å“¦)ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">markdown:</span><br><span class="line"> plugins:</span><br><span class="line"> - markdown-it-footnote</span><br><span class="line"> - markdown-it-sup</span><br><span class="line"> - markdown-it-sub</span><br><span class="line"> - markdown-it-abbr</span><br><span class="line"> - markdown-it-emoji</span><br></pre></td></tr></table></figure>
<p>æ›´å¤šé…ç½®å‚æ•°å¯ä»¥çœ‹è¿™ä¸ªï¼š<a href="https://github.com/hexojs/hexo-renderer-markdown-it/wiki/Getting-Started" target="_blank" rel="noopener">ç‚¹æˆ‘è¿›å…¥</a></p>
<h1>ä½¿ç”¨æ–¹æ³•</h1>
<p>è¾“å…¥å¯¹åº”çš„emojiç¼–ç å°±è¡Œäº†<br />
ä¾‹å¦‚ï¼šè¾“å…¥ç¬‘è„¸å¯¹åº”çš„emojiç¼–ç <code>:smile:</code>å°±å¯ä»¥å¾—åˆ°ğŸ˜„ã€‚</p>
<h1>emojiç¼–ç è¡¨</h1>
<table>
<thead>
<tr>
<th>People</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ˜„<code>:smile:</code></td>
<td>ğŸ˜†<code>:laughing:</code></td>
<td>ğŸ˜Š<code>:blush:</code></td>
<td>ğŸ˜ƒ<code>:smiley:</code></td>
</tr>
<tr>
<td>â˜ºï¸<code>:relaxed:</code></td>
<td>ğŸ˜<code>:smirk:</code></td>
<td>ğŸ˜<code>:heart_eyes:</code>â€‹</td>
<td>ğŸ˜˜<code>:kissing_heart:</code></td>
</tr>
<tr>
<td>ğŸ˜š<code>:kissing_closed_eyes:</code></td>
<td>ğŸ˜³<code>:flushed:</code></td>
<td>ğŸ˜Œ<code>:relieved:</code></td>
<td>ğŸ˜†<code>:satisfied:</code></td>
</tr>
<tr>
<td>ğŸ˜<code>:grin:</code></td>
<td>ğŸ˜‰<code>:wink:</code></td>
<td>ğŸ˜œ<code>:stuck_out_tongue_winking_eye:</code></td>
<td>ğŸ˜<code>:stuck_out_tongue_closed_eyes:</code></td>
</tr>
<tr>
<td>ğŸ˜€<code>:grinning:</code></td>
<td>ğŸ˜—<code>:kissing:</code></td>
<td>ğŸ˜™<code>:kissing_smiling_eyes:</code></td>
<td>ğŸ˜›<code>:stuck_out_tongue:</code></td>
</tr>
<tr>
<td>ğŸ˜´<code>:sleeping:</code></td>
<td>ğŸ˜Ÿ<code>:worried:</code></td>
<td>ğŸ˜¦<code>:frowning:</code></td>
<td>ğŸ˜§<code>:anguished:</code></td>
</tr>
<tr>
<td>ğŸ˜®<code>:open_mouth:</code></td>
<td>ğŸ˜¬<code>:grimacing:</code></td>
<td>ğŸ˜•<code>:confused:</code></td>
<td>ğŸ˜¯<code>:hushed:</code></td>
</tr>
<tr>
<td>ğŸ˜‘<code>:expressionless:</code></td>
<td>ğŸ˜’<code>:unamused:</code></td>
<td>ğŸ˜…<code>:sweat_smile:</code></td>
<td>ğŸ˜“<code>:sweat:</code></td>
</tr>
<tr>
<td>ğŸ˜¥<code>:disappointed_relieved:</code></td>
<td>ğŸ˜©<code>:weary:</code></td>
<td>ğŸ˜”<code>:pensive:</code></td>
<td>ğŸ˜<code>:disappointed:</code></td>
</tr>
<tr>
<td>ğŸ˜–<code>:confounded:</code></td>
<td>ğŸ˜¨<code>:fearful:</code></td>
<td>ğŸ˜°<code>:cold_sweat:</code></td>
<td>ğŸ˜£<code>:persevere:</code></td>
</tr>
<tr>
<td>ğŸ˜¢<code>:cry:</code></td>
<td>ğŸ˜­<code>:sob:</code></td>
<td>ğŸ˜‚<code>:joy:</code></td>
<td>ğŸ˜²<code>:astonished:</code></td>
</tr>
<tr>
<td>ğŸ˜±<code>:scream:</code></td>
<td>ğŸ˜«<code>:tired_face:</code></td>
<td>ğŸ˜ <code>:angry:</code></td>
<td>ğŸ˜¡<code>:rage:</code></td>
</tr>
<tr>
<td>ğŸ˜¤<code>:triumph:</code></td>
<td>ğŸ˜ª<code>:sleepy:</code></td>
<td>ğŸ˜‹<code>:yum:</code></td>
<td>ğŸ˜·<code>:mask:</code></td>
</tr>
<tr>
<td>ğŸ˜<code>:sunglasses:</code></td>
<td>ğŸ˜µ<code>:dizzy_face:</code></td>
<td>ğŸ‘¿<code>:imp:</code></td>
<td>ğŸ˜ˆ<code>:smiling_imp:</code>â€‹</td>
</tr>
<tr>
<td>ğŸ˜<code>:neutral_face:</code></td>
<td>ğŸ˜¶<code>:no_mouth:</code></td>
<td>ğŸ˜‡<code>:innocent:</code></td>
<td>ğŸ‘½<code>:alien:</code></td>
</tr>
<tr>
<td>ğŸ’›<code>:yellow_heart:</code></td>
<td>ğŸ’™<code>:blue_heart:</code></td>
<td>ğŸ’œ<code>:purple_heart:</code></td>
<td>â¤ï¸<code>:heart:</code></td>
</tr>
<tr>
<td>ğŸ’š<code>:green_heart:</code></td>
<td>ğŸ’”<code>:broken_heart:</code></td>
<td>ğŸ’“<code>:heartbeat:</code></td>
<td>ğŸ’—<code>:heartpulse:</code></td>
</tr>
<tr>
<td>ğŸ’•<code>:two_hearts:</code></td>
<td>ğŸ’<code>:revolving_hearts:</code></td>
<td>ğŸ’˜<code>:cupid:</code></td>
<td>ğŸ’–<code>:sparkling_heart:</code></td>
</tr>
<tr>
<td>âœ¨<code>:sparkles:</code></td>
<td>â­ï¸<code>:star:</code></td>
<td>ğŸŒŸ<code>:star2:</code></td>
<td>ğŸ’«<code>:dizzy:</code></td>
</tr>
<tr>
<td>ğŸ’¥<code>:boom:</code></td>
<td>ğŸ’¥<code>:collision:</code></td>
<td>ğŸ’¢<code>:anger:</code></td>
<td>â—ï¸<code>:exclamation:</code></td>
</tr>
<tr>
<td>â“<code>:question:</code></td>
<td>â•<code>:grey_exclamation:</code></td>
<td>â”<code>:grey_question:</code></td>
<td>ğŸ’¤<code>:zzz:</code></td>
</tr>
<tr>
<td>ğŸ’¨<code>:dash:</code></td>
<td>ğŸ’¦<code>:sweat_drops:</code></td>
<td>ğŸ¶<code>:notes:</code></td>
<td>ğŸµ<code>:musical_note:</code></td>
</tr>
<tr>
<td>ğŸ”¥<code>:fire:</code></td>
<td>ğŸ’©<code>:hankey:</code></td>
<td>ğŸ’©<code>:poop:</code></td>
<td>ğŸ’©<code>:shit:</code></td>
</tr>
<tr>
<td>ğŸ‘<code>:+1:</code></td>
<td>ğŸ‘<code>:thumbsup:</code></td>
<td>ğŸ‘<code>:-1:</code></td>
<td>ğŸ‘<code>:thumbsdown:</code></td>
</tr>
<tr>
<td>ğŸ‘Œ<code>:ok_hand:</code></td>
<td>ğŸ‘Š<code>:punch:</code></td>
<td>ğŸ‘Š<code>:facepunch:</code></td>
<td>âœŠ<code>:fist:</code></td>
</tr>
<tr>
<td>âœŒï¸<code>:v:</code></td>
<td>ğŸ‘‹<code>:wave:</code></td>
<td>âœ‹<code>:hand:</code></td>
<td>âœ‹<code>:raised_hand:</code></td>
</tr>
<tr>
<td>ğŸ‘<code>:open_hands:</code></td>
<td>â˜ï¸<code>:point_up:</code></td>
<td>ğŸ‘‡<code>:point_down:</code></td>
<td>ğŸ‘ˆ<code>:point_left:</code></td>
</tr>
<tr>
<td>ğŸ‘‰<code>:point_right:</code></td>
<td>ğŸ™Œ<code>:raised_hands:</code></td>
<td>ğŸ™<code>:pray:</code></td>
<td>ğŸ‘†<code>:point_up_2:</code></td>
</tr>
<tr>
<td>ğŸ‘<code>:clap:</code></td>
<td>ğŸ’ª<code>:muscle:</code></td>
<td>ğŸ¤˜<code>:metal:</code></td>
<td>ğŸ–•<code>:fu:</code></td>
</tr>
</tbody>
</table>
<p><strong>æœªå®Œå¾…ç»­â€¦</strong></p>
]]></content>
      <categories>
        <category>è®°å½•</category>
        <category>é—®é¢˜</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>emoji</tag>
      </tags>
  </entry>
  <entry>
    <title>HTMLå­—ç¬¦å®ä½“</title>
    <url>/post/HTML%E5%AD%97%E7%AC%A6%E5%AE%9E%E4%BD%93/</url>
    <content><![CDATA[<div class="note info">
            <p><strong>é€šçŸ¥ï¼š</strong> æœ¬ç¯‡å†…å®¹æ¥è‡ªW3School</p>
          </div>
<div class="note danger">
            <p><strong>æ³¨æ„ï¼š</strong> HTMLä¸­çš„é¢„ç•™å­—ç¬¦å¿…é¡»è¢«æ›¿æ¢ä¸ºå­—ç¬¦å®ä½“</p>
          </div>
<h2>HTMLå®ä½“</h2>
<p>åœ¨HTML ä¸­ï¼ŒæŸäº›å­—ç¬¦æ˜¯é¢„ç•™çš„ã€‚</p>
<p>åœ¨ HTML ä¸­ä¸èƒ½ä½¿ç”¨å°äºå·ï¼ˆ&lt;ï¼‰å’Œå¤§äºå·ï¼ˆ&gt;ï¼‰ï¼Œè¿™æ˜¯å› ä¸ºæµè§ˆå™¨ä¼šè¯¯è®¤ä¸ºå®ƒä»¬æ˜¯æ ‡ç­¾ã€‚</p>
<p>å¦‚æœå¸Œæœ›æ­£ç¡®åœ°æ˜¾ç¤ºé¢„ç•™å­—ç¬¦ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ HTML æºä»£ç ä¸­ä½¿ç”¨å­—ç¬¦å®ä½“ï¼ˆcharacter entitiesï¼‰ã€‚</p>
<a id="more"></a>
<p>å­—ç¬¦å®ä½“ç±»ä¼¼è¿™æ ·ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&amp;entity_name;</span><br><span class="line"></span><br><span class="line">æˆ–è€…</span><br><span class="line"></span><br><span class="line">&amp;#entity_number;</span><br></pre></td></tr></table></figure>
<p>å¦‚éœ€æ˜¾ç¤ºå°äºå·ï¼Œæˆ‘ä»¬å¿…é¡»è¿™æ ·å†™ï¼š<code>&amp;lt;</code>æˆ–<code>&amp;#60;</code></p>
<p><strong>æç¤º</strong>ï¼šä½¿ç”¨å®ä½“åè€Œä¸æ˜¯æ•°å­—çš„å¥½å¤„æ˜¯ï¼Œåç§°æ˜“äºè®°å¿†ã€‚ä¸è¿‡åå¤„æ˜¯ï¼Œæµè§ˆå™¨ä¹Ÿè®¸å¹¶ä¸æ”¯æŒæ‰€æœ‰å®ä½“åç§°ï¼ˆå¯¹å®ä½“æ•°å­—çš„æ”¯æŒå´å¾ˆå¥½ï¼‰ã€‚</p>
<h2>ä¸é—´æ–­ç©ºæ ¼ï¼ˆnon-breaking spaceï¼‰</h2>
<p>HTML ä¸­çš„å¸¸ç”¨å­—ç¬¦å®ä½“æ˜¯ä¸é—´æ–­ç©ºæ ¼<code>&amp;nbsp;</code>ã€‚</p>
<p>æµè§ˆå™¨æ€»æ˜¯ä¼šæˆªçŸ­ HTML é¡µé¢ä¸­çš„ç©ºæ ¼ã€‚<span class="label warning">å¦‚æœæ‚¨åœ¨æ–‡æœ¬ä¸­å†™ 10 ä¸ªç©ºæ ¼ï¼Œåœ¨æ˜¾ç¤ºè¯¥é¡µé¢ä¹‹å‰ï¼Œæµè§ˆå™¨ä¼šåˆ é™¤å®ƒä»¬ä¸­çš„ 9 ä¸ªã€‚</span>å¦‚éœ€åœ¨é¡µé¢ä¸­å¢åŠ ç©ºæ ¼çš„æ•°é‡ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ <code>&amp;nbsp;</code> å­—ç¬¦å®ä½“ã€‚</p>
<h2>HTML ä¸­æœ‰ç”¨çš„å­—ç¬¦å®ä½“</h2>
<div class="note default">
            <p><strong>æ³¨é‡Šï¼š</strong> å®ä½“åç§°å¯¹å¤§å°å†™æ•æ„Ÿï¼</p>
          </div>
<table>
<thead>
<tr>
<th style="text-align:left">æ˜¾ç¤ºç»“æœ</th>
<th>æè¿°</th>
<th>å®ä½“åç§°</th>
<th>å®ä½“ç¼–å·</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Â </td>
<td>ç©ºæ ¼</td>
<td><code>&amp;nbsp;</code></td>
<td><code>&amp;#160;</code></td>
</tr>
<tr>
<td style="text-align:left">&lt;</td>
<td>å°äºå·</td>
<td><code>&amp;lt;</code></td>
<td><code>&amp;#60;</code></td>
</tr>
<tr>
<td style="text-align:left">&gt;</td>
<td>å¤§äºå·</td>
<td><code>&amp;gt;</code></td>
<td><code>&amp;#62;</code></td>
</tr>
<tr>
<td style="text-align:left">&amp;</td>
<td>å’Œå·</td>
<td><code>&amp;amp;</code></td>
<td><code>&amp;#38;</code></td>
</tr>
<tr>
<td style="text-align:left">&quot;</td>
<td>å¼•å·</td>
<td><code>&amp;quot;</code></td>
<td><code>&amp;#34;</code></td>
</tr>
<tr>
<td style="text-align:left">'</td>
<td>æ’‡å·</td>
<td><code>&amp;apos; (IEä¸æ”¯æŒ)</code></td>
<td><code>&amp;#39;</code></td>
</tr>
<tr>
<td style="text-align:left">Â¢</td>
<td>åˆ†ï¼ˆcentï¼‰</td>
<td><code>&amp;cent;</code></td>
<td><code>&amp;#162;</code></td>
</tr>
<tr>
<td style="text-align:left">Â£</td>
<td>é•‘ï¼ˆpoundï¼‰</td>
<td><code>&amp;pound;</code></td>
<td><code>&amp;#163;</code></td>
</tr>
<tr>
<td style="text-align:left">Â¥</td>
<td>å…ƒï¼ˆyenï¼‰</td>
<td><code>&amp;yen;</code></td>
<td><code>&amp;#165;</code></td>
</tr>
<tr>
<td style="text-align:left">â‚¬</td>
<td>æ¬§å…ƒï¼ˆeuroï¼‰</td>
<td><code>&amp;euro;</code></td>
<td><code>&amp;#8364;</code></td>
</tr>
<tr>
<td style="text-align:left">Â§</td>
<td>å°èŠ‚</td>
<td><code>&amp;sect;</code></td>
<td><code>&amp;#167;</code></td>
</tr>
<tr>
<td style="text-align:left">Â©</td>
<td>ç‰ˆæƒï¼ˆcopyrightï¼‰</td>
<td><code>&amp;copy;</code></td>
<td><code>&amp;#169;</code></td>
</tr>
<tr>
<td style="text-align:left">Â®</td>
<td>æ³¨å†Œå•†æ ‡</td>
<td><code>&amp;reg;</code></td>
<td><code>&amp;#174;</code></td>
</tr>
<tr>
<td style="text-align:left">â„¢</td>
<td>å•†æ ‡</td>
<td><code>&amp;trade;</code></td>
<td><code>&amp;#8482;</code></td>
</tr>
<tr>
<td style="text-align:left">Ã—</td>
<td>ä¹˜å·</td>
<td><code>&amp;times;</code></td>
<td><code>&amp;#215;</code></td>
</tr>
<tr>
<td style="text-align:left">Ã·</td>
<td>é™¤å·</td>
<td><code>&amp;divide;</code></td>
<td><code>&amp;#247;</code></td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>ç¬”è®°</category>
      </categories>
      <tags>
        <tag>html</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/post/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<a id="more"></a>
<h2>Quick Start</h2>
<h3>Create a new post</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3>Run server</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3>Generate static files</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3>Deploy to remote sites</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>Markdown è¯­æ³•</title>
    <url>/post/Markdown%20%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<h2>Overview</h2>
<p><strong>Markdown</strong> is created by <a href="http://daringfireball.net/" target="_blank" rel="noopener">Daring Fireball</a>; the original guideline is <a href="http://daringfireball.net/projects/markdown/syntax" target="_blank" rel="noopener">here</a>. Its syntax, however, varies between different parsers or editors. <strong>Typora</strong> is using <a href="https://help.github.com/en/github/writing-on-github" target="_blank" rel="noopener">GitHub Flavored Markdown</a>.</p>
<p><strong># æœ¬ç¯‡è½¬è‡ªTypora</strong></p>
<a id="more"></a>
<h2>Block Elements</h2>
<h3>Paragraph and line breaks</h3>
<p>A paragraph is simply one or more consecutive lines of text. In markdown source code, paragraphs are separated by two or more blank lines. In Typora, you only need one blank line (press <code>Return</code> once) to create a new paragraph.</p>
<p>Press <code>Shift</code> + <code>Return</code> to create a single line break. Most other markdown parsers will ignore single line breaks, so in order to make other markdown parsers recognize your line break, you can leave two spaces at the end of the line, or insert <code>&lt;br/&gt;</code>.</p>
<h3>Headers</h3>
<p>Headers use 1-6 hash (<code>#</code>) characters at the start of the line, corresponding to header levels 1-6. For example:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># This is an H1</span></span><br><span class="line"></span><br><span class="line"><span class="section">## This is an H2</span></span><br><span class="line"></span><br><span class="line"><span class="section">###### This is an H6</span></span><br></pre></td></tr></table></figure>
<p>In Typora, input â€˜#â€™s followed by title content, and press <code>Return</code> key will create a header.</p>
<h3>Blockquotes</h3>
<p>Markdown uses email-style &gt; characters for block quoting. They are presented as:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="quote">&gt; This is a blockquote with two paragraphs. This is first paragraph.</span></span><br><span class="line">&gt;</span><br><span class="line"><span class="quote">&gt; This is second pragraph. Vestibulum enim wisi, viverra nec, fringilla in, laoreet vitae, risus.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; This is another blockquote with one paragraph. There is three empty line to seperate two blockquote.</span></span><br></pre></td></tr></table></figure>
<p>In Typora, inputting â€˜&gt;â€™ followed by your quote contents will generate a quote block. Typora will insert a proper â€˜&gt;â€™ or line break for you. Nested block quotes (a block quote inside another block quote) by adding additional levels of â€˜&gt;â€™.</p>
<h3>Lists</h3>
<p>Input <code>* list item 1</code> will create an unordered list - the <code>*</code> symbol can be replace with <code>+</code> or <code>-</code>.</p>
<p>Input <code>1. list item 1</code> will create an ordered list - their markdown source code is as follows:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section">## un-ordered list</span></span><br><span class="line"><span class="bullet">*   </span>Red</span><br><span class="line"><span class="bullet">*   </span>Green</span><br><span class="line"><span class="bullet">*   </span>Blue</span><br><span class="line"></span><br><span class="line"><span class="section">## ordered list</span></span><br><span class="line"><span class="bullet">1.  </span>Red</span><br><span class="line"><span class="bullet">2. 	</span>Green</span><br><span class="line"><span class="bullet">3.	</span>Blue</span><br></pre></td></tr></table></figure>
<h3>Task List</h3>
<p>Task lists are lists with items marked as either [ ] or [x] (incomplete or complete). For example:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">- </span>[ ] a task list item</span><br><span class="line"><span class="bullet">- </span>[ ] list syntax required</span><br><span class="line"><span class="bullet">- </span>[ ] normal <span class="strong">**formatting**</span>, @mentions, #1234 refs</span><br><span class="line"><span class="bullet">- </span>[ ] incomplete</span><br><span class="line"><span class="bullet">- </span>[x] completed</span><br></pre></td></tr></table></figure>
<p>You can change the complete/incomplete state by clicking on the checkbox before the item.</p>
<h3>(Fenced) Code Blocks</h3>
<p>Typora only supports fences in GitHub Flavored Markdown. Original code blocks in markdown are not supported.</p>
<p>Using fences is easy: Input ``` and press <code>return</code>. Add an optional language identifier after ``` and weâ€™ll run it through syntax highlighting:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Here's an example:</span><br><span class="line"></span><br><span class="line">\<span class="code">`\`</span>\`</span><br><span class="line">function test() &#123;</span><br><span class="line">  console.log("notice the blank line before this function?");</span><br><span class="line">&#125;</span><br><span class="line">\<span class="code">`\`</span>\`</span><br><span class="line"></span><br><span class="line">syntax highlighting:</span><br><span class="line">\<span class="code">`\`</span>\`ruby</span><br><span class="line">require 'redcarpet'</span><br><span class="line">markdown = Redcarpet.new("Hello World!")</span><br><span class="line">puts markdown.to_html</span><br><span class="line">\<span class="code">`\`</span>\`</span><br></pre></td></tr></table></figure>
<h3>Math Blocks</h3>
<div class="note danger no-icon">
            <p><strong>æ³¨æ„ï¼š</strong> å› ä¸ºTyporaçš„æ•°å­¦å…¬å¼æ˜¯ç”¨Mathjaxæ¸²æŸ“çš„è€Œæˆ‘çš„åšå®¢ä½¿ç”¨çš„æ˜¯<code>hexo-renderer-markdown-it</code>æ¸²æŸ“å™¨ï¼Œå®ƒæ˜¯ç”¨Katexæ¥æ¸²æŸ“æ•°å­¦å…¬å¼ï¼Œä¸‹é¢çš„å…¬å¼å‡æ˜¯ç”¨Mathjaxçš„è¯­æ³•å†™çš„ï¼Œè¯­æ³•ä¸åŒï¼Œæ‰€ä»¥ä¸‹é¢çš„å…¬å¼å‡ä¸èƒ½æ­£å¸¸çš„æ˜¾ç¤ºå‡ºæ¥ï¼</p>
          </div>
<p>You can render <em>LaTeX</em> mathematical expressions using <strong>MathJax</strong>.</p>
<p>To add a mathematical expression, input <code>$$</code> and press the â€˜Returnâ€™ key. This will trigger an input field which accepts <em>Tex/LaTex</em> source. For example:</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi mathvariant="bold">V</mi><mn>1</mn></msub><mo>Ã—</mo><msub><mi mathvariant="bold">V</mi><mn>2</mn></msub><mo>=</mo><mrow><mo fence="true">âˆ£</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="bold">i</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="bold">j</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="bold">k</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">âˆ‚</mi><mi>X</mi></mrow><mrow><mi mathvariant="normal">âˆ‚</mi><mi>u</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">âˆ‚</mi><mi>Y</mi></mrow><mrow><mi mathvariant="normal">âˆ‚</mi><mi>u</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">âˆ‚</mi><mi>X</mi></mrow><mrow><mi mathvariant="normal">âˆ‚</mi><mi>v</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mrow><mi mathvariant="normal">âˆ‚</mi><mi>Y</mi></mrow><mrow><mi mathvariant="normal">âˆ‚</mi><mi>v</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">âˆ£</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{V}_1 \times \mathbf{V}_2 =  \begin{vmatrix}
\mathbf{i} &amp; \mathbf{j} &amp; \mathbf{k} \\
\frac{\partial X}{\partial u} &amp;  \frac{\partial Y}{\partial u} &amp; 0 \\
\frac{\partial X}{\partial v} &amp;  \frac{\partial Y}{\partial v} &amp; 0 \\
\end{vmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83611em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83611em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.6802159999999997em;vertical-align:-1.590108em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.08597em;"><span style="top:-1.05597em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-1.6619700000000002em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-2.26797em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-2.87397em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-3.47997em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-4.08597em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500299999999998em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.090108em;"><span style="top:-4.250108em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">i</span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight">u</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">X</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.769892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">X</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.590108em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.090108em;"><span style="top:-4.250108em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">j</span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight">u</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight" style="margin-right:0.22222em;">Y</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.769892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight" style="margin-right:0.22222em;">Y</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.590108em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.090108em;"><span style="top:-4.250108em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">k</span></span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.769892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.590108em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.08597em;"><span style="top:-1.05597em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-1.6619700000000002em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-2.26797em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-2.87397em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-3.47997em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span><span style="top:-4.08597em;"><span class="pstrut" style="height:2.606em;"></span><span class="delimsizinginner delim-size1"><span>âˆ£</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500299999999998em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>In the markdown source file, the math block is a <em>LaTeX</em> expression wrapped by a pair of â€˜$$â€™ marks:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">$$</span><br><span class="line">\mathbf&#123;V&#125;<span class="emphasis">_1 \times \mathbf&#123;V&#125;_</span>2 =  \begin&#123;vmatrix&#125;</span><br><span class="line">\mathbf&#123;i&#125; &amp; \mathbf&#123;j&#125; &amp; \mathbf&#123;k&#125; \\</span><br><span class="line">\frac&#123;\partial X&#125;&#123;\partial u&#125; &amp;  \frac&#123;\partial Y&#125;&#123;\partial u&#125; &amp; 0 \\</span><br><span class="line">\frac&#123;\partial X&#125;&#123;\partial v&#125; &amp;  \frac&#123;\partial Y&#125;&#123;\partial v&#125; &amp; 0 \\</span><br><span class="line">\end&#123;vmatrix&#125;</span><br><span class="line">$$</span><br></pre></td></tr></table></figure>
<p>You can find more details <a href="https://support.typora.io/Math/" target="_blank" rel="noopener">here</a>.</p>
<h3>Tables</h3>
<p>Input <code>| First Header | Second Header |</code> and press the <code>return</code> key. This will create a table with two columns.</p>
<p>After a table is created, putting focus on that table will open up a toolbar for the table where you can resize, align, or delete the table. You can also use the context menu to copy and add/delete individual columns/rows.</p>
<p>The full syntax for tables is described below, but it is not necessary to know the full syntax in detail as the markdown source code for tables is generated automatically by Typora.</p>
<p>In markdown source code, they look like:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">| First Header  | Second Header |</span><br><span class="line">| ------------- | ------------- |</span><br><span class="line">| Content Cell  | Content Cell  |</span><br><span class="line">| Content Cell  | Content Cell  |</span><br></pre></td></tr></table></figure>
<p>You can also include inline Markdown such as links, bold, italics, or strikethrough in the table.</p>
<p>Finally, by including colons (<code>:</code>) within the header row, you can define text in that column to be left-aligned, right-aligned, or center-aligned:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">| Left-Aligned  | Center Aligned  | Right Aligned |</span><br><span class="line">| :------------ |:---------------:| -----:|</span><br><span class="line">| col 3 is      | some wordy text | $1600 |</span><br><span class="line">| col 2 is      | centered        |   $12 |</span><br><span class="line">| zebra stripes | are neat        |    $1 |</span><br></pre></td></tr></table></figure>
<p>A colon on the left-most side indicates a left-aligned column; a colon on the right-most side indicates a right-aligned column; a colon on both sides indicates a center-aligned column.</p>
<h3>Footnotes</h3>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">You can create footnotes like this[^footnote].</span><br><span class="line"></span><br><span class="line">[<span class="symbol">^footnote</span>]: <span class="link">Here is the *text* of the **footnote**.</span></span><br></pre></td></tr></table></figure>
<p>will produce:</p>
<p>You can create footnotes like this<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>.</p>
<p>Hover over the â€˜footnoteâ€™ superscript to see content of the footnote.</p>
<h3>Horizontal Rules</h3>
<p>Inputting <code>***</code> or <code>---</code> on a blank line and pressing <code>return</code> will draw a horizontal line.</p>
<hr />
<h3>YAML Front Matter</h3>
<p>Typora now supports <a href="http://jekyllrb.com/docs/frontmatter/" target="_blank" rel="noopener">YAML Front Matter</a>. Input <code>---</code> at the top of the article and then press <code>Return</code> to introduce a metadata block. Alternatively, you can insert a metadata block from the top menu of Typora.</p>
<h3>Table of Contents (TOC)</h3>
<p>Input <code>[toc]</code> and press the <code>Return</code> key. This will create a  â€œTable of Contentsâ€ section. The TOC extracts all headers from the document, and its contents are updated automatically as you add to the document.</p>
<h2>Span Elements</h2>
<p>Span elements will be parsed and rendered right after typing. Moving the cursor in middle of those span elements will expand those elements into markdown source. Below is an explanation of the syntax for each span element.</p>
<h3>Links</h3>
<p>Markdown supports two styles of links: inline and reference.</p>
<p>In both styles, the link text is delimited by [square brackets].</p>
<p>To create an inline link, use a set of regular parentheses immediately after the link textâ€™s closing square bracket. Inside the parentheses, put the URL where you want the link to point, along with an optional title for the link, surrounded in quotes. For example:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">This is [<span class="string">an example</span>](<span class="link">http://example.com/ "Title"</span>) inline link.</span><br><span class="line"></span><br><span class="line">[<span class="string">This link</span>](<span class="link">http://example.net/</span>) has no title attribute.</span><br></pre></td></tr></table></figure>
<p>will produce:</p>
<p>This is <a href="http://example.com/%22Title%22" target="_blank" rel="noopener">an example</a> inline link. (<code>&lt;p&gt;This is &lt;a href=&quot;http://example.com/&quot; title=&quot;Title&quot;&gt;</code>)</p>
<p><a href="http://example.net/" target="_blank" rel="noopener">This link</a> has no title attribute. (<code>&lt;p&gt;&lt;a href=&quot;http://example.net/&quot;&gt;This link&lt;/a&gt; has no</code>)</p>
<h4>Internal Links</h4>
<p><strong>You can set the href to headers</strong>, which will create a bookmark that allow you to jump to that section after clicking. For example:</p>
<p>Command(on Windows: Ctrl) + Click <a href="#block-elements">This link</a> will jump to header <code>Block Elements</code>. To see how to write that, please move cursor or click that link with <code>âŒ˜</code> key pressed to expand the element into markdown source.</p>
<h4>Reference Links</h4>
<p>Reference-style links use a second set of square brackets, inside which you place a label of your choosing to identify the link:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">This is [<span class="string">an example</span>][<span class="symbol">id</span>] reference-style link.</span><br><span class="line"></span><br><span class="line">Then, anywhere in the document, you define your link label on a line by itself like this:</span><br><span class="line"></span><br><span class="line">[<span class="symbol">id</span>]: <span class="link">http://example.com/  "Optional Title Here"</span></span><br></pre></td></tr></table></figure>
<p>In Typora, they will be rendered like so:</p>
<p>This is <a href="http://example.com/" target="_blank" rel="noopener" title="Optional Title Here">an example</a> reference-style link.</p>
<p>The implicit link name shortcut allows you to omit the name of the link, in which case the link text itself is used as the name. Just use an empty set of square brackets â€” for example, to link the word â€œGoogleâ€ to the <a href="http://google.com" target="_blank" rel="noopener">google.com</a> web site, you could simply write:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">[<span class="string">Google</span>][<span class="symbol"></span>]</span><br><span class="line">And then define the link:</span><br><span class="line"></span><br><span class="line">[<span class="symbol">Google</span>]: <span class="link">http://google.com/</span></span><br></pre></td></tr></table></figure>
<p>In Typora, clicking the link will expand it for editing, and command+click will open the hyperlink in your web browser.</p>
<h3>URLs</h3>
<p>Typora allows you to insert URLs as links, wrapped by <code>&lt;</code>brackets<code>&gt;</code>.</p>
<p><code>&lt;i@typora.io&gt;</code> becomes <a href="mailto:i@typora.io">i@typora.io</a>.</p>
<p>Typora will also automatically link standard URLs. e.g: <a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a>.</p>
<h3>Images</h3>
<p>Images have similar syntax as links, but they require an additional <code>!</code> char before the start of the link. The syntax for inserting an image looks like this:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">![<span class="string">Alt text</span>](<span class="link">/path/to/img.jpg</span>)</span><br><span class="line"></span><br><span class="line">![<span class="string">Alt text</span>](<span class="link">/path/to/img.jpg "Optional title"</span>)</span><br></pre></td></tr></table></figure>
<p>You are able to use drag &amp; drop to insert an image from an image file or your web browser. You can modify the markdown source code by clicking on the image. A relative path will be used if the image that is added using drag &amp; drop is in same directory or sub-directory as the document youâ€™re currently editing.</p>
<p>If youâ€™re using markdown for building websites, you may specify a URL prefix for the image preview on your local computer with property <code>typora-root-url</code> in YAML Front Matters. For example, input <code>typora-root-url:/User/Abner/Website/typora.io/</code> in YAML Front Matters, and then <code>![alt](/blog/img/test.png)</code> will be treated as <code>![alt](file:///User/Abner/Website/typora.io/blog/img/test.png)</code> in Typora.</p>
<p>You can find more details <a href="https://support.typora.io/Images/" target="_blank" rel="noopener">here</a>.</p>
<h3>Emphasis</h3>
<p>Markdown treats asterisks (<code>*</code>) and underscores (<code>_</code>) as indicators of emphasis. Text wrapped with one <code>*</code> or <code>_</code> will be wrapped with an HTML <code>&lt;em&gt;</code> tag. E.g:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="emphasis">*single asterisks*</span></span><br><span class="line"></span><br><span class="line"><span class="emphasis">_single underscores_</span></span><br></pre></td></tr></table></figure>
<p>output:</p>
<p><em>single asterisks</em></p>
<p><em>single underscores</em></p>
<p>GFM will ignore underscores in words, which is commonly used in code and names, like this:</p>
<blockquote>
<p>wow_great_stuff</p>
<p>do_this_and_do_that_and_another_thing.</p>
</blockquote>
<p>To produce a literal asterisk or underscore at a position where it would otherwise be used as an emphasis delimiter, you can backslash escape it:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">\<span class="emphasis">*this text is surrounded by literal asterisks\*</span></span><br></pre></td></tr></table></figure>
<p>Typora recommends using the <code>*</code> symbol.</p>
<h3>Strong</h3>
<p>A double <code>*</code> or <code>_</code> will cause its enclosed contents to be wrapped with an HTML <code>&lt;strong&gt;</code> tag, e.g:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="strong">**double asterisks**</span></span><br><span class="line"></span><br><span class="line"><span class="strong">__double underscores__</span></span><br></pre></td></tr></table></figure>
<p>output:</p>
<p><strong>double asterisks</strong></p>
<p><strong>double underscores</strong></p>
<p>Typora recommends using the <code>**</code> symbol.</p>
<h3>Code</h3>
<p>To indicate an inline span of code, wrap it with backtick quotes (`). Unlike a pre-formatted code block, a code span indicates code within a normal paragraph. For example:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Use the <span class="code">`printf()`</span> function.</span><br></pre></td></tr></table></figure>
<p>will produce:</p>
<p>Use the <code>printf()</code> function.</p>
<h3>Strikethrough</h3>
<p>GFM adds syntax to create strikethrough text, which is missing from standard Markdown.</p>
<p><code>~~Mistaken text.~~</code> becomes <s>Mistaken text.</s></p>
<h3>Underlines</h3>
<p>Underline is powered by raw HTML.</p>
<p><code>&lt;u&gt;Underline&lt;/u&gt;</code> becomes <u>Underline</u>.</p>
<h3>Emoji ğŸ˜„</h3>
<p>Input emoji with syntax <code>:smile:</code>.</p>
<p>User can trigger auto-complete suggestions for emoji by pressing <code>ESC</code> key, or trigger it automatically after enabling it on preference panel. Also, inputting UTF-8 emoji characters directly is also supported by going to <code>Edit</code> -&gt; <code>Emoji &amp; Symbols</code> in the menu bar (macOS).</p>
<h3>Inline Math</h3>
<p>To use this feature, please enable it first in the <code>Preference</code> Panel -&gt; <code>Markdown</code> Tab. Then, use <code>$</code> to wrap a TeX command. For example: <code>$\lim_{x \to \infty} \exp(-x) = 0$</code> will be rendered as LaTeX command.</p>
<p>To trigger inline preview for inline math: input â€œ$â€, then press the <code>ESC</code> key, then input a TeX command.</p>
<p>You can find more details <a href="https://support.typora.io/Math/" target="_blank" rel="noopener">here</a>.</p>
<h3>Subscript</h3>
<p>To use this feature, please enable it first in the <code>Preference</code> Panel -&gt; <code>Markdown</code> Tab. Then, use <code>~</code> to wrap subscript content. For example: <code>H~2~O</code>, <code>X~long\ text~</code>/</p>
<h3>Superscript</h3>
<p>To use this feature, please enable it first in the <code>Preference</code> Panel -&gt; <code>Markdown</code> Tab. Then, use <code>^</code> to wrap superscript content. For example: <code>X^2^</code>.</p>
<h3>Highlight</h3>
<p>To use this feature, please enable it first in the <code>Preference</code> Panel -&gt; <code>Markdown</code> Tab. Then, use <code>==</code> to wrap highlight content. For example: <code>==highlight==</code>.</p>
<h2>HTML</h2>
<p>You can use HTML to style content what pure Markdown does not support. For example, use <code>&lt;span style=&quot;color:red&quot;&gt;this text is red&lt;/span&gt;</code> to add text with red color.</p>
<h3>Embed Contents</h3>
<p>Some websites provide iframe-based embed code which you can also paste into Typora. For example:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">height</span>=<span class="string">'265'</span> <span class="attr">scrolling</span>=<span class="string">'no'</span> <span class="attr">title</span>=<span class="string">'Fancy Animated SVG Menu'</span> <span class="attr">src</span>=<span class="string">'http://codepen.io/jeangontijo/embed/OxVywj/?height=265&amp;theme-id=0&amp;default-tab=css,result&amp;embed-version=2'</span> <span class="attr">frameborder</span>=<span class="string">'no'</span> <span class="attr">allowtransparency</span>=<span class="string">'true'</span> <span class="attr">allowfullscreen</span>=<span class="string">'true'</span> <span class="attr">style</span>=<span class="string">'width: 100%;'</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3>Video</h3>
<p>You can use the <code>&lt;video&gt;</code> HTML tag to embed videos. For example:</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">"xxx.mp4"</span> /&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3>Other HTML Support</h3>
<p>You can find more details <a href="https://support.typora.io/HTML/" target="_blank" rel="noopener">here</a>.</p>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>Here is the <em>text</em> of the <strong>footnote</strong>. <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>ç¬”è®°</category>
      </categories>
      <tags>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexoä¸­æ’å…¥æ•°å­¦å…¬å¼</title>
    <url>/post/Hexo%E4%B8%AD%E6%8F%92%E5%85%A5%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦è®°å½•ç”¨äºæ¸²æŸ“æ•°å­¦å…¬å¼çš„ä¸¤ä¸ªæ’ä»¶ï¼š<code>MathJax</code>å’Œ<code>Katex</code>ã€‚</p>
<a id="more"></a>
<h2>ä½¿ç”¨MathJax</h2>
<h3>ä½¿ç”¨kramedä»£æ›¿marked</h3>
<p>hexo é»˜è®¤çš„æ¸²æŸ“å¼•æ“æ˜¯ <code>marked</code>ï¼Œä½†æ˜¯ marked ä¸æ”¯æŒ <code>mathjax</code>ã€‚ <code>kramed</code>æ˜¯åœ¨ marked çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ã€‚æˆ‘ä»¬åœ¨å·¥ç¨‹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… <code>kramed</code>.</p>
<figure class="highlight plain"><figcaption><span>~/åšå®¢æ ¹ç›®å½•</span></figcaption><table><tr><td class="code"><pre><span class="line">npm uninstall hexo-renderer-marked --save</span><br><span class="line">npm install hexo-renderer-kramed --save</span><br></pre></td></tr></table></figure>
<p>ç„¶åï¼Œæ›´æ”¹<code>/node_modules/hexo-renderer-kramed/lib/</code>ä¸‹çš„<code>renderer.js</code>æ–‡ä»¶ï¼š</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">// Change inline math rule</span><br><span class="line">function formatText(text) &#123;</span><br><span class="line"><span class="deletion">-    // Fit kramed's rule: $$ + \1 + $$</span></span><br><span class="line"><span class="deletion">-    return text.replace(/`\$(.*?)\$`/g, '$$$$$1$$$$');</span></span><br><span class="line"><span class="addition">+    return text;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>æ›´æ”¹é»˜è®¤è½¬ä¹‰è§„åˆ™</h3>
<p>å› ä¸º hexo é»˜è®¤çš„è½¬ä¹‰è§„åˆ™ä¼šå°†ä¸€äº›å­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œæ¯”å¦‚ <code>_</code>è½¬ä¸º <code>&lt;em&gt;</code>, æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹é»˜è®¤çš„è§„åˆ™è¿›è¡Œä¿®æ”¹.</p>
<figure class="highlight diff"><figcaption><span>~/node_modules/kramed/lib/rules/nline.js</span></figcaption><table><tr><td class="code"><pre><span class="line">// æ›¿æ¢11è¡Œ</span><br><span class="line"><span class="deletion">-  escape: /^\\([\\`*&#123;&#125;\[\]()#$+\-.!_&gt;])/,</span></span><br><span class="line">//ä¿®æ”¹ä¸º</span><br><span class="line"><span class="addition">+  escape: /^\\([`*\[\]()# +\-.!_&gt;])/,</span></span><br><span class="line"></span><br><span class="line">//æ›¿æ¢20è¡Œ</span><br><span class="line"><span class="deletion">-  em: /^\b_((?:__|[\s\S])+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,</span></span><br><span class="line">//ä¿®æ”¹ä¸º</span><br><span class="line"><span class="addition">+  em: /^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,</span></span><br></pre></td></tr></table></figure>
<h3>å¼€å¯MathJax</h3>
<p>è®¾ç½®<code>_config.yml</code>ï¼š</p>
<figure class="highlight diff"><figcaption><span>~/themes/next/_config.yml</span></figcaption><table><tr><td class="code"><pre><span class="line">mathjax:</span><br><span class="line"><span class="deletion">- enable: false</span></span><br><span class="line"><span class="addition">+ enable: true</span></span><br><span class="line">  perpage: false</span><br><span class="line">  cdn: //cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML</span><br></pre></td></tr></table></figure>
<h3>ä¿®æ”¹postæ¨¡æ¿</h3>
<figure class="highlight diff"><figcaption><span>~/scaffolds/post.md</span></figcaption><table><tr><td class="code"><pre><span class="line">title: &#123;&#123; title &#125;&#125;</span><br><span class="line">date: &#123;&#123; date &#125;&#125;</span><br><span class="line">tags:</span><br><span class="line">    - </span><br><span class="line">categories: </span><br><span class="line">    - </span><br><span class="line"><span class="addition">+ mathjax: false</span></span><br></pre></td></tr></table></figure>
<p>æ–‡ç« éœ€è¦æ¸²æŸ“æ•°å­¦å…¬å¼æ—¶æ”¹ä¸º<code>true</code>å°±è¡Œäº†ã€‚</p>
<hr />
<h2>ä½¿ç”¨Katex</h2>
<h3>ä½¿ç”¨markdown-it-plusä»£æ›¿marked</h3>
<p>å®‰è£…æ’ä»¶ï¼š</p>
<figure class="highlight plain"><figcaption><span>~/åšå®¢æ ¹ç›®å½•</span></figcaption><table><tr><td class="code"><pre><span class="line">$ npm un hexo-renderer-marked --save</span><br><span class="line">$ npm i hexo-renderer-markdown-it-plus --save</span><br></pre></td></tr></table></figure>
<h3>é…ç½®</h3>
<p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶é‡Œè®¾ç½®ï¼š</p>
<figure class="highlight yml"><figcaption><span>~/next/_config.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># Math Formulas Render Support</span></span><br><span class="line"><span class="attr">math:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Default (true) will load mathjax / katex script on demand.</span></span><br><span class="line">  <span class="comment"># That is it only render those page which has `mathjax: true` in Front-matter.</span></span><br><span class="line">  <span class="comment"># If you set it to false, it will load mathjax / katex srcipt EVERY PAGE.</span></span><br><span class="line">  <span class="attr">per_page:</span> <span class="literal">true</span> <span class="comment">#å¦‚æœè¿™ä¸ªé€‰é¡¹æ˜¯falseï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªç½‘é¡µéƒ½ä¼šå¼•å…¥å…¬å¼æ¸²æŸ“ï¼Œè¿™æ˜¯å¾ˆæµªè´¹çš„ï¼Œåªéœ€è¦åœ¨éœ€è¦å…¬å¼æ¸²æŸ“åŠŸèƒ½çš„åšæ–‡mdæ–‡ä»¶çš„å¤´éƒ¨ï¼Œæ·»åŠ ä¸€è¡Œ`mathjax: true`(ä½¿ç”¨Katexå¼•æ“æ¸²æŸ“ä¹Ÿæ˜¯åœ¨æ–‡ä»¶å¤´éƒ¨æ ‡è®°`mathjax: true`ï¼Œè¡¨ç¤ºæ”¯æŒå…¬å¼)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># hexo-renderer-pandoc (or hexo-renderer-kramed) required for full MathJax support.</span></span><br><span class="line">  <span class="attr">mathjax:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># See: https://mhchem.github.io/MathJax-mhchem/</span></span><br><span class="line">    <span class="attr">mhchem:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># hexo-renderer-markdown-it-plus (or hexo-renderer-markdown-it with markdown-it-katex plugin) required for full Katex support.</span></span><br><span class="line">  <span class="attr">katex:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># See: https://github.com/KaTeX/KaTeX/tree/master/contrib/copy-tex</span></span><br><span class="line">    <span class="attr">copy_tex:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3>æ·»åŠ æ ·å¼</h3>
<p>åœ¨<code>~/source/_data/head.swig</code>æ–‡ä»¶é‡Œæ·»åŠ ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css"</span>&gt;</span><br></pre></td></tr></table></figure>
<p>ç„¶åä¿®æ”¹æ¨¡æ¿<code>post.md</code>ï¼Œ<a href="#ä¿®æ”¹postæ¨¡æ¿">åŒä¸Š</a></p>
<hr />
<h2>ç®€å•è¯­æ³•</h2>
<h3>è¡Œå†…å…¬å¼</h3>
<p>ä¸¤è¾¹å„ç”¨ä¸€ä¸ª<code>$</code>åŒ…è£¹èµ·æ¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$\sqrt&#123;3x-1&#125;+(1+x)^2$</span><br></pre></td></tr></table></figure>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msqrt><mrow><mn>3</mn><mi>x</mi><mo>âˆ’</mo><mn>1</mn></mrow></msqrt><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mi>x</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sqrt{3x-1}+(1+x)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.17444499999999996em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8655550000000001em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">3</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span></span></span><span style="top:-2.825555em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,
-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,
-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,
35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,
-221c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467
s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422
s-65,47,-65,47z M834 80H400000v40H845z'/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.17444499999999996em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></p>
<h3>å¤šè¡Œå…¬å¼</h3>
<p>ä¸Šä¸‹å„ç”¨ä¸€ä¸ª(<code>$$</code>) åŒ…è£¹èµ·æ¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$$\begin&#123;array&#125;&#123;c&#125;</span><br><span class="line"></span><br><span class="line">\nabla \times \vec&#123;\mathbf&#123;B&#125;&#125; -\, \frac1c\, \frac&#123;\partial\vec&#123;\mathbf&#123;E&#125;&#125;&#125;&#123;\partial t&#125; &amp;</span><br><span class="line">&#x3D; \frac&#123;4\pi&#125;&#123;c&#125;\vec&#123;\mathbf&#123;j&#125;&#125;    \nabla \cdot \vec&#123;\mathbf&#123;E&#125;&#125; &amp; &#x3D; 4 \pi \rho \\</span><br><span class="line"></span><br><span class="line">\nabla \times \vec&#123;\mathbf&#123;E&#125;&#125;\, +\, \frac1c\, \frac&#123;\partial\vec&#123;\mathbf&#123;B&#125;&#125;&#125;&#123;\partial t&#125; &amp; &#x3D; \vec&#123;\mathbf&#123;0&#125;&#125; \\</span><br><span class="line"></span><br><span class="line">\nabla \cdot \vec&#123;\mathbf&#123;B&#125;&#125; &amp; &#x3D; 0</span><br><span class="line"></span><br><span class="line">\end&#123;array&#125;$$</span><br></pre></td></tr></table></figure>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.15999999999999992em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">âˆ‡</mi><mo>Ã—</mo><mover accent="true"><mi mathvariant="bold">B</mi><mo>âƒ—</mo></mover><mo>âˆ’</mo><mtext>â€‰</mtext><mfrac><mn>1</mn><mi>c</mi></mfrac><mtext>â€‰</mtext><mfrac><mrow><mi mathvariant="normal">âˆ‚</mi><mover accent="true"><mi mathvariant="bold">E</mi><mo>âƒ—</mo></mover></mrow><mrow><mi mathvariant="normal">âˆ‚</mi><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mfrac><mrow><mn>4</mn><mi>Ï€</mi></mrow><mi>c</mi></mfrac><mover accent="true"><mi mathvariant="bold">j</mi><mo>âƒ—</mo></mover><mi mathvariant="normal">âˆ‡</mi><mo>â‹…</mo><mover accent="true"><mi mathvariant="bold">E</mi><mo>âƒ—</mo></mover></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>4</mn><mi>Ï€</mi><mi>Ï</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">âˆ‡</mi><mo>Ã—</mo><mover accent="true"><mi mathvariant="bold">E</mi><mo>âƒ—</mo></mover><mtext>â€‰</mtext><mo>+</mo><mtext>â€‰</mtext><mfrac><mn>1</mn><mi>c</mi></mfrac><mtext>â€‰</mtext><mfrac><mrow><mi mathvariant="normal">âˆ‚</mi><mover accent="true"><mi mathvariant="bold">B</mi><mo>âƒ—</mo></mover></mrow><mrow><mi mathvariant="normal">âˆ‚</mi><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mover accent="true"><mn mathvariant="bold">0</mn><mo>âƒ—</mo></mover></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">âˆ‡</mi><mo>â‹…</mo><mover accent="true"><mi mathvariant="bold">B</mi><mo>âƒ—</mo></mover></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>=</mo><mn>0</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{c}

\nabla \times \vec{\mathbf{B}} -\, \frac1c\, \frac{\partial\vec{\mathbf{E}}}{\partial t} &amp;
= \frac{4\pi}{c}\vec{\mathbf{j}}    \nabla \cdot \vec{\mathbf{E}} &amp; = 4 \pi \rho \\

\nabla \times \vec{\mathbf{E}}\, +\, \frac1c\, \frac{\partial\vec{\mathbf{B}}}{\partial t} &amp; = \vec{\mathbf{0}} \\

\nabla \cdot \vec{\mathbf{B}} &amp; = 0

\end{array}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.1938640000000005em;vertical-align:-1.846932em;"></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3469320000000002em;"><span style="top:-4.346932000000001em;"><span class="pstrut" style="height:3.072377em;"></span><span class="mord"><span class="mord">âˆ‡</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9691099999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">B</span></span></span></span><span style="top:-3.25511em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.072377em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9691099999999999em;"><span style="top:-2.714em;"><span class="pstrut" style="height:2.714em;"></span><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">E</span></span></span></span><span style="top:-2.96911em;"><span class="pstrut" style="height:2.714em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay mtight" style="height:0.714em;width:0.471em;"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.9145549999999996em;"><span class="pstrut" style="height:3.072377em;"></span><span class="mord"><span class="mord">âˆ‡</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9691099999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">E</span></span></span></span><span style="top:-3.25511em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">c</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.072377em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">âˆ‚</span><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9691099999999999em;"><span style="top:-2.714em;"><span class="pstrut" style="height:2.714em;"></span><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">B</span></span></span></span><span style="top:-2.96911em;"><span class="pstrut" style="height:2.714em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay mtight" style="height:0.714em;width:0.471em;"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.585445em;"><span class="pstrut" style="height:3.072377em;"></span><span class="mord"><span class="mord">âˆ‡</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9691099999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">B</span></span></span></span><span style="top:-3.25511em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.846932em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3469320000000002em;"><span style="top:-4.346932000000001em;"><span class="pstrut" style="height:3.072377em;"></span><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">c</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">Ï€</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9774399999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">j</span></span></span></span><span style="top:-3.26344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mord">âˆ‡</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9691099999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">E</span></span></span></span><span style="top:-3.25511em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span><span style="top:-2.9145549999999996em;"><span class="pstrut" style="height:3.072377em;"></span><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.92744em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">0</span></span></span></span><span style="top:-3.21344em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span></span></span><span style="top:-1.585445em;"><span class="pstrut" style="height:3.072377em;"></span><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.846932em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:2.3469320000000002em;"><span style="top:-4.346932000000001em;"><span class="pstrut" style="height:3.072377em;"></span><span class="mord"><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.03588em;">Ï€</span><span class="mord mathdefault">Ï</span></span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span></span></span></span></span></p>
<hr />
<h2>å‚è€ƒ</h2>
<ol>
<li><a href="https://github.com/Khan/KaTeX/wiki/Function-Support-in-KaTeX" target="_blank" rel="noopener">Function Support in KaTeX</a></li>
<li><a href="https://github.com/markdown-it/markdown-it" target="_blank" rel="noopener">Markdown-it</a></li>
</ol>
]]></content>
      <categories>
        <category>è®°å½•</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>mathjax</tag>
        <tag>katex</tag>
      </tags>
  </entry>
  <entry>
    <title>æ ‡ç­¾æ’ä»¶(Tag Plugins)</title>
    <url>/post/note-tag/</url>
    <content><![CDATA[<h1>è¯´åœ¨å‰é¢</h1>
<p>æ ‡ç­¾æ’ä»¶æ˜¯ä½¿Hexoæ”¯æŒç‰¹æ®Šç±»å‹å†…å®¹çš„ä¸€ç§æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨æ ‡å‡†MarkDownä¸­æ˜¾ç¤ºè‡ªå®šä¹‰å¤§å°çš„å›¾ç‰‡ã€‚Hexoå’ŒNextä¸»é¢˜éƒ½æä¾›äº†å„è‡ªçš„æ ‡ç­¾æ’ä»¶ã€‚ä¸‹é¢å…ˆä»‹ç»Hexoæä¾›çš„ã€‚</p>
<h1>Hexoæä¾›çš„æ ‡ç­¾æ’ä»¶</h1>
<h2>å¼•ç”¨å—</h2>
<p>åœ¨æ–‡ç« ä¸­æ’å…¥å¼•è¨€ï¼Œå¯åŒ…å«ä½œè€…ã€æ¥æºå’Œæ ‡é¢˜ã€‚<br />
**å¼•ç”¨ï¼š**quote</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% blockquote [author[, source]] [link] [source_link_title] %&#125;</span><br><span class="line">content</span><br><span class="line">&#123;% endblockquote %&#125;</span><br></pre></td></tr></table></figure>
<h3>æ ·ä¾‹</h3>
<p><strong>æ²¡æœ‰æä¾›å‚æ•°ï¼Œåˆ™åªè¾“å‡ºæ™®é€šçš„blockquote</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% blockquote %&#125;</span><br><span class="line">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque hendrerit lacus ut purus iaculis feugiat. Sed nec tempor elit, quis aliquam neque. Curabitur sed diam eget dolor fermentum semper at eu lorem.</span><br><span class="line">&#123;% endblockquote %&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque hendrerit lacus ut purus iaculis feugiat. Sed nec tempor elit, quis aliquam neque. Curabitur sed diam eget dolor fermentum semper at eu lorem.</p>
</blockquote>
<p><strong>å¼•ç”¨ä¹¦ä¸Šçš„ä¾‹å­</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% blockquote David Levithan, Wide Awake %&#125;</span><br><span class="line">Do not just seek happiness for yourself. Seek happiness for all. Through kindness. Through mercy.</span><br><span class="line">&#123;% endblockquote %&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p>Do not just seek happiness for yourself. Seek happiness for all. Through kindness. Through mercy.</p>
<footer><strong>David Levithan</strong><cite>Wide Awake</cite></footer></blockquote>
<p><strong>å¼•ç”¨Twitter</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% blockquote @DevDocs https:&#x2F;&#x2F;twitter.com&#x2F;devdocs&#x2F;status&#x2F;356095192085962752 %&#125;</span><br><span class="line">NEW: DevDocs now comes with syntax highlighting. http:&#x2F;&#x2F;devdocs.io</span><br><span class="line">&#123;% endblockquote %&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p>NEW: DevDocs now comes with syntax highlighting. <a href="http://devdocs.io" target="_blank" rel="noopener">http://devdocs.io</a></p>
<footer><strong>@DevDocs</strong><cite><a href="https://twitter.com/devdocs/status/356095192085962752" target="_blank" rel="noopener">twitter.com/devdocs/status/356095192085962752</a></cite></footer></blockquote>
<p><strong>å¼•ç”¨ç½‘ç»œä¸Šçš„æ–‡ç« </strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% blockquote Seth Godin http:&#x2F;&#x2F;sethgodin.typepad.com&#x2F;seths_blog&#x2F;2009&#x2F;07&#x2F;welcome-to-island-marketing.html Welcome to Island Marketing %&#125;</span><br><span class="line">Every interaction is both precious and an opportunity to delight.</span><br><span class="line">&#123;% endblockquote %&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p>Every interaction is both precious and an opportunity to delight.</p>
<footer><strong>Seth Godin</strong><cite><a href="http://sethgodin.typepad.com/seths_blog/2009/07/welcome-to-island-marketing.html" target="_blank" rel="noopener">Welcome to Island Marketing</a></cite></footer></blockquote>
<h2>ä»£ç å—</h2>
<p>åœ¨æ–‡ç« ä¸­æ’å…¥ä»£ç <br />
**åˆ«åï¼š**code</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% codeblock [title] [lang:language] [url] [link text] [additional options] %&#125;</span><br><span class="line">code snippet</span><br><span class="line">&#123;% endcodeblock %&#125;</span><br></pre></td></tr></table></figure>
<p>Specify additional options in<code>option:value</code>format, e.g<code>line_number:false first_line:5</code></p>
<table>
<thead>
<tr>
<th>Extra Options</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>line_number</code></td>
<td>Show line number</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>highlight</code></td>
<td>Enable code highlighting</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>first_line</code></td>
<td>Specify the first line number</td>
<td><code>1</code></td>
</tr>
<tr>
<td><code>mark</code></td>
<td>Line highlight specific line(s), each value separated by a comma. Specify number range using a dash<br/>Example: <code>mark:1,4-7,10</code> will mark line 1, 4 to 7 and 10.</td>
<td></td>
</tr>
<tr>
<td><code>wrap</code></td>
<td>Wrap the code block in <code>&lt;table&gt;</code></td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
<h3>æ ·ä¾‹</h3>
<p><strong>æ™®é€šçš„ä»£ç å—</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% codeblock %&#125;</span><br><span class="line">alert(&#39;Hello World!&#39;);</span><br><span class="line">&#123;% endcodeblock %&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alert(&#39;Hello World!&#39;);</span><br></pre></td></tr></table></figure>
<p><strong>æŒ‡å®šè¯­è¨€</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% codeblock lang:objc %&#125;</span><br><span class="line">[rectangle setX: 10 y: 10 width: 20 height: 20];</span><br><span class="line">&#123;% endcodeblock %&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[rectangle setX: <span class="number">10</span> y: <span class="number">10</span> width: <span class="number">20</span> height: <span class="number">20</span>];</span><br></pre></td></tr></table></figure>
<p><strong>é™„åŠ è¯´æ˜</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% codeblock Array.map %&#125;</span><br><span class="line">array.map(callback[, thisArg])</span><br><span class="line">&#123;% endcodeblock %&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>Array.map</span></figcaption><table><tr><td class="code"><pre><span class="line">array.map(callback[, thisArg])</span><br></pre></td></tr></table></figure>
<p><strong>é™„åŠ è¯´æ˜å’Œç½‘å€</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% codeblock _.compact http:&#x2F;&#x2F;underscorejs.org&#x2F;#compact Underscore.js %&#125;</span><br><span class="line">_.compact([0, 1, false, 2, &#39;&#39;, 3]);</span><br><span class="line">&#x3D;&gt; [1, 2, 3]</span><br><span class="line">&#123;% endcodeblock %&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>_.compact</span><a href="http://underscorejs.org/#compact" target="_blank" rel="noopener">Underscore.js</a></figcaption><table><tr><td class="code"><pre><span class="line">_.compact([0, 1, false, 2, &#39;&#39;, 3]);</span><br><span class="line">&#x3D;&gt; [1, 2, 3]</span><br></pre></td></tr></table></figure>
<h2>åå¼•å·ä»£ç å—</h2>
<p>å¦ä¸€ç§å½¢å¼çš„ä»£ç å—ï¼Œä¸åŒçš„æ˜¯å®ƒä½¿ç”¨ä¸‰ä¸ªåå¼•å·æ¥åŒ…è£¹ã€‚<br />
``` [language] [title] [url] [link text] code snippet ```</p>
<h2>Pull Quote</h2>
<p>åœ¨æ–‡ç« ä¸­æ’å…¥Pull quoteã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% pullquote [class] %&#125;</span><br><span class="line">content</span><br><span class="line">&#123;% endpullquote %&#125;</span><br></pre></td></tr></table></figure>
<h2>jsFiddle</h2>
<p>åœ¨æ–‡ç« ä¸­åµŒå…¥jsFiddleã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% jsfiddle shorttag [tabs] [skin] [width] [height] %&#125;</span><br></pre></td></tr></table></figure>
<h2>Gist</h2>
<p>åœ¨æ–‡ç« ä¸­åµŒå…¥Gistã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% gist gist_id [filename] %&#125;</span><br></pre></td></tr></table></figure>
<h2>iframe</h2>
<p>åœ¨æ–‡ç« ä¸­æ’å…¥iframeã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% iframe url [width] [height] %&#125;</span><br></pre></td></tr></table></figure>
<h2>Image</h2>
<p>åœ¨æ–‡ç« ä¸­æ’å…¥æŒ‡å®šå¤§å°çš„å›¾ç‰‡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% img [class names] &#x2F;path&#x2F;to&#x2F;image [width] [height] &#96;&quot;title text&quot; &quot;alt text&quot;&#39; %&#125;</span><br></pre></td></tr></table></figure>
<h2>Link</h2>
<p>åœ¨æ–‡ç« ä¸­æ’å…¥é“¾æ¥ï¼Œå¹¶è‡ªåŠ¨ç»™å¤–éƒ¨é“¾æ¥æ·»åŠ <code>target=&quot;_blank&quot;</code>å±æ€§ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% link text url [external] [title] %&#125;</span><br></pre></td></tr></table></figure>
<h2>Include Code</h2>
<p>æ’å…¥<code>source/downloads/code</code>æ–‡ä»¶å¤¹å†…çš„ä»£ç æ–‡ä»¶ã€‚<code>source/downloads/code</code>ä¸æ˜¯å›ºå®šçš„ï¼Œå–å†³äºä½ åœ¨é…ç½®æ–‡ä»¶ä¸­<code>code_dir</code>çš„é…ç½®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% include_code [title] [lang:language] [from:line] [to:line] path&#x2F;to&#x2F;file %&#125;</span><br></pre></td></tr></table></figure>
<h3>æ ·ä¾‹</h3>
<p><strong>åµŒå…¥test.jsæ–‡ä»¶å…¨æ–‡</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% include_code lang:javascript test.js %&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åªåµŒå…¥ç¬¬3è¡Œ</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% include_code lang:javascript from:3 to:3 test.js %&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åµŒå…¥ç¬¬5è¡Œè‡³ç¬¬8è¡Œ</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% include_code lang:javascript from:5 to:8 test.js %&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åµŒå…¥ç¬¬5è¡Œè‡³æ–‡ä»¶ç»“æŸ</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% include_code lang:javascript from:5 test.js %&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åµŒå…¥ç¬¬1è¡Œè‡³ç¬¬8è¡Œ</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% include_code lang:javascript to:8 test.js %&#125;</span><br></pre></td></tr></table></figure>
<h2>Youtube</h2>
<p>åœ¨æ–‡ç« ä¸­æ’å…¥YOUtubeè§†é¢‘ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% youtube video_id %&#125;</span><br></pre></td></tr></table></figure>
<h2>Vimeo</h2>
<p>åœ¨æ–‡ç« ä¸­æ’å…¥Vimeoè§†é¢‘ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% vimeo video_id %&#125;</span><br></pre></td></tr></table></figure>
<h2>å¼•ç”¨æ–‡ç« </h2>
<p>å¼•ç”¨å…¶ä»–æ–‡ç« çš„é“¾æ¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% post_path filename %&#125;</span><br><span class="line">&#123;% post_link filename [title] [escape] %&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä½¿ç”¨æ­¤æ ‡ç­¾æ—¶å¯ä»¥å¿½ç•¥æ–‡ç« æ‰€åœ¨çš„è·¯å¾„æˆ–è€…æ–‡ç« çš„æ°¸ä¹…é“¾æ¥ä¿¡æ¯ã€å¦‚è¯­è¨€ã€æ—¥æœŸã€‚<br />
ä¾‹å¦‚ï¼Œåœ¨æ–‡ç« ä¸­ä½¿ç”¨<code></code>æ—¶ï¼Œåªéœ€è¦ä¸€ä¸ªåä¸º<code>how-to-bake-a-cake.md</code>çš„æ–‡ç« æ–‡ä»¶å³å¯ã€‚å³ä½¿è¿™ä¸ªæ–‡ä»¶ä½äºç«™ç‚¹æ–‡ä»¶å¤¹çš„<code>source/posts/2015-02-my-family-holiday</code>ç›®å½•ä¸‹ã€æˆ–è€…æ–‡ç« çš„æ°¸ä¹…é“¾æ¥æ˜¯<code>2018/en/how-to-bake-a-cake</code>ï¼Œéƒ½æ²¡æœ‰å½±å“ã€‚<br />
é»˜è®¤é“¾æ¥æ–‡å­—æ˜¯æ–‡ç« çš„æ ‡é¢˜ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è¦æ˜¾ç¤ºçš„æ–‡æœ¬ã€‚æ­¤æ—¶ä¸åº”è¯¥ä½¿ç”¨Markdownè¯­æ³•<code>[]()</code>ã€‚<br />
é»˜è®¤å¯¹æ–‡ç« çš„æ ‡é¢˜å’Œè‡ªå®šä¹‰æ ‡é¢˜é‡Œçš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ã€‚å¯ä»¥ä½¿ç”¨<code>escape</code>é€‰é¡¹ï¼Œç¦æ­¢å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ã€‚<br />
<strong>é“¾æ¥ä½¿ç”¨æ–‡ç« çš„æ ‡é¢˜</strong><br />
<code></code></p>
  
<p><strong>é“¾æ¥ä½¿ç”¨è‡ªå®šä¹‰æ–‡å­—</strong><br />
<code></code></p>

<p><strong>å¯¹æ ‡é¢˜çš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% post_link hexo-4-released &#39;How to use &lt;b&gt; tag in title&#39; %&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¦æ­¢å¯¹æ ‡é¢˜çš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% post_link hexo-4-released &#39;&lt;b&gt;bold&lt;&#x2F;b&gt; custom title&#39; false %&#125;</span><br></pre></td></tr></table></figure>

<h2>å¼•ç”¨èµ„æº</h2>
<p>å¼•ç”¨æ–‡ç« çš„èµ„æºã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% asset_path filename %&#125;</span><br><span class="line">&#123;% asset_img filename [title] %&#125;</span><br><span class="line">&#123;% asset_link filename [title] [escape] %&#125;</span><br></pre></td></tr></table></figure>
<h2>Raw</h2>
<p>å¦‚æœæ‚¨æƒ³åœ¨æ–‡ç« ä¸­æ’å…¥Swigæ ‡ç­¾ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨Rawæ ‡ç­¾ï¼Œä»¥å…å‘ç”Ÿè§£æå¼‚å¸¸ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line">content</span><br><span class="line">&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<h2>æ–‡ç« æ‘˜è¦å’Œæˆªæ–­</h2>
<p>åœ¨æ–‡ç« ä¸­ä½¿ç”¨ <code>&lt;!-- more --&gt;</code>ï¼Œé‚£ä¹ˆ <code>&lt;!-- more --&gt;</code> ä¹‹å‰çš„æ–‡å­—å°†ä¼šè¢«è§†ä¸ºæ‘˜è¦ã€‚é¦–é¡µä¸­å°†åªå‡ºç°è¿™éƒ¨åˆ†æ–‡å­—ï¼ŒåŒæ—¶è¿™éƒ¨åˆ†æ–‡å­—ä¹Ÿä¼šå‡ºç°åœ¨æ­£æ–‡ä¹‹ä¸­ã€‚<br />
ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</span><br><span class="line">&lt;!-- more --&gt;</span><br><span class="line">Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</span><br></pre></td></tr></table></figure>
<p>é¦–é¡µä¸­å°†åªä¼šå‡ºç°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</span><br></pre></td></tr></table></figure>
<p>æ­£æ–‡ä¸­åˆ™ä¼šå‡ºç°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</span><br><span class="line"></span><br><span class="line">Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œæ‘˜è¦å¯èƒ½ä¼šè¢«Front Matterä¸­çš„<code>excerpt</code>è¦†ç›–ã€‚</p>
<hr />
<h1>NexTä¸»é¢˜æä¾›çš„æ ‡ç­¾æ’ä»¶</h1>
<h2>å±…ä¸­å¼•ç”¨(Centered Quote)</h2>
<p>è¿™ä¸ªæ ‡è®°å°†åœ¨å®ƒä¹‹å‰å’Œä¹‹åçš„ä¸¤è¡Œä¸­åˆ›å»ºä¸€ä¸ªå¼•ç”¨ï¼Œå¼•ç”¨çš„æ–‡æœ¬å°†å±…ä¸­ã€‚å½“ä½¿ç”¨å±…ä¸­å¼•ç”¨æ—¶ï¼Œå¦‚æœæˆ‘ä»¬æœ‰å¤šè¡Œæ–‡æœ¬ï¼Œè€Œä¸”æ¯è¡Œæœ‰ä¸åŒçš„é•¿åº¦ï¼Œå¼•ç”¨å°±ä¸æ˜¯å¯¹ç§°çš„ï¼Œæ‰€ä»¥å»ºè®®åœ¨åªæœ‰å•è¡Œæ–‡æœ¬æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚æ–‡ç« å‰éƒ½è¦åšæ–‡ç« åçš„æ€»ç»“ã€‚</p>
<h3>ä½¿ç”¨æ–¹æ³•</h3>
<p>center-quote.js</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% centerquote %&#125;Something&#123;% endcenterquote %&#125;</span><br><span class="line">&lt;!-- Tag Alias --&gt;</span><br><span class="line">&#123;% cq %&#125;Something&#123;% endcq %&#125;</span><br></pre></td></tr></table></figure>
<h3>æ ·ä¾‹</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% cq %&#125;Elegant in code, simple in core&#123;% endcq %&#125;</span><br></pre></td></tr></table></figure>
<blockquote class="blockquote-center">
            <i class="fa fa-quote-left"></i>
            <p>Elegant in code, simple in core</p>

            <i class="fa fa-quote-right"></i>
          </blockquote>
<h2>æ³¨é‡Š(Note)</h2>
<h3>è®¾ç½®</h3>
<figure class="highlight yml"><figcaption><span>next/_config.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">note:</span></span><br><span class="line">  <span class="comment"># Note tag style values:</span></span><br><span class="line">  <span class="comment">#  - simple    bs-callout old alert style. Default.</span></span><br><span class="line">  <span class="comment">#  - modern    bs-callout new (v2-v3) alert style.</span></span><br><span class="line">  <span class="comment">#  - flat      flat callout style with background, like on Mozilla or StackOverflow.</span></span><br><span class="line">  <span class="comment">#  - disabled  disable all CSS styles import of note tag.</span></span><br><span class="line">  <span class="attr">style:</span> <span class="string">simple</span></span><br><span class="line">  <span class="attr">icons:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Offset lighter of background in % for modern and flat styles (modern: -12 | 12; flat: -18 | 6).</span></span><br><span class="line">  <span class="comment"># Offset also applied to label tag variables. This option can work with disabled note tag.</span></span><br><span class="line">  <span class="attr">light_bg_offset:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3>ä½¿ç”¨æ–¹æ³•</h3>
<p>note.js</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note [class] [no-icon] %&#125;</span><br><span class="line">Any content (support inline tags too.io).</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">[class]   : default | primary | success | info | warning | danger.</span><br><span class="line">[no-icon] : Disable icon in note.</span><br><span class="line"></span><br><span class="line">All parameters are optional.</span><br></pre></td></tr></table></figure>
<div class="note danger">
            <h4>æ³¨æ„äº‹é¡¹</h4><p>å¦‚æœä½ ä¸æƒ³çœ‹åˆ°å‡ºbugå°±ä¸è¦æŠŠè¿™ä¸ªæ ‡ç­¾å†™æˆä¸€è¡Œã€‚<br />ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ç”¨é”™è¯¯çš„è¯­æ³•å†™å‡ºæ¥çš„å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note danger %&#125;note text, note text, note text&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>æˆ–è€…åƒè¿™æ ·çš„ï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note danger %&#125;note text</span><br><span class="line">note text</span><br><span class="line">note text</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>éœ€è¦æŠŠå†…å®¹å†™åˆ°æ–°çš„ä¸€è¡Œï¼Œåƒè¿™æ ·ï¼š<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note danger %&#125;</span><br><span class="line">note text, note text, note text</span><br><span class="line">note text, note text, note text</span><br><span class="line">note text, note text, note text</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
          </div>
<h3>æ ·ä¾‹</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note %&#125;</span><br><span class="line">#### Header</span><br><span class="line">(without define class style)</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note ">
            <h4>Header</h4><p>(without define class style)</p>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note default %&#125;</span><br><span class="line">#### Default Header</span><br><span class="line">Welcome to [Hexo!](https:&#x2F;&#x2F;hexo.io)</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note default">
            <h4>Default Header</h4><p>Welcome to <a href="https://hexo.io" target="_blank" rel="noopener">Hexo!</a></p>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note primary %&#125;</span><br><span class="line">#### Primary Header</span><br><span class="line">**Welcome** to [Hexo!](https:&#x2F;&#x2F;hexo.io)</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note primary">
            <h4>Primary Header</h4><p><strong>Welcome</strong> to <a href="https://hexo.io" target="_blank" rel="noopener">Hexo!</a></p>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note info %&#125;</span><br><span class="line">#### Info Header</span><br><span class="line">**Welcome** to [Hexo!](https:&#x2F;&#x2F;hexo.io)</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note info">
            <h4>Info Header</h4><p><strong>Welcome</strong> to <a href="https://hexo.io" target="_blank" rel="noopener">Hexo!</a></p>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note success %&#125;</span><br><span class="line">#### Success Header</span><br><span class="line">**Welcome** to [Hexo!](https:&#x2F;&#x2F;hexo.io)</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note success">
            <h4>Success Header</h4><p><strong>Welcome</strong> to <a href="https://hexo.io" target="_blank" rel="noopener">Hexo!</a></p>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note warning %&#125;</span><br><span class="line">#### Warning Header</span><br><span class="line">**Welcome** to [Hexo!](https:&#x2F;&#x2F;hexo.io)</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note warning">
            <h4>Warning Header</h4><p><strong>Welcome</strong> to <a href="https://hexo.io" target="_blank" rel="noopener">Hexo!</a></p>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note danger %&#125;</span><br><span class="line">#### Danger Header</span><br><span class="line">**Welcome** to [Hexo!](https:&#x2F;&#x2F;hexo.io)</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note danger">
            <h4>Danger Header</h4><p><strong>Welcome</strong> to <a href="https://hexo.io" target="_blank" rel="noopener">Hexo!</a></p>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note info no-icon %&#125;</span><br><span class="line">#### No icon note</span><br><span class="line">Note **without** icon: &#96;note info no-icon&#96;</span><br><span class="line"></span><br><span class="line">note info, note info, note info</span><br><span class="line">note info, note info, note info</span><br><span class="line">note info, note info, note info</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note info no-icon">
            <h4>No icon note</h4><p>Note <strong>without</strong> icon: <code>note info no-icon</code></p><p>note info, note info, note info<br />note info, note info, note info<br />note info, note info, note info</p>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note success %&#125;</span><br><span class="line">#### Codeblock in note</span><br><span class="line">&#123;% code %&#125;</span><br><span class="line">code block in note tag</span><br><span class="line">code block in note tag</span><br><span class="line">code block in note tag</span><br><span class="line">&#123;% endcode %&#125;</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note success">
            <h4>Codeblock in note</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">code block in note tag</span><br><span class="line">code block in note tag</span><br><span class="line">code block in note tag</span><br></pre></td></tr></table></figure>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note default %&#125;</span><br><span class="line">#### Lists in note</span><br><span class="line">* ul</span><br><span class="line">* ul</span><br><span class="line">  * ul</span><br><span class="line">  * ul</span><br><span class="line">* ul</span><br><span class="line"></span><br><span class="line">1. ol</span><br><span class="line">2. ol</span><br><span class="line">  1. ol</span><br><span class="line">  2. ol</span><br><span class="line">3. ol</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note default">
            <h4>Lists in note</h4><ul><li>ul</li><li>ul<ul><li>ul</li><li>ul</li></ul></li><li>ul</li></ul><ol><li>ol</li><li>ol</li><li>ol</li><li>ol</li><li>ol</li></ol>
          </div>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% note default %&#125;</span><br><span class="line">#### Table in Note</span><br><span class="line">| 1 | 2 |</span><br><span class="line">| - | - |</span><br><span class="line">| 3 | 4 |</span><br><span class="line">| 5 | 6 |</span><br><span class="line">| 7 | 8 |</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>
<div class="note default">
            <h4>Table in Note</h4><table><thead><tr><th>1</th><th>2</th></tr></thead><tbody><tr><td>3</td><td>4</td></tr><tr><td>5</td><td>6</td></tr><tr><td>7</td><td>8</td></tr></tbody></table>
          </div>
]]></content>
      <categories>
        <category>ç¬”è®°</category>
      </categories>
      <tags>
        <tag>next</tag>
        <tag>tag</tag>
        <tag>plugins</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»npmåˆ°yarn</title>
    <url>/post/%E4%BB%8Enpm%E5%88%B0yarn/</url>
    <content><![CDATA[<p>ç”±äºnpmçš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥æƒ³è¯•è¯•æ¯”è¾ƒç«çš„yarnï¼Œæœ¬ç¯‡è®°å½•ä»npmåˆ°yarnçš„è¿ç§»ã€‚</p>
<a id="more"></a>
<h1>å®‰è£…</h1>
<p>å»<a href="https://legacy.yarnpkg.com/lang/zh-hans/" target="_blank" rel="noopener">yarnå®˜ç½‘</a>æŸ¥çœ‹å®‰è£…æ–¹æ³•ï¼Œwindowsä¸‹å¯ä»¥ç›´æ¥ä¸‹è½½å®‰è£…åŒ…ã€‚</p>
<div class="note danger no-icon">
            <p><strong>æ³¨æ„ï¼š</strong> ä¸€å®šè¦ä¸Šå®˜ç½‘ï¼Œä¸è¦ä¸Š<code>https://yarn.bootcss.com</code>è¿™ä¸ªç½‘ç«™ï¼Œåœ¨è¿™ä¸ªç½‘ç«™ä¸‹è½½ä¸äº†ã€‚</p>
          </div>
<h1>å‘½ä»¤</h1>
<p>å¤§ä½“å’Œnpmå‘½ä»¤ç›¸åŒï¼Œä¸‹é¢å¤§æ¦‚åˆ—ä¸€ä¸ªè¡¨æ ¼ï¼š</p>
<table>
<thead>
<tr>
<th>npmå‘½ä»¤</th>
<th>yarnå‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>npm install</td>
<td>yarnæˆ–yarn install</td>
<td>å®‰è£…å…¨éƒ¨ä¾èµ–</td>
</tr>
<tr>
<td>npm install xx</td>
<td>yarn add xx</td>
<td>æ·»åŠ è¿è¡Œæ—¶ä¾èµ–åŒ…xx</td>
</tr>
<tr>
<td>npm install xx --save-dev</td>
<td>yarn add --dev</td>
<td>æ·»åŠ å¼€å‘æ—¶ä¾èµ–åŒ…xx</td>
</tr>
<tr>
<td>npm init</td>
<td>yarn init</td>
<td>åˆå§‹åŒ–ä¸€ä¸ªæ–°é¡¹ç›®</td>
</tr>
<tr>
<td>npm uninstall xx</td>
<td>yarn remove xx</td>
<td>åˆ é™¤ä¾èµ–é¡¹</td>
</tr>
<tr>
<td>npm update xx</td>
<td>yarn upgrade xx</td>
<td>å‡çº§ä¾èµ–é¡¹</td>
</tr>
<tr>
<td>npm run dev</td>
<td>yarn run devæˆ–yarn dev</td>
<td>è¿è¡Œä¸€ä¸ªå®šä¹‰å¥½çš„åŒ…è„šæœ¬</td>
</tr>
<tr>
<td>-g</td>
<td>global</td>
<td>å…¨å±€å®‰è£…ä½¿ç”¨çš„å‚æ•°</td>
</tr>
</tbody>
</table>
<h1>è¿ç§»</h1>
<ol>
<li>åˆ é™¤é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„<code>package-lock.json</code>æ–‡ä»¶ï¼Œè¿è¡Œ<code>yarn</code>åä¼šç”Ÿæˆ<code>yarn.lock</code>æ–‡ä»¶ä»£æ›¿</li>
<li>åˆ é™¤<code>node_modules</code>ç›®å½•ä¸‹çš„æ‰€æœ‰åŸæ¥ç”¨<code>npm</code>å®‰è£…çš„æ–‡ä»¶</li>
<li>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>å®‰è£…å®Œæˆåï¼Œå¦‚æœéœ€è¦å¯åŠ¨é¡¹ç›®ï¼ŒæŠŠ<code>npm run xxx</code>å‘½ä»¤æ”¹æˆ<code>yarn xxx</code>å‘½ä»¤å†æ‰§è¡Œå³å¯</li>
</ol>
]]></content>
      <categories>
        <category>è®°å½•</category>
      </categories>
      <tags>
        <tag>npm</tag>
        <tag>yarn</tag>
        <tag>è¿ç§»</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo-renderer-markdown-ité‡Œçš„æ’ä»¶ä½¿ç”¨</title>
    <url>/post/hexo-renderer-markdown-it%E9%87%8C%E7%9A%84%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p><code>hexo-renderer-markdown-it</code> é»˜è®¤é›†æˆ5ä¸ª <code>markdown-it</code> æ’ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Markdown-it config</span></span><br><span class="line">markdown:</span><br><span class="line">  plugins:</span><br><span class="line">    - markdown-it-abbr</span><br><span class="line">    - markdown-it-footnote</span><br><span class="line">    - markdown-it-ins</span><br><span class="line">    - markdown-it-sub</span><br><span class="line">    - markdown-it-sup</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<ul>
<li>markdown-it-abbrï¼šç¼©å†™æ’ä»¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*[HTML]: Hyper Text Markup Language</span><br><span class="line">*[W3C]:  World Wide Web Consortium</span><br><span class="line"></span><br><span class="line">The HTML specification</span><br><span class="line">is maintained by the W3C.</span><br></pre></td></tr></table></figure>
<ul>
<li>markdown-it-footnoteï¼šè„šæ³¨æ’ä»¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">basic footnote[^1]</span><br><span class="line">and another one[^3]</span><br><span class="line">and another one[^4]</span><br><span class="line"></span><br><span class="line">[^1]: basic footnote content</span><br><span class="line">[^3]: paragraph</span><br><span class="line">[^4]: footnote content with some [markdown](https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Markdown)</span><br></pre></td></tr></table></figure>
<ul>
<li>markdown-it-insï¼šæ’å…¥æ’ä»¶ï¼ˆä¸‹åˆ’çº¿æ’ä»¶ï¼‰</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">++inserted++ =&gt; <span class="xml"><span class="tag">&lt;<span class="name">ins</span>&gt;</span>inserted<span class="tag">&lt;/<span class="name">ins</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>markdown-it-subï¼šä¸‹æ ‡æ’ä»¶</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">H~2~0 =&gt; H<span class="tag">&lt;<span class="name">sub</span>&gt;</span>2<span class="tag">&lt;/<span class="name">sub</span>&gt;</span>O</span><br></pre></td></tr></table></figure>
<ul>
<li>markdown-it-supï¼šä¸Šæ ‡æ’ä»¶</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">29^th^ =&gt; 29<span class="tag">&lt;<span class="name">sup</span>&gt;</span>th<span class="tag">&lt;/<span class="name">sup</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>markdown-it-markï¼šé«˜äº®æ’ä»¶ï¼ˆéœ€è¦è‡ªå·±ä¸‹è½½ï¼‰</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x3D;&#x3D;marked&#x3D;&#x3D;&#96; &#x3D;&gt; &#96;inserted</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>è®°å½•</category>
      </categories>
      <tags>
        <tag>markdown</tag>
        <tag>æ’ä»¶</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸€ä¸ªå¿«é€Ÿç”ŸæˆéŸ³ä¹å¤–é“¾çš„æ–¹æ³•</title>
    <url>/post/%E4%B8%80%E4%B8%AA%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E9%9F%B3%E4%B9%90%E5%A4%96%E9%93%BE%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>åƒå›¾ç‰‡å¯ä»¥ç”¨SM.MSæˆ–è…¾è®¯äº‘æåˆ°å›¾ç‰‡å¤–é“¾ä¸€æ ·ï¼ŒéŸ³ä¹å…¶å®ä¹Ÿå¯ä»¥é€šè¿‡ç½‘æ˜“äº‘éŸ³ä¹ç½‘é¡µç‰ˆå¿«é€Ÿçš„æåˆ°å¤–é“¾çš„ ã€‚</p>
<a id="more"></a>
<ol>
<li>é¦–å…ˆåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€<a href="https://music.163.com/" target="_blank" rel="noopener">ç½‘æ˜“äº‘éŸ³ä¹</a>ã€‚</li>
<li>æœç´¢æƒ³è¦æçš„éŸ³ä¹ï¼Œä»¥sunflower feelingsä¸ºä¾‹</li>
<li>æŠŠé“¾æ¥å¤åˆ¶ä¸‹æ¥ï¼š<code>https://music.163.com/#/song?id=520458166</code>ï¼Œç„¶åæŠŠidåé¢çš„è¿™ä¸€ä¸²æ•°å­—å¤åˆ¶ä¸€ä¸‹ã€‚</li>
<li>å¤–é“¾çš„æ¨¡æ¿æ˜¯ï¼š<code>https://music.163.com/song/media/outer/url?id=XXXXX.mp3</code>ï¼Œå°†XXXXXæ›¿æ¢ä¸ºåˆšåˆšå¤åˆ¶çš„é‚£ä¸²æ•°å­—å³å¯ã€‚</li>
<li>ç»„åˆåœ¨ä¸€èµ·å°±æ˜¯<code>https://music.163.com/song/media/outer/url?id=520458166.mp3</code>ï¼Œè¿™æ ·ä¸€ä¸ªéŸ³ä¹é“¾æ¥å°±å®Œæˆäº†ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>è®°å½•</category>
      </categories>
      <tags>
        <tag>å¤–é“¾</tag>
        <tag>éŸ³ä¹</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨LeanCloudæ— æ³•æ˜¾ç¤ºæ•°é‡</title>
    <url>/post/%E4%BD%BF%E7%94%A8LeanCloud%E7%BB%9F%E8%AE%A1%E4%B8%8D%E6%98%BE%E7%A4%BA%E6%95%B0%E5%AD%97(%E5%B7%B2%E8%A7%A3%E5%86%B3)/</url>
    <content><![CDATA[<h2>å…·ä½“é—®é¢˜</h2>
<p>åœ¨æ ¹æ®æ–‡æ¡£é…ç½®å¥½LeanCloudå¹¶å®Œæˆéƒ¨ç½²ä¹‹åï¼Œåˆ·æ–°åšå®¢ç½‘é¡µï¼Œåœ¨ä¸»é¡µçœ‹åˆ°æ¯ç¯‡æ–‡ç« çš„é˜…è¯»æ¬¡æ•°è¦ä¹ˆæ˜¾ç¤ºä¸º0ï¼Œè¦ä¹ˆå°±æ²¡æœ‰æ•°å­—åªæœ‰ä¸€ä¸ªçœ¼ç›å›¾æ ‡ï¼Œè€Œæ‰“å¼€æ¯ç¯‡æ–‡ç« çš„ç›¸åº”é¡µé¢æ›´æ˜¯å‘ç°é”™è¯¯ä¿¡æ¯ï¼š<code>Counter not initialized! More info at console err msg.</code>ã€‚<a id="more"></a></p>
<div class="note default no-icon">
            <p><s>ç›®å‰è¿™ä¸ªé—®é¢˜è²Œä¼¼æ— è§£ï¼Œç½‘ä¸Šæ‰¾åˆ°çš„æ‰€æœ‰æ–¹æ³•éƒ½è¯•äº†è¿˜æ˜¯æ²¡æœ‰è§£å†³</s><br />ä¸€å®šè¦æŠŠWebå®‰å…¨åŸŸåå¡«æ­£ç¡®ï¼Œå¡«å®Œä¿å­˜ä¹‹åå¯èƒ½éœ€è¦ç­‰å¾…å‡ åˆ†é’Ÿåˆ°åå‡ åˆ†é’Ÿä¹‹åæ‰ä¼šå¼€å§‹æ˜¾ç¤º</p>
          </div>
<h2>ä¸‹é¢åˆ—å‡ºä¸€äº›åœ¨ç½‘ä¸Šæ‰¾çš„è§£å†³æ–¹æ¡ˆ</h2>
<ul>
<li>å®‰è£…æ’ä»¶<code>hexo-leancloud-counter-security</code>
<ul>
<li>æ‰§è¡Œå‘½ä»¤<code>npm install hexo-leancloud-counter-security</code></li>
</ul>
</li>
<li>å°†ä¸»é¢˜é…ç½®æ–‡ä»¶<code>_config.yml</code>ä¸­çš„<code>leancloud_visitors.security</code>è®¾ç½®æˆ<code>false</code></li>
</ul>
<div class="note danger no-icon">
            <p><strong>æ³¨ï¼š</strong> åŸæ–‡æ¡£ä¸­å»ºè®®çš„æ˜¯ä¸¤ç§æ–¹æ³•ï¼š1) ä½¿ç”¨<code>hexo-leancloud-counter-security</code>æ’ä»¶ï¼›2) è®¾ç½®<code>leancloud_visitors.security = false</code>å‡å¯ã€‚<br />ä½†è€ƒè™‘åˆ°ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­å…³äºå®‰å…¨æ€§çš„æé†’ï¼Œæˆ‘æ˜¯æŒ‰æ­¥éª¤åˆ†åˆ«å®Œæˆäº†è¿™ä¸¤æ­¥ã€‚å¹¶ä¸”åªå®‰è£…<code>hexo-leancloud-counter-security</code>æ’ä»¶ä¾ç„¶ä¸èƒ½è§£å†³æŠ¥é”™é—®é¢˜ï¼Œå¯èƒ½çœŸæ­£ç”Ÿæ•ˆçš„æ˜¯â€œå°†<code>security</code>ç½®ä¸º<code>false</code>è¿™ä¸€æ­¥ã€‚<br />ä½†å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œå»ºè®®å¤§å®¶ä¹ŸåŒæ—¶å®‰è£…<code>hexo-leancloud-counter-security</code>æ’ä»¶ã€‚</p>
          </div>]]></content>
      <categories>
        <category>è®°å½•</category>
        <category>é—®é¢˜</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>leancloud</tag>
      </tags>
  </entry>
  <entry>
    <title>ç»™æ–‡ç« æ·»åŠ ç½®é¡¶</title>
    <url>/post/%E7%BB%99%E6%96%87%E7%AB%A0%E6%B7%BB%E5%8A%A0%E7%BD%AE%E9%A1%B6/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ç»™nextä¸»é¢˜ä¸‹æ–‡ç« æ·»åŠ ç½®é¡¶åŠŸèƒ½çš„æ•™ç¨‹ã€‚</p>
<a id="more"></a>
<h1>å®‰è£…æ’ä»¶</h1>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm uninstall hexo-generator-index --save</span><br><span class="line">npm install hexo-generator-index-pin-top --save</span><br></pre></td></tr></table></figure>
<h1>ä¿®æ”¹æ–‡ç« æ¨¡æ¿</h1>
<p>æ‰“å¼€<code>~/scaffolds/post.md</code>ï¼Œåœ¨<code>Front-matter</code>é‡Œæœ€åº•ä¸‹æ·»åŠ <code>top: false</code>ï¼Œè¿™æ ·æ¯æ¬¡ç”Ÿæˆçš„postæ–‡ä»¶éƒ½è‡ªå¸¦ç”±<code>top:</code>è¿™ä¸ªå‚æ•°é¡¹äº†ï¼Œéœ€è¦ç½®é¡¶çš„æ—¶å€™å°±æŠŠ<code>false</code>æ”¹ä¸º<code>true</code>å°±è¡Œäº†ã€‚</p>
<h1>è®¾ç½®ç½®é¡¶çš„æ ·å¼</h1>
<p>æ‰“å¼€<code>~/themes/next/layout/_macro/</code>é‡Œçš„<code>post.swig</code>æ–‡ä»¶ï¼Œå®šä½åˆ°<code>&lt;div class=&quot;post-meta&quot;&gt;</code>åœ¨ä¸‹é¢æ’å…¥ä»£ç ï¼š</p>
<figure class="highlight plain"><figcaption><span>post.swig</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;% if post.top %&#125;</span><br><span class="line">     &lt;i class&#x3D;&quot;fa fa-thumb-tack&quot;&gt;&lt;&#x2F;i&gt;</span><br><span class="line">     &lt;font color&#x3D;7D26CD&gt;ç½®é¡¶&lt;&#x2F;font&gt;</span><br><span class="line">     &lt;span class&#x3D;&quot;post-meta-divider&quot;&gt;|&lt;&#x2F;span&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>color</code>æ˜¯è°ƒæ•´æ–‡å­—é¢œè‰²çš„å±æ€§ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹æƒ³è¦çš„é¢œè‰²ã€‚</p>
]]></content>
      <categories>
        <category>ç¾åŒ–</category>
      </categories>
      <tags>
        <tag>next</tag>
        <tag>ç¾åŒ–</tag>
        <tag>ç½®é¡¶</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”¨Hexoå’ŒNextä¸»é¢˜æ­å»ºä¸ªäººåšå®¢</title>
    <url>/post/%E7%94%A8Hexo%E5%92%8CNext%E4%B8%BB%E9%A2%98%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<div class="note info">
            <p><strong>æœ¬ç¯‡è½¬è½½ï¼Œ</strong><a href="http://dugblog.coding.me/Hexo/20180616-build-blog-hexo-next-windows.html#HexoEditor%E5%AE%89%E8%A3%85" target="_blank" rel="noopener">åŸæ–‡åœ°å€</a></p>
          </div>
<h1>å‰è¨€</h1>
<p>å¤„å¥³åšæ–‡ï¼Œå°±å†™ä¸€ä¸‹è¿™ä¸ªä¸ªäººBlogæ˜¯å¦‚ä½•æ­å»ºèµ·æ¥çš„å§ã€‚æœ¬æ–‡åªè®²è§£åœ¨Windowsç¯å¢ƒä¸‹å¦‚ä½•æ­å»ºã€‚<br />
è¯´èµ·æ¥æƒ³è¦æ­å»ºè¿™æ ·ä¸€ä¸ªBlogè¿˜æ˜¯å› ä¸ºæˆ‘ç‰¹åˆ«å–œæ¬¢è¿™ä¸ªä¸»é¢˜ <strong><em>Next</em></strong>ï¼Œæ‰€ä»¥ç´¢æ€§å°±è‡ªå·±æ­ä¸€ä¸ªå•¦ã€‚</p>
<hr />
<a id="more"></a>
<h1>éœ€è¦å‡†å¤‡çš„ä¸œè¥¿</h1>
<ul>
<li>Node.jsï¼ˆç‚¹å‡»å¯è¿›å…¥ä¸‹è½½é¡µé¢ï¼Œä¸¤ä¸ªç‰ˆæœ¬éƒ½è¡Œï¼Œæˆ‘é€‰çš„æœ€æ–°çš„ç‰ˆæœ¬ï¼‰</li>
<li>Gitï¼ˆç‚¹å‡»è¿›å»ç›´æ¥ä¸‹è½½ï¼Œé™„èµ ä¸€ä¸ªGit å®‰è£…æ•™ç¨‹ï¼‰<br />
Hexo å®˜æ–¹ä½¿ç”¨æ–‡æ¡£ï¼ˆæœ‰ä»€ä¹ˆæ›´è¯¦ç»†çš„æƒ³äº†è§£å¯ä»¥ä¸Šå®˜ç½‘ï¼Œå³ä¸Šè§’å¯ä»¥é€‰ä¸­æ–‡ï¼‰</li>
<li>Next ä¸»é¢˜å®˜ç½‘ï¼ˆå®˜ç½‘ä¸Šæœ‰å¾ˆå¤šè¯¦ç»†çš„é…ç½®è¯´æ˜å’Œè®¾å®šæ•™ç¨‹ï¼‰<br />
HexoEditorï¼ˆç”¨äºç¼–å†™Markdown æ–‡ç« çš„è½¯ä»¶ï¼Œé…åˆHexoé£Ÿç”¨ï¼‰</li>
<li>Notepad++ï¼ˆWindowsä¸‹è®°äº‹æœ¬çš„æ›¿ä»£å“ï¼Œå› ä¸ºè®°äº‹æœ¬ä¿å­˜çš„æ—¶å€™ä¼šåœ¨æ¯ä¸€è¡Œçš„å¼€å¤´è¿˜æ˜¯ç»“å°¾åŠ ä¸€ä¸ªä»€ä¹ˆæ ‡è®°ï¼Œä¼šå¯¼è‡´æœ‰äº›æ–‡ä»¶ç”¨è®°äº‹æœ¬æ‰“å¼€ä¹‹åå†ä¿å­˜ä¼šå‡ºé—®é¢˜ï¼‰</li>
<li>Git Bash ç›¸å…³çš„ä¸€ç‚¹ç‚¹å°çŸ¥è¯†ï¼Œå’Œå‘½ä»¤è¡Œä½¿ç”¨æ–¹æ³•ä¸€æ ·ã€‚ï¼ˆè¿™ä¸ªæˆ‘å†™åœ¨æœ€åé¢ï¼Œå¦‚æœä¸ä¼šçš„è¯è¯·çœ‹ä¸€çœ‹ï¼‰</li>
</ul>
<div class="note info">
            <p>å¦‚æœä»¥ä¸‹æ­¥éª¤å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Œæ¬¢è¿ç•™è¨€ï¼Œç•™è¨€æ—¶è¯·å¡«ä¸Šé‚®ç®±ï¼Œä½ å°±å¯ä»¥æ”¶åˆ°æˆ‘çš„å›å¤äº†ã€‚<br />PSï¼šé‚®ä»¶å›å¤å¯èƒ½ä¼šè¢«æ”¶è¿›åƒåœ¾ç®±ï¼Œè¯·æ³¨æ„ã€‚</p>
          </div>
<hr />
<h1>å¼€å§‹æ­å»º</h1>
<h2>å®‰è£…ä¾èµ–</h2>
<p>æ‰€è°“çš„ä¾èµ–å°±æ˜¯æ­å»ºåšå®¢éœ€è¦çš„ä¸€äº›åŸºå±‚çš„è½¯ä»¶ï¼ŒåŒ…æ‹¬Node.jså’ŒGitï¼Œè¿™ä¸¤ä¸ªä¸œè¥¿åœ¨ä¸Šé¢å·²ç»ç»™å‡ºäº†ä¸‹è½½é“¾æ¥ï¼Œå®‰è£…çš„è¯å¯¹äºWindowsç”¨æˆ·åº”è¯¥ä¸ç®—éš¾é¢˜å§ã€‚</p>
<h2>å®‰è£…Hexo</h2>
<p>å®‰è£…å¥½Gitä¹‹åï¼Œä»»æ„ç©ºç™½å¤„é¼ æ ‡å³é”®ï¼Œä¼šå‡ºç°<code>Git Bash Here</code>ã€‚ç‚¹å‡»<code>Git Bash Here</code>ä¼šå‡ºç°<code>Git Bash</code>å¯¹è¯æ¡†ã€‚<br />
æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç”¨äºä¿å­˜Hexoç”Ÿæˆçš„åšå®¢å†…å®¹ã€‚ï¼ˆå°†è¿™ä¸ªæ–‡ä»¶å¤¹æˆä¸ºHexoæ–‡ä»¶å¤¹ï¼‰ç„¶åè¿›å…¥è¯¥æ–‡ä»¶å¤¹ï¼Œç©ºç™½å¤„å³é”®ï¼Œç‚¹å‡»<code>Git Bash Here</code>ï¼Œè¾“å…¥å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œç»§ç»­è¾“å…¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo init &lt;folder&gt;</span><br></pre></td></tr></table></figure>
<p><code>&lt;folder&gt;</code>ä»£è¡¨çš„æ˜¯ä¿å­˜ç›®å½•ï¼Œå¦‚æœä¸å¡«ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”ŸæˆHexoæ¡†æ¶æ‰€éœ€è¦çš„æ–‡ä»¶ä»¶ã€‚<br />
å‘½ä»¤æ‰§è¡Œå®Œæˆåï¼Œæ–‡ä»¶å¤¹ä¸‹çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ _config.yml</span><br><span class="line">â”œâ”€â”€ package.json</span><br><span class="line">â”œâ”€â”€ scaffolds</span><br><span class="line">â”œâ”€â”€ source</span><br><span class="line">|   â”œâ”€â”€ _drafts</span><br><span class="line">|   â””â”€â”€ _posts</span><br><span class="line">â””â”€â”€ themes</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>_config.yml</code>ä¸ºé…ç½®æ–‡ä»¶ï¼Œåé¢ä¼šç”¨åˆ°ã€‚<br />
éªŒè¯ä¸€ä¸‹æ˜¯å¦å®‰è£…æˆåŠŸï¼Œåœ¨åˆšåˆšçš„<code>Git Bash</code>å¯¹è¯æ¡†ä¸­è¾“å…¥å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo g</span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…å®Œæˆåå†è¾“å…¥å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥<code>localhost:4000</code>ã€‚å¦‚æœæˆåŠŸçœ‹è§åšå®¢å°±è¯æ˜å®‰è£…æˆåŠŸã€‚<br />
æˆåŠŸååœ¨åˆšåˆšçš„<code>Git Bash</code>å¯¹è¯æ¡†ä¸­æŒ‰ä¸‹<code>Ctrl+C</code>åœæ­¢æœåŠ¡ã€‚</p>
<h2>å®‰è£…Nextä¸»é¢˜</h2>
<p>è¿›å…¥Hexoæ–‡ä»¶å¤¹ï¼ˆä¸Šæ–‡æåˆ°è¿‡ï¼Œè¿™ä¸ªç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°ä¸€ä¸ªthemesæ–‡ä»¶å¤¹ï¼‰ï¼Œåœ¨Hexoæ–‡ä»¶å¤¹ç©ºç™½å¤„å³é”®æ‰“å¼€<code>Git Bash Here</code>ï¼Œè¾“å…¥å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;theme-next&#x2F;hexo-theme-next themes&#x2F;next</span><br></pre></td></tr></table></figure>
<p>æ²¡æœ‰æŠ¥é”™ï¼ˆçº¢è‰²çš„erï¼‰ï¼Œå°±è¯æ˜å·²ç»å®‰è£…å¥½äº†Nextä¸»é¢˜ã€‚</p>
<h2>å°†Hexoçš„ä¸»é¢˜æ›´æ”¹ä¸ºNextä¸»é¢˜</h2>
<p>åœ¨Hexoæ–‡ä»¶å¤¹ä¸‹é¢å¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>_config.yml</code>æ–‡ä»¶ï¼Œå³é”®ç”¨Notepad<ins>æ‰“å¼€ï¼ˆç”¨è®°äº‹æœ¬æ‰“å¼€ä¸çŸ¥é“ä¼šä¸ä¼šå‡ºé—®é¢˜ï¼Œå»ºè®®ç”¨Notepad</ins>ï¼‰ï¼Œé ä¸‹é¢çš„ä½ç½®å¯»æ‰¾</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">theme: landscape</span><br></pre></td></tr></table></figure>
<p>å°†é‡Œé¢çš„landscapeæ”¹æˆnext</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">theme: next</span><br></pre></td></tr></table></figure>
<p>ç„¶åå’ŒHexoé‡Œé¢éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸä¸€æ ·çš„æ­¥éª¤ï¼Œå¯ä»¥æ£€éªŒä¸»é¢˜æ˜¯å¦æ›´æ”¹æˆåŠŸã€‚<br />
åœ¨Hexoæ–‡ä»¶å¤¹é‡Œé¢æ‰“å¼€<code>Git Bash</code>å¯¹è¯æ¡†ï¼Œè¾“å…¥å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo clean -g</span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…å®Œæˆåå†è¾“å…¥å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥<code>localhost:4000</code>ã€‚å¦‚æœæˆåŠŸçœ‹åˆ°ä¸»é¢˜æ›´æ”¹äº†ï¼Œè®°å¾—åœ¨åˆšåˆšçš„<code>Git Bash</code>å¯¹è¯æ¡†ä¸­æŒ‰ä¸‹<code>Ctrl+C</code>åœæ­¢æœåŠ¡ã€‚</p>
<hr />
<h1>éƒ¨ç½²Hexo</h1>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°æ˜¾ç¤ºè‡ªå·±åšå®¢äº†ï¼Œå¯æ˜¯åˆ›å»ºåšå®¢å°±æ˜¯ç»™äººçœ‹çš„å‘€ï¼Œé‚£æ¥ä¸‹æ¥å°±æŠŠæˆ‘ä»¬çš„åšå®¢éƒ¨ç½²åˆ°ç½‘ä¸Šã€‚åœ¨æ²¡æœ‰è‡ªå·±çš„æœåŠ¡å™¨çš„æƒ…å†µä¸‹ï¼Œå¤§è‡´çš„é€‰æ‹©æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>éƒ¨ç½²åˆ°GitHubä¸Š</li>
<li>éƒ¨ç½²åˆ°Codingä¸Š</li>
</ul>
<div class="note primary">
            <p>å› ä¸ºGitHubä¸è®©ç™¾åº¦çˆ¬è™«ï¼Œå½±å“ç™¾åº¦æ”¶å½•ï¼Œç„¶åæœåŠ¡å™¨åœ¨å›½å¤–ï¼Œé€Ÿåº¦ä¹Ÿæ…¢ï¼Œæ‰€ä»¥æ¨èCodingã€‚</p>
          </div>
<p>é¦–å…ˆå½“ç„¶æ˜¯å¾—æ‹¥æœ‰ä¸€ä¸ªCodingè´¦å·å•¦~ï¼Œ<a href="https://coding.net/" target="_blank" rel="noopener">ç‚¹å‡»æˆ‘æ³¨å†Œ</a>ã€‚</p>
<div class="note danger">
            <p>ç”¨æˆ·åä¸€å®šä¸è¦æœ‰å¥‡å¥‡æ€ªæ€ªçš„ç¬¦å·ï¼ç‰¹åˆ«æ˜¯ä¸‹åˆ’çº¿ï¼å½±å“æ”¶å½•ï¼æ‰€ä»¥æœ€å¥½ä¸è¦ç¬¦å·ï¼</p>
          </div>
<p>æ³¨å†Œç™»å½•ä¹‹åï¼Œå³ä¸Šè§’åŠ å·ç‚¹å‡»é¡¹ç›®ï¼Œæ–°å»ºä¸€ä¸ªé¡¹ç›®</p>
<div align="center"><img src="https://i.loli.net/2020/01/23/ocbtN6BKskSHuUR.png"/></div>
é¡¹ç›®åç§°ä¸€å®šè¦ç”¨`[ä½ çš„ç”¨æˆ·å].coding.me`ï¼Œæ¯”å¦‚ç”¨ç”¨æˆ·åä¸º`dugblog`ï¼Œé¡¹ç›®åå°±å¡«`dugblog.coding.me`ã€‚
<div align=center><img src="https://i.loli.net/2020/01/23/MlgUSxkLn7dK4pD.png"/></div>
æ–°å»ºå¥½äº†ä¹‹åï¼Œä¼šè¿›å…¥é¡¹ç›®é¡µé¢ï¼Œç‚¹å‡»å·¦ä¾§ä»£ç ->PagesæœåŠ¡
<div align=center><img src="https://i.loli.net/2020/01/23/V7b9ZSfW1dUQJzF.png"/></div>
åœ¨éƒ¨ç½²æ¥æºé‡Œé¢é€‰æ‹©masteråˆ†æ”¯ï¼Œä¿å­˜
<div align=center><img src="https://i.loli.net/2020/01/23/SwK1459zvxIF8Gq.png"/></div>
ä¿å­˜å¥½äº†ä¹‹åï¼Œä¼šå‡ºç°è¿™æ ·çš„æç¤º
<div align=center><img src="https://i.loli.net/2020/01/23/ISQv1ZT3RfmcqYz.png"/></div>
<div class="note warning">
            <p>ä¸Šå›¾æ¡†å‡ºæ¥çš„åœ°å€ï¼Œå°±æ˜¯ä½ çš„åšå®¢åœ°å€ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªä¸€çº§ç›®å½•ï¼Œå¦‚æœä½ çš„æœ€åè¿˜æœ‰ä¸€ä¸ªæ–œæ ç„¶åä¸€ä¸²åç§°ï¼ˆä¾‹å¦‚ï¼š<code>http://DugBlog.coding.me/abcd</code>ï¼‰ï¼Œè¯·æ£€æŸ¥é¡¹ç›®åç§°æ˜¯å¦å¡«å¯¹ã€‚</p>
          </div>
ç„¶ååœ¨å·¦ä¾§å¯ä»¥æ‰¾åˆ°è¿™ä¸ª
<div align=center><img src="https://i.loli.net/2020/01/23/IHMa3ibhpwsUuvz.png"/></div>
å¤åˆ¶ä¸‹æ¥ï¼Œæ‰“å¼€ç«™ç‚¹é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯`/yoursite/_config.yml`ï¼Œå’Œ`source`å¹³çº§ç›®å½•ä¸‹çš„é‚£ä¸ªã€‚æ‰¾åˆ°`deploy`ï¼Œæ›´æ”¹é‡Œé¢çš„é…ç½®ï¼š
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git # å¿…é¡»å¡«git</span><br><span class="line">  repo: # https:&#x2F;&#x2F;ç”¨æˆ·å:å¯†ç @åˆšåˆšå¤åˆ¶çš„é“¾æ¥å»æ‰https:&#x2F;&#x2F;</span><br><span class="line">  # repoç¤ºä¾‹ https:&#x2F;&#x2F;myblog:123456@git.coding.net&#x2F;myblog&#x2F;myblog.coding.me.git</span><br><span class="line">  branch: master # åˆšåˆšé€‰æ‹©çš„åˆ†æ”¯ï¼Œä¸æ‡‚å°±å¡«è¿™ä¸ª</span><br><span class="line">  message: blog update # æ¯æ¬¡æ›´æ–°æ—¶æäº¤çš„å¤‡æ³¨</span><br></pre></td></tr></table></figure>
  å¡«å¥½ä¿å­˜å¥½ï¼Œåœ¨Hexoæ ¹ç›®å½•ä¸‹æ‰“å¼€Git Bashï¼Œå…ˆåæ‰§è¡Œå‘½ä»¤ï¼š
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g -d</span><br></pre></td></tr></table></figure>
å†å›åˆ°åˆšåˆšçš„PagesæœåŠ¡é¡µé¢ï¼Œç‚¹å¼€è‡ªå·±çš„åšå®¢åœ°å€ï¼Œå°±åº”è¯¥å¯ä»¥çœ‹åˆ°ä½ çš„åšå®¢äº†ã€‚
<hr />
<h1>HexoEditorå®‰è£…</h1>
<p>é¦–å…ˆæ‰¾ä¸€ä¸ªåœ°æ–¹ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ç”¨æ¥æ”¾HexoEditorçš„æ–‡ä»¶ã€‚è¿›å…¥æ–‡ä»¶å¤¹ï¼Œå³é”®æ‰“å¼€<code>Git Bash</code>å¯¹è¯æ¡†ï¼Œä¾æ¬¡è¾“å…¥ä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm config set registry &quot;https:&#x2F;&#x2F;registry.npm.taobao.org&#x2F;&quot;</span><br><span class="line">npm config set electron_mirror &quot;https:&#x2F;&#x2F;npm.taobao.org&#x2F;mirrors&#x2F;electron&#x2F;&quot;</span><br><span class="line"></span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;zhuzhuyule&#x2F;HexoEditor.git</span><br><span class="line">cd HexoEditor</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æŠ¥é”™ï¼Œå°±æ˜¯å®‰è£…æˆåŠŸã€‚è€Œä¸”ä¼šåœ¨ä½ åˆšåˆšæ–°å»ºçš„ç›®å½•ä¸‹é¢ç”Ÿæˆä¸€ä¸ªHexoEditorç›®å½•ã€‚é‚£ä¹ˆå¦‚ä½•æ‰“å¼€HexoEditorå‘¢ï¼Ÿ<br />
è¿›å…¥åˆ°HexoEditorçš„ç›®å½•é‡Œé¢ï¼Œå³é”®æ‰“å¼€<code>Git Bash</code>å¯¹è¯æ¡†ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤å¯åŠ¨HexoEditor:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure>
<hr />
<h1>å…³äºGit Bash</h1>
<p>å¦‚æœä½ æ¥çœ‹è¿™ä¸ªï¼Œæˆ‘é»˜è®¤ä½ ä¸æ€ä¹ˆæ‡‚å‘½ä»¤è¡Œï¼Œä¸æ‰“ç®—æ·±è®²ï¼Œåªè®²ä¸€ç‚¹ç›¸å…³çš„å†…å®¹ã€‚<br />
åœ¨ä¸Šè¿°æ•™ç¨‹ä¸­ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä¼šæœ‰ä¸€ä¸ªæ“ä½œï¼Œå°±æ˜¯åœ¨æŸä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œé¢ï¼Œç©ºç™½å¤„å³é”®æ‰“å¼€Git Bashã€‚å¯èƒ½æœ‰çš„åŒå­¦ä¼šæœ‰ç–‘é—®ï¼Œåœ¨ä¸åŒçš„åœ°æ–¹æ‰“å¼€ä¼šæœ‰ä»€ä¹ˆä¸åŒå—ï¼Ÿ<br />
<strong>æ˜¯çš„ï¼å¯ä»¥è¯´å®Œå…¨ä¸åŒï¼è€Œä¸”å½±å“å¾ˆä¸¥é‡ã€‚</strong><br />
ä½ ä»”ç»†è§‚å¯Ÿä¼šå‘ç°ï¼Œ$è¿™ä¸ªç¬¦å·ä¸Šé¢ä¸€è¡Œæœ€åé¢ï¼Œæœ‰ä¸€ä¸ªç›®å½•</p>
<div align=center><img src="https://i.loli.net/2020/01/23/cCVxiz8r6Qdlqnk.png"/></div>
ä½ åœ¨å“ªé‡Œæ‰“å¼€çš„ï¼Œè¿™ä¸ªç›®å½•å°±ä¼šæ˜¯ä»€ä¹ˆã€‚è€Œä¸”ä½ æ‰§è¡Œçš„æ‰€æœ‰å‘½ä»¤ï¼Œéƒ½ä¼šåŸºäºè¿™ä¸ªç›®å½•æ¥æ‰§è¡Œã€‚å¯ä»¥ç™¾åº¦ä¸€ä¸‹å‘½ä»¤è¡Œå’Œcdå‘½ä»¤ï¼Œä¼šæœ‰æ›´æ·±çš„ç†è§£ã€‚
<hr />
]]></content>
      <categories>
        <category>è®°å½•</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
      </tags>
  </entry>
  <entry>
    <title>æ£é¼“ä¸»é¢˜æ ·å¼çš„æ–¹æ³•</title>
    <url>/post/%E6%8D%A3%E9%BC%93%E4%B8%BB%E9%A2%98%E6%A0%B7%E5%BC%8F%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<h1>å·¥å…·</h1>
<ul>
<li>ç«ç‹æµè§ˆå™¨ï¼ˆæˆ‘ç”¨çš„æ˜¯å¼€å‘è€…ç‰ˆæœ¬ï¼‰</li>
<li>VSCode</li>
</ul>
<h1>æ­¥éª¤</h1>
<a id="more"></a>
<ol>
<li>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ç½‘é¡µ
<ul>
<li>F12æ‰“å¼€å¼€å‘è€…å·¥å…·<br />
<img src="https://i.loli.net/2020/01/23/9dSBCq5jv4NOEzW.png" alt="" /></li>
<li>ç”¨æ–°çª—å£å·¦ä¸Šè§’çš„å…ƒç´ é€‰æ‹©å™¨åœ¨å·¦è¾¹çš„é¡µé¢é€‰æ‹©éœ€è¦ä¿®æ”¹çš„å…ƒç´ </li>
</ul>
</li>
<li>å¤åˆ¶é€‰æ‹©å™¨çš„åå­—
<ul>
<li>cssé€‰æ‹©å™¨<br />
<img src="https://i.loli.net/2020/01/23/K9TQ2uhwdJ7ICsU.png" alt="" /></li>
</ul>
</li>
<li>åœ¨<code>~theme/next/source/css</code>é‡Œç”¨VSCodeæ‰“å¼€
<ul>
<li>ç‚¹å‡»æœç´¢ï¼Œå¤åˆ¶ä¹‹å‰å¤åˆ¶çš„cssé€‰æ‹©å™¨<br />
<img src="https://i.loli.net/2020/01/23/vBnOTy13HEVLfSq.png" alt="" /></li>
<li>å› ä¸ºæœ‰å¾ˆå¤šæ–‡ä»¶é‡Œéƒ½å­˜åœ¨åŒåçš„cssé€‰æ‹©å™¨ï¼Œæ‰€ä»¥è¦ä»”ç»†ä¸€ä¸€æ¯”å¯¹æ‰¾åˆ°å¯¹åº”çš„ä½ç½®</li>
</ul>
</li>
<li>ä¿®æ”¹æ ·å¼å†ä¿å­˜å³å¯</li>
</ol>
<h1>æ€»ç»“</h1>
<ul>
<li>ç”¨æµè§ˆå™¨é‡Œçš„F12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œç”¨å…ƒç´ é€‰æ‹©å™¨é€‰æ‹©è¦ä¿®æ”¹çš„å…ƒç´ ï¼Œå¤åˆ¶cssé€‰æ‹©å™¨å</li>
<li>åœ¨vscodeé‡Œæœç´¢cssé€‰æ‹©å™¨åï¼Œæ‰¾åˆ°å¯¹åº”çš„ä½ç½®ä¿®æ”¹ä¿å­˜</li>
</ul>
]]></content>
      <categories>
        <category>è®°å½•</category>
        <category>æ£é¼“</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
        <tag>è‡ªå®šä¹‰</tag>
      </tags>
  </entry>
  <entry>
    <title>å…³äºmarkdownçš„ä¸€äº›æ“ä½œ</title>
    <url>/post/%E5%85%B3%E4%BA%8Emarkdown%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<h1>webå¼€å‘ï¼šè®¾ç½®å¤é€‰æ¡†çš„åªè¯»æ•ˆæœ</h1>
<p>åœ¨Webå¼€å‘ä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦æ˜¾ç¤ºä¸€äº›å¤é€‰æ¡†ï¼ˆcheckboxï¼‰ï¼Œè¡¨æ˜è¿™ä¸ªåœ°æ–¹æ˜¯å¯ä»¥è¿›è¡Œå‹¾é€‰æ“ä½œçš„ï¼Œä½†æ˜¯æœ‰æ—¶å€™æ˜¯åªæƒ³å‘ŠçŸ¥ç”¨æˆ·&quot;è¿™ä¸ªåœ°æ–¹æ˜¯å¯ä»¥è¿›è¡Œå‹¾é€‰æ“ä½œçš„&quot;è€Œä¸æƒ³è®©ç”¨æˆ·åœ¨æ­¤å¤„å‹¾é€‰ï¼ˆæ¯”å¦‚åœ¨ä¿¡æ¯å±•ç¤ºé¡µé¢ï¼‰ï¼Œè¿™æ—¶å€™å°±éœ€è¦å°†å¤é€‰æ¡†è®¾ç½®æˆåªè¯»çš„æ•ˆæœã€‚</p>
<a id="more"></a>
<p>æåˆ°åªè¯»ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨<code>readonly</code>å±æ€§ï¼Œä½†æ˜¯å¯¹äºå¤é€‰æ¡†æ¥è¯´ï¼Œè¿™ä¸ªå±æ€§å’ŒæœŸæœ›å¾—åˆ°çš„æ•ˆæœæ˜¯æœ‰å·®åˆ«çš„ã€‚åŸå› åœ¨äº <strong><code>readonly</code>å±æ€§å…³è”çš„æ˜¯é¡µé¢å…ƒç´ çš„valueå±æ€§ï¼ˆä¾‹å¦‚<code>textbox</code>ï¼Œè®¾ç½®äº†<code>readonly</code>å°±ä¸èƒ½ä¿®æ”¹è¾“å…¥æ¡†çš„æ–‡æœ¬å†…å®¹ï¼‰ï¼Œè€Œå¤é€‰æ¡†çš„å‹¾é€‰/å–æ¶ˆå¹¶ä¸æ”¹å˜å…¶valueå±æ€§ï¼Œæ”¹å˜çš„åªæ˜¯ä¸€ä¸ª<code>checked</code>çŠ¶æ€</strong>ã€‚æ‰€ä»¥å¯¹äº<code>checkbox</code>æ¥è¯´ï¼Œè®¾ç½®äº†<code>readonly</code>ï¼Œä»ç„¶æ˜¯å¯ä»¥å‹¾é€‰/å–æ¶ˆçš„ã€‚æ•ˆæœå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th><code>&lt;input type=&quot;text&quot; name=&quot;realname&quot; value=&quot;åªè¯»çš„æ–‡æœ¬å†…å®¹&quot; readonly=&quot;readonly&quot; /&gt;</code></th>
<th><input type="text" name="realname" value="åªè¯»çš„æ–‡æœ¬å†…å®¹" readonly="readonly" /></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;input type=&quot;checkbox&quot; name=&quot;optiona&quot; readonly=&quot;readonly&quot; /&gt;option a</code><br /><code>&lt;input type=&quot;checkbox&quot; name=&quot;optionb&quot; readonly=&quot;readonly&quot; /&gt;option b</code><br/><code>&lt;input type=&quot;checkbox&quot; name=&quot;optionc&quot; readonly=&quot;readonly&quot; /&gt;option c</code></td>
<td><input type="checkbox" name="optiona" readonly="readonly" />option a<br/><input type="checkbox" name="optionb" readonly="readonly" />option b<br/><input type="checkbox" name="optionc" readonly="readonly" />option c</td>
</tr>
</tbody>
</table>
<p>å’Œreadonlyç±»ä¼¼çš„ï¼Œè¿˜æœ‰ä¸€ä¸ªdisabledå±æ€§ï¼Œè¿™ä¸ªå±æ€§çš„ä½œç”¨æ˜¯è®¾ç½®é¡µé¢å…ƒç´ ä¸ºä¸å¯ç”¨ï¼Œå³ä¸å¯è¿›è¡Œä»»ä½•äº¤äº’æ“ä½œï¼ˆåŒ…æ‹¬ä¸å¯ä¿®æ”¹valueå±æ€§ã€ä¸å¯ä¿®æ”¹checkedçŠ¶æ€ç­‰ï¼‰ã€‚æ•ˆæœå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th><code>&lt;input type=&quot;text&quot; name=&quot;realname&quot; value=&quot;è¾“å…¥çš„æ–‡æœ¬å†…å®¹&quot; disabled=&quot;disabled&quot; /&gt;</code></th>
<th><input type="text" name="realname" value="è¾“å…¥çš„æ–‡æœ¬å†…å®¹" disabled="disabled" /></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;input type=&quot;checkbox&quot; name=&quot;optiona&quot; disabled=&quot;disabled&quot; /&gt;option a</code><br /><code>&lt;input type=&quot;checkbox&quot; name=&quot;optionb&quot; disabled=&quot;disabled&quot; /&gt;option b</code><br /><code>&lt;input type=&quot;checkbox&quot; name=&quot;optionc&quot; disabled=&quot;disabled&quot; /&gt;option c</code></td>
<td><input type="checkbox" name="optiona" disabled="disabled" />option a<br/><input type="checkbox" name="optionb" disabled="disabled" />option b<br/><input type="checkbox" name="optionc" disabled="disabled" />option c</td>
</tr>
</tbody>
</table>
<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯readonlyè¿˜æ˜¯disabledï¼Œéƒ½æ²¡æœ‰å®ç°æˆ‘ä»¬æœŸæœ›çš„æ•ˆæœã€‚æ—¢ç„¶ç›´æ¥å®ç°ä¸äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å˜é€šä¸€ä¸‹ï¼Œæ¨¡æ‹Ÿå®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p><code>&lt;input type=&quot;checkbox&quot; name=&quot;chkAllowed&quot; onclick=&quot;return false;&quot; checked=&quot;checked&quot; /&gt;</code> â€”&gt; <input type="checkbox" name="chkAllowed" onclick="return false;" checked="checked" /></p>
<p>è½¬è‡ªï¼š <a href="https://www.cnblogs.com/josephchan/archive/2012/10/15/webui_checkbox_readonly.html" target="_blank" rel="noopener">Webå¼€å‘ï¼šè®¾ç½®å¤é€‰æ¡†çš„åªè¯»æ•ˆæœ</a></p>
<hr />
<h1>å®ç°â€œå†…å®¹æŠ˜å â€çš„åŠŸèƒ½</h1>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">summary</span>&gt;</span><span class="tag">&lt;<span class="name">mark</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">darkred</span>&gt;</span>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å†…å®¹<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">mark</span>&gt;</span><span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">code</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">details</span>&gt;</span></span><br></pre></td></tr></table></figure>
<details>
<summary><mark><font color=darkred>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å†…å®¹</font></mark></summary>
<code></code>
</details>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">summary</span>&gt;</span>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å†…å®¹<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">code</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">	<span class="tag">&lt;/<span class="name">code</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">details</span>&gt;</span></span><br></pre></td></tr></table></figure>
<details>
    <summary>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å†…å®¹</summary>
	<code>
	</code>
</details>
]]></content>
      <categories>
        <category>è®°å½•</category>
      </categories>
      <tags>
        <tag>html</tag>
        <tag>markdown</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€ŠTCP-IPç½‘ç»œç¼–ç¨‹ã€‹å­¦ä¹ ç¬”è®°</title>
    <url>/post/%E3%80%8ATCP-IP%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E3%80%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2><strong>#æœ¬ç¯‡æ¥è‡ªè½¬è½½</strong></h2>
<p>æˆ‘çš„ç¯å¢ƒæ˜¯ï¼šUbuntu18.04 LTS</p>
<p>ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼š<code>g++ (Ubuntu 7.3.0-27 ubuntu 1~18.04) 7.3.0</code></p>
<p>å’Œ <code>gcc (Ubuntu 7.3.0-27 ubuntu 1~18.04) 7.3.0</code></p>
<p>æ‰€ä»¥æœ¬ç¬”è®°ä¸­åªå­¦ä¹ æœ‰å…³äº Linux çš„éƒ¨åˆ†ã€‚ <a id="more"></a></p>
<p>æœ¬é¡¹ç›®åœ¨ GitHub åœ°å€ä¸ºï¼š<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a></p>
<p>å¦‚æœåœ¨é˜…è¯»æœ¬ç¬”è®°çš„è¿‡ç¨‹ä¸­å‘ç°é”™åˆ«å­—ï¼ŒåŠ bug ï¼Œè¯·å‘æœ¬é¡¹ç›®æäº¤ <code>PR</code>.</p>
<p>ç¬”è®°çš„ PDF ç‰ˆæœ¬å¯ä»¥åœ¨æœ¬é¡¹ç›® <a href="https://github.com/riba2534/TCP-IP-NetworkNote/releases" target="_blank" rel="noopener">releases</a> ä¸­æ‰¾åˆ°åŠä¸‹è½½ã€‚</p>
<h2>ç¬¬ 1 ç« ï¼šç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ï¼Œç›´æ¥ç‚¹è¿æ¥å¯èƒ½è¿›ä¸å»ã€‚</p>
<h3>1.1 ç†è§£ç½‘ç»œç¼–ç¨‹å’Œå¥—æ¥å­—</h3>
<h4>1.1.1æ„å»ºæ‰“ç”µè¯å¥—æ¥å­—</h4>
<p>ä»¥ç”µè¯æœºæ‰“ç”µè¯çš„æ–¹å¼æ¥ç†è§£å¥—æ¥å­—ã€‚</p>
<p><strong>è°ƒç”¨ socket å‡½æ•°ï¼ˆå®‰è£…ç”µè¯æœºï¼‰æ—¶è¿›è¡Œçš„å¯¹è¯</strong>ï¼š</p>
<blockquote>
<p>é—®ï¼šæ¥ç”µè¯éœ€è¦å‡†å¤‡ä»€ä¹ˆï¼Ÿ</p>
<p>ç­”ï¼šå½“ç„¶æ˜¯ç”µè¯æœºã€‚</p>
</blockquote>
<p>æœ‰äº†ç”µè¯æœºæ‰èƒ½å®‰è£…ç”µè¯ï¼Œäºæ˜¯å°±è¦å‡†å¤‡ä¸€ä¸ªç”µè¯æœºï¼Œä¸‹é¢å‡½æ•°ç›¸å½“äºç”µè¯æœºçš„å¥—æ¥å­—ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br><span class="line"><span class="comment">//æˆåŠŸæ—¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br></pre></td></tr></table></figure>
<p><strong>è°ƒç”¨ bind å‡½æ•°ï¼ˆåˆ†é…ç”µè¯å·ç ï¼‰æ—¶è¿›è¡Œçš„å¯¹è¯</strong>ï¼š</p>
<blockquote>
<p>é—®ï¼šè¯·é—®æˆ‘çš„ç”µè¯å·ç æ˜¯å¤šå°‘</p>
<p>ç­”ï¼šæˆ‘çš„ç”µè¯å·ç æ˜¯123-1234</p>
</blockquote>
<p>å¥—æ¥å­—åŒæ ·å¦‚æ­¤ã€‚å°±æƒ³ç»™ç”µè¯æœºåˆ†é…ç”µè¯å·ç ä¸€æ ·ï¼Œåˆ©ç”¨ä»¥ä¸‹å‡½æ•°ç»™åˆ›å»ºå¥½çš„å¥—æ¥å­—åˆ†é…åœ°å€ä¿¡æ¯ï¼ˆIPåœ°å€å’Œç«¯å£å·ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *myaddr, <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br><span class="line"><span class="comment">//æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ bind å‡½æ•°ç»™å¥—æ¥å­—åˆ†é…åœ°å€ä¹‹åï¼Œå°±åŸºæœ¬å®Œæˆäº†æ‰€æœ‰çš„å‡†å¤‡å·¥ä½œã€‚æ¥ä¸‹æ¥æ˜¯éœ€è¦è¿æ¥ç”µè¯çº¿å¹¶ç­‰å¾…æ¥ç”µã€‚</p>
<p><strong>è°ƒç”¨ listen å‡½æ•°ï¼ˆè¿æ¥ç”µè¯çº¿ï¼‰æ—¶è¿›è¡Œçš„å¯¹è¯</strong>ï¼š</p>
<blockquote>
<p>é—®ï¼šå·²æ¶è®¾å®Œç”µè¯æœºåæ˜¯å¦åªéœ€é“¾æ¥ç”µè¯çº¿ï¼Ÿ</p>
<p>ç­”ï¼šå¯¹ï¼Œåªéœ€è¦è¿æ¥å°±èƒ½æ¥å¬ç”µè¯ã€‚</p>
</blockquote>
<p>ä¸€è¿æ¥ç”µè¯çº¿ï¼Œç”µè¯æœºå°±å¯ä»¥è½¬æ¢ä¸ºå¯æ¥å¬çŠ¶æ€ï¼Œè¿™æ—¶å…¶ä»–äººå¯ä»¥æ‹¨æ‰“ç”µè¯è¯·æ±‚è¿æ¥åˆ°è¯¥æœºã€‚åŒæ ·ï¼Œéœ€è¦æŠŠå¥—æ¥å­—è½¬åŒ–æˆå¯æ¥å—è¿æ¥çŠ¶æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> backlog)</span></span>;</span><br><span class="line"><span class="comment">//æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br></pre></td></tr></table></figure>
<p>è¿æ¥å¥½ç”µè¯çº¿ä»¥åï¼Œå¦‚æœæœ‰äººæ‹¨æ‰“ç”µè¯å°±å“é“ƒï¼Œæ‹¿èµ·è¯ç­’æ‰èƒ½æ¥å¬ç”µè¯ã€‚</p>
<p><strong>è°ƒç”¨ accept å‡½æ•°ï¼ˆæ‹¿èµ·è¯ç­’ï¼‰æ—¶è¿›è¡Œçš„å¯¹è¯</strong>ï¼š</p>
<blockquote>
<p>é—®ï¼šç”µè¯é“ƒå“äº†ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<p>ç­”ï¼šæ¥å¬å•Šã€‚</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd,struct sockaddr *addr,<span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line"><span class="comment">//æˆåŠŸæ—¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br></pre></td></tr></table></figure>
<p>ç½‘ç»œç¼–ç¨‹ä¸­å’Œæ¥å—è¿æ¥è¯·æ±‚çš„å¥—æ¥å­—åˆ›å»ºè¿‡ç¨‹å¯æ•´ç†å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¬¬ä¸€æ­¥ï¼šè°ƒç”¨ socket å‡½æ•°åˆ›å»ºå¥—æ¥å­—ã€‚</li>
<li>ç¬¬äºŒæ­¥ï¼šè°ƒç”¨ bind å‡½æ•°åˆ†é…IPåœ°å€å’Œç«¯å£å·ã€‚</li>
<li>ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨ listen å‡½æ•°è½¬æ¢ä¸ºå¯æ¥å—è¯·æ±‚çŠ¶æ€ã€‚</li>
<li>ç¬¬å››æ­¥ï¼šè°ƒç”¨ accept å‡½æ•°å—ç†å¥—æ¥å­—è¯·æ±‚ã€‚</li>
</ol>
<h4>1.1.2  ç¼–å†™<code>Hello World</code>å¥—æ¥å­—ç¨‹åº</h4>
<p><strong>æœåŠ¡ç«¯</strong>ï¼š</p>
<p>æœåŠ¡å™¨ç«¯ï¼ˆserverï¼‰æ˜¯èƒ½å¤Ÿå—ç†è¿æ¥è¯·æ±‚çš„ç¨‹åºã€‚ä¸‹é¢æ„å»ºæœåŠ¡ç«¯ä»¥éªŒè¯ä¹‹å‰æåˆ°çš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œè¯¥æœåŠ¡å™¨ç«¯æ”¶åˆ°è¿æ¥è¯·æ±‚åå‘è¯·æ±‚è€…è¿”å›<code>Hello World!</code>ç­”å¤ã€‚é™¤å„ç§å‡½æ•°çš„è°ƒç”¨é¡ºåºå¤–ï¼Œæˆ‘ä»¬è¿˜æœªæ¶‰åŠä»»ä½•å®é™…ç¼–ç¨‹ã€‚å› æ­¤ï¼Œé˜…è¯»ä»£ç æ—¶è¯·é‡ç‚¹å…³æ³¨å¥—æ¥å­—ç›¸å…³çš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œä¸å¿…ç†è§£å…¨è¿‡ç¨‹ã€‚</p>
<p>æœåŠ¡å™¨ç«¯ä»£ç è¯·å‚è§ï¼š<a href="ch01/hello_server.c">hello_server.c</a></p>
<p><strong>å®¢æˆ·ç«¯</strong>ï¼š</p>
<p>å®¢æˆ·ç«¯ç¨‹åºåªæœ‰<code>è°ƒç”¨ socket å‡½æ•°åˆ›å»ºå¥—æ¥å­—</code> å’Œ <code>è°ƒç”¨ connect å‡½æ•°å‘æœåŠ¡ç«¯å‘é€è¿æ¥è¯·æ±‚</code>è¿™ä¸¤ä¸ªæ­¥éª¤ï¼Œä¸‹é¢ç»™å‡ºå®¢æˆ·ç«¯ï¼Œéœ€è¦æŸ¥çœ‹ä»¥ä¸‹ä¸¤æ–¹é¢çš„å†…å®¹ï¼š</p>
<ol>
<li>è°ƒç”¨ socket å‡½æ•° å’Œ connect å‡½æ•°</li>
<li>ä¸æœåŠ¡ç«¯å…±åŒè¿è¡Œä»¥æ”¶å‘å­—ç¬¦ä¸²æ•°æ®</li>
</ol>
<p>å®¢æˆ·ç«¯ä»£ç è¯·å‚è§ï¼š<a href="ch01/hello_client.c">hello_client.c</a></p>
<p><strong>ç¼–è¯‘</strong>ï¼š</p>
<p>åˆ†åˆ«å¯¹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç¨‹åºè¿›è¡Œç¼–è¯‘ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc hello_server.c -o hserver</span><br><span class="line">gcc hello_client.c -o hclient</span><br></pre></td></tr></table></figure>
<p><strong>è¿è¡Œ</strong>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./hserver 9190</span><br><span class="line">./hclient 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œçš„æ—¶å€™ï¼Œé¦–å…ˆå† 9190 ç«¯å£å¯åŠ¨æœåŠ¡ï¼Œç„¶å heserver å°±ä¼šä¸€ç›´ç­‰å¾…å®¢æˆ·ç«¯è¿›è¡Œå“åº”ï¼Œå½“å®¢æˆ·ç«¯ç›‘å¬ä½äºæœ¬åœ°çš„ IP ä¸º 127.0.0.1 çš„åœ°å€çš„9190ç«¯å£æ—¶ï¼Œå®¢æˆ·ç«¯å°±ä¼šæ”¶åˆ°æœåŠ¡ç«¯çš„å›åº”ï¼Œè¾“å‡º<code>Hello World!</code></p>
<h3>1.2 åŸºäº Linux çš„æ–‡ä»¶æ“ä½œ</h3>
<p>è®¨è®ºå¥—æ¥å­—çš„è¿‡ç¨‹ä¸­çªç„¶è°ˆåŠæ–‡ä»¶ä¹Ÿè®¸æœ‰äº›å¥‡æ€ªã€‚ä½†æ˜¯å¯¹äº Linux è€Œè¨€ï¼Œsocket æ“ä½œä¸æ–‡ä»¶æ“ä½œæ²¡æœ‰åŒºåˆ«ï¼Œå› è€Œæœ‰å¿…è¦è¯¦ç»†äº†è§£æ–‡ä»¶ã€‚åœ¨ Linux ä¸–ç•Œé‡Œï¼Œsocket ä¹Ÿè¢«è®¤ä¸ºæ˜¯æ–‡ä»¶çš„ä¸€ç§ï¼Œå› æ­¤åœ¨ç½‘ç»œæ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­è‡ªç„¶å¯ä»¥ä½¿ç”¨ I/O çš„ç›¸å…³å‡½æ•°ã€‚Windows ä¸ Linux ä¸åŒï¼Œæ˜¯è¦åŒºåˆ† socket å’Œæ–‡ä»¶çš„ã€‚å› æ­¤åœ¨ Windows ä¸­éœ€è¦è°ƒç”¨ç‰¹æ®Šçš„æ•°æ®ä¼ è¾“ç›¸å…³å‡½æ•°ã€‚</p>
<h4>1.2.1 åº•å±‚è®¿é—®å’Œæ–‡ä»¶æè¿°ç¬¦</h4>
<p>åˆ†é…ç»™æ ‡å‡†è¾“å…¥è¾“å‡ºåŠæ ‡å‡†é”™è¯¯çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ–‡ä»¶æè¿°ç¬¦</th>
<th style="text-align:center">å¯¹è±¡</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">æ ‡å‡†è¾“å…¥ï¼šStandard Input</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">æ ‡å‡†è¾“å‡ºï¼šStandard Output</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">æ ‡å‡†é”™è¯¯ï¼šStandard Error</td>
</tr>
</tbody>
</table>
<p>æ–‡ä»¶å’Œå¥—æ¥å­—ä¸€èˆ¬ç»è¿‡åˆ›å»ºè¿‡ç¨‹æ‰ä¼šè¢«åˆ†é…æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p>æ–‡ä»¶æè¿°ç¬¦ä¹Ÿè¢«ç§°ä¸ºã€Œæ–‡ä»¶å¥æŸ„ã€ï¼Œä½†æ˜¯ã€Œå¥æŸ„ã€ä¸»è¦æ˜¯ Windows ä¸­çš„æœ¯è¯­ã€‚å› æ­¤ï¼Œåœ¨æœ¬ä¹¦ä¸­å¦‚æœè®¾è®¡ Windows å¹³å°å°†ä½¿ç”¨ã€Œå¥æŸ„ã€ï¼Œå¦‚æœæ˜¯ Linux å°†ä½¿ç”¨ã€Œæè¿°ç¬¦ã€ã€‚</p>
<h4>1.2.2 æ‰“å¼€æ–‡ä»¶:</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">int</span> flag)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br><span class="line"><span class="comment">path : æ–‡ä»¶åçš„å­—ç¬¦ä¸²åœ°å€</span></span><br><span class="line"><span class="comment">flag : æ–‡ä»¶æ‰“å¼€æ¨¡å¼ä¿¡æ¯</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>æ–‡ä»¶æ‰“å¼€æ¨¡å¼å¦‚ä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ‰“å¼€æ¨¡å¼</th>
<th style="text-align:center">å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">O_CREAT</td>
<td style="text-align:center">å¿…è¦æ—¶åˆ›å»ºæ–‡ä»¶</td>
</tr>
<tr>
<td style="text-align:center">O_TRUNC</td>
<td style="text-align:center">åˆ é™¤å…¨éƒ¨ç°æœ‰æ•°æ®</td>
</tr>
<tr>
<td style="text-align:center">O_APPEND</td>
<td style="text-align:center">ç»´æŒç°æœ‰æ•°æ®ï¼Œä¿å­˜åˆ°å…¶åé¢</td>
</tr>
<tr>
<td style="text-align:center">O_RDONLY</td>
<td style="text-align:center">åªè¯»æ‰“å¼€</td>
</tr>
<tr>
<td style="text-align:center">O_WRONLY</td>
<td style="text-align:center">åªå†™æ‰“å¼€</td>
</tr>
<tr>
<td style="text-align:center">O_RDWR</td>
<td style="text-align:center">è¯»å†™æ‰“å¼€</td>
</tr>
</tbody>
</table>
<h4>1.2.3 å…³é—­æ–‡ä»¶ï¼š</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> fd)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">fd : éœ€è¦å…³é—­çš„æ–‡ä»¶æˆ–å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è‹¥è°ƒç”¨æ­¤å‡½æ•°åŒæ—¶ä¼ é€’æ–‡ä»¶æè¿°ç¬¦å‚æ•°ï¼Œåˆ™å…³é—­ï¼ˆç»ˆæ­¢ï¼‰å“åº”æ–‡ä»¶ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤å‡½æ•°ä¸ä»…å¯ä»¥å…³é—­æ–‡ä»¶ï¼Œè¿˜å¯ä»¥å…³é—­å¥—æ¥å­—ã€‚å†æ¬¡è¯æ˜äº†ã€ŒLinux æ“ä½œç³»ç»Ÿä¸åŒºåˆ†æ–‡ä»¶ä¸å¥—æ¥å­—ã€çš„ç‰¹ç‚¹ã€‚</p>
<h4>1.2.4 å°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼š</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›å†™å…¥çš„å­—èŠ‚æ•° ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">fd : æ˜¾ç¤ºæ•°æ®ä¼ è¾“å¯¹è±¡çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">buf : ä¿å­˜è¦ä¼ è¾“æ•°æ®çš„ç¼“å†²å€¼åœ°å€</span></span><br><span class="line"><span class="comment">nbytes : è¦ä¼ è¾“æ•°æ®çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>åœ¨æ­¤å‡½æ•°çš„å®šä¹‰ä¸­ï¼Œsize_t æ˜¯é€šè¿‡ typedef å£°æ˜çš„ unsigned int ç±»å‹ã€‚å¯¹ ssize_t æ¥è¯´ï¼Œssize_t å‰é¢å¤šåŠ çš„ s ä»£è¡¨ signed ï¼Œå³ ssize_t æ˜¯é€šè¿‡ typedef å£°æ˜çš„ signed int ç±»å‹ã€‚</p>
<p>åˆ›å»ºæ–°æ–‡ä»¶å¹¶ä¿å­˜æ•°æ®ï¼š</p>
<p>ä»£ç è§ï¼š<a href="ch01/low_open.c">low_open.c</a></p>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc low_open.c -o lopen</span><br><span class="line">./lopen</span><br></pre></td></tr></table></figure>
<p>ç„¶åä¼šç”Ÿæˆä¸€ä¸ª<code>data.txt</code>çš„æ–‡ä»¶ï¼Œé‡Œé¢æœ‰<code>Let's go!</code></p>
<h4>1.2.5 è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®ï¼š</h4>
<p>ä¸ä¹‹å‰çš„<code>write()</code>å‡½æ•°ç›¸å¯¹åº”ï¼Œ<code>read()</code>ç”¨æ¥è¾“å…¥ï¼ˆæ¥æ”¶ï¼‰æ•°æ®ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›æ¥æ”¶çš„å­—èŠ‚æ•°ï¼ˆä½†é‡åˆ°æ–‡ä»¶ç»“å°¾åˆ™è¿”å› 0ï¼‰ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">fd : æ˜¾ç¤ºæ•°æ®æ¥æ”¶å¯¹è±¡çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">buf : è¦ä¿å­˜æ¥æ”¶çš„æ•°æ®çš„ç¼“å†²åœ°å€å€¼ã€‚</span></span><br><span class="line"><span class="comment">nbytes : è¦æ¥æ”¶æ•°æ®çš„æœ€å¤§å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢ç¤ºä¾‹é€šè¿‡ read() å‡½æ•°è¯»å– data.txt ä¸­ä¿å­˜çš„æ•°æ®ã€‚</p>
<p>ä»£ç è§ï¼š<a href="ch01/low_read.c">low_read.c</a></p>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc low_read.c -o lread</span><br><span class="line">./lread</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šä¸€æ­¥çš„ data.txt æ–‡ä»¶ä¸æ²¡æœ‰åˆ çš„æƒ…å†µä¸‹ï¼Œä¼šè¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file descriptor: 3</span><br><span class="line">file data: Let&#39;s go!</span><br></pre></td></tr></table></figure>
<p>å…³äºæ–‡ä»¶æè¿°ç¬¦çš„ I/O æ“ä½œåˆ°æ­¤ç»“æŸï¼Œè¦æ˜ç™½ï¼Œè¿™äº›å†…å®¹åŒæ ·é€‚åˆäºå¥—æ¥å­—ã€‚</p>
<h4>1.2.6 æ–‡ä»¶æè¿°ç¬¦ä¸å¥—æ¥å­—</h4>
<p>ä¸‹é¢å°†åŒæ—¶åˆ›å»ºæ–‡ä»¶å’Œå¥—æ¥å­—ï¼Œå¹¶ç”¨æ•´æ•°å‹æ€æ¯”è¾ƒè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦çš„å€¼.</p>
<p>ä»£ç è§ï¼š<a href="ch01/fd_seri.c">fd_seri.c</a></p>
<p><strong>ç¼–è¯‘è¿è¡Œ</strong>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc fd_seri.c -o fds</span><br><span class="line">./fds</span><br></pre></td></tr></table></figure>
<p><strong>è¾“å‡ºç»“æœ</strong>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file descriptor 1: 3</span><br><span class="line">file descriptor 2: 15</span><br><span class="line">file descriptor 3: 16</span><br></pre></td></tr></table></figure>
<h3>1.3 åŸºäº Windows å¹³å°çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>1.4 åŸºäº Windows çš„å¥—æ¥å­—ç›¸å…³å‡½æ•°åŠç¤ºä¾‹</h3>
<p>æš‚ç•¥</p>
<h3>1.5 ä¹ é¢˜</h3>
<blockquote>
<p>â—ï¸ä»¥ä¸‹éƒ¨åˆ†çš„ç­”æ¡ˆï¼Œä»…ä»£è¡¨æˆ‘ä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆ</p>
</blockquote>
<ol>
<li>
<p>å¥—æ¥å­—åœ¨ç½‘ç»œç¼–ç¨‹ä¸­çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä½•ç§°å®ƒä¸ºå¥—æ¥å­—ï¼Ÿ</p>
<blockquote>
<p>ç­”ï¼šæ“ä½œç³»ç»Ÿä¼šæä¾›ã€Œå¥—æ¥å­—ã€ï¼ˆsocketï¼‰çš„éƒ¨ä»¶ï¼Œå¥—æ¥å­—æ˜¯ç½‘ç»œæ•°æ®ä¼ è¾“ç”¨çš„è½¯ä»¶è®¾å¤‡ã€‚å› æ­¤ï¼Œã€Œç½‘ç»œç¼–ç¨‹ã€ä¹Ÿå«ã€Œå¥—æ¥å­—ç¼–ç¨‹ã€ã€‚ã€Œå¥—æ¥å­—ã€å°±æ˜¯ç”¨æ¥è¿æ¥ç½‘ç»œçš„å·¥å…·ã€‚</p>
</blockquote>
</li>
<li>
<p>åœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºå¥—æ¥å­—ä»¥åï¼Œä¼šä¾æ¬¡è°ƒç”¨ listen å‡½æ•°å’Œ accept å‡½æ•°ã€‚è¯·æ¯”è¾ƒäºŒè€…ä½œç”¨ã€‚</p>
<blockquote>
<p>ç­”ï¼šè°ƒç”¨ listen å‡½æ•°å°†å¥—æ¥å­—è½¬æ¢æˆå¯å—è¿æ¥çŠ¶æ€ï¼ˆç›‘å¬ï¼‰ï¼Œè°ƒç”¨ accept å‡½æ•°å—ç†è¿æ¥è¯·æ±‚ã€‚å¦‚æœåœ¨æ²¡æœ‰è¿æ¥è¯·æ±‚çš„æƒ…å†µä¸‹è°ƒç”¨è¯¥å‡½æ•°ï¼Œåˆ™ä¸ä¼šè¿”å›ï¼Œç›´åˆ°æœ‰è¿æ¥è¯·æ±‚ä¸ºæ­¢ã€‚</p>
</blockquote>
</li>
<li>
<p>Linux ä¸­ï¼Œå¯¹å¥—æ¥å­—æ•°æ®è¿›è¡Œ I/O æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨æ–‡ä»¶ I/O ç›¸å…³å‡½æ•°ï¼›è€Œåœ¨ Windows ä¸­åˆ™ä¸å¯ä»¥ã€‚åŸå› ä¸ºä½•ï¼Ÿ</p>
<blockquote>
<p>ç­”ï¼šæš‚ç•¥ã€‚</p>
</blockquote>
</li>
<li>
<p>åˆ›å»ºå¥—æ¥å­—åä¸€èˆ¬ä¼šç»™ä»–åˆ†é…åœ°å€ï¼Œä¸ºä»€ä¹ˆï¼Ÿä¸ºäº†å®Œæˆåœ°å€åˆ†é…éœ€è¦è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Ÿ</p>
<blockquote>
<p>ç­”ï¼šå¥—æ¥å­—è¢«åˆ›å»ºä¹‹åï¼Œåªæœ‰ä¸ºå…¶åˆ†é…äº†IPåœ°å€å’Œç«¯å£å·åï¼Œå®¢æˆ·ç«¯æ‰èƒ½å¤Ÿé€šè¿‡IPåœ°å€åŠç«¯å£å·ä¸æœåŠ¡å™¨ç«¯å»ºç«‹è¿æ¥ï¼Œéœ€è¦è°ƒç”¨ bind å‡½æ•°æ¥å®Œæˆåœ°å€åˆ†é…ã€‚</p>
</blockquote>
</li>
<li>
<p>Linux ä¸­çš„æ–‡ä»¶æè¿°ç¬¦ä¸ Windows çš„å¥æŸ„å®é™…ä¸Šéå¸¸ç±»ä¼¼ã€‚è¯·ä»¥å¥—æ¥å­—ä¸ºå¯¹è±¡è¯´æ˜å®ƒä»¬çš„å«ä¹‰ã€‚</p>
</li>
</ol>
<blockquote>
<p>ç­”ï¼šæš‚ç•¥ã€‚</p>
</blockquote>
<ol start="6">
<li>
<p>åº•å±‚ I/O å‡½æ•°ä¸ ANSI æ ‡å‡†å®šä¹‰çš„æ–‡ä»¶ I/O å‡½æ•°æœ‰ä½•åŒºåˆ«ï¼Ÿ</p>
<blockquote>
<p>ç­”ï¼šæ–‡ä»¶ I/O åˆç§°ä¸ºä½çº§ç£ç›˜ I/Oï¼Œéµå¾ª POSIX ç›¸å…³æ ‡å‡†ã€‚ä»»ä½•å…¼å®¹ POSIX æ ‡å‡†çš„æ“ä½œç³»ç»Ÿä¸Šéƒ½æ”¯æŒæ–‡ä»¶I/Oã€‚æ ‡å‡† I/O è¢«ç§°ä¸ºé«˜çº§ç£ç›˜ I/Oï¼Œéµå¾ª ANSI C ç›¸å…³æ ‡å‡†ã€‚åªè¦å¼€å‘ç¯å¢ƒä¸­æœ‰æ ‡å‡† I/O åº“ï¼Œæ ‡å‡† I/O å°±å¯ä»¥ä½¿ç”¨ã€‚ï¼ˆLinux ä¸­ä½¿ç”¨çš„æ˜¯ GLIBCï¼Œå®ƒæ˜¯æ ‡å‡†Cåº“çš„è¶…é›†ã€‚ä¸ä»…åŒ…å« ANSI C ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œè¿˜åŒ…æ‹¬ POSIX æ ‡å‡†ä¸­å®šä¹‰çš„å‡½æ•°ã€‚å› æ­¤ï¼ŒLinux ä¸‹æ—¢å¯ä»¥ä½¿ç”¨æ ‡å‡† I/Oï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡ä»¶ I/Oï¼‰ã€‚</p>
</blockquote>
</li>
<li>
<p>å‚è€ƒæœ¬ä¹¦ç»™å‡ºçš„ç¤ºä¾‹<code>low_open.c</code>å’Œ<code>low_read.c</code>ï¼Œåˆ†åˆ«åˆ©ç”¨åº•å±‚æ–‡ä»¶ I/O å’Œ ANSI æ ‡å‡† I/O ç¼–å†™æ–‡ä»¶å¤åˆ¶ç¨‹åºã€‚å¯ä»»æ„æŒ‡å®šå¤åˆ¶ç¨‹åºçš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<blockquote>
<p>ç­”ï¼šæš‚ç•¥ã€‚</p>
</blockquote>
</li>
</ol>
<h2>ç¬¬ 2 ç«  å¥—æ¥å­—ç±»å‹ä¸åè®®è®¾ç½®</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ï¼Œç›´æ¥ç‚¹è¿æ¥å¯èƒ½è¿›ä¸å»ã€‚</p>
<p>æœ¬ç« ä»…éœ€äº†è§£åˆ›å»ºå¥—æ¥å­—æ—¶è°ƒç”¨çš„ socket å‡½æ•°ã€‚</p>
<h3>2.1 å¥—æ¥å­—åè®®åŠæ•°æ®ä¼ è¾“ç‰¹æ€§</h3>
<h4>2.1.1 åˆ›å»ºå¥—æ¥å­—</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br><span class="line"><span class="comment">domain: å¥—æ¥å­—ä¸­ä½¿ç”¨çš„åè®®æ—ï¼ˆProtocol Familyï¼‰</span></span><br><span class="line"><span class="comment">type: å¥—æ¥å­—æ•°æ®ä¼ è¾“çš„ç±»å‹ä¿¡æ¯</span></span><br><span class="line"><span class="comment">protocol: è®¡ç®—æœºé—´é€šä¿¡ä¸­ä½¿ç”¨çš„åè®®ä¿¡æ¯</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h4>2.1.2 åè®®æ—ï¼ˆProtocol Familyï¼‰</h4>
<p>é€šè¿‡ socket å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’å¥—æ¥å­—ä¸­ä½¿ç”¨çš„åè®®åˆ†ç±»ä¿¡æ¯ã€‚æ­¤åè®®åˆ†ç±»ä¿¡æ¯ç§°ä¸ºåè®®æ—ï¼Œå¯åˆ†æˆå¦‚ä¸‹å‡ ç±»ï¼š</p>
<blockquote>
<p>å¤´æ–‡ä»¶ <code>sys/socket.h</code> ä¸­å£°æ˜çš„åè®®æ—</p>
</blockquote>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>åè®®æ—</th>
</tr>
</thead>
<tbody>
<tr>
<td>PF_INET</td>
<td>IPV4 äº’è”ç½‘åè®®æ—</td>
</tr>
<tr>
<td>PF_INET6</td>
<td>IPV6 äº’è”ç½‘åè®®æ—</td>
</tr>
<tr>
<td>PF_LOCAL</td>
<td>æœ¬åœ°é€šä¿¡ Unix åè®®æ—</td>
</tr>
<tr>
<td>PF_PACKET</td>
<td>åº•å±‚å¥—æ¥å­—çš„åè®®æ—</td>
</tr>
<tr>
<td>PF_IPX</td>
<td>IPX Novel åè®®æ—</td>
</tr>
</tbody>
</table>
<p>æœ¬ä¹¦ç€é‡è®² PF_INET å¯¹åº”çš„ IPV4 äº’è”ç½‘åè®®æ—ã€‚å…¶ä»–åè®®å¹¶ä¸å¸¸ç”¨ï¼Œæˆ–å¹¶æœªæ™®åŠã€‚<strong>å¦å¤–ï¼Œå¥—æ¥å­—ä¸­é‡‡ç”¨çš„æœ€ç»ˆçš„åè®®ä¿¡æ¯æ˜¯é€šè¿‡ socket å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’çš„ã€‚åœ¨æŒ‡å®šçš„åè®®æ—èŒƒå›´å†…é€šè¿‡ç¬¬ä¸€ä¸ªå‚æ•°å†³å®šç¬¬ä¸‰ä¸ªå‚æ•°ã€‚</strong></p>
<h4>2.1.3 å¥—æ¥å­—ç±»å‹ï¼ˆTypeï¼‰</h4>
<p>å¥—æ¥å­—ç±»å‹æŒ‡çš„æ˜¯å¥—æ¥å­—çš„æ•°æ®ä¼ è¾“æ–¹å¼ï¼Œæ˜¯é€šè¿‡ socket å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œä¼ é€’ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½å†³å®šåˆ›å»ºçš„å¥—æ¥å­—çš„æ•°æ®ä¼ è¾“æ–¹å¼ã€‚<strong>å·²ç»é€šè¿‡ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’äº†åè®®æ—ä¿¡æ¯ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å†³å®šæ•°æ®ä¼ è¾“æ–¹å¼ï¼Ÿé—®é¢˜å°±åœ¨äºï¼Œå†³å®šäº†åè®®æ—å¹¶ä¸èƒ½åŒæ—¶å†³å®šæ•°æ®ä¼ è¾“æ–¹å¼ã€‚æ¢è¨€ä¹‹ï¼Œ socket å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° PF_INET åè®®æ—ä¸­ä¹Ÿå­˜åœ¨å¤šç§æ•°æ®ä¼ è¾“æ–¹å¼ã€‚</strong></p>
<h4>2.1.4 å¥—æ¥å­—ç±»å‹1ï¼šé¢å‘è¿æ¥çš„å¥—æ¥å­—ï¼ˆSOCK_STREAMï¼‰</h4>
<p>å¦‚æœ socket å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’<code>SOCK_STREAM</code>ï¼Œå°†åˆ›å»ºé¢å‘è¿æ¥çš„å¥—æ¥å­—ã€‚</p>
<p>ä¼ è¾“æ–¹å¼ç‰¹å¾æ•´ç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¼šæ¶ˆå¤±</li>
<li>æŒ‰åºä¼ è¾“æ•°æ®</li>
<li>ä¼ è¾“çš„æ•°æ®ä¸å­˜åœ¨æ•°æ®è¾¹ç•Œï¼ˆBoundaryï¼‰</li>
</ul>
<p>è¿™ç§æƒ…å½¢é€‚ç”¨äºä¹‹å‰è¯´è¿‡çš„ write å’Œ read å‡½æ•°</p>
<blockquote>
<p>ä¼ è¾“æ•°æ®çš„è®¡ç®—æœºé€šè¿‡è°ƒç”¨3æ¬¡ write å‡½æ•°ä¼ é€’äº† 100 å­—èŠ‚çš„æ•°æ®ï¼Œä½†æ˜¯æ¥å—æ•°æ®çš„è®¡ç®—æœºä»…ä»…é€šè¿‡è°ƒç”¨ 1 æ¬¡ read å‡½æ•°è°ƒç”¨å°±æ¥å—äº†å…¨éƒ¨ 100 ä¸ªå­—èŠ‚ã€‚</p>
</blockquote>
<p>æ”¶å‘æ•°æ®çš„å¥—æ¥å­—å†…éƒ¨æœ‰ç¼“å†²ï¼ˆbufferï¼‰ï¼Œç®€è¨€ä¹‹å°±æ˜¯å­—èŠ‚æ•°ç»„ã€‚åªè¦ä¸è¶…è¿‡æ•°ç»„å®¹é‡ï¼Œé‚£ä¹ˆæ•°æ®å¡«æ»¡ç¼“å†²åè¿‡ 1 æ¬¡ read å‡½æ•°çš„è°ƒç”¨å°±å¯ä»¥è¯»å–å…¨éƒ¨ï¼Œä¹Ÿæœ‰å¯èƒ½è°ƒç”¨å¤šæ¬¡æ¥å®Œæˆè¯»å–ã€‚</p>
<p><strong>å¥—æ¥å­—ç¼“å†²å·²æ»¡æ˜¯å¦æ„å‘³ç€æ•°æ®ä¸¢å¤±ï¼Ÿ</strong></p>
<blockquote>
<p>ç­”ï¼šç¼“å†²å¹¶ä¸æ€»æ˜¯æ»¡çš„ã€‚å¦‚æœè¯»å–é€Ÿåº¦æ¯”æ•°æ®ä¼ å…¥è¿‡æ¥çš„é€Ÿåº¦æ…¢ï¼Œåˆ™ç¼“å†²å¯èƒ½è¢«å¡«æ»¡ï¼Œä½†æ˜¯è¿™æ—¶ä¹Ÿä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œå› ä¸ºä¼ è¾“å¥—æ¥å­—æ­¤æ—¶ä¼šåœæ­¢æ•°æ®ä¼ è¾“ï¼Œæ‰€ä»¥é¢å‘è¿æ¥çš„å¥—æ¥å­—ä¸ä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±ã€‚</p>
</blockquote>
<p>å¥—æ¥å­—è”æœºå¿…é¡»ä¸€ä¸€å¯¹åº”ã€‚é¢å‘è¿æ¥çš„å¥—æ¥å­—å¯æ€»ç»“ä¸ºï¼š</p>
<p><strong>å¯é åœ°ã€æŒ‰åºä¼ é€’çš„ã€åŸºäºå­—èŠ‚çš„é¢å‘è¿æ¥çš„æ•°æ®ä¼ è¾“æ–¹å¼çš„å¥—æ¥å­—ã€‚</strong></p>
<h4>2.1.5 é¢å‘æ¶ˆæ¯çš„å¥—æ¥å­—ï¼ˆSOCK_DGRAMï¼‰</h4>
<p>å¦‚æœ socket å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’<code>SOCK_DGRAM</code>ï¼Œåˆ™å°†åˆ›å»ºé¢å‘æ¶ˆæ¯çš„å¥—æ¥å­—ã€‚é¢å‘æ¶ˆæ¯çš„å¥—æ¥å­—å¯ä»¥æ¯”å–»æˆé«˜é€Ÿç§»åŠ¨çš„æ‘©æ‰˜è½¦é˜Ÿã€‚ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¼ºè°ƒå¿«é€Ÿä¼ è¾“è€Œéä¼ è¾“æœ‰åº</li>
<li>ä¼ è¾“çš„æ•°æ®å¯èƒ½ä¸¢å¤±ä¹Ÿå¯èƒ½æŸæ¯</li>
<li>ä¼ è¾“çš„æ•°æ®æœ‰è¾¹ç•Œ</li>
<li>é™åˆ¶æ¯æ¬¡ä¼ è¾“æ•°æ®çš„å¤§å°</li>
</ul>
<p>é¢å‘æ¶ˆæ¯çš„å¥—æ¥å­—æ¯”é¢å‘è¿æ¥çš„å¥—æ¥å­—æ›´å…·å“Ÿä¼ è¾“é€Ÿåº¦ï¼Œä½†å¯èƒ½ä¸¢å¤±ã€‚ç‰¹ç‚¹å¯æ€»ç»“ä¸ºï¼š</p>
<p><strong>ä¸å¯é çš„ã€ä¸æŒ‰åºä¼ é€’çš„ã€ä»¥æ•°æ®çš„é«˜é€Ÿä¼ è¾“ä¸ºç›®çš„å¥—æ¥å­—ã€‚</strong></p>
<h4>2.1.6 åè®®çš„æœ€ç»ˆé€‰æ‹©</h4>
<p>socket å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°å†³å®šæœ€ç»ˆé‡‡ç”¨çš„åè®®ã€‚å‰é¢å·²ç»é€šè¿‡å‰ä¸¤ä¸ªå‚æ•°ä¼ é€’äº†åè®®æ—ä¿¡æ¯å’Œå¥—æ¥å­—æ•°æ®ä¼ è¾“æ–¹å¼ï¼Œè¿™äº›ä¿¡æ¯è¿˜ä¸å¤Ÿå—ï¼Ÿä¸ºä»€ä¹ˆè¦ä¼ è¾“ç¬¬ä¸‰ä¸ªå‚æ•°å‘¢ï¼Ÿ</p>
<blockquote>
<p>å¯ä»¥åº”å¯¹åŒä¸€åè®®æ—ä¸­å­˜åœ¨çš„å¤šä¸ªæ•°æ®ä¼ è¾“æ–¹å¼ç›¸åŒçš„åè®®ï¼Œæ‰€ä»¥æ•°æ®ä¼ è¾“æ–¹å¼ç›¸åŒï¼Œä½†æ˜¯åè®®ä¸åŒï¼Œéœ€è¦ç”¨ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å®šå…·ä½“çš„åè®®ä¿¡æ¯ã€‚</p>
</blockquote>
<p>æœ¬ä¹¦ç”¨çš„æ˜¯ Ipv4 çš„åè®®æ—ï¼Œå’Œé¢å‘è¿æ¥çš„æ•°æ®ä¼ è¾“ï¼Œæ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„åè®®åªæœ‰ TPPROTO_TCP ï¼Œå› æ­¤å¯ä»¥å¦‚ä¸‹è°ƒç”¨ socket å‡½æ•°åˆ›å»ºå¥—æ¥å­—ï¼Œè¿™ç§å¥—æ¥å­—ç§°ä¸º TCP å¥—æ¥å­—ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> tcp_socket = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br></pre></td></tr></table></figure>
<p>SOCK_DGRAM æŒ‡çš„æ˜¯é¢å‘æ¶ˆæ¯çš„æ•°æ®ä¼ è¾“æ–¹å¼ï¼Œæ»¡è¶³ä¸Šè¿°æ¡ä»¶çš„åè®®åªæœ‰ TPPROTO_UDP ã€‚è¿™ç§å¥—æ¥å­—ç§°ä¸º UDP å¥—æ¥å­—ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> udp_socket = socket(PF_INET, SOCK_DGRAM, IPPROTO_UDP);</span><br></pre></td></tr></table></figure>
<h4>2.1.7 é¢å‘è¿æ¥çš„å¥—æ¥å­—ï¼šTCP å¥—æ¥å­—ç¤ºä¾‹</h4>
<p>éœ€è¦å¯¹ç¬¬ä¸€ç« çš„ä»£ç åšå‡ºä¿®æ”¹ï¼Œä¿®æ”¹å¥½çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch02/tcp_client.c" target="_blank" rel="noopener">tcp_client.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch02/tcp_server.c" target="_blank" rel="noopener">tcp_server.c</a></li>
</ul>
<p>ç¼–è¯‘ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc tcp_client.c -o hclient</span><br><span class="line">gcc tcp_server.c -o hserver</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./hserver 9190</span><br><span class="line">./hclient 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Message from server : Hello World! </span><br><span class="line">Function read call count: 13</span><br></pre></td></tr></table></figure>
<p>ä»è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºæœåŠ¡ç«¯å‘é€äº†13å­—èŠ‚çš„æ•°æ®ï¼Œå®¢æˆ·ç«¯è°ƒç”¨13æ¬¡ read å‡½æ•°è¿›è¡Œè¯»å–ã€‚</p>
<h3>2.2 Windows å¹³å°ä¸‹çš„å®ç°åŠéªŒè¯</h3>
<p>æš‚ç•¥</p>
<h3>2.3 ä¹ é¢˜</h3>
<ol>
<li>
<p>ä»€ä¹ˆæ˜¯åè®®ï¼Ÿåœ¨æ”¶å‘æ•°æ®ä¸­å®šä¹‰åè®®æœ‰ä½•æ„ä¹‰ï¼Ÿ</p>
<blockquote>
<p>ç­”ï¼šåè®®æ˜¯å¯¹è¯ä¸­ä½¿ç”¨çš„é€šä¿¡è§„åˆ™ï¼Œç®€è¨€ä¹‹ï¼Œåè®®å°±æ˜¯ä¸ºäº†å®Œæˆæ•°æ®äº¤æ¢è€Œå®šå¥½çš„çº¦å®šã€‚åœ¨æ”¶å‘æ•°æ®ä¸­å®šä¹‰åè®®ï¼Œèƒ½å¤Ÿè®©è®¡ç®—æœºä¹‹é—´è¿›è¡Œæ­£ç¡®æ— è¯¯çš„å¯¹è¯ï¼Œä»¥æ­¤æ¥äº¤æ¢æ•°æ®ã€‚</p>
</blockquote>
</li>
<li>
<p>é¢å‘è¿æ¥çš„å¥—æ¥å­— TCP å¥—æ¥å­—ä¼ è¾“ç‰¹æ€§æœ‰ 3 ç‚¹ï¼Œè¯·åˆ†åˆ«è¯´æ˜ã€‚</p>
<blockquote>
<p>ç­”ï¼šâ‘ ä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¼šæ¶ˆå¤±â‘¡æŒ‰åºä¼ è¾“æ•°æ®â‘¢ä¼ è¾“çš„æ•°æ®ä¸å­˜åœ¨æ•°æ®è¾¹ç•Œï¼ˆBoundaryï¼‰</p>
</blockquote>
</li>
<li>
<p>ä¸‹é¢é‚£äº›æ˜¯é¢å‘æ¶ˆæ¯çš„å¥—æ¥å­—çš„ç‰¹æ€§ï¼Ÿ</p>
<ul>
<li><strong>ä¼ è¾“æ•°æ®å¯èƒ½ä¸¢å¤±</strong></li>
<li>æ²¡æœ‰æ•°æ®è¾¹ç•Œï¼ˆBoundaryï¼‰</li>
<li><strong>ä»¥å¿«é€Ÿä¼ é€’ä¸ºç›®æ ‡</strong></li>
<li>ä¸é™åˆ¶æ¯æ¬¡ä¼ è¾“æ•°æ®å¤§å°</li>
<li><strong>ä¸é¢å‘è¿æ¥çš„å¥—æ¥å­—ä¸åŒï¼Œä¸å­˜åœ¨è¿æ¥æ¦‚å¿µ</strong></li>
</ul>
</li>
<li>
<p>ä¸‹åˆ—æ•°æ®é€‚åˆç”¨å“ªç±»å¥—æ¥å­—è¿›è¡Œä¼ è¾“ï¼Ÿ</p>
<ul>
<li>æ¼”å”±ä¼šç°åœºç›´æ’­çš„å¤šåª’ä½“æ•°æ®ï¼ˆUDPï¼‰</li>
<li>æŸäººå‹ç¼©è¿‡çš„æ–‡æœ¬æ–‡ä»¶ï¼ˆTCPï¼‰</li>
<li>ç½‘ä¸Šé“¶è¡Œç”¨æˆ·ä¸é“¶è¡Œä¹‹é—´çš„æ•°æ®ä¼ é€’ï¼ˆTCPï¼‰</li>
</ul>
</li>
<li>
<p>ä½•ç§ç±»å‹çš„å¥—æ¥å­—ä¸å­˜åœ¨æ•°æ®è¾¹ç•Œï¼Ÿè¿™ç±»å¥—æ¥å­—æ¥æ”¶æ•°æ®æ—¶åº”è¯¥æ³¨æ„ä»€ä¹ˆï¼Ÿ</p>
<blockquote>
<p>ç­”ï¼šTCP ä¸å­˜åœ¨æ•°æ®è¾¹ç•Œã€‚åœ¨æ¥æ”¶æ•°æ®æ—¶ï¼Œéœ€è¦ä¿è¯åœ¨æ¥æ”¶å¥—æ¥å­—çš„ç¼“å†²åŒºå¡«å……æ»¡ä¹‹æ—¶å°±ä»bufferé‡Œè¯»å–æ•°æ®ã€‚ä¹Ÿå°±æ˜¯ï¼Œåœ¨æ¥æ”¶å¥—æ¥å­—å†…éƒ¨ï¼Œå†™å…¥bufferçš„é€Ÿåº¦è¦å°äºè¯»å‡ºbufferçš„é€Ÿåº¦ã€‚</p>
</blockquote>
</li>
</ol>
<h2>ç¬¬ 3 ç«  åœ°å€æ—ä¸æ•°æ®åºåˆ—</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<p>æŠŠå¥—æ¥å­—æ¯”å–»æˆç”µè¯ï¼Œé‚£ä¹ˆç›®å‰åªå®‰è£…äº†ç”µè¯æœºï¼Œæœ¬ç« è®²è§£ç»™ç”µè¯æœºåˆ†é…å·ç çš„æ–¹æ³•ï¼Œå³ç»™å¥—æ¥å­—åˆ†é… IP åœ°å€å’Œç«¯å£å·ã€‚</p>
<h3>3.1 åˆ†é…ç»™å¥—æ¥å­—çš„ IP åœ°å€ä¸ç«¯å£å·</h3>
<p>IP æ˜¯ Internet Protocolï¼ˆç½‘ç»œåè®®ï¼‰çš„ç®€å†™ï¼Œæ˜¯ä¸ºæ‰‹æ³•ç½‘ç»œæ•°æ®è€Œåˆ†é…ç»™è®¡ç®—æœºçš„å€¼ã€‚ç«¯å£å·å¹¶éèµ‹äºˆè®¡ç®—æœºçš„å€¼ï¼Œè€Œæ˜¯ä¸ºäº†åŒºåˆ†ç¨‹åºä¸­åˆ›å»ºçš„å¥—æ¥å­—è€Œåˆ†é…ç»™å¥—æ¥å­—çš„ç«¯å£å·ã€‚</p>
<h4>3.1.1 ç½‘ç»œåœ°å€ï¼ˆInternet Addressï¼‰</h4>
<p>ä¸ºä½¿è®¡ç®—æœºè¿æ¥åˆ°ç½‘ç»œå¹¶æ”¶å‘æ•°æ®ï¼Œå¿…é¡»ä¸ºå…¶åˆ†é… IP åœ°å€ã€‚IP åœ°å€åˆ†ä¸ºä¸¤ç±»ã€‚</p>
<ul>
<li>IPV4ï¼ˆInternet Protocol version 4ï¼‰4 å­—èŠ‚åœ°å€æ—</li>
<li>IPV6ï¼ˆInternet Protocol version 6ï¼‰6 å­—èŠ‚åœ°å€æ—</li>
</ul>
<p>ä¸¤è€…ä¹‹é—´çš„ä¸»è¦å·®åˆ«æ˜¯ IP åœ°å€æ‰€ç”¨çš„å­—èŠ‚æ•°ï¼Œç›®å‰é€šç”¨çš„æ˜¯ IPV4 , IPV6 çš„æ™®åŠè¿˜éœ€è¦æ—¶é—´ã€‚</p>
<p>IPV4 æ ‡å‡†çš„ 4 å­—èŠ‚ IP åœ°å€åˆ†ä¸ºç½‘ç»œåœ°å€å’Œä¸»æœºï¼ˆæŒ‡è®¡ç®—æœºï¼‰åœ°å€ï¼Œä¸”åˆ†ä¸º Aã€Bã€Cã€Dã€E ç­‰ç±»å‹ã€‚</p>
<p><img src="https://i.loli.net/2019/01/13/5c3ab0eb17bbe.png" alt="" /></p>
<p>æ•°æ®ä¼ è¾“è¿‡ç¨‹ï¼š</p>
<p><img src="https://i.loli.net/2019/01/13/5c3ab19174fa4.png" alt="" /></p>
<p>æŸä¸»æœºå‘ 203.211.172.103 å’Œ 203.211.217.202 ä¼ é€’æ•°æ®ï¼Œå…¶ä¸­ 203.211.172 å’Œ 203.211.217 ä¸ºè¯¥ç½‘ç»œçš„ç½‘ç»œåœ°å€ï¼Œæ‰€ä»¥ã€Œå‘ç›¸åº”ç½‘ç»œä¼ è¾“æ•°æ®ã€å®é™…ä¸Šæ˜¯å‘æ„æˆç½‘ç»œçš„è·¯ç”±å™¨æˆ–è€…äº¤æ¢æœºä¼ è¾“æ•°æ®ï¼Œç„¶ååˆè·¯ç”±å™¨æˆ–è€…äº¤æ¢æœºæ ¹æ®æ•°æ®ä¸­çš„ä¸»æœºåœ°å€å‘ç›®æ ‡ä¸»æœºä¼ é€’æ•°æ®ã€‚</p>
<h4>3.1.2 ç½‘ç»œåœ°å€åˆ†ç±»ä¸ä¸»æœºåœ°å€è¾¹ç•Œ</h4>
<p>åªéœ€é€šè¿‡IPåœ°å€çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å³å¯åˆ¤æ–­ç½‘ç»œåœ°å€å ç”¨çš„æ€»å­—èŠ‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ ¹æ®IPåœ°å€çš„è¾¹ç•ŒåŒºåˆ†ç½‘ç»œåœ°å€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>A ç±»åœ°å€çš„é¦–å­—èŠ‚èŒƒå›´ä¸ºï¼š0~127</li>
<li>B ç±»åœ°å€çš„é¦–å­—èŠ‚èŒƒå›´ä¸ºï¼š128~191</li>
<li>C ç±»åœ°å€çš„é¦–å­—èŠ‚èŒƒå›´ä¸ºï¼š192~223</li>
</ul>
<p>è¿˜æœ‰å¦‚ä¸‹è¿™ç§è¡¨ç¤ºæ–¹å¼ï¼š</p>
<ul>
<li>A ç±»åœ°å€çš„é¦–ä½ä»¥ 0 å¼€å§‹</li>
<li>B ç±»åœ°å€çš„å‰2ä½ä»¥ 10 å¼€å§‹</li>
<li>C ç±»åœ°å€çš„å‰3ä½ä»¥ 110 å¼€å§‹</li>
</ul>
<p>å› æ­¤å¥—æ¥å­—æ‰‹æ³•æ•°æ®æ—¶ï¼Œæ•°æ®ä¼ åˆ°ç½‘ç»œåå³å¯è½»æ¾æ‰¾åˆ°ä¸»æœºã€‚</p>
<h4>3.1.3 ç”¨äºåŒºåˆ†å¥—æ¥å­—çš„ç«¯å£å·</h4>
<p>IPåœ°å€ç”¨äºåŒºåˆ†è®¡ç®—æœºï¼Œåªè¦æœ‰IPåœ°å€å°±èƒ½å‘ç›®æ ‡ä¸»æœºä¼ è¾“æ•°æ®ï¼Œä½†æ˜¯åªæœ‰è¿™äº›è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬éœ€è¦æŠŠä¿¡æ¯ä¼ è¾“ç»™å…·ä½“çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>æ‰€ä»¥è®¡ç®—æœºä¸€èˆ¬æœ‰ NICï¼ˆç½‘ç»œæ¥å£å¡ï¼‰æ•°æ®ä¼ è¾“è®¾å¤‡ã€‚é€šè¿‡ NIC æ¥å—çš„æ•°æ®å†…æœ‰ç«¯å£å·ï¼Œæ“ä½œç³»ç»Ÿå‚è€ƒç«¯å£å·æŠŠä¿¡æ¯ä¼ ç»™ç›¸åº”çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>ç«¯å£å·ç”± 16 ä½æ„æˆï¼Œå¯åˆ†é…çš„ç«¯å£å·èŒƒå›´æ˜¯ 0~65535 ã€‚ä½†æ˜¯ 0~1023 æ˜¯çŸ¥åç«¯å£ï¼Œä¸€èˆ¬åˆ†é…ç»™ç‰¹å®šçš„åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥åº”å½“åˆ†é…ç»™æ­¤èŒƒå›´ä¹‹å¤–çš„å€¼ã€‚</p>
<p>è™½ç„¶ç«¯å£å·ä¸èƒ½é‡å¤ï¼Œä½†æ˜¯ TCP å¥—æ¥å­—å’Œ UDP å¥—æ¥å­—ä¸ä¼šå…±ç”¨ç«¯æ¥å£å·ï¼Œæ‰€ä»¥å…è®¸é‡å¤ã€‚å¦‚æœæŸ TCP å¥—æ¥å­—ä½¿ç”¨äº† 9190 ç«¯å£å·ï¼Œå…¶ä»– TCP å¥—æ¥å­—å°±æ— æ³•ä½¿ç”¨è¯¥ç«¯å£å·ï¼Œä½†æ˜¯ UDP å¥—æ¥å­—å¯ä»¥ä½¿ç”¨ã€‚</p>
<p>æ€»ä¹‹ï¼Œæ•°æ®ä¼ è¾“ç›®æ ‡åœ°å€åŒæ—¶åŒ…å«IPåœ°å€å’Œç«¯å£å·ï¼Œåªæœ‰è¿™æ ·ï¼Œæ•°æ®æ‰ä¼šè¢«ä¼ è¾“åˆ°æœ€ç»ˆçš„ç›®çš„åº”ç”¨ç¨‹åºã€‚</p>
<h3>3.2 åœ°å€ä¿¡æ¯çš„è¡¨ç¤º</h3>
<p>åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„IPåœ°å€å’Œç«¯å£å·ä»¥ç»“æ„ä½“çš„å½¢å¼ç»™å‡ºäº†å®šä¹‰ã€‚æœ¬èŠ‚å›´ç»•ç»“æ„ä½“è®¨è®ºç›®æ ‡åœ°å€çš„è¡¨ç¤ºæ–¹æ³•ã€‚</p>
<h4>3.2.1 è¡¨ç¤º IPV4 åœ°å€çš„ç»“æ„ä½“</h4>
<p>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">sa_family_t</span> sin_family;  <span class="comment">//åœ°å€æ—ï¼ˆAddress Familyï¼‰</span></span><br><span class="line">    <span class="keyword">uint16_t</span> sin_port;       <span class="comment">//16 ä½ TCP/UDP ç«¯å£å·</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span> <span class="comment">//32ä½ IP åœ°å€</span></span><br><span class="line">    <span class="keyword">char</span> sin_zero[<span class="number">8</span>];        <span class="comment">//ä¸ä½¿ç”¨</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¯¥ç»“æ„ä½“ä¸­æåˆ°çš„å¦ä¸€ä¸ªç»“æ„ä½“ in_addr å®šä¹‰å¦‚ä¸‹ï¼Œå®ƒç”¨æ¥å­˜æ”¾ 32 ä½IPåœ°å€</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">in_addr_t</span> s_addr; <span class="comment">//32ä½IPV4åœ°å€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…³äºä»¥ä¸Šä¸¤ä¸ªç»“æ„ä½“çš„ä¸€äº›æ•°æ®ç±»å‹ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ•°æ®ç±»å‹åç§°</th>
<th style="text-align:center">æ•°æ®ç±»å‹è¯´æ˜</th>
<th style="text-align:center">å£°æ˜çš„å¤´æ–‡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">int 8_t</td>
<td style="text-align:center">signed 8-bit int</td>
<td style="text-align:center">sys/types.h</td>
</tr>
<tr>
<td style="text-align:center">uint8_t</td>
<td style="text-align:center">unsigned 8-bit int (unsigned char)</td>
<td style="text-align:center">sys/types.h</td>
</tr>
<tr>
<td style="text-align:center">int16_t</td>
<td style="text-align:center">signed 16-bit int</td>
<td style="text-align:center">sys/types.h</td>
</tr>
<tr>
<td style="text-align:center">uint16_t</td>
<td style="text-align:center">unsigned 16-bit int (unsigned short)</td>
<td style="text-align:center">sys/types.h</td>
</tr>
<tr>
<td style="text-align:center">int32_t</td>
<td style="text-align:center">signed 32-bit int</td>
<td style="text-align:center">sys/types.h</td>
</tr>
<tr>
<td style="text-align:center">uint32_t</td>
<td style="text-align:center">unsigned 32-bit int (unsigned long)</td>
<td style="text-align:center">sys/types.h</td>
</tr>
<tr>
<td style="text-align:center">sa_family_t</td>
<td style="text-align:center">åœ°å€æ—ï¼ˆaddress familyï¼‰</td>
<td style="text-align:center">sys/socket.h</td>
</tr>
<tr>
<td style="text-align:center">socklen_t</td>
<td style="text-align:center">é•¿åº¦ï¼ˆlength of structï¼‰</td>
<td style="text-align:center">sys/socket.h</td>
</tr>
<tr>
<td style="text-align:center">in_addr_t</td>
<td style="text-align:center">IPåœ°å€ï¼Œå£°æ˜ä¸º uint_32_t</td>
<td style="text-align:center">netinet/in.h</td>
</tr>
<tr>
<td style="text-align:center">in_port_t</td>
<td style="text-align:center">ç«¯å£å·ï¼Œå£°æ˜ä¸º uint_16_t</td>
<td style="text-align:center">netinet/in.h</td>
</tr>
</tbody>
</table>
<p>ä¸ºä»€ä¹ˆè¦é¢å¤–å®šä¹‰è¿™äº›æ•°æ®ç±»å‹å‘¢ï¼Ÿè¿™æ˜¯è€ƒè™‘æ‰©å±•æ€§çš„ç»“æœ</p>
<h4>3.2.2 ç»“æ„ä½“ sockaddr_in çš„æˆå‘˜åˆ†æ</h4>
<ul>
<li>æˆå‘˜ sin_family</li>
</ul>
<p>æ¯ç§åè®®é€‚ç”¨çš„åœ°å€æ—ä¸åŒï¼Œæ¯”å¦‚ï¼ŒIPV4 ä½¿ç”¨ 4 å­—èŠ‚çš„åœ°å€æ—ï¼ŒIPV6 ä½¿ç”¨ 16 å­—èŠ‚çš„åœ°å€æ—ã€‚</p>
<blockquote>
<p>åœ°å€æ—</p>
</blockquote>
<table>
<thead>
<tr>
<th>åœ°å€æ—ï¼ˆAddress Familyï¼‰</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>AF_INET</td>
<td>IPV4ç”¨çš„åœ°å€æ—</td>
</tr>
<tr>
<td>AF_INET6</td>
<td>IPV6ç”¨çš„åœ°å€æ—</td>
</tr>
<tr>
<td>AF_LOCAL</td>
<td>æœ¬åœ°é€šä¿¡ä¸­é‡‡ç”¨çš„ Unix åè®®çš„åœ°å€æ—</td>
</tr>
</tbody>
</table>
<p>AF_LOACL åªæ˜¯ä¸ºäº†è¯´æ˜å…·æœ‰å¤šç§åœ°å€æ—è€Œæ·»åŠ çš„ã€‚</p>
<ul>
<li>
<p>æˆå‘˜ sin_port</p>
<p>è¯¥æˆå‘˜ä¿å­˜ 16 ä½ç«¯å£å·ï¼Œé‡ç‚¹åœ¨äºï¼Œå®ƒä»¥ç½‘ç»œå­—èŠ‚åºä¿å­˜ã€‚</p>
</li>
<li>
<p>æˆå‘˜ sin_addr</p>
<p>è¯¥æˆå‘˜ä¿å­˜ 32 ä¸ºIPåœ°å€ä¿¡æ¯ï¼Œä¸”ä¹Ÿä»¥ç½‘ç»œå­—èŠ‚åºä¿å­˜</p>
</li>
<li>
<p>æˆå‘˜ sin_zero</p>
<p>æ— ç‰¹æ®Šå«ä¹‰ã€‚åªæ˜¯ä¸ºç»“æ„ä½“ sockaddr_in ç»“æ„ä½“å˜é‡åœ°å€å€¼å°†ä»¥å¦‚ä¸‹æ–¹å¼ä¼ é€’ç»™ bind å‡½æ•°ã€‚</p>
<p>åœ¨ä¹‹å‰çš„ä»£ç ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (bind(serv_sock, (struct sockaddr *)&amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr)) == <span class="number">-1</span>)</span><br><span class="line">    error_handling(<span class="string">"bind() error"</span>);</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤„ bind ç¬¬äºŒä¸ªå‚æ•°æœŸæœ›å¾—åˆ°çš„æ˜¯ sockaddr ç»“æ„ä½“å˜é‡çš„åœ°å€å€¼ï¼ŒåŒ…æ‹¬åœ°å€æ—ã€ç«¯å£å·ã€IPåœ°å€ç­‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">sa_family_t</span> sin_family; <span class="comment">//åœ°å€æ—</span></span><br><span class="line">    <span class="keyword">char</span> sa_data[<span class="number">14</span>];       <span class="comment">//åœ°å€ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤ç»“æ„ä½“ sa_data ä¿å­˜çš„åœ°å€ä¿¡æ¯ä¸­éœ€è¦åŒ…å«IPåœ°å€å’Œç«¯å£å·ï¼Œå‰©ä½™éƒ¨åˆ†åº”è¯¥å¡«å…… 0 ï¼Œä½†æ˜¯è¿™æ ·å¯¹äºåŒ…å«åœ°å€çš„ä¿¡æ¯éå¸¸éº»çƒ¦ï¼Œæ‰€ä»¥å‡ºç°äº† sockaddr_in ç»“æ„ä½“ï¼Œç„¶åå¼ºåˆ¶è½¬æ¢æˆ sockaddr ç±»å‹ï¼Œåˆ™ç”Ÿæˆç¬¦åˆ bind æ¡ä»¶çš„å‚æ•°ã€‚</p>
</li>
</ul>
<h3>3.3 ç½‘ç»œå­—èŠ‚åºä¸åœ°å€å˜æ¢</h3>
<p>ä¸åŒçš„ CPU ä¸­ï¼Œ4 å­—èŠ‚æ•´æ•°å€¼1åœ¨å†…å­˜ç©ºé—´ä¿å­˜æ–¹å¼æ˜¯ä¸åŒçš„ã€‚</p>
<p>æœ‰äº› CPU è¿™æ ·ä¿å­˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00000000 00000000 00000000 00000001</span><br></pre></td></tr></table></figure>
<p>æœ‰äº› CPU è¿™æ ·ä¿å­˜ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00000001 00000000 00000000 00000000</span><br></pre></td></tr></table></figure>
<p>ä¸¤ç§ä¸€ç§æ˜¯é¡ºåºä¿å­˜ï¼Œä¸€ç§æ˜¯å€’åºä¿å­˜ ã€‚</p>
<h4>3.3.1 å­—èŠ‚åºï¼ˆOrderï¼‰ä¸ç½‘ç»œå­—èŠ‚åº</h4>
<p>CPU ä¿å­˜æ•°æ®çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œè¿™æ„å‘³ç€ CPU è§£ææ•°æ®çš„æ–¹å¼ä¹Ÿæœ‰ 2 ç§ï¼š</p>
<ul>
<li>å¤§ç«¯åºï¼ˆBig Endianï¼‰ï¼šé«˜ä½å­—èŠ‚å­˜æ”¾åˆ°ä½ä½åœ°å€</li>
<li>å°ç«¯åºï¼ˆLittle Endianï¼‰ï¼šé«˜ä½å­—èŠ‚å­˜æ”¾åˆ°é«˜ä½åœ°å€</li>
</ul>
<p><img src="https://i.loli.net/2019/01/13/5c3ac9c1b2550.png" alt="big.png" /><br />
<img src="https://i.loli.net/2019/01/13/5c3ac9c1c3348.png" alt="small.png" /></p>
<p>ä¸¤å°å­—èŠ‚åºä¸åŒçš„è®¡ç®—æœºåœ¨æ•°æ®ä¼ é€’çš„è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š</p>
<p><img src="https://i.loli.net/2019/01/13/5c3aca956c8e9.png" alt="zijiexu.png" /></p>
<p>å› ä¸ºè¿™ç§åŸå› ï¼Œæ‰€ä»¥åœ¨é€šè¿‡ç½‘ç»œä¼ è¾“æ•°æ®æ—¶å¿…é¡»çº¦å®šç»Ÿä¸€çš„æ–¹å¼ï¼Œè¿™ç§çº¦å®šè¢«ç§°ä¸ºç½‘ç»œå­—èŠ‚åºï¼Œéå¸¸ç®€å•ï¼Œç»Ÿä¸€ä¸ºå¤§ç«¯åºã€‚å³ï¼Œå…ˆæŠŠæ•°æ®æ•°ç»„è½¬åŒ–æˆå¤§ç«¯åºæ ¼å¼å†è¿›è¡Œç½‘ç»œä¼ è¾“ã€‚</p>
<h4>3.3.2 å­—èŠ‚åºè½¬æ¢</h4>
<p>å¸®åŠ©è½¬æ¢å­—èŠ‚åºçš„å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> short <span class="title">htons</span><span class="params">(<span class="keyword">unsigned</span> short)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> short <span class="title">ntohs</span><span class="params">(<span class="keyword">unsigned</span> short)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">htonl</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">ntohl</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å‡½æ•°åç§°æŒæ¡å…¶åŠŸèƒ½ï¼Œåªéœ€è¦äº†è§£ï¼š</p>
<ul>
<li>htons çš„ h ä»£è¡¨ä¸»æœºï¼ˆhostï¼‰å­—èŠ‚åºã€‚</li>
<li>htons çš„ n ä»£è¡¨ç½‘ç»œï¼ˆnetworkï¼‰å­—èŠ‚åºã€‚</li>
<li>s ä»£è¡¨ short</li>
<li>l ä»£è¡¨ long</li>
</ul>
<p>ä¸‹é¢çš„ä»£ç æ˜¯ç¤ºä¾‹ï¼Œè¯´æ˜ä»¥ä¸Šå‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼š</p>
<p><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch03/endian_conv.c" target="_blank" rel="noopener">endian_conv.c</a></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> short host_port = <span class="number">0x1234</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> short net_port;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> host_addr = <span class="number">0x12345678</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> net_addr;</span><br><span class="line"></span><br><span class="line">    net_port = htons(host_port); <span class="comment">//è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åº</span></span><br><span class="line">    net_addr = htonl(host_addr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Host ordered port: %#x \n"</span>, host_port);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Network ordered port: %#x \n"</span>, net_port);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Host ordered address: %#lx \n"</span>, host_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Network ordered address: %#lx \n"</span>, net_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc endian_conv.c -o conv</span><br><span class="line">./conv</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Host ordered port: 0x1234</span><br><span class="line">Network ordered port: 0x3412</span><br><span class="line">Host ordered address: 0x12345678</span><br><span class="line">Network ordered address: 0x78563412</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯åœ¨å°ç«¯ CPU çš„è¿è¡Œç»“æœã€‚å¤§éƒ¨åˆ†äººä¼šå¾—åˆ°ç›¸åŒçš„ç»“æœï¼Œå› ä¸º Intel å’Œ AMD çš„ CPU éƒ½æ˜¯å°ç«¯åºä¸ºæ ‡å‡†ã€‚</p>
<h3>3.4 ç½‘ç»œåœ°å€çš„åˆå§‹åŒ–ä¸åˆ†é…</h3>
<h4>3.4.1 å°†å­—ç¬¦ä¸²ä¿¡æ¯è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºçš„æ•´æ•°å‹</h4>
<p>sockaddr_in ä¸­éœ€è¦çš„æ˜¯ 32 ä½æ•´æ•°å‹ï¼Œä½†æ˜¯æˆ‘ä»¬åªç†Ÿæ‚‰ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºæ³•ï¼Œé‚£ä¹ˆæ”¹å¦‚ä½•æŠŠç±»ä¼¼äº 201.211.214.36 è½¬æ¢ä¸º 4 å­—èŠ‚çš„æ•´æ•°ç±»å‹æ•°æ®å‘¢ ?å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆå®ƒã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">in_addr_t</span> <span class="title">inet_addr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“ç¤ºä¾‹ï¼š</p>
<p><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch03/inet_addr.c" target="_blank" rel="noopener">inet_addr.c</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *addr1 = <span class="string">"1.2.3.4"</span>;</span><br><span class="line">    <span class="keyword">char</span> *addr2 = <span class="string">"1.2.3.256"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> conv_addr = inet_addr(addr1);</span><br><span class="line">    <span class="keyword">if</span> (conv_addr == INADDR_NONE)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Error occured! \n"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Network ordered integer addr: %#lx \n"</span>, conv_addr);</span><br><span class="line"></span><br><span class="line">    conv_addr = inet_addr(addr2);</span><br><span class="line">    <span class="keyword">if</span> (conv_addr == INADDR_NONE)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Error occured! \n"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Network ordered integer addr: %#lx \n"</span>, conv_addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc inet_addr.c -o addr</span><br><span class="line">./addr</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Network ordered integer addr: 0x4030201</span><br><span class="line">Error occured!</span><br></pre></td></tr></table></figure>
<p>1ä¸ªå­—èŠ‚èƒ½è¡¨ç¤ºçš„æœ€å¤§æ•´æ•°æ˜¯255ï¼Œæ‰€ä»¥ä»£ç ä¸­ addr2 æ˜¯é”™è¯¯çš„IPåœ°å€ã€‚ä»è¿è¡Œç»“æœçœ‹ï¼Œinet_addr ä¸ä»…å¯ä»¥è½¬æ¢åœ°å€ï¼Œè¿˜å¯ä»¥æ£€æµ‹æœ‰æ•ˆæ€§ã€‚</p>
<p>inet_aton å‡½æ•°ä¸ inet_addr å‡½æ•°åœ¨åŠŸèƒ½ä¸Šå®Œå…¨ç›¸åŒï¼Œä¹Ÿæ˜¯å°†å­—ç¬¦ä¸²å½¢å¼çš„IPåœ°å€è½¬æ¢æˆæ•´æ•°å‹çš„IPåœ°å€ã€‚åªä¸è¿‡è¯¥å‡½æ•°ç”¨äº† in_addr ç»“æ„ä½“ï¼Œä¸”ä½¿ç”¨é¢‘ç‡æ›´é«˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_aton</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>, struct in_addr *addr)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 1 ï¼Œå¤±è´¥æ—¶è¿”å› 0</span></span><br><span class="line"><span class="comment">string: å«æœ‰éœ€è¦è½¬æ¢çš„IPåœ°å€ä¿¡æ¯çš„å­—ç¬¦ä¸²åœ°å€å€¼</span></span><br><span class="line"><span class="comment">addr: å°†ä¿å­˜è½¬æ¢ç»“æœçš„ in_addr ç»“æ„ä½“å˜é‡çš„åœ°å€å€¼</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>å‡½æ•°è°ƒç”¨ç¤ºä¾‹ï¼š</p>
<p><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch03/inet_aton.c" target="_blank" rel="noopener">inet_aton.c</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *addr = <span class="string">"127.232.124.79"</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr_inet</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!inet_aton(addr, &amp;addr_inet.sin_addr))</span><br><span class="line">        error_handling(<span class="string">"Conversion error"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Network ordered integer addr: %#x \n"</span>, addr_inet.sin_addr.s_addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gcc inet_aton.c -o aton</span><br><span class="line">./aton</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Network ordered integer addr: 0x4f7ce87f</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œå·²ç»æˆåŠŸçš„æŠŠè½¬æ¢åçš„åœ°å€æ”¾è¿›äº† addr_inet.sin_addr.s_addr ä¸­ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªå‡½æ•°ï¼Œä¸ inet_aton() æ­£å¥½ç›¸åï¼Œå®ƒå¯ä»¥æŠŠç½‘ç»œå­—èŠ‚åºæ•´æ•°å‹IPåœ°å€è½¬æ¢æˆæˆ‘ä»¬ç†Ÿæ‚‰çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">inet_ntoa</span><span class="params">(struct in_addr adr)</span></span>;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°å°†é€šè¿‡å‚æ•°ä¼ å…¥çš„æ•´æ•°å‹IPåœ°å€è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼å¹¶è¿”å›ã€‚ä½†è¦å°å¿ƒï¼Œè¿”å›å€¼ä¸º char æŒ‡é’ˆï¼Œè¿”å›å­—ç¬¦ä¸²åœ°å€æ„å‘³ç€å­—ç¬¦ä¸²å·²ç»ä¿å­˜åœ¨å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯è¯¥å‡½æ•°æœªå‘ç¨‹åºå‘˜è¦æ±‚åˆ†é…å†…å­˜ï¼Œè€Œæ˜¯å†å†…éƒ¨ç”³è¯·äº†å†…å­˜ä¿å­˜äº†å­—ç¬¦ä¸²ã€‚ä¹Ÿå°±æ˜¯è¯´è°ƒç”¨äº†è¯¥å‡½æ•°å€™è¦ç«‹å³æŠŠä¿¡æ¯å¤åˆ¶åˆ°å…¶ä»–å†…å­˜ç©ºé—´ã€‚å› æ­¤ï¼Œè‹¥å†æ¬¡è°ƒç”¨ inet_ntoa å‡½æ•°ï¼Œåˆ™æœ‰å¯èƒ½è¦†ç›–ä¹‹å‰ä¿å­˜çš„å­—ç¬¦ä¸²ä¿¡æ¯ã€‚æ€»ä¹‹ï¼Œå†æ¬¡è°ƒç”¨ inet_ntoa å‡½æ•°å‰è¿”å›çš„å­—ç¬¦ä¸²åœ°å€æ˜¯æœ‰æ•ˆçš„ã€‚è‹¥éœ€è¦é•¿æœŸä¿å­˜ï¼Œåˆ™åº”è¯¥å°†å­—ç¬¦ä¸²å¤åˆ¶åˆ°å…¶ä»–å†…å­˜ç©ºé—´ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<p><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch03/inet_ntoa.c" target="_blank" rel="noopener">inet_ntoa.c</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr1</span>, <span class="title">addr2</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *str_ptr;</span><br><span class="line">    <span class="keyword">char</span> str_arr[<span class="number">20</span>];</span><br><span class="line"></span><br><span class="line">    addr1.sin_addr.s_addr = htonl(<span class="number">0x1020304</span>);</span><br><span class="line">    addr2.sin_addr.s_addr = htonl(<span class="number">0x1010101</span>);</span><br><span class="line">    <span class="comment">//æŠŠaddr1ä¸­çš„ç»“æ„ä½“ä¿¡æ¯è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„IPåœ°å€å½¢å¼</span></span><br><span class="line">    str_ptr = inet_ntoa(addr1.sin_addr);</span><br><span class="line">    <span class="built_in">strcpy</span>(str_arr, str_ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Dotted-Decimal notation1: %s \n"</span>, str_ptr);</span><br><span class="line"></span><br><span class="line">    inet_ntoa(addr2.sin_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Dotted-Decimal notation2: %s \n"</span>, str_ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Dotted-Decimal notation3: %s \n"</span>, str_arr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc inet_ntoa.c -o ntoa</span><br><span class="line">./ntoa</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Dotted-Decimal notation1: <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">Dotted-Decimal notation2: <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">Dotted-Decimal notation3: <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>
<h4>3.4.2 ç½‘ç»œåœ°å€åˆå§‹åŒ–</h4>
<p>ç»“åˆå‰é¢çš„å†…å®¹ï¼Œä»‹ç»å¥—æ¥å­—åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå¸¸è§çš„ç½‘ç»œä¿¡æ¯åˆå§‹åŒ–æ–¹æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line"><span class="keyword">char</span> *serv_ip = <span class="string">"211.217,168.13"</span>;          <span class="comment">//å£°æ˜IPåœ°å€æ—</span></span><br><span class="line"><span class="keyword">char</span> *serv_port = <span class="string">"9190"</span>;                  <span class="comment">//å£°æ˜ç«¯å£å·å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr));            <span class="comment">//ç»“æ„ä½“å˜é‡ addr çš„æ‰€æœ‰æˆå‘˜åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">addr.sin_family = AF_INET;                 <span class="comment">//åˆ¶å®šåœ°å€æ—</span></span><br><span class="line">addr.sin_addr.s_addr = inet_addr(serv_ip); <span class="comment">//åŸºäºå­—ç¬¦ä¸²çš„IPåœ°å€åˆå§‹åŒ–</span></span><br><span class="line">addr.sin_port = htons(atoi(serv_port));    <span class="comment">//åŸºäºå­—ç¬¦ä¸²çš„IPåœ°å€ç«¯å£å·åˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure>
<h3>3.5 åŸºäº Windows çš„å®ç°</h3>
<p>ç•¥</p>
<h3>3.6 ä¹ é¢˜</h3>
<blockquote>
<p>ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œä¸ä¸€å®šæ­£ç¡®</p>
</blockquote>
<ol>
<li>
<p><strong>IPåœ°å€æ— IPV4 ä¸ IPV6 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿåœ¨ä½•ç§èƒŒæ™¯ä¸‹è¯ç”Ÿäº† IPV6?</strong></p>
<p>ç­”ï¼šä¸»è¦å·®åˆ«æ˜¯IPåœ°å€æ‰€ç”¨çš„å­—èŠ‚æ•°ï¼Œç›®å‰é€šç”¨çš„æ˜¯IPV4ï¼Œç›®å‰IPV4çš„èµ„æºå·²è€—å°½ï¼Œæ‰€ä»¥è¯ç”Ÿäº†IPV6ï¼Œå®ƒå…·æœ‰æ›´å¤§çš„åœ°å€ç©ºé—´ã€‚</p>
</li>
<li>
<p><strong>é€šè¿‡ IPV4 ç½‘ç»œ ID ã€ä¸»æœº ID åŠè·¯ç”±å™¨çš„å…³ç³»è¯´æ˜å…¬å¸å±€åŸŸç½‘çš„è®¡ç®—æœºä¼ è¾“æ•°æ®çš„è¿‡ç¨‹</strong></p>
<p>ç­”ï¼šç½‘ç»œIDæ˜¯ä¸ºäº†åŒºåˆ†ç½‘ç»œè€Œè®¾ç½®çš„ä¸€éƒ¨åˆ†IPåœ°å€ï¼Œå‡è®¾å‘<code>www.baidu.com</code>å…¬å¸ä¼ è¾“æ•°æ®ï¼Œè¯¥å…¬å¸å†…éƒ¨æ„å»ºäº†å±€åŸŸç½‘ã€‚å› ä¸ºé¦–å…ˆè¦å‘<code>baidu.com</code>ä¼ è¾“æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å¹¶éä¸€å¼€å§‹å°±æµè§ˆæ‰€æœ‰å››å­—èŠ‚IPåœ°å€ï¼Œé¦–å…ˆæ‰¾åˆ°ç½‘ç»œåœ°å€ï¼Œè¿›è€Œç”±<code>baidu.com</code>ï¼ˆæ„æˆç½‘ç»œçš„è·¯ç”±å™¨ï¼‰æ¥æ”¶åˆ°æ•°æ®åï¼Œä¼ è¾“åˆ°ä¸»æœºåœ°å€ã€‚æ¯”å¦‚å‘ 203.211.712.103 ä¼ è¾“æ•°æ®ï¼Œé‚£å°±å…ˆæ‰¾åˆ° 203.211.172 ç„¶åç”±è¿™ä¸ªç½‘ç»œçš„ç½‘å…³æ‰¾ä¸»æœºå·ä¸º 172 çš„æœºå™¨ä¼ è¾“æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>å¥—æ¥å­—åœ°å€åˆ†ä¸ºIPåœ°å€å’Œç«¯å£å·ï¼Œä¸ºä»€ä¹ˆéœ€è¦IPåœ°å€å’Œç«¯å£å·ï¼Ÿæˆ–è€…è¯´ï¼Œé€šè¿‡IPåœ°å€å¯ä»¥åŒºåˆ†å“ªäº›å¯¹è±¡ï¼Ÿé€šè¿‡ç«¯å£å·å¯ä»¥åŒºåˆ†å“ªäº›å¯¹è±¡ï¼Ÿ</strong></p>
<p>ç­”ï¼šæœ‰äº†IPåœ°å€å’Œç«¯å£å·ï¼Œæ‰èƒ½æŠŠæ•°æ®å‡†ç¡®çš„ä¼ é€åˆ°æŸä¸ªåº”ç”¨ç¨‹åºä¸­ã€‚é€šè¿‡IPåœ°å€å¯ä»¥åŒºåˆ†å…·ä½“çš„ä¸»æœºï¼Œé€šè¿‡ç«¯å£å·å¯ä»¥åŒºåˆ†ä¸»æœºä¸Šçš„åº”ç”¨ç¨‹åºã€‚</p>
</li>
<li>
<p><strong>è¯·è¯´æ˜IPåœ°å€çš„åˆ†ç±»æ–¹æ³•ï¼Œå¹¶æ®æ­¤è¯´å‡ºä¸‹é¢è¿™äº›IPçš„åˆ†ç±»ã€‚</strong></p>
<ul>
<li>214.121.212.102ï¼ˆCç±»ï¼‰</li>
<li>120.101.122.89ï¼ˆAç±»ï¼‰</li>
<li>129.78.102.211ï¼ˆBç±»ï¼‰</li>
</ul>
<p>åˆ†ç±»æ–¹æ³•ï¼šA ç±»åœ°å€çš„é¦–å­—èŠ‚èŒƒå›´ä¸ºï¼š0~127ã€B ç±»åœ°å€çš„é¦–å­—èŠ‚èŒƒå›´ä¸ºï¼š128~191ã€C ç±»åœ°å€çš„é¦–å­—èŠ‚èŒƒå›´ä¸ºï¼š192~223</p>
</li>
<li>
<p><strong>è®¡ç®—æœºé€šè¿‡è·¯ç”±å™¨å’Œäº¤æ¢æœºè¿æ¥åˆ°äº’è”ç½‘ï¼Œè¯·è¯´å‡ºè·¯ç”±å™¨å’Œäº¤æ¢æœºçš„ä½œç”¨ã€‚</strong></p>
<p>ç­”ï¼šè·¯ç”±å™¨å’Œäº¤æ¢æœºå®Œæˆå¤–ç½‘å’Œæœ¬ç½‘ä¸»æœºä¹‹é—´çš„æ•°æ®äº¤æ¢ã€‚</p>
</li>
<li>
<p><strong>ä»€ä¹ˆæ˜¯çŸ¥åç«¯å£ï¼Ÿå…¶èŒƒå›´æ˜¯å¤šå°‘ï¼ŸçŸ¥åç«¯å£ä¸­å…·æœ‰ä»£è¡¨æ€§çš„ HTTP å’Œ FTP çš„ç«¯å£å·å„æ˜¯å¤šå°‘ï¼Ÿ</strong></p>
<p>ç­”ï¼šçŸ¥åç«¯å£æ˜¯è¦æŠŠè¯¥ç«¯å£åˆ†é…ç»™ç‰¹å®šçš„åº”ç”¨ç¨‹åºï¼ŒèŒƒå›´æ˜¯ 0~1023 ï¼ŒHTTP çš„ç«¯å£å·æ˜¯ 80 ï¼ŒFTP çš„ç«¯å£å·æ˜¯20å’Œ21</p>
</li>
<li>
<p><strong>å‘å¥—æ¥å­—åˆ†é…åœ°å€çš„ bind å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *myaddr, <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br></pre></td></tr></table></figure>
<p><strong>è€Œè°ƒç”¨æ—¶åˆ™ç”¨ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bind(serv_sock, (struct sockaddr *)&amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr)</span><br></pre></td></tr></table></figure>
<p><strong>æ­¤å¤„ serv_addr ä¸º sockaddr_in ç»“æ„ä½“å˜é‡ã€‚ä¸å‡½æ•°åŸå‹ä¸åŒï¼Œä¼ å…¥çš„æ˜¯ sockaddr_in ç»“æ„ä½“å˜é‡ï¼Œè¯·è¯´æ˜åŸå› ã€‚</strong></p>
<p>ç­”ï¼šå› ä¸ºå¯¹äºè¯¦ç»†çš„åœ°å€ä¿¡æ¯ä½¿ç”¨ sockaddr ç±»å‹ä¼ é€’ç‰¹åˆ«éº»çƒ¦ï¼Œè¿›è€Œæœ‰äº† sockaddr_in ç±»å‹ï¼Œå…¶ä¸­åŸºæœ¬ä¸å‰é¢çš„ç±»å‹ä¿æŒä¸€è‡´ï¼Œè¿˜æœ‰ sa_sata[4] æ¥ä¿å­˜åœ°å€ä¿¡æ¯ï¼Œå‰©ä½™å…¨éƒ¨å¡« 0ï¼Œæ‰€ä»¥å¼ºåˆ¶è½¬æ¢åï¼Œä¸å½±å“ç¨‹åºè¿è¡Œã€‚</p>
</li>
<li>
<p><strong>è¯·è§£é‡Šå¤§ç«¯åºï¼Œå°ç«¯åºã€ç½‘ç»œå­—èŠ‚åºï¼Œå¹¶è¯´æ˜ä¸ºä½•éœ€è¦ç½‘ç»œå­—èŠ‚åºã€‚</strong></p>
<p>ç­”ï¼šCPU å‘å†…å­˜ä¿å­˜æ•°æ®æœ‰ä¸¤ç§æ–¹å¼ï¼Œå¤§ç«¯åºæ˜¯é«˜ä½å­—èŠ‚å­˜æ”¾ä½ä½åœ°å€ï¼Œå°ç«¯åºæ˜¯é«˜ä½å­—èŠ‚å­˜æ”¾é«˜ä½åœ°å€ï¼Œç½‘ç»œå­—èŠ‚åºæ˜¯ä¸ºäº†æ–¹ä¾¿ä¼ è¾“çš„ä¿¡æ¯ç»Ÿä¸€æ€§ï¼Œç»Ÿä¸€æˆäº†å¤§ç«¯åºã€‚</p>
</li>
<li>
<p><strong>å¤§ç«¯åºè®¡ç®—æœºå¸Œæœ›æŠŠ 4 å­—èŠ‚æ•´æ•°å‹ 12 ä¼ é€’åˆ°å°ç«¯åºè®¡ç®—æœºã€‚è¯·è¯´å‡ºæ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­å‘ç”Ÿçš„å­—èŠ‚åºå˜æ¢è¿‡ç¨‹ã€‚</strong></p>
<p>ç­”ï¼š0x12-&gt;0x21</p>
</li>
<li>
<p><strong>æ€æ ·è¡¨ç¤ºå›é€åœ°å€ï¼Ÿå…¶å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœå‘ä¼šé€åœ°å€å¤„ä¼ è¾“æ•°æ®å°†ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ</strong></p>
<p>ç­”ï¼š127.0.0.1 è¡¨ç¤ºå›é€åœ°å€ï¼ŒæŒ‡çš„æ˜¯è®¡ç®—æœºè‡ªèº«çš„IPåœ°å€ï¼Œæ— è®ºä»€ä¹ˆç¨‹åºï¼Œä¸€æ—¦ä½¿ç”¨å›é€åœ°å€å‘é€æ•°æ®ï¼Œåè®®è½¯ä»¶ç«‹å³è¿”å›ï¼Œä¸è¿›è¡Œä»»ä½•ç½‘ç»œä¼ è¾“ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 4 ç«  åŸºäº TCP çš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯ï¼ˆ1ï¼‰</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>4.1 ç†è§£ TCP å’Œ UDP</h3>
<p>æ ¹æ®æ•°æ®ä¼ è¾“æ–¹å¼çš„ä¸åŒï¼ŒåŸºäºç½‘ç»œåè®®çš„å¥—æ¥å­—ä¸€èˆ¬åˆ†ä¸º TCP å¥—æ¥å­—å’Œ UDP å¥—æ¥å­—ã€‚å› ä¸º TCP å¥—æ¥å­—æ˜¯é¢å‘è¿æ¥çš„ï¼Œå› æ­¤åˆè¢«ç§°ä¸ºåŸºäºæµï¼ˆstreamï¼‰çš„å¥—æ¥å­—ã€‚</p>
<p>TCP æ˜¯ Transmission Control Protocol ï¼ˆä¼ è¾“æ§åˆ¶åè®®ï¼‰çš„ç®€å†™ï¼Œæ„ä¸ºã€Œå¯¹æ•°æ®ä¼ è¾“è¿‡ç¨‹çš„æ§åˆ¶ã€ã€‚å› æ­¤ï¼Œå­¦ä¹ æ§åˆ¶æ–¹æ³•åŠèŒƒå›´æœ‰åŠ©äºæ­£ç¡®ç†è§£ TCP å¥—æ¥å­—ã€‚</p>
<h4>4.1.1 TCP/IP åè®®æ ˆ</h4>
<p><img src="https://i.loli.net/2019/01/14/5c3c21889db06.png" alt="" /></p>
<p>TCP/IP åè®®æ ˆå…±åˆ†ä¸º 4 å±‚ï¼Œå¯ä»¥ç†è§£ä¸ºæ•°æ®æ”¶å‘åˆ†æˆäº† 4 ä¸ªå±‚æ¬¡åŒ–è¿‡ç¨‹ï¼Œé€šè¿‡å±‚æ¬¡åŒ–çš„æ–¹å¼æ¥è§£å†³é—®é¢˜</p>
<h4>4.1.2 é“¾è·¯å±‚</h4>
<p>é“¾è·¯å±‚æ˜¯ç‰©ç†é“¾æ¥é¢†åŸŸæ ‡å‡†åŒ–çš„ç»“æœï¼Œä¹Ÿæ˜¯æœ€åŸºæœ¬çš„é¢†åŸŸï¼Œä¸“é—¨å®šä¹‰LANã€WANã€MANç­‰ç½‘ç»œæ ‡å‡†ã€‚è‹¥ä¸¤å°ä¸»æœºé€šè¿‡ç½‘ç»œè¿›è¡Œæ•°æ®äº¤æ¢ï¼Œåˆ™éœ€è¦ç‰©ç†è¿æ¥ï¼Œé“¾è·¯å±‚å°±è´Ÿè´£è¿™äº›æ ‡å‡†ã€‚</p>
<h4>4.1.3 IP å±‚</h4>
<p>è½¬å¤‡å¥½ç‰©ç†è¿æ¥å€™å°±è¦ä¼ è¾“æ•°æ®ã€‚ä¸ºäº†å†å¤æ‚ç½‘ç»œä¸­ä¼ è¾“æ•°æ®ï¼Œé¦–å…ˆè¦è€ƒè™‘è·¯å¾„çš„é€‰æ‹©ã€‚å‘ç›®æ ‡ä¼ è¾“æ•°æ®éœ€è¦ç»è¿‡å“ªæ¡è·¯å¾„ï¼Ÿè§£å†³æ­¤é—®é¢˜çš„å°±æ˜¯IPå±‚ï¼Œè¯¥å±‚ä½¿ç”¨çš„åè®®å°±æ˜¯IPã€‚</p>
<p>IP æ˜¯é¢å‘æ¶ˆæ¯çš„ã€ä¸å¯é çš„åè®®ã€‚æ¯æ¬¡ä¼ è¾“æ•°æ®æ—¶ä¼šå¸®æˆ‘ä»¬é€‰æ‹©è·¯å¾„ï¼Œä½†å¹¶ä¸ä¸€è‡´ã€‚å¦‚æœä¼ è¾“è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œåˆ™é€‰æ‹©å…¶ä»–è·¯å¾„ï¼Œä½†æ˜¯å¦‚æœå‘ç”Ÿæ•°æ®ä¸¢å¤±æˆ–é”™è¯¯ï¼Œåˆ™æ— æ³•è§£å†³ã€‚æ¢è¨€ä¹‹ï¼ŒIPåè®®æ— æ³•åº”å¯¹æ•°æ®é”™è¯¯ã€‚</p>
<h4>4.1.4 TCP/UDP å±‚</h4>
<p>IP å±‚è§£å†³æ•°æ®ä¼ è¾“ä¸­çš„è·¯å¾„é€‰æ‹©é—®é¢˜ï¼Œç§©åºç…§æ­¤è·¯å¾„ä¼ è¾“æ•°æ®å³å¯ã€‚TCP å’Œ UDP å±‚ä»¥ IP å±‚æä¾›çš„è·¯å¾„ä¿¡æ¯ä¸ºåŸºç¡€å®Œæˆå®é™…çš„æ•°æ®ä¼ è¾“ï¼Œæ•…è¯¥å±‚åˆç§°ä¸ºä¼ è¾“å±‚ã€‚UDP æ¯” TCP ç®€å•ï¼Œç°åœ¨æˆ‘ä»¬åªè§£é‡Š TCP ã€‚ TCP å¯ä»¥ä¿è¯æ•°æ®çš„å¯é ä¼ è¾“ï¼Œä½†æ˜¯å®ƒå‘é€æ•°æ®æ—¶ä»¥ IP å±‚ä¸ºåŸºç¡€ï¼ˆè¿™ä¹Ÿæ˜¯åè®®æ ˆå±‚æ¬¡åŒ–çš„åŸå› ï¼‰</p>
<p>IP å±‚åªå…³æ³¨ä¸€ä¸ªæ•°æ®åŒ…ï¼ˆæ•°æ®ä¼ è¾“åŸºæœ¬å•ä½ï¼‰çš„ä¼ è¾“è¿‡ç¨‹ã€‚å› æ­¤ï¼Œå³ä½¿ä¼ è¾“å¤šä¸ªæ•°æ®åŒ…ï¼Œæ¯ä¸ªæ•°æ®åŒ…ä¹Ÿæ˜¯ç”± IP å±‚å®é™…ä¼ è¾“çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼ è¾“é¡ºåºåŠä¼ è¾“æœ¬èº«æ˜¯ä¸å¯é çš„ã€‚è‹¥åªåˆ©ç”¨IPå±‚ä¼ è¾“æ•°æ®ï¼Œåˆ™å¯èƒ½å¯¼è‡´åä¼ è¾“çš„æ•°æ®åŒ…Bæ¯”å…ˆä¼ è¾“çš„æ•°æ®åŒ…Aææ—©åˆ°è¾¾ã€‚å¦å¤–ï¼Œä¼ è¾“çš„æ•°æ®åŒ…Aã€Bã€Cä¸­å¯èƒ½åªæ”¶åˆ°Aå’ŒCï¼Œç”šè‡³æ”¶åˆ°çš„Cå¯èƒ½å·²ç»æŸæ¯ ã€‚åä¹‹ï¼Œè‹¥æ·»åŠ  TCP åè®®åˆ™æŒ‰ç…§å¦‚ä¸‹å¯¹è¯æ–¹å¼è¿›è¡Œæ•°æ®äº¤æ¢ã€‚</p>
<blockquote>
<p>ä¸»æœºAï¼šæ­£ç¡®æ¥å—ç¬¬äºŒä¸ªæ•°æ®åŒ…</p>
<p>ä¸»æœºBï¼šæ©ï¼ŒçŸ¥é“äº†</p>
<p>ä¸»æœºAï¼šæ­£ç¡®æ”¶åˆ°ç¬¬ä¸‰ä¸ªæ•°æ®åŒ…</p>
<p>ä¸»æœºBï¼šå¯æˆ‘å·²ç»å‘é€ç¬¬å››ä¸ªæ•°æ®åŒ…äº†å•Šï¼å“¦ï¼Œæ‚¨æ²¡æ”¶åˆ°å§ï¼Œæˆ‘ç»™ä½ é‡æ–°å‘ã€‚</p>
</blockquote>
<p>è¿™å°±æ˜¯ TCP çš„ä½œç”¨ã€‚å¦‚æœäº¤æ¢æ•°æ®çš„è¿‡ç¨‹ä¸­å¯ä»¥ç¡®è®¤å¯¹æ–¹å·²ç»æ”¶åˆ°æ•°æ®ï¼Œå¹¶é‡ä¼ ä¸¢å¤±çš„æ•°æ®ï¼Œé‚£ä¹ˆå³ä¾¿IPå±‚ä¸ä¿è¯æ•°æ®ä¼ è¾“ï¼Œè¿™ç±»é€šä¿¡ä¹Ÿæ˜¯å¯é çš„ã€‚</p>
<p><img src="https://i.loli.net/2019/01/14/5c3c268b40be6.png" alt="" /></p>
<h4>4.1.5 åº”ç”¨å±‚</h4>
<p>ä¸Šè¿°å†…å®¹æ˜¯å¥—æ¥å­—é€šä¿¡è¿‡ç¨‹ä¸­è‡ªåŠ¨å¤„ç†çš„ã€‚é€‰æ‹©æ•°æ®ä¼ è¾“è·¯å¾„ã€æ•°æ®ç¡®è®¤è¿‡ç¨‹éƒ½è¢«éšè—åˆ°å¥—æ¥å­—å†…éƒ¨ã€‚å‘ç¨‹åºå‘˜æä¾›çš„å·¥å…·å°±æ˜¯å¥—æ¥å­—ï¼Œåªéœ€è¦åˆ©ç”¨å¥—æ¥å­—ç¼–å‡ºç¨‹åºå³å¯ã€‚ç¼–å†™è½¯ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ ¹æ®ç¨‹åºçš„ç‰¹ç‚¹æ¥å†³å®šæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ä¼ è¾“è§„åˆ™ï¼Œè¿™ä¾¿æ˜¯åº”ç”¨å±‚åè®®ã€‚</p>
<h3>4.2 å®ç°åŸºäº TCP çš„æœåŠ¡å™¨/å®¢æˆ·ç«¯</h3>
<h4>4.2.1 TCP æœåŠ¡ç«¯çš„é»˜è®¤å‡½æ•°çš„è°ƒç”¨ç¨‹åº</h4>
<p><img src="https://i.loli.net/2019/01/14/5c3c2782a7810.png" alt="" /></p>
<p>è°ƒç”¨ socket å‡½æ•°åˆ›å»ºå¥—æ¥å­—ï¼Œå£°æ˜å¹¶åˆå§‹åŒ–åœ°å€ä¿¡æ¯çš„ç»“æ„ä½“å˜é‡ï¼Œè°ƒç”¨ bind å‡½æ•°å‘å¥—æ¥å­—åˆ†é…åœ°å€ã€‚</p>
<h4>4.2.2 è¿›å…¥ç­‰å¾…è¿æ¥è¯·æ±‚çŠ¶æ€</h4>
<p>å·²ç»è°ƒç”¨äº† bind å‡½æ•°ç»™å¥—æ¥å­—åˆ†é…åœ°å€ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦é€šè¿‡è°ƒç”¨ listen å‡½æ•°è¿›å…¥ç­‰å¾…è¿æ¥è¯·æ±‚çŠ¶æ€ã€‚åªæœ‰è°ƒç”¨äº† listen å‡½æ•°ï¼Œå®¢æˆ·ç«¯æ‰èƒ½è¿›å…¥å¯å‘å‡ºè¿æ¥è¯·æ±‚çš„çŠ¶æ€ã€‚æ¢è¨€ä¹‹ï¼Œè¿™æ—¶å®¢æˆ·ç«¯æ‰èƒ½è°ƒç”¨ connect å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> backlog)</span></span>;</span><br><span class="line"><span class="comment">//æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br><span class="line"><span class="comment">//sock: å¸Œæœ›è¿›å…¥ç­‰å¾…è¿æ¥è¯·æ±‚çŠ¶æ€çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œä¼ é€’çš„æè¿°ç¬¦å¥—æ¥å­—å‚æ•°ç§°ä¸ºæœåŠ¡ç«¯å¥—æ¥å­—</span></span><br><span class="line"><span class="comment">//backlog: è¿æ¥è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—çš„é•¿åº¦ï¼Œè‹¥ä¸º5ï¼Œåˆ™é˜Ÿåˆ—é•¿åº¦ä¸º5ï¼Œè¡¨ç¤ºæœ€å¤šä½¿5ä¸ªè¿æ¥è¯·æ±‚è¿›å…¥é˜Ÿåˆ—</span></span><br></pre></td></tr></table></figure>
<h4>4.2.3 å—ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚</h4>
<p>è°ƒç”¨ listen å‡½æ•°åï¼Œåˆ™åº”è¯¥æŒ‰åºå—ç†ã€‚å—ç†è¯·æ±‚æ„å‘³ç€å¯æ¥å—æ•°æ®çš„çŠ¶æ€ã€‚è¿›å…¥è¿™ç§çŠ¶æ€æ‰€éœ€çš„éƒ¨ä»¶æ˜¯<strong>å¥—æ¥å­—</strong>ï¼Œä½†æ˜¯æ­¤æ—¶ä½¿ç”¨çš„ä¸æ˜¯æœåŠ¡ç«¯å¥—æ¥å­—ï¼Œæ­¤æ—¶éœ€è¦å¦ä¸€ä¸ªå¥—æ¥å­—ï¼Œä½†æ˜¯æ²¡å¿…è¦äº²è‡ªåˆ›å»ºï¼Œä¸‹é¢çš„å‡½æ•°å°†è‡ªåŠ¨åˆ›å»ºå¥—æ¥å­—ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *addr, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br><span class="line"><span class="comment">sock: æœåŠ¡ç«¯å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">addr: ä¿å­˜å‘èµ·è¿æ¥è¯·æ±‚çš„å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯çš„å˜é‡åœ°å€å€¼</span></span><br><span class="line"><span class="comment">addrlen: çš„ç¬¬äºŒä¸ªå‚æ•°addrç»“æ„ä½“çš„é•¿åº¦ï¼Œä½†æ˜¯å­˜æ”¾æœ‰é•¿åº¦çš„å˜é‡åœ°å€ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>sccept å‡½æ•°å—ç†è¿æ¥è¯·æ±‚é˜Ÿåˆ—ä¸­å¾…å¤„ç†çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ã€‚å‡½æ•°è°ƒç”¨æˆåŠŸåï¼Œaccept å†…éƒ¨å°†äº§ç”Ÿç”¨äºæ•°æ® I/O çš„å¥—æ¥å­—ï¼Œå¹¶è¿”å›å…¶æ–‡ä»¶æè¿°ç¬¦ã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯å¥—æ¥å­—æ˜¯è‡ªåŠ¨åˆ›å»ºçš„ï¼Œå¹¶è‡ªåŠ¨ä¸å‘èµ·è¿æ¥è¯·æ±‚çš„å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ã€‚</p>
<h4>4.2.4 å›é¡¾ Hello World æœåŠ¡ç«¯</h4>
<ul>
<li>ä»£ç ï¼š<a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch04/hello_server.c" target="_blank" rel="noopener">hello_server.c</a></li>
</ul>
<p>é‡æ–°æ•´ç†ä¸€ä¸‹ä»£ç çš„æ€è·¯</p>
<ol>
<li>æœåŠ¡ç«¯å®ç°è¿‡ç¨‹ä¸­é¦–å…ˆè¦åˆ›å»ºå¥—æ¥å­—ï¼Œæ­¤æ—¶çš„å¥—æ¥å­—å¹¶éæ˜¯çœŸæ­£çš„æœåŠ¡ç«¯å¥—æ¥å­—</li>
<li>ä¸ºäº†å®Œæˆå¥—æ¥å­—åœ°å€çš„åˆ†é…ï¼Œåˆå§‹åŒ–ç»“æ„ä½“å˜é‡å¹¶è°ƒç”¨ bind å‡½æ•°ã€‚</li>
<li>è°ƒç”¨ listen å‡½æ•°è¿›å…¥ç­‰å¾…è¿æ¥è¯·æ±‚çŠ¶æ€ã€‚è¿æ¥è¯·æ±‚çŠ¶æ€é˜Ÿåˆ—çš„é•¿åº¦è®¾ç½®ä¸º5.æ­¤æ—¶çš„å¥—æ¥å­—æ‰æ˜¯æœåŠ¡ç«¯å¥—æ¥å­—ã€‚</li>
<li>è°ƒç”¨ accept å‡½æ•°ä»é˜Ÿå¤´å– 1 ä¸ªè¿æ¥è¯·æ±‚ä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œå¹¶è¿”å›åˆ›å»ºçš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚å¦å¤–ï¼Œè°ƒç”¨ accept å‡½æ•°æ—¶è‹¥ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ accept å‡½æ•°ä¸ä¼šè¿”å›ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­å‡ºç°æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
<li>è°ƒç”¨ write å‡½æ•°å‘å®¢æˆ·ç«¯ä¼ é€æ•°æ®ï¼Œè°ƒç”¨ close å…³é—­è¿æ¥</li>
</ol>
<h4>4.2.5 TCP å®¢æˆ·ç«¯çš„é»˜è®¤å‡½æ•°è°ƒç”¨é¡ºåº</h4>
<p><img src="https://i.loli.net/2019/01/14/5c3c31d77e86c.png" alt="" /></p>
<p>ä¸æœåŠ¡ç«¯ç›¸æ¯”ï¼ŒåŒºåˆ«å°±åœ¨äºã€Œè¯·æ±‚è¿æ¥ã€ï¼Œä»–æ˜¯åˆ›å»ºå®¢æˆ·ç«¯å¥—æ¥å­—åå‘æœåŠ¡ç«¯å‘èµ·çš„è¿æ¥è¯·æ±‚ã€‚æœåŠ¡ç«¯è°ƒç”¨ listen å‡½æ•°ååˆ›å»ºè¿æ¥è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—ï¼Œä¹‹åå®¢æˆ·ç«¯å³å¯è¯·æ±‚è¿æ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span> sock, struct sockaddr *servaddr, <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥è¿”å›-1</span></span><br><span class="line"><span class="comment">sock:å®¢æˆ·ç«¯å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">servaddr: ä¿å­˜ç›®æ ‡æœåŠ¡å™¨ç«¯åœ°å€ä¿¡æ¯çš„å˜é‡åœ°å€å€¼</span></span><br><span class="line"><span class="comment">addrlen: ä»¥å­—èŠ‚ä¸ºå•ä½ä¼ é€’ç»™ç¬¬äºŒä¸ªç»“æ„ä½“å‚æ•° servaddr çš„å˜é‡åœ°å€é•¿åº¦</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯è°ƒç”¨ connect å‡½æ•°å€™ï¼Œå‘ç”Ÿä»¥ä¸‹å‡½æ•°ä¹‹ä¸€æ‰ä¼šè¿”å›ï¼ˆå®Œæˆå‡½æ•°è°ƒç”¨ï¼‰:</p>
<ul>
<li>æœåŠ¡ç«¯æ¥å—è¿æ¥è¯·æ±‚</li>
<li>å‘ç”Ÿæ–­ç½‘ç­‰ä¸€åœºçŠ¶å†µè€Œä¸­æ–­è¿æ¥è¯·æ±‚</li>
</ul>
<p>æ³¨æ„ï¼š<strong>æ¥å—è¿æ¥</strong>ä¸ä»£è¡¨æœåŠ¡ç«¯è°ƒç”¨ accept å‡½æ•°ï¼Œå…¶å®åªæ˜¯æœåŠ¡å™¨ç«¯æŠŠè¿æ¥è¯·æ±‚ä¿¡æ¯è®°å½•åˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚å› æ­¤ connect å‡½æ•°è¿”å›åå¹¶ä¸åº”è¯¥ç«‹å³è¿›è¡Œæ•°æ®äº¤æ¢ã€‚</p>
<h4>4.2.6 å›é¡¾ Hello World å®¢æˆ·ç«¯</h4>
<ul>
<li>ä»£ç ï¼š<a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch04/hello_client.c" target="_blank" rel="noopener">hello_client.c</a></li>
</ul>
<p>é‡æ–°ç†è§£è¿™ä¸ªç¨‹åºï¼š</p>
<ol>
<li>åˆ›å»ºå‡†å¤‡è¿æ¥æœåŠ¡å™¨çš„å¥—æ¥å­—ï¼Œæ­¤æ—¶åˆ›å»ºçš„æ˜¯ TCP å¥—æ¥å­—</li>
<li>ç»“æ„ä½“å˜é‡ serv_addr ä¸­åˆå§‹åŒ–IPå’Œç«¯å£ä¿¡æ¯ã€‚åˆå§‹åŒ–å€¼ä¸ºç›®æ ‡æœåŠ¡å™¨ç«¯å¥—æ¥å­—çš„IPå’Œç«¯å£ä¿¡æ¯ã€‚</li>
<li>è°ƒç”¨ connect å‡½æ•°å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥è¯·æ±‚</li>
<li>å®Œæˆè¿æ¥åï¼Œæ¥æ”¶æœåŠ¡ç«¯ä¼ è¾“çš„æ•°æ®</li>
<li>æ¥æ”¶æ•°æ®åè°ƒç”¨ close å‡½æ•°å…³é—­å¥—æ¥å­—ï¼Œç»“æŸä¸æœåŠ¡å™¨ç«¯çš„è¿æ¥ã€‚</li>
</ol>
<h4>4.2.7 åŸºäº TCP çš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯å‡½æ•°è°ƒç”¨å…³ç³»</h4>
<p><img src="https://i.loli.net/2019/01/14/5c3c35a773b8c.png" alt="" /></p>
<p>å…³ç³»å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p>
<h3>4.3 å®ç°è¿­ä»£æœåŠ¡ç«¯/å®¢æˆ·ç«¯</h3>
<p>ç¼–å†™ä¸€ä¸ªå›å£°ï¼ˆechoï¼‰æœåŠ¡å™¨/å®¢æˆ·ç«¯ã€‚é¡¾åæ€ä¹‰ï¼ŒæœåŠ¡ç«¯å°†å®¢æˆ·ç«¯ä¼ è¾“çš„å­—ç¬¦ä¸²æ•°æ®åŸå°ä¸åŠ¨çš„ä¼ å›å®¢æˆ·ç«¯ï¼Œå°±åƒå›å£°ä¸€æ ·ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œéœ€è¦è§£é‡Šä¸€ä¸‹è¿­ä»£æœåŠ¡å™¨ç«¯ã€‚</p>
<h4>4.3.1 å®ç°è¿­ä»£æœåŠ¡å™¨ç«¯</h4>
<p>åœ¨ Hello World çš„ä¾‹å­ä¸­ï¼Œç­‰å¾…é˜Ÿåˆ—çš„ä½œç”¨æ²¡æœ‰å¤ªå¤§æ„ä¹‰ã€‚å¦‚æœæƒ³ç»§ç»­å¤„ç†å¥½åé¢çš„å®¢æˆ·ç«¯è¯·æ±‚åº”è¯¥æ€æ ·æ‰©å±•ä»£ç ï¼Ÿæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯æ’å…¥å¾ªç¯åå¤è°ƒç”¨ accept å‡½æ•°ï¼Œå¦‚å›¾:</p>
<p><img src="https://i.loli.net/2019/01/15/5c3d3c8a283ad.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨ accept å‡½æ•°åï¼Œç´§æ¥ç€è°ƒç”¨ I/O ç›¸å…³çš„ read write å‡½æ•°ï¼Œç„¶åè°ƒç”¨ close å‡½æ•°ã€‚è¿™å¹¶éé’ˆå¯¹æœåŠ¡å™¨å¥—æ¥å­—ï¼Œè€Œæ˜¯é’ˆå¯¹ accept å‡½æ•°è°ƒç”¨æ—¶åˆ›å»ºçš„å¥—æ¥å­—ã€‚</p>
<h4>4.3.2 è¿­ä»£å›å£°æœåŠ¡å™¨ç«¯/å®¢æˆ·ç«¯</h4>
<p>ç¨‹åºè¿è¡Œçš„åŸºæœ¬æ–¹å¼ï¼š</p>
<ul>
<li>æœåŠ¡å™¨ç«¯åœ¨åŒä¸€æ—¶åˆ»åªä¸ä¸€ä¸ªå®¢æˆ·ç«¯ç›¸è¿ï¼Œå¹¶æä¾›å›å£°æœåŠ¡ã€‚</li>
<li>æœåŠ¡å™¨ç«¯ä¾æ¬¡å‘ 5 ä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡å¹¶é€€å‡ºã€‚</li>
<li>å®¢æˆ·ç«¯æ¥å—ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¸²å¹¶å‘é€åˆ°æœåŠ¡å™¨ç«¯ã€‚</li>
<li>æœåŠ¡å™¨ç«¯å°†æ¥å—çš„å­—ç¬¦ä¸²æ•°æ®ä¼ å›å®¢æˆ·ç«¯ï¼Œå³ã€Œå›å£°ã€</li>
<li>æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„å­—ç¬¦ä¸²å›å£°ä¸€ç›´æ‰§è¡Œåˆ°å®¢æˆ·ç«¯è¾“å…¥ Q ä¸ºæ­¢ã€‚</li>
</ul>
<p>ä»¥ä¸‹æ˜¯æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch04/echo_server.c" target="_blank" rel="noopener">echo_server.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch04/echo_client.c" target="_blank" rel="noopener">echo_client.c</a></li>
</ul>
<p>ç¼–è¯‘:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_client.c -o eclient</span><br><span class="line">gcc echo_server.c -o eserver</span><br></pre></td></tr></table></figure>
<p>åˆ†åˆ«è¿è¡Œ:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./eserver 9190</span><br><span class="line">./eclient 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>è¿‡ç¨‹å’Œç»“æœï¼š</p>
<p>åœ¨ä¸€ä¸ªæœåŠ¡ç«¯å¼€å¯åï¼Œç”¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£å¼€å¯å®¢æˆ·ç«¯ï¼Œç„¶åç¨‹åºä¼šè®©ä½ è¾“å…¥å­—ç¬¦ä¸²ï¼Œç„¶åå®¢æˆ·ç«¯è¾“å…¥ä»€ä¹ˆå­—ç¬¦ä¸²ï¼Œå®¢æˆ·ç«¯å°±ä¼šè¿”å›ä»€ä¹ˆå­—ç¬¦ä¸²ï¼ŒæŒ‰ q é€€å‡ºã€‚è¿™æ—¶æœåŠ¡ç«¯çš„è¿è¡Œå¹¶æ²¡æœ‰ç»“æŸï¼ŒæœåŠ¡ç«¯ä¸€å…±è¦å¤„ç† 5 ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ï¼Œæ‰€ä»¥å¦å¤–å¼€å¤šä¸ªç»ˆç«¯çª—å£åŒæ—¶å¼€å¯å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨æŒ‰ç…§é¡ºåºè¿›è¡Œå¤„ç†ã€‚</p>
<p>server:<br />
<img src="https://i.loli.net/2019/01/15/5c3d523d0a675.png" alt="server.png" /></p>
<p>client:<br />
<img src="https://i.loli.net/2019/01/15/5c3d523d336e7.png" alt="client.png" /></p>
<h4>4.3.3 å›å£°å®¢æˆ·ç«¯å­˜åœ¨çš„é—®é¢˜</h4>
<p>ä»¥ä¸Šä»£ç æœ‰ä¸€ä¸ªå‡è®¾ã€Œæ¯æ¬¡è°ƒç”¨ readã€writeå‡½æ•°æ—¶éƒ½ä¼šä»¥å­—ç¬¦ä¸²ä¸ºå•ä½æ‰§è¡Œå®é™… I/O æ“ä½œã€</p>
<p>ä½†æ˜¯ã€Œç¬¬äºŒç« ã€ä¸­è¯´è¿‡ã€ŒTCP ä¸å­˜åœ¨æ•°æ®è¾¹ç•Œã€ï¼Œä¸Šè¿°å®¢æˆ·ç«¯æ˜¯åŸºäº TCP çš„ï¼Œå› æ­¤å¤šæ¬¡è°ƒç”¨ write å‡½æ•°ä¼ é€’çš„å­—ç¬¦ä¸²æœ‰å¯èƒ½ä¸€æ¬¡æ€§ä¼ é€’åˆ°æœåŠ¡ç«¯ã€‚æ­¤æ—¶å®¢æˆ·ç«¯æœ‰å¯èƒ½ä»æœåŠ¡ç«¯æ”¶åˆ°å¤šä¸ªå­—ç¬¦ä¸²ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚è¿˜éœ€è¦è€ƒè™‘æœåŠ¡å™¨çš„å¦‚ä¸‹æƒ…å†µï¼š</p>
<p>ã€Œå­—ç¬¦ä¸²å¤ªé•¿ï¼Œéœ€è¦åˆ† 2 ä¸ªåŒ…å‘é€ï¼ã€</p>
<p>æœåŠ¡ç«¯å¸Œæœ›é€šè¿‡è°ƒç”¨ 1 æ¬¡ write å‡½æ•°ä¼ è¾“æ•°æ®ï¼Œä½†æ˜¯å¦‚æœæ•°æ®å¤ªå¤§ï¼Œæ“ä½œç³»ç»Ÿå°±æœ‰å¯èƒ½æŠŠæ•°æ®åˆ†æˆå¤šä¸ªæ•°æ®åŒ…å‘é€åˆ°å®¢æˆ·ç«¯ã€‚å¦å¤–ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å¯èƒ½åœ¨å°šæœªæ”¶åˆ°å…¨éƒ¨æ•°æ®åŒ…æ—¶å°±è°ƒç”¨ read å‡½æ•°ã€‚</p>
<p>ä»¥ä¸Šçš„é—®é¢˜éƒ½æ˜¯æºè‡ª TCP çš„ä¼ è¾“ç‰¹æ€§ï¼Œè§£å†³æ–¹æ³•åœ¨ç¬¬ 5 ç« ã€‚</p>
<h3>4.4 åŸºäº Windows çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>4.5 ä¹ é¢˜</h3>
<blockquote>
<p>ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œä¸ä¸€å®šæ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>è¯·ä½ è¯´æ˜ TCP/IP çš„ 4 å±‚åè®®æ ˆï¼Œå¹¶è¯´æ˜ TCP å’Œ UDP å¥—æ¥å­—ç»è¿‡çš„å±‚çº§ç»“æ„å·®å¼‚ã€‚</strong></p>
<p>ç­”ï¼šTCP/IP çš„å››å±‚åè®®åˆ†ä¸ºï¼šåº”ç”¨å±‚ã€TCP/UDP å±‚ã€IPå±‚ã€é“¾è·¯å±‚ã€‚å·®å¼‚æ˜¯ä¸€ä¸ªç»è¿‡ TCP å±‚ï¼Œä¸€ä¸ªç»è¿‡ UDP å±‚ã€‚</p>
</li>
<li>
<p><strong>è¯·è¯´å‡º TCP/IP åè®®æ ˆä¸­é“¾è·¯å±‚å’ŒIPå±‚çš„ä½œç”¨ï¼Œå¹¶ç»™å‡ºäºŒè€…å…³ç³»</strong></p>
<p>ç­”ï¼šé“¾è·¯å±‚æ˜¯ç‰©ç†é“¾æ¥é¢†åŸŸæ ‡å‡†åŒ–çš„ç»“æœï¼Œä¸“é—¨å®šä¹‰ç½‘ç»œæ ‡å‡†ã€‚è‹¥ä¸¤å°ä¸»æœºé€šè¿‡ç½‘ç»œè¿›è¡Œæ•°æ®äº¤æ¢ï¼Œåˆ™é¦–å…ˆè¦åšåˆ°çš„å°±æ˜¯è¿›è¡Œç‰©ç†é“¾æ¥ã€‚IPå±‚ï¼šä¸ºäº†åœ¨å¤æ‚çš„ç½‘ç»œä¸­ä¼ è¾“æ•°æ®ï¼Œé¦–å…ˆéœ€è¦è€ƒè™‘è·¯å¾„çš„é€‰æ‹©ã€‚å…³ç³»ï¼šé“¾è·¯å±‚è´Ÿè´£è¿›è¡Œä¸€ç³»åˆ—ç‰©ç†è¿æ¥ï¼Œè€ŒIPå±‚è´Ÿè´£é€‰æ‹©æ­£ç¡®å¯è¡Œçš„ç‰©ç†è·¯å¾„ã€‚</p>
</li>
<li>
<p><strong>ä¸ºä½•éœ€è¦æŠŠ TCP/IP åè®®æ ˆåˆ†æˆ 4 å±‚ï¼ˆæˆ–7å±‚ï¼‰ï¼Ÿå¼€æ”¾å¼å›ç­”ã€‚</strong></p>
<p>ç­”ï¼šARPANET çš„ç ”åˆ¶ç»éªŒè¡¨æ˜ï¼Œå¯¹äºå¤æ‚çš„è®¡ç®—æœºç½‘ç»œåè®®ï¼Œå…¶ç»“æ„åº”è¯¥æ˜¯å±‚æ¬¡å¼çš„ã€‚åˆ†å†Œçš„å¥½å¤„ï¼šâ‘ éš”å±‚ä¹‹é—´æ˜¯ç‹¬ç«‹çš„â‘¡çµæ´»æ€§å¥½â‘¢ç»“æ„ä¸Šå¯ä»¥åˆ†éš”å¼€â‘£æ˜“äºå®ç°å’Œç»´æŠ¤â‘¤èƒ½ä¿ƒè¿›æ ‡å‡†åŒ–å·¥ä½œã€‚</p>
</li>
<li>
<p><strong>å®¢æˆ·ç«¯è°ƒç”¨ connect å‡½æ•°å‘æœåŠ¡å™¨ç«¯å‘é€è¯·æ±‚ã€‚æœåŠ¡å™¨ç«¯è°ƒç”¨å“ªä¸ªå‡½æ•°åï¼Œå®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨ connect å‡½æ•°ï¼Ÿ</strong></p>
<p>ç­”ï¼šæœåŠ¡ç«¯è°ƒç”¨ listen å‡½æ•°åï¼Œå®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨ connect å‡½æ•°ã€‚å› ä¸ºï¼ŒæœåŠ¡ç«¯è°ƒç”¨ listen å‡½æ•°åï¼ŒæœåŠ¡ç«¯å¥—æ¥å­—æ‰æœ‰èƒ½åŠ›æ¥å—è¯·æ±‚è¿æ¥çš„ä¿¡å·ã€‚</p>
</li>
<li>
<p><strong>ä»€ä¹ˆæ—¶å€™åˆ›å»ºè¿æ¥è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—ï¼Ÿå®ƒæœ‰ä½•ç§ä½œç”¨ï¼Ÿä¸ accept æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</strong></p>
<p>ç­”ï¼šæœåŠ¡ç«¯è°ƒç”¨ listen å‡½æ•°åï¼Œacceptå‡½æ•°æ­£åœ¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œ æ›´å¤šçš„å®¢æˆ·ç«¯å‘æ¥äº†è¯·æ±‚è¿æ¥çš„æ•°æ®ï¼Œæ­¤æ—¶ï¼Œå°±éœ€è¦åˆ›å»ºè¿æ¥è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—ã€‚ä»¥ä¾¿äºåœ¨acceptå‡½æ•°å¤„ç†å®Œæ‰‹å¤´çš„è¯·æ±‚ä¹‹åï¼ŒæŒ‰ç…§æ­£ç¡®çš„é¡ºåºå¤„ç†åé¢æ­£åœ¨æ’é˜Ÿçš„å…¶ä»–è¯·æ±‚ã€‚ä¸acceptå‡½æ•°çš„å…³ç³»ï¼šacceptå‡½æ•°å—ç†è¿æ¥è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—ä¸­å¾…å¤„ç†çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ã€‚</p>
</li>
<li>
<p><strong>å®¢æˆ·ç«¯ä¸­ä¸ºä½•ä¸éœ€è¦è°ƒç”¨ bind å‡½æ•°åˆ†é…åœ°å€ï¼Ÿå¦‚æœä¸è°ƒç”¨ bind å‡½æ•°ï¼Œé‚£ä½•æ—¶ã€å¦‚ä½•å‘å¥—æ¥å­—åˆ†é…IPåœ°å€å’Œç«¯å£å·ï¼Ÿ</strong></p>
<p>ç­”ï¼šåœ¨è°ƒç”¨ connect å‡½æ•°æ—¶åˆ†é…äº†åœ°å€ï¼Œå®¢æˆ·ç«¯IPåœ°å€å’Œç«¯å£åœ¨è°ƒç”¨ connect å‡½æ•°æ—¶è‡ªåŠ¨åˆ†é…ï¼Œæ— éœ€è°ƒç”¨æ ‡è®°çš„ bind å‡½æ•°è¿›è¡Œåˆ†é…ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 5 ç«  åŸºäº TCP çš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯ï¼ˆ2ï¼‰</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<p>ä¸Šä¸€ç« ä»…ä»…æ˜¯ä»ç¼–ç¨‹è§’åº¦å­¦ä¹ å®ç°æ–¹æ³•ï¼Œå¹¶æœªè¯¦ç»†è®¨è®º TCP çš„å·¥ä½œåŸç†ã€‚å› æ­¤ï¼Œæœ¬ç« å°†æƒ³æ¬¡è®²è§£ TCP ä¸­å¿…è¦çš„ç†è®ºçŸ¥è¯†ï¼Œè¿˜å°†ç»™å‡ºç¬¬ 4 ç« å®¢æˆ·ç«¯é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h3>5.1 å›å£°å®¢æˆ·ç«¯çš„å®Œç¾å®ç°</h3>
<h4>5.1.1 å›å£°æœåŠ¡å™¨æ²¡æœ‰é—®é¢˜ï¼Œåªæœ‰å›å£°å®¢æˆ·ç«¯æœ‰é—®é¢˜ï¼Ÿ</h4>
<p>é—®é¢˜ä¸åœ¨æœåŠ¡å™¨ç«¯ï¼Œè€Œåœ¨å®¢æˆ·ç«¯ï¼Œåªçœ‹ä»£ç å¯èƒ½ä¸å¥½ç†è§£ï¼Œå› ä¸º I/O ä¸­ä½¿ç”¨äº†ç›¸åŒçš„å‡½æ•°ã€‚å…ˆå›é¡¾ä¸€ä¸‹æœåŠ¡å™¨ç«¯çš„ I/O ç›¸å…³ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> ((str_len = <span class="built_in">read</span>(clnt_sock, message, BUF_SIZE)) != <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">write</span>(clnt_sock, message, str_len);</span><br></pre></td></tr></table></figure>
<p>æ¥ç€æ˜¯å®¢æˆ·ç«¯ä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">write</span>(sock, message, <span class="built_in">strlen</span>(message));</span><br><span class="line">str_len = <span class="built_in">read</span>(sock, message, BUF_SIZE - <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>äºŒè€…éƒ½åœ¨æ‘æ¢è°ƒç”¨ read å’Œ write å‡½æ•°ã€‚å®é™…ä¸Šä¹‹å‰çš„å›å£°å®¢æˆ·ç«¯å°† 100% æ¥å—å­—èŠ‚ä¼ è¾“çš„æ•°æ®ï¼Œåªä¸è¿‡æ¥å—æ•°æ®æ—¶çš„å•ä½æœ‰äº›é—®é¢˜ã€‚æ‰©å±•å®¢æˆ·ç«¯ä»£ç å›é¡¾èŒƒå›´ï¼Œä¸‹é¢æ˜¯ï¼Œå®¢æˆ·ç«¯çš„ä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">"Input message(Q to quit): "</span>, <span class="built_in">stdout</span>);</span><br><span class="line">    fgets(message, BUF_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(message, <span class="string">"q\n"</span>) || !<span class="built_in">strcmp</span>(message, <span class="string">"Q\n"</span>))</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">write</span>(sock, message, <span class="built_in">strlen</span>(message));</span><br><span class="line">    str_len = <span class="built_in">read</span>(sock, message, BUF_SIZE - <span class="number">1</span>);</span><br><span class="line">    message[str_len] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Message from server: %s"</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨åº”è¯¥ç†è§£äº†é—®é¢˜ï¼Œå›å£°å®¢æˆ·ç«¯ä¼ è¾“çš„æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œä¸”æ˜¯é€šè¿‡è°ƒç”¨ write å‡½æ•°ä¸€æ¬¡æ€§å‘é€çš„ã€‚ä¹‹åè¿˜è°ƒç”¨ä¸€æ¬¡ read å‡½æ•°ï¼ŒæœŸå¾…ç€æ¥å—è‡ªå·±ä¼ è¾“çš„å­—ç¬¦ä¸²ï¼Œè¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ã€‚</p>
<h4>5.1.2 å›å£°å®¢æˆ·ç«¯é—®é¢˜çš„è§£å†³åŠæ³•</h4>
<p>è¿™ä¸ªé—®é¢˜å…¶å®å¾ˆå®¹æ˜“è§£å†³ï¼Œå› ä¸ºå¯ä»¥æå‰æ¥å—æ•°æ®çš„å¤§å°ã€‚è‹¥ä¹‹å‰ä¼ è¾“äº†20å­—èŠ‚é•¿çš„å­—ç¬¦ä¸²ï¼Œåˆ™å†æ¥æ”¶æ—¶å¾ªç¯è°ƒç”¨ read å‡½æ•°è¯»å– 20 ä¸ªå­—èŠ‚å³å¯ã€‚æ—¢ç„¶æœ‰äº†è§£å†³åŠæ³•ï¼Œé‚£ä¹ˆä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch05/echo_client2.c" target="_blank" rel="noopener">echo_client2.c</a></li>
</ul>
<p>è¿™æ ·ä¿®æ”¹ä¸ºäº†æ¥æ”¶æ‰€æœ‰ä¼ è¾“æ•°æ®è€Œå¾ªç¯è°ƒç”¨ read å‡½æ•°ã€‚æµ‹è¯•åŠè¿è¡Œç»“æœå¯å‚è€ƒç¬¬å››ç« ã€‚</p>
<h4>5.1.3 å¦‚æœé—®é¢˜ä¸åœ¨äºå›å£°å®¢æˆ·ç«¯ï¼šå®šä¹‰åº”ç”¨å±‚åè®®</h4>
<p>å›å£°å®¢æˆ·ç«¯å¯ä»¥æå‰çŸ¥é“æ¥æ”¶æ•°æ®çš„é•¿åº¦ï¼Œè¿™åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¸å¯èƒ½çš„ã€‚é‚£ä¹ˆæ­¤æ—¶æ— æ³•é¢„çŸ¥æ¥æ”¶æ•°æ®é•¿åº¦æ—¶åº”è¯¥å¦‚ä½•æ‰‹æ³•æ•°æ®ï¼Ÿè¿™æ˜¯éœ€è¦çš„æ˜¯<strong>åº”ç”¨å±‚åè®®</strong>çš„å®šä¹‰ã€‚åœ¨æ”¶å‘è¿‡ç¨‹ä¸­å®šå¥½è§„åˆ™ï¼ˆåè®®ï¼‰ä»¥è¡¨ç¤ºæ•°æ®è¾¹ç•Œï¼Œæˆ–è€…æå‰å‘ŠçŸ¥éœ€è¦å‘é€çš„æ•°æ®çš„å¤§å°ã€‚æœåŠ¡ç«¯/å®¢æˆ·ç«¯å®ç°è¿‡ç¨‹ä¸­é€æ­¥å®šä¹‰çš„è§„åˆ™é›†åˆå°±æ˜¯åº”ç”¨å±‚åè®®ã€‚</p>
<p>ç°åœ¨å†™ä¸€ä¸ªå°ç¨‹åºæ¥ä½“éªŒåº”ç”¨å±‚åè®®çš„å®šä¹‰è¿‡ç¨‹ã€‚è¦æ±‚ï¼š</p>
<ol>
<li>æœåŠ¡å™¨ä»å®¢æˆ·ç«¯è·å¾—å¤šä¸ªæ•°ç»„å’Œè¿ç®—ç¬¦ä¿¡æ¯ã€‚</li>
<li>æœåŠ¡å™¨æ¥æ”¶åˆ°æ•°å­—å€™å¯¹é½è¿›è¡ŒåŠ å‡ä¹˜è¿ç®—ï¼Œç„¶åæŠŠç»“æœä¼ å›å®¢æˆ·ç«¯ã€‚</li>
</ol>
<p>ä¾‹ï¼š</p>
<ol>
<li>å‘æœåŠ¡å™¨ä¼ é€’3,5,9çš„åŒæ—¶è¯·æ±‚åŠ æ³•è¿ç®—ï¼ŒæœåŠ¡å™¨è¿”å›3+5+9çš„ç»“æœ</li>
<li>è¯·æ±‚åšä¹˜æ³•è¿ç®—ï¼Œå®¢æˆ·ç«¯ä¼šæ”¶åˆ°<code>3*5*9</code>çš„ç»“æœ</li>
<li>å¦‚æœå‘æœåŠ¡å™¨ä¼ é€’4,3,2çš„åŒæ—¶è¦æ±‚åšå‡æ³•ï¼Œåˆ™è¿”å›4-3-2çš„è¿ç®—ç»“æœã€‚</li>
</ol>
<p>è¯·è‡ªå·±å®ç°ä¸€ä¸ªç¨‹åºæ¥å®ç°åŠŸèƒ½ã€‚</p>
<p>æˆ‘è‡ªå·±çš„å®ç°ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch05/My_op_server.c" target="_blank" rel="noopener">My_op_server.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch05/My_op_client.c" target="_blank" rel="noopener">My_op_client.c</a></li>
</ul>
<p>ç¼–è¯‘ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc My_op_client.c -o myclient</span><br><span class="line">gcc My_op_server.c -o myserver</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/15/5c3d966b81c03.png" alt="" /></p>
<p>å…¶å®ä¸»è¦æ˜¯å¯¹ç¨‹åºçš„ä¸€ç‚¹ç‚¹å°æ”¹åŠ¨ï¼Œåªéœ€è¦å†å®¢æˆ·ç«¯å›ºå®šå¥½å‘é€çš„æ ¼å¼ï¼ŒæœåŠ¡ç«¯æŒ‰ç…§å›ºå®šæ ¼å¼è§£æï¼Œç„¶åè¿”å›ç»“æœå³å¯ã€‚</p>
<p>ä¹¦ä¸Šçš„å®ç°ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch05/op_client.c" target="_blank" rel="noopener">op_client.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch05/op_server.c" target="_blank" rel="noopener">op_server.c</a></li>
</ul>
<p>é˜…è¯»ä»£ç è¦æ³¨æ„ä¸€ä¸‹ï¼Œ<code>int*</code>ä¸<code>char</code>ä¹‹é—´çš„è½¬æ¢ã€‚TCP ä¸­ä¸å­˜åœ¨æ•°æ®è¾¹ç•Œã€‚</p>
<p>ç¼–è¯‘ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc op_client.c -o opclient</span><br><span class="line">gcc op_server.c -o opserver</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œ:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./opserver 9190</span><br><span class="line">./opclient 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/16/5c3ea297c7649.png" alt="" /></p>
<h3>5.2 TCP åŸç†</h3>
<h4>5.2.1 TCP å¥—æ¥å­—ä¸­çš„ I/O ç¼“å†²</h4>
<p>TCP å¥—æ¥å­—çš„æ•°æ®æ”¶å‘æ— è¾¹ç•Œã€‚æœåŠ¡å™¨å³ä½¿è°ƒç”¨ 1 æ¬¡ write å‡½æ•°ä¼ è¾“ 40 å­—èŠ‚çš„æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¹Ÿæœ‰å¯èƒ½é€šè¿‡ 4 æ¬¡ read å‡½æ•°è°ƒç”¨æ¯æ¬¡è¯»å– 10 å­—èŠ‚ã€‚ä½†æ­¤å¤„ä¹Ÿæœ‰ä¸€äº›ä¸€é—®ï¼ŒæœåŠ¡å™¨ä¸€æ¬¡æ€§ä¼ è¾“äº† 40 å­—èŠ‚ï¼Œè€Œå®¢æˆ·ç«¯ç«Ÿç„¶å¯ä»¥ç¼“æ…¢çš„åˆ†æ‰¹æ¥å—ã€‚å®¢æˆ·ç«¯æ¥å— 10 å­—èŠ‚åï¼Œå‰©ä¸‹çš„ 30 å­—èŠ‚åœ¨ä½•å¤„ç­‰å€™å‘¢ï¼Ÿ</p>
<p>å®é™…ä¸Šï¼Œwrite å‡½æ•°è°ƒç”¨åå¹¶éç«‹å³ä¼ è¾“æ•°æ®ï¼Œ read å‡½æ•°è°ƒç”¨åä¹Ÿå¹¶éé©¬ä¸Šæ¥æ”¶æ•°æ®ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œwrite å‡½æ•°æ»´å•Šç”¨ç¬é—´ï¼Œæ•°æ®å°†ç§»è‡³è¾“å‡ºç¼“å†²ï¼›read å‡½æ•°è°ƒç”¨ç¬é—´ï¼Œä»è¾“å…¥ç¼“å†²è¯»å–æ•°æ®ã€‚</p>
<p><img src="https://i.loli.net/2019/01/16/5c3ea41cd93c6.png" alt="" /></p>
<p>I/O ç¼“å†²ç‰¹æ€§å¯ä»¥æ•´ç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>I/O ç¼“å†²åœ¨æ¯ä¸ª TCP å¥—æ¥å­—ä¸­å•ç‹¬å­˜åœ¨</li>
<li>I/O ç¼“å†²åœ¨åˆ›å»ºå¥—æ¥å­—æ—¶è‡ªåŠ¨ç”Ÿæˆ</li>
<li>å³ä½¿å…³é—­å¥—æ¥å­—ä¹Ÿä¼šç»§ç»­ä¼ é€’è¾“å‡ºç¼“å†²ä¸­é—ç•™çš„æ•°æ®</li>
<li>å…³é—­å¥—æ¥å­—å°†ä¸¢å¤±è¾“å…¥ç¼“å†²ä¸­çš„æ•°æ®</li>
</ul>
<p>å‡è®¾å‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼Œä¼šå‘ç”Ÿä»€ä¹ˆäº‹å‘¢ï¼Ÿ</p>
<blockquote>
<p>å®¢æˆ·ç«¯è¾“å…¥ç¼“å†²ä¸º 50 å­—èŠ‚ï¼Œè€ŒæœåŠ¡å™¨ç«¯ä¼ è¾“äº† 100 å­—èŠ‚ã€‚</p>
</blockquote>
<p>å› ä¸º TCP ä¸ä¼šå‘ç”Ÿè¶…è¿‡è¾“å…¥ç¼“å†²å¤§å°çš„æ•°æ®ä¼ è¾“ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ ¹æœ¬ä¸ä¼šå‘ç”Ÿè¿™ç±»é—®é¢˜ï¼Œå› ä¸º TCP ä¼šæ§åˆ¶æ•°æ®æµã€‚TCP ä¸­æœ‰æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰åè®®ï¼Œç”¨å¯¹è¯æ–¹å¼å¦‚ä¸‹ï¼š</p>
<blockquote>
<ul>
<li>Aï¼šä½ å¥½ï¼Œæœ€å¤šå¯ä»¥å‘æˆ‘ä¼ é€’ 50 å­—èŠ‚</li>
<li>Bï¼šå¥½çš„</li>
<li>Aï¼šæˆ‘è…¾å‡ºäº† 20 å­—èŠ‚çš„ç©ºé—´ï¼Œæœ€å¤šå¯ä»¥æ¥å— 70 å­—èŠ‚</li>
<li>Bï¼šå¥½çš„</li>
</ul>
</blockquote>
<p>æ•°æ®æ”¶å‘ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå› æ­¤ TCP ä¸­ä¸ä¼šå› ä¸ºç¼“å†²æº¢å‡ºè€Œä¸¢å¤±æ•°æ®ã€‚</p>
<p><strong>write å‡½æ•°åœ¨æ•°æ®ä¼ è¾“å®Œæˆæ—¶è¿”å›ã€‚</strong></p>
<h4>5.2.2 TCP å†…éƒ¨å·¥ä½œåŸç† 1ï¼šä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥</h4>
<p>TCP å¥—æ¥å­—ä»åˆ›å»ºåˆ°æ¶ˆå¤±æ‰€ç»è¿‡çš„è¿‡ç¨‹åˆ†ä¸ºå¦‚ä¸‹ä¸‰æ­¥ï¼š</p>
<ul>
<li>ä¸å¯¹æ–¹å¥—æ¥å­—å»ºç«‹è¿æ¥</li>
<li>ä¸å¯¹æ–¹å¥—æ¥å­—è¿›è¡Œæ•°æ®äº¤æ¢</li>
<li>æ–­å¼€ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥</li>
</ul>
<p>é¦–å…ˆè®²è§£ä¸å¯¹æ–¹å¥—æ¥å­—å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ã€‚è¿æ¥è¿‡ç¨‹ä¸­ï¼Œå¥—æ¥å­—çš„å¯¹è¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¥—æ¥å­—Aï¼šä½ å¥½ï¼Œå¥—æ¥å­— Bã€‚æˆ‘è¿™é‡Œæœ‰æ•°æ®ç»™ä½ ï¼Œå»ºç«‹è¿æ¥å§</li>
<li>å¥—æ¥å­—Bï¼šå¥½çš„ï¼Œæˆ‘è¿™è¾¹å·²å°±ç»ª</li>
<li>å¥—æ¥å­—Aï¼šè°¢è°¢ä½ å—ç†æˆ‘çš„è¯·æ±‚</li>
</ul>
<p>TCP åœ¨å®é™…é€šä¿¡ä¸­ä¹Ÿä¼šç»è¿‡ä¸‰æ¬¡å¯¹è¯è¿‡ç¨‹ï¼Œå› æ­¤ï¼Œè¯¥è¿‡ç¨‹åˆè¢«ç§°ä¸º <strong>Three-way handshakingï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰</strong>ã€‚æ¥ä¸‹æ¥ç»™å‡ºè¿æ¥è¿‡ç¨‹ä¸­å®é™…äº¤æ¢çš„ä¿¡æ¯æ–¹å¼ï¼š</p>
<p><img src="https://i.loli.net/2019/01/16/5c3ecdec9fc04.png" alt="" /></p>
<p>å¥—æ¥å­—æ˜¯å…¨åŒå·¥æ–¹å¼å·¥ä½œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¯ä»¥åŒå‘ä¼ é€’æ•°æ®ã€‚å› æ­¤ï¼Œæ”¶å‘æ•°æ®å‰è¦åšä¸€äº›å‡†å¤‡ã€‚é¦–å…ˆè¯·æ±‚è¿æ¥çš„ä¸»æœº A è¦ç»™ä¸»æœº B ä¼ é€’ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<blockquote>
<p>[SYN] SEQ : 1000 , ACK:-</p>
</blockquote>
<p>è¯¥æ¶ˆæ¯ä¸­çš„ SEQ ä¸º 1000 ï¼ŒACK ä¸ºç©ºï¼Œè€Œ SEQ ä¸º1000 çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ç°åœ¨ä¼ é€’çš„æ•°æ®åŒ…çš„åºå·ä¸º 1000ï¼Œå¦‚æœæ¥æ”¶æ— è¯¯ï¼Œè¯·é€šçŸ¥æˆ‘å‘æ‚¨ä¼ é€’ 1001 å·æ•°æ®åŒ…ã€‚</p>
</blockquote>
<p>è¿™æ˜¯é¦–æ¬¡è¯·æ±‚è¿æ¥æ—¶ä½¿ç”¨çš„æ¶ˆæ¯ï¼Œåˆç§°ä¸º SYNã€‚SYN æ˜¯ Synchronization çš„ç®€å†™ï¼Œè¡¨ç¤ºæ”¶å‘æ•°æ®å‰ä¼ è¾“çš„åŒæ­¥æ¶ˆæ¯ã€‚æ¥ä¸‹æ¥ä¸»æœº B å‘ A ä¼ é€’ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<blockquote>
<p>[SYN+ACK] SEQ: 2000, ACK: 1001</p>
</blockquote>
<p>æ­¤æ—¶ SEQ ä¸º 2000ï¼ŒACK ä¸º 1001ï¼Œè€Œ SEQ ä¸º 2000 çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ç°ä¼ é€’çš„æ•°æ®åŒ…å·ä¸º 2000 ï¼Œå¦‚æœæ¥å—æ— è¯¯ï¼Œè¯·é€šçŸ¥æˆ‘å‘æ‚¨ä¼ é€’ 2001 å·æ•°æ®åŒ…ã€‚</p>
</blockquote>
<p>è€Œ ACK 1001 çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>åˆšæ‰ä¼ è¾“çš„ SEQ ä¸º 1000 çš„æ•°æ®åŒ…æ¥å—æ— è¯¯ï¼Œç°åœ¨è¯·ä¼ é€’ SEQ ä¸º 1001 çš„æ•°æ®åŒ…ã€‚</p>
</blockquote>
<p>å¯¹äºä¸»æœº A é¦–æ¬¡ä¼ è¾“çš„æ•°æ®åŒ…çš„ç¡®è®¤æ¶ˆæ¯ï¼ˆACK 1001ï¼‰å’Œä¸ºä¸»æœº B ä¼ è¾“æ•°æ®åšå‡†å¤‡çš„åŒæ­¥æ¶ˆæ¯ï¼ˆSEQ 2000ï¼‰æ†ç»‘å‘é€ã€‚å› æ­¤ï¼Œæ­¤ç§ç±»æ¶ˆæ¯åˆç§°ä¸º SYN+ACKã€‚</p>
<p>æ”¶å‘æ•°æ®å‰å‘æ•°æ®åŒ…åˆ†é…åºå·ï¼Œå¹¶å‘å¯¹æ–¹é€šæŠ¥æ­¤åºå·ï¼Œè¿™éƒ½æ˜¯ä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±åšçš„å‡†å¤‡ã€‚é€šè¿‡é¡¹æ•°æ®åŒ…åˆ†é…åºå·å¹¶ç¡®è®¤ï¼Œå¯ä»¥åœ¨æ•°æ®åŒ…ä¸¢å¤±æ—¶é©¬ä¸ŠæŸ¥çœ‹å¹¶é‡ä¼ ä¸¢å¤±çš„æ•°æ®åŒ…ã€‚å› æ­¤ TCP å¯ä»¥ä¿è¯å¯é çš„æ•°æ®ä¼ è¾“ã€‚</p>
<p>é€šè¿‡è¿™ä¸‰ä¸ªè¿‡ç¨‹ï¼Œè¿™æ ·ä¸»æœº A å’Œä¸»æœº B å°±ç¡®è®¤äº†å½¼æ­¤å·²ç»å‡†å¤‡å°±ç»ªã€‚</p>
<h4>5.2.3 TCP å†…éƒ¨å·¥ä½œåŸç† 2ï¼šä¸å¯¹æ–¹ä¸»æœºçš„æ•°æ®äº¤æ¢</h4>
<p>é€šè¿‡ç¬¬ä¸€æ­¥ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹å®Œæˆäº†æ•°æ®äº¤æ¢å‡†å¤‡ï¼Œä¸‹é¢å°±å¼€å§‹æ­£å¼æ”¶å‘æ•°æ®ï¼Œå…¶é»˜è®¤æ–¹å¼å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/16/5c3ed1a97ce2b.png" alt="" /></p>
<p>å›¾ä¸Šç»™å‡ºäº†ä¸»æœº A åˆ†æˆ 2 ä¸ªæ•°æ®åŒ…å‘ä¸»æœº B ä¼ è¾“ 200 å­—èŠ‚çš„è¿‡ç¨‹ã€‚é¦–å…ˆï¼Œä¸»æœº A é€šè¿‡ 1 ä¸ªæ•°æ®åŒ…å‘é€ 100 ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ•°æ®åŒ…çš„ SEQ ä¸º 1200 ã€‚ä¸»æœº B ä¸ºäº†ç¡®è®¤è¿™ä¸€ç‚¹ï¼Œå‘ä¸»æœº A å‘é€ ACK 1301 æ¶ˆæ¯ã€‚</p>
<p>æ­¤æ—¶çš„ ACK å·ä¸º 1301 è€Œä¸æ˜¯ 1201ï¼ŒåŸå› åœ¨äº ACK å·çš„å¢é‡ä¸ºä¼ è¾“çš„æ•°æ®å­—èŠ‚æ•°ã€‚å‡è®¾æ¯æ¬¡ ACK å·ä¸åŠ ä¼ è¾“çš„å­—èŠ‚æ•°ï¼Œè¿™æ ·è™½ç„¶å¯ä»¥ç¡®è®¤æ•°æ®åŒ…çš„ä¼ è¾“ï¼Œä½†æ— æ³•æ˜ç¡® 100 ä¸ªå­—èŠ‚å…¨éƒ½æ­£ç¡®ä¼ é€’è¿˜æ˜¯ä¸¢å¤±äº†ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚åªä¼ é€’äº† 80 å­—èŠ‚ã€‚å› æ­¤æŒ‰ç…§å¦‚ä¸‹å…¬å¼ä¼ é€’ ACK ä¿¡æ¯ï¼š</p>
<blockquote>
<p>ACK å· = SEQ å· + ä¼ é€’çš„å­—èŠ‚æ•° + 1</p>
</blockquote>
<p>ä¸ä¸‰æ¬¡æ¡æ‰‹åè®®ç›¸åŒï¼Œæœ€å + 1 æ˜¯ä¸ºäº†å‘ŠçŸ¥å¯¹æ–¹ä¸‹æ¬¡è¦ä¼ é€’çš„ SEQ å·ã€‚ä¸‹é¢åˆ†æä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®åŒ…ä¸¢å¤±çš„æƒ…å†µï¼š</p>
<p><img src="https://i.loli.net/2019/01/16/5c3ed371187a6.png" alt="" />â€™</p>
<p>ä¸Šå›¾è¡¨ç¤ºäº†é€šè¿‡ SEQ 1301 æ•°æ®åŒ…å‘ä¸»æœº B ä¼ é€’ 100 å­—èŠ‚æ•°æ®ã€‚ä½†ä¸­é—´å‘ç”Ÿäº†é”™è¯¯ï¼Œä¸»æœº B æœªæ”¶åˆ°ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œä¸»æœº A ä»ç„¶æœªæ”¶åˆ°å¯¹äº SEQ 1301 çš„ ACK çš„ç¡®è®¤ï¼Œå› æ­¤è¯•ç€é‡ä¼ è¯¥æ•°æ®åŒ…ã€‚ä¸ºäº†å®Œæˆè¯¥æ•°æ®åŒ…çš„é‡ä¼ ï¼ŒTCP å¥—æ¥å­—å¯åŠ¨è®¡æ—¶å™¨ä»¥ç­‰å¾… ACK åº”ç­”ã€‚è‹¥ç›¸åº”è®¡æ—¶å™¨å‘ç”Ÿè¶…æ—¶ï¼ˆTime-out!ï¼‰åˆ™é‡ä¼ ã€‚</p>
<h4>5.2.4 TCP å†…éƒ¨å·¥ä½œåŸç† 3ï¼šæ–­å¼€å¥—æ¥å­—çš„è¿æ¥</h4>
<p>TCP å¥—æ¥å­—çš„ç»“æŸè¿‡ç¨‹ä¹Ÿéå¸¸ä¼˜é›…ã€‚å¦‚æœå¯¹æ–¹è¿˜æœ‰æ•°æ®éœ€è¦ä¼ è¾“æ—¶ç›´æ¥æ–­æ‰è¯¥è¿æ¥ä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥æ–­å¼€è¿æ¥æ—¶éœ€è¦åŒæ–¹åå•†ï¼Œæ–­å¼€è¿æ¥æ—¶åŒæ–¹çš„å¯¹è¯å¦‚ä¸‹ï¼š</p>
<blockquote>
<ul>
<li>å¥—æ¥å­—Aï¼šæˆ‘å¸Œæœ›æ–­å¼€è¿æ¥</li>
<li>å¥—æ¥å­—Bï¼šå“¦ï¼Œæ˜¯å—ï¼Ÿè¯·ç¨åã€‚</li>
<li>å¥—æ¥å­—Aï¼šæˆ‘ä¹Ÿå‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ–­å¼€è¿æ¥ã€‚</li>
<li>å¥—æ¥å­—Bï¼šå¥½çš„ï¼Œè°¢è°¢åˆä½œã€‚</li>
</ul>
</blockquote>
<p>å…ˆç”±å¥—æ¥å­— A å‘å¥—æ¥å­— B ä¼ é€’æ–­å¼€è¿æ¥çš„ä¿¡æ¯ï¼Œå¥—æ¥å­— B å‘å‡ºç¡®è®¤æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œç„¶åå‘å¥—æ¥å­— A ä¼ é€’å¯ä»¥æ–­å¼€è¿æ¥çš„æ¶ˆæ¯ï¼Œå¥—æ¥å­— A åŒæ ·å‘å‡ºç¡®è®¤æ¶ˆæ¯ã€‚</p>
<p><img src="https://i.loli.net/2019/01/16/5c3ed7503c18c.png" alt="" /></p>
<p>å›¾ä¸­æ•°æ®åŒ…å†…çš„ FIN è¡¨ç¤ºæ–­å¼€è¿æ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒæ–¹å„å‘é€ 1 æ¬¡ FIN æ¶ˆæ¯åæ–­å¼€è¿æ¥ã€‚æ­¤è¿‡è¿‡ç¨‹ç»å† 4 ä¸ªé˜¶æ®µï¼Œå› æ­¤åˆç§°å››æ¬¡æ¡æ‰‹ï¼ˆFour-way handshakingï¼‰ã€‚SEQ å’Œ ACK çš„å«ä¹‰ä¸ä¹‹å‰è®²è§£çš„å†…å®¹ä¸€è‡´ï¼Œçœç•¥ã€‚å›¾ä¸­ï¼Œä¸»æœº A ä¼ é€’äº†ä¸¤æ¬¡ ACK 5001ï¼Œä¹Ÿè®¸è¿™é‡Œä¼šæœ‰å›°æƒ‘ã€‚å…¶å®ï¼Œç¬¬äºŒæ¬¡ FIN æ•°æ®åŒ…ä¸­çš„ ACK 5001 åªæ˜¯å› ä¸ºæ¥æ”¶äº† ACK æ¶ˆæ¯åæœªæ¥æ”¶åˆ°çš„æ•°æ®é‡ä¼ çš„ã€‚</p>
<h3>5.3 åŸºäº Windows çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>5.4 ä¹ é¢˜</h3>
<blockquote>
<p>ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>è¯·è¯´æ˜ TCP å¥—æ¥å­—è¿æ¥è®¾ç½®çš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ã€‚å°¤å…¶æ˜¯ 3 æ¬¡æ•°æ®äº¤æ¢è¿‡ç¨‹æ¯æ¬¡æ”¶å‘çš„æ•°æ®å†…å®¹ã€‚</strong></p>
<p>ç­”ï¼šä¸‰æ¬¡æ¡æ‰‹ä¸»è¦åˆ†ä¸ºï¼šâ‘ ä¸å¯¹æ–¹å¥—æ¥å­—å»ºç«‹è¿æ¥â‘¡ä¸å¯¹æ–¹å¥—æ¥å­—è¿›è¡Œæ•°æ®äº¤æ¢â‘¢æ–­å¼€ä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥ã€‚æ¯æ¬¡æ”¶å‘çš„æ•°æ®å†…å®¹ä¸»è¦æœ‰ï¼šâ‘ ç”±ä¸»æœº1ç»™ä¸»æœº2å‘é€åˆå§‹çš„SEQï¼Œé¦–æ¬¡è¿æ¥è¯·æ±‚æ˜¯å…³é”®å­—æ˜¯SYNï¼Œè¡¨ç¤ºæ”¶å‘æ•°æ®å‰åŒæ­¥ä¼ è¾“çš„æ¶ˆæ¯ã€‚â‘¡ä¸»æœº2æ”¶åˆ°æŠ¥æ–‡ä»¥åï¼Œç»™ä¸»æœº 1 ä¼ é€’ä¿¡æ¯ï¼Œç”¨ä¸€ä¸ªæ–°çš„SEQè¡¨ç¤ºè‡ªå·±çš„åºå·ï¼Œç„¶åACKä»£è¡¨å·²ç»æ¥å—åˆ°ä¸»æœº1çš„æ¶ˆæ¯ï¼Œå¸Œæœ›æ¥å—ä¸‹ä¸€ä¸ªæ¶ˆæ¯â‘¢ä¸»æœº1æ”¶åˆ°ä¸»æœº2çš„ç¡®è®¤ä»¥åï¼Œè¿˜éœ€è¦ç»™ä¸»æœº2ç»™å‡ºç¡®è®¤ï¼Œæ­¤æ—¶å†å‘é€ä¸€æ¬¡SEQå’ŒACKã€‚</p>
</li>
<li>
<p><strong>TCP æ˜¯å¯é çš„æ•°æ®ä¼ è¾“åè®®ï¼Œä½†åœ¨é€šè¿‡ç½‘ç»œé€šä¿¡çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¸¢å¤±æ•°æ®ã€‚è¯·é€šè¿‡ ACK å’Œ SEQ è¯´æ˜ TCP é€šè¿‡å’Œä½•ç§æœºåˆ¶ä¿è¯ä¸¢å¤±æ•°æ®çš„å¯é ä¼ è¾“ã€‚</strong></p>
<p>ç­”ï¼šé€šè¿‡è¶…æ—¶é‡ä¼ æœºåˆ¶æ¥ä¿è¯ï¼Œå¦‚æœæŠ¥æ–‡å‘å‡ºå»çš„ç‰¹å®šæ—¶é—´å†…ï¼Œå‘é€æ¶ˆæ¯çš„ä¸»æœºæ²¡æœ‰æ”¶åˆ°å¦ä¸€ä¸ªä¸»æœºçš„å›å¤ï¼Œé‚£ä¹ˆå°±ç»§ç»­å‘é€è¿™æ¡æ¶ˆæ¯ï¼Œç›´åˆ°æ”¶åˆ°å›å¤ä¸ºæ­¢ã€‚</p>
</li>
<li>
<p><strong>TCP å¥—æ¥å­—ä¸­è°ƒç”¨ write å’Œ read å‡½æ•°æ—¶æ•°æ®å¦‚ä½•ç§»åŠ¨ï¼Ÿç»“åˆ I/O ç¼“å†²è¿›è¡Œè¯´æ˜ã€‚</strong></p>
<p>ç­”ï¼šTCP å¥—æ¥å­—è°ƒç”¨ write å‡½æ•°æ—¶ï¼Œæ•°æ®å°†ç§»è‡³è¾“å‡ºç¼“å†²ï¼Œåœ¨é€‚å½“çš„æ—¶å€™ï¼Œä¼ åˆ°å¯¹æ–¹è¾“å…¥ç¼“å†²ã€‚è¿™æ—¶å¯¹æ–¹å°†è°ƒç”¨ read å‡½æ•°ä»è¾“å…¥ç¼“å†²ä¸­è¯»å–æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>å¯¹æ–¹ä¸»æœºçš„è¾“å…¥ç¼“å†²å‰©ä½™ 50 å­—èŠ‚ç©ºé—´æ—¶ï¼Œè‹¥æœ¬ä¸»æœºé€šè¿‡ write å‡½æ•°è¯·æ±‚ä¼ è¾“ 70 å­—èŠ‚ï¼Œè¯·é—® TCP å¦‚ä½•å¤„ç†è¿™ç§æƒ…å†µï¼Ÿ</strong></p>
<p>ç­”ï¼šTCP ä¸­æœ‰æ»‘åŠ¨çª—å£æ§åˆ¶åè®®ï¼Œæ‰€ä»¥ä¼ è¾“çš„æ—¶å€™ä¼šä¿è¯ä¼ è¾“çš„å­—èŠ‚æ•°å°äºç­‰äºè‡ªå·±èƒ½æ¥å—çš„å­—èŠ‚æ•°ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 6 ç«  åŸºäº UDP çš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<p>TCP æ˜¯å†…å®¹è¾ƒå¤šçš„ä¸€ä¸ªåè®®ï¼Œè€Œæœ¬ç« ä¸­çš„ UDP å†…å®¹è¾ƒå°‘ï¼Œä½†æ˜¯ä¹Ÿå¾ˆé‡è¦ã€‚</p>
<h3>6.1 ç†è§£ UDP</h3>
<h4>6.1.1 UDP å¥—æ¥å­—çš„ç‰¹ç‚¹</h4>
<p>é€šè¿‡å¯„ä¿¡æ¥è¯´æ˜ UDP çš„å·¥ä½œåŸç†ï¼Œè¿™æ˜¯è®²è§£ UDP æ—¶ä½¿ç”¨çš„ä¼ ç»Ÿç¤ºä¾‹ï¼Œå®ƒä¸ UDP çš„ç‰¹ç‚¹å®Œå…¨ç›¸åŒã€‚å¯„ä¿¡å‰åº”ç°åœ¨ä¿¡å°ä¸Šå¡«å¥½å¯„ä¿¡äººå’Œæ”¶ä¿¡äººçš„åœ°å€ï¼Œä¹‹åè´´ä¸Šé‚®ç¥¨æ”¾è¿›é‚®ç­’å³å¯ã€‚å½“ç„¶ï¼Œä¿¡ä»¶çš„ç‰¹ç‚¹ä½¿æˆ‘ä»¬æ— æ³•ç¡®è®¤ä¿¡ä»¶æ˜¯å¦è¢«æ”¶åˆ°ã€‚é‚®å¯„è¿‡ç¨‹ä¸­ä¹Ÿå¯èƒ½å‘ç”Ÿä¿¡ä»¶ä¸¢å¤±çš„æƒ…å†µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¿¡ä»¶æ˜¯ä¸€ç§ä¸å¯é çš„ä¼ è¾“æ–¹å¼ï¼ŒUDP ä¹Ÿæ˜¯ä¸€ç§ä¸å¯é çš„æ•°æ®ä¼ è¾“æ–¹å¼ã€‚</p>
<p>å› ä¸º UDP æ²¡æœ‰ TCP é‚£ä¹ˆå¤æ‚ï¼Œæ‰€ä»¥ç¼–ç¨‹éš¾åº¦æ¯”è¾ƒå°ï¼Œæ€§èƒ½ä¹Ÿæ¯” TCP é«˜ã€‚åœ¨æ›´é‡è§†æ€§èƒ½çš„æƒ…å†µä¸‹å¯ä»¥é€‰æ‹© UDP çš„ä¼ è¾“æ–¹å¼ã€‚</p>
<p>TCP ä¸ UDP çš„åŒºåˆ«å¾ˆå¤§ä¸€éƒ¨åˆ†æ¥æºäºæµæ§åˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ TCP çš„ç”Ÿå‘½åœ¨äºæµæ§åˆ¶ã€‚</p>
<h4>6.1.2 UDP çš„å·¥ä½œåŸç†</h4>
<p>å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/17/5c3fd29c70bf2.png" alt="" /></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒIP çš„ä½œç”¨å°±æ˜¯è®©ç¦»å¼€ä¸»æœº B çš„ UDP æ•°æ®åŒ…å‡†ç¡®ä¼ é€’åˆ°ä¸»æœº A ã€‚ä½†æ˜¯æŠŠ UDP æ•°æ®åŒ…æœ€ç»ˆäº¤ç»™ä¸»æœº A çš„æŸä¸€ UDP å¥—æ¥å­—çš„è¿‡ç¨‹æ˜¯ç”± UDP å®Œæˆçš„ã€‚UDP çš„æœ€é‡è¦çš„ä½œç”¨å°±æ˜¯æ ¹æ®ç«¯å£å·å°†ä¼ åˆ°ä¸»æœºçš„æ•°æ®åŒ…äº¤ä»˜ç»™æœ€ç»ˆçš„ UDP å¥—æ¥å­—ã€‚</p>
<h4>6.1.3 UDP çš„é«˜æ•ˆä½¿ç”¨</h4>
<p>UDP ä¹Ÿå…·æœ‰ä¸€å®šçš„å¯é æ€§ã€‚å¯¹äºé€šè¿‡ç½‘ç»œå®æ—¶ä¼ é€’çš„è§†é¢‘æˆ–è€…éŸ³é¢‘æ—¶æƒ…å†µæœ‰æ‰€ä¸åŒã€‚å¯¹äºå¤šåª’ä½“æ•°æ®è€Œè¨€ï¼Œä¸¢å¤±ä¸€éƒ¨åˆ†æ•°æ®ä¹Ÿæ²¡æœ‰å¤ªå¤§é—®é¢˜ï¼Œè¿™åªæ˜¯ä¼šæš‚æ—¶å¼•èµ·ç”»é¢æŠ–åŠ¨ï¼Œæˆ–è€…å‡ºç°ç»†å¾®çš„æ‚éŸ³ã€‚ä½†æ˜¯è¦æä¾›å®æ—¶æœåŠ¡ï¼Œé€Ÿåº¦å°±æˆä¸ºäº†ä¸€ä¸ªå¾ˆé‡è¦çš„å› ç´ ã€‚å› æ­¤æµæ§åˆ¶å°±æ˜¾å¾—æœ‰ä¸€ç‚¹å¤šä½™ï¼Œè¿™æ—¶å°±è¦è€ƒè™‘ä½¿ç”¨ UDP ã€‚TCP æ¯” UDP æ…¢çš„åŸå› ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ul>
<li>æ”¶å‘æ•°æ®å‰åè¿›è¡Œçš„è¿æ¥è®¾ç½®åŠæ¸…æ¥šè¿‡ç¨‹ã€‚</li>
<li>æ”¶å‘è¿‡ç¨‹ä¸­ä¸ºä¿è¯å¯é æ€§è€Œæ·»åŠ çš„æµæ§åˆ¶ã€‚</li>
</ul>
<p>å¦‚æœæ”¶å‘çš„æ•°æ®é‡å°ä½†æ˜¯éœ€è¦é¢‘ç¹è¿æ¥æ—¶ï¼ŒUDP æ¯” TCP æ›´é«˜æ•ˆã€‚</p>
<h3>6.2 å®ç°åŸºäº UDP çš„æœåŠ¡ç«¯/å®¢æˆ·ç«¯</h3>
<h4>6.2.1 UDP ä¸­çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ²¡æœ‰è¿æ¥</h4>
<p>UDP ä¸­çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸åƒ TCP é‚£æ ·åœ¨è¿æ¥çŠ¶æ€ä¸‹äº¤æ¢æ•°æ®ï¼Œå› æ­¤ä¸ TCP ä¸åŒï¼Œæ— éœ€ç»è¿‡è¿æ¥è¿‡ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸å¿…è°ƒç”¨ TCP è¿æ¥è¿‡ç¨‹ä¸­è°ƒç”¨çš„ listen å’Œ accept å‡½æ•°ã€‚UDP ä¸­åªæœ‰åˆ›å»ºå¥—æ¥å­—å’Œæ•°æ®äº¤æ¢çš„è¿‡ç¨‹ã€‚</p>
<h4>6.2.2 UDP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å‡åªéœ€ä¸€ä¸ªå¥—æ¥å­—</h4>
<p>TCP ä¸­ï¼Œå¥—æ¥å­—ä¹‹é—´åº”è¯¥æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚è‹¥è¦å‘ 10 ä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œé™¤äº†å®ˆé—¨çš„æœåŠ¡å™¨å¥—æ¥å­—ä¹‹å¤–ï¼Œè¿˜éœ€è¦ 10 ä¸ªæœåŠ¡å™¨å¥—æ¥å­—ã€‚ä½†åœ¨ UDP ä¸­ï¼Œä¸ç®¡äº‹æœåŠ¡å™¨ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯éƒ½åªéœ€è¦ 1 ä¸ªå¥—æ¥å­—ã€‚åªéœ€è¦ä¸€ä¸ª UDP å¥—æ¥å­—å°±å¯ä»¥å‘ä»»æ„ä¸»æœºä¼ è¾“æ•°æ®ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/17/5c3fd703f3c40.png" alt="" /></p>
<p>å›¾ä¸­å±•ç¤ºäº† 1 ä¸ª UDP å¥—æ¥å­—ä¸ 2 ä¸ªä¸åŒä¸»æœºäº¤æ¢æ•°æ®çš„è¿‡ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªéœ€ 1 ä¸ª UDP å¥—æ¥å­—å°±èƒ½å’Œå¤šå°ä¸»æœºè¿›è¡Œé€šä¿¡ã€‚</p>
<h4>6.2.3 åŸºäº UDP çš„æ•°æ® I/O å‡½æ•°</h4>
<p>åˆ›å»ºå¥½ TCP å¥—æ¥å­—ä»¥åï¼Œä¼ è¾“æ•°æ®æ—¶æ— éœ€åŠ ä¸Šåœ°å€ä¿¡æ¯ã€‚å› ä¸º TCP å¥—æ¥å­—å°†ä¿æŒä¸å¯¹æ–¹å¥—æ¥å­—çš„è¿æ¥ã€‚æ¢è¨€ä¹‹ï¼ŒTCP å¥—æ¥å­—çŸ¥é“ç›®æ ‡åœ°å€ä¿¡æ¯ã€‚ä½† UDP å¥—æ¥å­—ä¸ä¼šä¿æŒè¿æ¥çŠ¶æ€ï¼ˆUDP å¥—æ¥å­—åªæœ‰ç®€å•çš„é‚®ç­’åŠŸèƒ½ï¼‰ï¼Œå› æ­¤æ¯æ¬¡ä¼ è¾“æ•°æ®æ—¶éƒ½éœ€è¦æ·»åŠ ç›®æ ‡çš„åœ°å€ä¿¡æ¯ã€‚è¿™ç›¸å½“äºå¯„ä¿¡å‰åœ¨ä¿¡ä»¶ä¸­å¡«å†™åœ°å€ã€‚æ¥ä¸‹æ¥æ˜¯ UDP çš„ç›¸å…³å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">sendto</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">void</span> *buff, <span class="keyword">size_t</span> nbytes, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">               struct sockaddr *to, <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›ä¼ è¾“çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ˜¯è¿”å› -1</span></span><br><span class="line"><span class="comment">sock: ç”¨äºä¼ è¾“æ•°æ®çš„ UDP å¥—æ¥å­—</span></span><br><span class="line"><span class="comment">buff: ä¿å­˜å¾…ä¼ è¾“æ•°æ®çš„ç¼“å†²åœ°å€å€¼</span></span><br><span class="line"><span class="comment">nbytes: å¾…ä¼ è¾“çš„æ•°æ®é•¿åº¦ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½</span></span><br><span class="line"><span class="comment">flags: å¯é€‰é¡¹å‚æ•°ï¼Œè‹¥æ²¡æœ‰åˆ™ä¼ é€’ 0</span></span><br><span class="line"><span class="comment">to: å­˜æœ‰ç›®æ ‡åœ°å€çš„ sockaddr ç»“æ„ä½“å˜é‡çš„åœ°å€å€¼</span></span><br><span class="line"><span class="comment">addrlen: ä¼ é€’ç»™å‚æ•° to çš„åœ°å€å€¼ç»“æ„ä½“å˜é‡é•¿åº¦</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°å‡½æ•°ä¸ä¹‹å‰çš„ TCP è¾“å‡ºå‡½æ•°æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œæ­¤å‡½æ•°éœ€è¦å‘å®ƒä¼ é€’ç›®æ ‡åœ°å€ä¿¡æ¯ã€‚æ¥ä¸‹æ¥ä»‹ç»æ¥æ”¶ UDP æ•°æ®çš„å‡½æ•°ã€‚UDP æ•°æ®çš„å‘é€å¹¶ä¸å›ºå®šï¼Œå› æ­¤è¯¥å‡½æ•°å®šä¹‰ä¸ºå¯æ¥å—å‘é€ç«¯ä¿¡æ¯çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯å°†åŒæ—¶è¿”å› UDP æ•°æ®åŒ…ä¸­çš„å‘é€ç«¯ä¿¡æ¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recvfrom</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">void</span> *buff, <span class="keyword">size_t</span> nbytes, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                 struct sockaddr *from, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›ä¼ è¾“çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ˜¯è¿”å› -1</span></span><br><span class="line"><span class="comment">sock: ç”¨äºä¼ è¾“æ•°æ®çš„ UDP å¥—æ¥å­—</span></span><br><span class="line"><span class="comment">buff: ä¿å­˜å¾…ä¼ è¾“æ•°æ®çš„ç¼“å†²åœ°å€å€¼</span></span><br><span class="line"><span class="comment">nbytes: å¾…ä¼ è¾“çš„æ•°æ®é•¿åº¦ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½</span></span><br><span class="line"><span class="comment">flags: å¯é€‰é¡¹å‚æ•°ï¼Œè‹¥æ²¡æœ‰åˆ™ä¼ é€’ 0</span></span><br><span class="line"><span class="comment">from: å­˜æœ‰å‘é€ç«¯åœ°å€ä¿¡æ¯çš„ sockaddr ç»“æ„ä½“å˜é‡çš„åœ°å€å€¼</span></span><br><span class="line"><span class="comment">addrlen: ä¿å­˜å‚æ•° from çš„ç»“æ„ä½“å˜é‡é•¿åº¦çš„å˜é‡åœ°å€å€¼ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ç¼–å†™ UDP ç¨‹åºçš„æœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±åœ¨äºä¸Šè¿°ä¸¤ä¸ªå‡½æ•°ï¼Œè¿™ä¹Ÿè¯´æ˜äºŒè€…åœ¨ UDP æ•°æ®ä¼ è¾“ä¸­çš„åœ°ä½ã€‚</p>
<h4>6.2.4 åŸºäº UDP çš„å›å£°æœåŠ¡å™¨ç«¯/å®¢æˆ·ç«¯</h4>
<p>ä¸‹é¢æ˜¯å®ç°çš„åŸºäº UDP çš„å›å£°æœåŠ¡å™¨çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ï¼š</p>
<p>ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch06/uecho_client.c" target="_blank" rel="noopener">uecho_client.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch06/uecho_server.c" target="_blank" rel="noopener">uecho_server.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc uecho_client.c -o uclient</span><br><span class="line">gcc uecho_server.c -o userver</span><br><span class="line">./server 9190</span><br><span class="line">./uclient 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/17/5c3feb85baa83.png" alt="" /></p>
<p>TCP å®¢æˆ·ç«¯å¥—æ¥å­—åœ¨è°ƒç”¨ connect å‡½æ•°æ—¶è‡ªåŠ¨åˆ†é…IPåœ°å€å’Œç«¯å£å·ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼ŒUDP å®¢æˆ·ç«¯ä½•æ—¶åˆ†é…IPåœ°å€å’Œç«¯å£å·ï¼Ÿ</p>
<h4>6.2.5 UDP å®¢æˆ·ç«¯å¥—æ¥å­—çš„åœ°å€åˆ†é…</h4>
<p>ä»”ç»†è§‚å¯Ÿ UDP å®¢æˆ·ç«¯å¯ä»¥å‘ç°ï¼ŒUDP å®¢æˆ·ç«¯ç¼ºå°‘äº†æŠŠIPå’Œç«¯å£åˆ†é…ç»™å¥—æ¥å­—çš„è¿‡ç¨‹ã€‚TCP å®¢æˆ·ç«¯è°ƒç”¨ connect å‡½æ•°è‡ªåŠ¨å®Œæˆæ­¤è¿‡ç¨‹ï¼Œè€Œ UDP ä¸­è¿æ¥èƒ½æ‰¿æ‹…ç›¸åŒåŠŸèƒ½çš„å‡½æ•°è°ƒç”¨è¯­å¥éƒ½æ²¡æœ‰ã€‚ç©¶ç«Ÿåœ¨ä»€ä¹ˆæ—¶å€™åˆ†é…IPå’Œç«¯å£å·å‘¢ï¼Ÿ</p>
<p>UDP ç¨‹åºä¸­ï¼Œè°ƒç”¨ sendto å‡½æ•°ä¼ è¾“æ•°æ®å‰åº”è¯¥å®Œæˆå¯¹å¥—æ¥å­—çš„åœ°å€åˆ†é…å·¥ä½œï¼Œå› æ­¤è°ƒç”¨ bind å‡½æ•°ã€‚å½“ç„¶ï¼Œbind å‡½æ•°åœ¨ TCP ç¨‹åºä¸­å‡ºç°è¿‡ï¼Œä½† bind å‡½æ•°ä¸åŒºåˆ† TCP å’Œ UDPï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ UDP ç¨‹åºä¸­åŒæ ·å¯ä»¥è°ƒç”¨ã€‚å¦å¤–ï¼Œå¦‚æœè°ƒç”¨ sendto å‡½æ•°å°šæœªåˆ†é…åœ°å€ä¿¡æ¯ï¼Œåˆ™åœ¨é¦–æ¬¡è°ƒç”¨ sendto å‡½æ•°æ—¶ç»™ç›¸åº”å¥—æ¥å­—è‡ªåŠ¨åˆ†é… IP å’Œç«¯å£ã€‚è€Œä¸”æ­¤æ—¶åˆ†é…çš„åœ°å€ä¸€ç›´ä¿ç•™åˆ°ç¨‹åºç»“æŸä¸ºæ­¢ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨æ¥å’Œå…¶ä»– UDP å¥—æ¥å­—è¿›è¡Œæ•°æ®äº¤æ¢ã€‚å½“ç„¶ï¼ŒIP ç”¨ä¸»æœºIPï¼Œç«¯å£å·ç”¨æœªé€‰ç”¨çš„ä»»æ„ç«¯å£å·ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œè°ƒç”¨ sendto å‡½æ•°æ—¶è‡ªåŠ¨åˆ†é…IPå’Œç«¯å£å·ï¼Œå› æ­¤ï¼ŒUDP å®¢æˆ·ç«¯ä¸­é€šå¸¸æ— éœ€é¢å¤–çš„åœ°å€åˆ†é…è¿‡ç¨‹ã€‚æ‰€ä»¥ä¹‹å‰çš„ç¤ºä¾‹ä¸­çœç•¥äº†è¯¥è¿‡ç¨‹ã€‚è¿™ä¹Ÿæ˜¯æ™®éçš„å®ç°æ–¹å¼ã€‚</p>
<h3>6.3 UDP çš„æ•°æ®ä¼ è¾“ç‰¹æ€§å’Œè°ƒç”¨ connect å‡½æ•°</h3>
<h4>6.3.1 å­˜åœ¨æ•°æ®è¾¹ç•Œçš„ UDP å¥—æ¥å­—</h4>
<p>å‰é¢è¯´å¾— TCP æ•°æ®ä¼ è¾“ä¸­ä¸å­˜åœ¨æ•°æ®è¾¹ç•Œï¼Œè¿™è¡¨ç¤ºã€Œæ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­è°ƒç”¨ I/O å‡½æ•°çš„æ¬¡æ•°ä¸å…·æœ‰ä»»ä½•æ„ä¹‰ã€</p>
<p>ç›¸åï¼ŒUDP æ˜¯å…·æœ‰æ•°æ®è¾¹ç•Œçš„ä¸‹ä¸€ï¼Œä¼ è¾“ä¸­è°ƒç”¨ I/O å‡½æ•°çš„æ¬¡æ•°éå¸¸é‡è¦ã€‚å› æ­¤ï¼Œè¾“å…¥å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°å’Œè¾“å‡ºå‡½æ•°çš„è°ƒç”¨æ¬¡æ•°å®Œå…¨ä¸€è‡´ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ¥æ”¶å…¨éƒ¨å·²ç»å‘é€çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œè°ƒç”¨ 3 æ¬¡è¾“å‡ºå‡½æ•°å‘é€çš„æ•°æ®å¿…é¡»é€šè¿‡è°ƒç”¨ 3 æ¬¡è¾“å…¥å‡½æ•°æ‰èƒ½æ¥æ”¶å®Œã€‚é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¿›è¡ŒéªŒè¯ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch06/bound_host1.c" target="_blank" rel="noopener">bound_host1.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch06/bound_host2.c" target="_blank" rel="noopener">bound_host2.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc bound_host1.c -o host1</span><br><span class="line">gcc bound_host2.c -o host2</span><br><span class="line">./host1 9190</span><br><span class="line">./host2 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/17/5c3ff966a8d34.png" alt="" /></p>
<p>host1 æ˜¯æœåŠ¡ç«¯ï¼Œhost2 æ˜¯å®¢æˆ·ç«¯ï¼Œhost2 ä¸€æ¬¡æ€§æŠŠæ•°æ®å‘ç»™æœåŠ¡ç«¯åï¼Œç»“æŸç¨‹åºã€‚ä½†æ˜¯å› ä¸ºæœåŠ¡ç«¯æ¯éš”äº”ç§’æ‰æ¥æ”¶ä¸€æ¬¡ï¼Œæ‰€ä»¥æœåŠ¡ç«¯æ¯éš”äº”ç§’æ¥æ”¶ä¸€æ¬¡æ¶ˆæ¯ã€‚</p>
<p><strong>ä»è¿è¡Œç»“æœä¹Ÿå¯ä»¥è¯æ˜ UDP é€šä¿¡è¿‡ç¨‹ä¸­ I/O çš„è°ƒç”¨æ¬¡æ•°å¿…é¡»ä¿æŒä¸€è‡´</strong></p>
<h4>6.3.2 å·²è¿æ¥ï¼ˆconnectï¼‰UDP å¥—æ¥å­—ä¸æœªè¿æ¥ï¼ˆunconnectedï¼‰UDP å¥—æ¥å­—</h4>
<p>TCP å¥—æ¥å­—ä¸­éœ€æ³¨å†Œå¾…ä¼ ä¼ è¾“æ•°æ®çš„ç›®æ ‡IPå’Œç«¯å£å·ï¼Œè€Œåœ¨ UDP ä¸­æ— éœ€æ³¨å†Œã€‚å› æ­¤é€šè¿‡ sendto å‡½æ•°ä¼ è¾“æ•°æ®çš„è¿‡ç¨‹å¤§æ¦‚å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 3 ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>ç¬¬ 1 é˜¶æ®µï¼šå‘ UDP å¥—æ¥å­—æ³¨å†Œç›®æ ‡ IP å’Œç«¯å£å·</li>
<li>ç¬¬ 2 é˜¶æ®µï¼šä¼ è¾“æ•°æ®</li>
<li>ç¬¬ 3 é˜¶æ®µï¼šåˆ é™¤ UDP å¥—æ¥å­—ä¸­æ³¨å†Œçš„ç›®æ ‡åœ°å€ä¿¡æ¯ã€‚</li>
</ul>
<p>æ¯æ¬¡è°ƒç”¨ sendto å‡½æ•°æ—¶é‡å¤ä¸Šè¿°è¿‡ç¨‹ã€‚æ¯æ¬¡éƒ½å˜æ›´ç›®æ ‡åœ°å€ï¼Œå› æ­¤å¯ä»¥é‡å¤åˆ©ç”¨åŒä¸€ UDP å¥—æ¥å­—å‘ä¸åŒç›®æ ‡ä¼ é€’æ•°æ®ã€‚è¿™ç§æœªæ³¨å†Œç›®æ ‡åœ°å€ä¿¡æ¯çš„å¥—æ¥å­—ç§°ä¸ºæœªè¿æ¥å¥—æ¥å­—ï¼Œåä¹‹ï¼Œæ³¨å†Œäº†ç›®æ ‡åœ°å€çš„å¥—æ¥å­—ç§°ä¸ºè¿æ¥ connected å¥—æ¥å­—ã€‚æ˜¾ç„¶ï¼ŒUDP å¥—æ¥å­—é»˜è®¤å±äºæœªè¿æ¥å¥—æ¥å­—ã€‚å½“ä¸€å°ä¸»æœºå‘å¦ä¸€å°ä¸»æœºä¼ è¾“å¾ˆå¤šä¿¡æ¯æ—¶ï¼Œä¸Šè¿°çš„ä¸‰ä¸ªé˜¶æ®µä¸­ï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µå’Œç¬¬ä¸‰ä¸ªé˜¶æ®µå æ•´ä¸ªé€šä¿¡è¿‡ç¨‹ä¸­è¿‘ä¸‰åˆ†ä¹‹ä¸€çš„æ—¶é—´ï¼Œç¼©çŸ­è¿™éƒ¨åˆ†çš„æ—¶é—´å°†ä¼šå¤§å¤§æé«˜æ•´ä½“æ€§èƒ½ã€‚</p>
<h4>6.3.3 åˆ›å»ºå·²è¿æ¥ UDP å¥—æ¥å­—</h4>
<p>åˆ›å»ºå·²è¿æ¥ UDP å¥—æ¥å­—è¿‡ç¨‹æ ¼å¤–ç®€å•ï¼Œåªéœ€é’ˆå¯¹ UDP å¥—æ¥å­—è°ƒç”¨ connect å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sock = socket(PF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">memset</span>(&amp;adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(adr));</span><br><span class="line">adr.sin_family = AF_INET;</span><br><span class="line">adr.sin_addr.s_addr = inet_addr(argv[<span class="number">1</span>]);</span><br><span class="line">adr.sin_port = htons(atoi(argv[<span class="number">2</span>]));</span><br><span class="line"><span class="built_in">connect</span>(sock, (struct sockaddr *)&amp;adr, <span class="keyword">sizeof</span>(adr));</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç çœ‹ä¼¼ä¸ TCP å¥—æ¥å­—åˆ›å»ºè¿‡ç¨‹ä¸€è‡´ï¼Œä½† socket å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°åˆ†æ˜æ˜¯ SOCK_DGRAM ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ›å»ºçš„çš„ç¡®æ˜¯ UDP å¥—æ¥å­—ã€‚å½“ç„¶é’ˆå¯¹ UDP è°ƒç”¨ connect å‡½æ•°å¹¶ä¸æ˜¯æ„å‘³ç€è¦ä¸å¯¹æ–¹ UDP å¥—æ¥å­—è¿æ¥ï¼Œè¿™åªæ˜¯å‘ UDP å¥—æ¥å­—æ³¨å†Œç›®æ ‡IPå’Œç«¯å£ä¿¡æ¯ã€‚</p>
<p>ä¹‹åå°±ä¸ TCP å¥—æ¥å­—ä¸€è‡´ï¼Œæ¯æ¬¡è°ƒç”¨ sendto å‡½æ•°æ—¶åªéœ€ä¼ é€’ä¿¡æ¯æ•°æ®ã€‚å› ä¸ºå·²ç»æŒ‡å®šäº†æ”¶å‘å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ä»…å¯ä»¥ä½¿ç”¨ sendtoã€recvfrom å‡½æ•°ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ writeã€read å‡½æ•°è¿›è¡Œé€šä¿¡ã€‚</p>
<p>ä¸‹é¢çš„ä¾‹å­æŠŠä¹‹å‰çš„ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch06/uecho_client.c" target="_blank" rel="noopener">uecho_client.c</a> ç¨‹åºæ”¹æˆäº†åŸºäºå·²è¿æ¥ UDP çš„å¥—æ¥å­—çš„ç¨‹åºï¼Œå› æ­¤å¯ä»¥ç»“åˆ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch06/uecho_server.c" target="_blank" rel="noopener">uecho_server.c</a> ç¨‹åºè¿è¡Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch06/uecho_con_client.c" target="_blank" rel="noopener">uecho_con_client.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œè¿‡ç¨‹ä¸ä¸Šé¢ä¸€æ ·ï¼Œæ•…çœç•¥ã€‚</p>
<p>ä¸Šé¢çš„ä»£ç ä¸­ç”¨ writeã€read å‡½æ•°ä»£æ›¿äº† sendtoã€recvfrom å‡½æ•°ã€‚</p>
<h3>6.4 åŸºäº Windows çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>6.5 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>UDP ä¸ºä»€ä¹ˆæ¯” TCP å¿«ï¼Ÿä¸ºä»€ä¹ˆ TCP ä¼ è¾“å¯é è€Œ TCP ä¼ è¾“ä¸å¯é ï¼Ÿ</strong></p>
<p>ç­”ï¼šä¸ºäº†æä¾›å¯é çš„æ•°æ®ä¼ è¾“æœåŠ¡ï¼ŒTCP åœ¨ä¸å¯é çš„IPå±‚è¿›è¡Œæµæ§åˆ¶ï¼Œè€Œ UDP ç¼ºå°‘è¿™ç§æµæ§åˆ¶ã€‚æ‰€ä»¥ UDP æ˜¯ä¸å¯é çš„è¿æ¥ã€‚</p>
</li>
<li>
<p><strong>ä¸‹é¢ä¸å±äº UDP ç‰¹ç‚¹çš„æ˜¯ï¼Ÿ</strong></p>
<p>ä¸‹é¢åŠ ç²—çš„ä»£è¡¨æ­¤å¥è¯æ­£ç¡®</p>
<ol>
<li><strong>UDP ä¸åŒäº TCP ï¼Œä¸å­˜åœ¨è¿æ¥æ¦‚å¿µï¼Œæ‰€ä»¥ä¸åƒ TCP é‚£æ ·åªèƒ½è¿›è¡Œä¸€å¯¹ä¸€çš„æ•°æ®ä¼ è¾“ã€‚</strong></li>
<li>åˆ©ç”¨ UDP ä¼ è¾“æ•°æ®æ—¶ï¼Œå¦‚æœæœ‰ 2 ä¸ªç›®æ ‡ï¼Œåˆ™éœ€è¦ 2 ä¸ªå¥—æ¥å­—ã€‚</li>
<li>UDP å¥—æ¥å­—ä¸­æ— æ³•ä½¿ç”¨å·²åˆ†é…ç»™ TCP çš„åŒä¸€ç«¯å£å·</li>
<li><strong>UDP å¥—æ¥å­—å’Œ TCP å¥—æ¥å­—å¯ä»¥å…±å­˜ã€‚è‹¥éœ€è¦ï¼Œå¯ä»¥åŒæ—¶åœ¨åŒä¸€ä¸»æœºè¿›è¡Œ TCP å’Œ UDP æ•°æ®ä¼ è¾“ã€‚</strong></li>
<li>é’ˆå¯¹ UDP å‡½æ•°ä¹Ÿå¯ä»¥è°ƒç”¨ connect å‡½æ•°ï¼Œæ­¤æ—¶ UDP å¥—æ¥å­—è·Ÿ TCP å¥—æ¥å­—ç›¸åŒï¼Œä¹Ÿéœ€è¦ç»è¿‡ 3 æ¬¡æ¡æ‰‹é˜¶æ®µã€‚</li>
</ol>
</li>
<li>
<p><strong>UDP æ•°æ®æŠ¥å‘å¯¹æ–¹ä¸»æœºçš„ UDP å¥—æ¥å­—ä¼ é€’è¿‡ç¨‹ä¸­ï¼ŒIP å’Œ UDP åˆ†åˆ«è´Ÿè´£å“ªäº›éƒ¨åˆ†ï¼Ÿ</strong></p>
<p>ç­”ï¼šIPçš„ä½œç”¨å°±æ˜¯è®©ç¦»å¼€ä¸»æœºçš„ UDP æ•°æ®åŒ…å‡†ç¡®ä¼ é€’åˆ°å¦ä¸€ä¸ªä¸»æœºã€‚ä½†æŠŠ UDP åŒ…æœ€ç»ˆäº¤ç»™ä¸»æœºçš„æŸä¸€ UDP å¥—æ¥å­—çš„è¿‡ç¨‹åˆ™æ˜¯ç”± UDP å®Œæˆçš„ã€‚UDP çš„æœ€é‡è¦çš„ä½œç”¨å°±æ˜¯æ ¹æ®ç«¯å£å·å°†ä¼ åˆ°ä¸»æœºçš„æ•°æ®åŒ…äº¤ä»˜ç»™æœ€ç»ˆçš„ UDP å¥—æ¥å­—ã€‚</p>
</li>
<li>
<p><strong>UDP ä¸€èˆ¬æ¯” TCP å¿«ï¼Œä½†æ ¹æ®äº¤æ¢æ•°æ®çš„ç‰¹ç‚¹ï¼Œå…¶å·®å¼‚å¯å¤§å¯å°ã€‚è¯·ä½ è¯´æ˜ä½•ç§æƒ…å†µä¸‹ UDP çš„æ€§èƒ½ä¼˜äº TCPï¼Ÿ</strong></p>
<p>ç­”ï¼šå¦‚æœæ”¶å‘æ•°æ®é‡å°ä½†éœ€è¦é¢‘ç¹è¿æ¥æ—¶ï¼ŒUDP æ¯” TCP æ›´é«˜æ•ˆã€‚</p>
</li>
<li>
<p><strong>å®¢æˆ·ç«¯ TCP å¥—æ¥å­—è°ƒç”¨ connect å‡½æ•°æ—¶è‡ªåŠ¨åˆ†é…IPå’Œç«¯å£å·ã€‚UDP ä¸­ä¸è°ƒç”¨ bind å‡½æ•°ï¼Œé‚£ä½•æ—¶åˆ†é…IPå’Œç«¯å£å·ï¼Ÿ</strong></p>
<p>ç­”ï¼šåœ¨é¦–æ¬¡è°ƒç”¨ sendto å‡½æ•°æ—¶è‡ªåŠ¨ç»™ç›¸åº”çš„å¥—æ¥å­—åˆ†é…IPå’Œç«¯å£å·ã€‚è€Œä¸”æ­¤æ—¶åˆ†é…çš„åœ°å€ä¸€ç›´ä¿ç•™åˆ°ç¨‹åºç»“æŸä¸ºæ­¢ã€‚</p>
</li>
<li>
<p><strong>TCP å®¢æˆ·ç«¯å¿…é¡»è°ƒç”¨ connect å‡½æ•°ï¼Œè€Œ UDP å¯ä»¥é€‰æ‹©æ€§è°ƒç”¨ã€‚è¯·é—®ï¼Œåœ¨ UDP ä¸­è°ƒç”¨ connect å‡½æ•°æœ‰å“ªäº›å¥½å¤„ï¼Ÿ</strong></p>
<p>ç­”ï¼šè¦ä¸åŒä¸€ä¸ªä¸»æœºè¿›è¡Œé•¿æ—¶é—´é€šä¿¡æ—¶ï¼Œå°† UDP å¥—æ¥å­—å˜æˆå·²è¿æ¥å¥—æ¥å­—ä¼šæé«˜æ•ˆç‡ã€‚å› ä¸ºä¸‰ä¸ªé˜¶æ®µä¸­ï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µå’Œç¬¬ä¸‰ä¸ªé˜¶æ®µå ç”¨äº†ä¸€å¤§éƒ¨åˆ†æ—¶é—´ï¼Œè°ƒç”¨ connect å‡½æ•°å¯ä»¥èŠ‚çœè¿™äº›æ—¶é—´ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 7 ç«  ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<p>æœ¬ç« è®¨è®ºå¦‚ä½•ä¼˜é›…çš„æ–­å¼€å¥—æ¥å­—çš„è¿æ¥ï¼Œä¹‹å‰ç”¨çš„æ–¹æ³•ä¸å¤Ÿä¼˜é›…æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬æ˜¯è°ƒç”¨ close å‡½æ•°æˆ– closesocket å‡½æ•°å•æ–¹é¢æ–­å¼€è¿æ¥çš„ã€‚</p>
<h3>7.1 åŸºäº TCP çš„åŠå…³é—­</h3>
<p>TCP çš„æ–­å¼€è¿æ¥è¿‡ç¨‹æ¯”å»ºç«‹è¿æ¥æ›´é‡è¦ï¼Œå› ä¸ºè¿æ¥è¿‡ç¨‹ä¸­ä¸€èˆ¬ä¸ä¼šå‡ºç°å¤§é—®é¢˜ï¼Œä½†æ˜¯æ–­å¼€è¿‡ç¨‹å¯èƒ½å‘ç”Ÿé¢„æƒ³ä¸åˆ°çš„æƒ…å†µã€‚å› æ­¤åº”è¯¥å‡†ç¡®æŒæ§ã€‚æ‰€ä»¥è¦<strong>æŒæ¡åŠå…³é—­ï¼ˆHalf-closeï¼‰</strong>ï¼Œæ‰èƒ½æ˜ç¡®æ–­å¼€è¿‡ç¨‹ã€‚</p>
<h4>7.1.1 å•æ–¹é¢æ–­å¼€è¿æ¥å¸¦æ¥çš„é—®é¢˜</h4>
<p>Linux å’Œ Windows çš„ closesocket å‡½æ•°æ„å‘³ç€å®Œå…¨æ–­å¼€è¿æ¥ã€‚å®Œå…¨æ–­å¼€ä¸ä»…æŒ‡æ— æ³•ä¼ è¾“æ•°æ®ï¼Œè€Œä¸”ä¹Ÿä¸èƒ½æ¥æ”¶æ•°æ®ã€‚å› æ­¤åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œé€šä¿¡ä¸€æ–¹å•æ–¹é¢çš„æ–­å¼€å¥—æ¥å­—è¿æ¥ï¼Œæ˜¾å¾—ä¸å¤ªä¼˜é›…ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/18/5c412a8baa2d8.png" alt="" /></p>
<p>å›¾ä¸­æè¿°çš„æ˜¯ 2 å°ä¸»æœºæ­£åœ¨è¿›è¡ŒåŒå‘é€šä¿¡ï¼Œä¸»æœº A å‘é€å®Œæœ€åçš„æ•°æ®åï¼Œè°ƒç”¨ close å‡½æ•°æ–­å¼€äº†æœ€åçš„è¿æ¥ï¼Œä¹‹åä¸»æœº A æ— æ³•å†æ¥å—ä¸»æœº B ä¼ è¾“çš„æ•°æ®ã€‚å®é™…ä¸Šï¼Œæ˜¯å®Œå…¨æ— æ³•è°ƒç”¨ä¸æ¥å—æ•°æ®ç›¸å…³çš„å‡½æ•°ã€‚æœ€ç»ˆï¼Œç”±ä¸»æœº B ä¼ è¾“çš„ã€ä¸»æœº A å¿…é¡»è¦æ¥å—çš„æ•°æ®ä¹Ÿé”€æ¯äº†ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜ï¼Œã€Œåªå…³é—­ä¸€éƒ¨åˆ†æ•°æ®äº¤æ¢ä¸­ä½¿ç”¨çš„æµã€çš„æ–¹æ³•åº”è¿è€Œç”Ÿã€‚æ–­å¼€ä¸€éƒ¨åˆ†è¿æ¥æ˜¯æŒ‡ï¼Œå¯ä»¥ä¼ è¾“æ•°æ®ä½†æ˜¯æ— æ³•æ¥æ”¶ï¼Œæˆ–å¯ä»¥æ¥å—æ•°æ®ä½†æ— æ³•ä¼ è¾“ã€‚é¡¾åæ€ä¹‰å°±æ˜¯åªå…³é—­æµçš„ä¸€åŠã€‚</p>
<h4>7.1.2 å¥—æ¥å­—å’Œæµï¼ˆStreamï¼‰</h4>
<p>ä¸¤å°ä¸»æœºé€šè¿‡å¥—æ¥å­—å»ºç«‹è¿æ¥åè¿›å…¥å¯äº¤æ¢æ•°æ®çš„çŠ¶æ€ï¼Œåˆç§°ã€Œæµå½¢æˆçš„çŠ¶æ€ã€ã€‚ä¹Ÿå°±æ˜¯æŠŠå»ºç«‹å¥—æ¥å­—åå¯äº¤æ¢æ•°æ®çš„çŠ¶æ€çœ‹ä½œä¸€ç§æµã€‚</p>
<p>æ­¤å¤„çš„æµå¯ä»¥æ¯”ä½œæ°´æµã€‚æ°´æœç€ä¸€ä¸ªæ–¹å‘æµåŠ¨ï¼ŒåŒæ ·ï¼Œåœ¨å¥—æ¥å­—çš„æµä¸­ï¼Œæ•°æ®ä¹Ÿæ­¢å‘•èƒ½å‘ä¸€ä¸ªæ–¹å‘æµåŠ¨ã€‚å› æ­¤ï¼Œä¸ºäº†è¿›è¡ŒåŒå‘é€šä¿¡ï¼Œéœ€è¦å¦‚å›¾æ‰€ç¤ºçš„ä¸¤ä¸ªæµï¼š</p>
<p><img src="https://i.loli.net/2019/01/18/5c412c3ba25dd.png" alt="" /></p>
<p>ä¸€æ—¦ä¸¤å°ä¸»æœºä¹‹é—´å»ºç«‹äº†å¥—æ¥å­—è¿æ¥ï¼Œæ¯ä¸ªä¸»æœºå°±ä¼šæ‹¥æœ‰å•ç‹¬çš„è¾“å…¥æµå’Œè¾“å‡ºæµã€‚å½“ç„¶ï¼Œå…¶ä¸­ä¸€ä¸ªä¸»æœºçš„è¾“å…¥æµä¸å¦ä¸€ä¸ªä¸»æœºçš„è¾“å‡ºæµç›¸è¿ï¼Œè€Œè¾“å‡ºæµåˆ™ä¸å¦ä¸€ä¸ªä¸»æœºçš„è¾“å…¥æµç›¸è¿ã€‚å¦å¤–ï¼Œæœ¬ç« è®¨è®ºçš„ã€Œä¼˜é›…çš„æ–­å¼€è¿æ¥æ–¹å¼ã€åªæ–­å¼€å…¶ä¸­ 1 ä¸ªæµï¼Œè€ŒéåŒæ—¶æ–­å¼€ä¸¤ä¸ªæµã€‚Linux å’Œ Windows çš„ closesocket å‡½æ•°å°†åŒæ—¶æ–­å¼€è¿™ä¸¤ä¸ªæµï¼Œå› æ­¤ä¸ã€Œä¼˜é›…ã€äºŒå­—è¿˜æœ‰ä¸€æ®µè·ç¦»ã€‚</p>
<h4>7.1.3 é’ˆå¯¹ä¼˜é›…æ–­å¼€çš„ shutdown å‡½æ•°</h4>
<p>shutdown ç”¨æ¥å…³é—­å…¶ä¸­ä¸€ä¸ªæµï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> howto)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">sock: éœ€è¦æ–­å¼€å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">howto: ä¼ é€’æ–­å¼€æ–¹å¼ä¿¡æ¯</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ä¸Šè¿°å‡½æ•°æ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•°å†³å®šæ–­å¼€è¿æ¥çš„æ–¹å¼ï¼Œå…¶å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li><code>SHUT_RD</code> : æ–­å¼€è¾“å…¥æµ</li>
<li><code>SHUT_WR</code> : æ–­å¼€è¾“å‡ºæµ</li>
<li><code>SHUT_RDWR</code> : åŒæ—¶æ–­å¼€ I/O æµ</li>
</ul>
<p>è‹¥å‘ shutdown çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’<code>SHUT_RD</code>ï¼Œåˆ™æ–­å¼€è¾“å…¥æµï¼Œå¥—æ¥å­—æ— æ³•æ¥æ”¶æ•°æ®ã€‚å³ä½¿è¾“å…¥ç¼“å†²æ”¶åˆ°æ•°æ®ä¹Ÿå›æŠ¹å»ï¼Œè€Œä¸”æ— æ³•è°ƒç”¨ç›¸å…³å‡½æ•°ã€‚å¦‚æœå‘  shutdown çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’<code>SHUT_WR</code>ï¼Œåˆ™ä¸­æ–­è¾“å‡ºæµï¼Œä¹Ÿå°±æ— æ³•ä¼ è¾“æ•°æ®ã€‚è‹¥å¦‚æœè¾“å‡ºç¼“å†²ä¸­è¿˜æœ‰æœªä¼ è¾“çš„æ•°æ®ï¼Œåˆ™å°†ä¼ é€’ç»™ç›®æ ‡ä¸»æœºã€‚æœ€åï¼Œè‹¥ä¼ é€’å…³é”®å­—<code>SHUT_RDWR</code>ï¼Œåˆ™åŒæ—¶ä¸­æ–­ I/O æµã€‚è¿™ç›¸å½“äºåˆ† 2 æ¬¡è°ƒç”¨ shutdown ï¼Œå…¶ä¸­ä¸€æ¬¡ä»¥<code>SHUT_RD</code>ä¸ºå‚æ•°ï¼Œå¦ä¸€æ¬¡ä»¥<code>SHUT_WR</code>ä¸ºå‚æ•°ã€‚</p>
<h4>7.1.4 ä¸ºä½•è¦åŠå…³é—­</h4>
<p>è€ƒè™‘ä»¥ä¸‹æƒ…å†µï¼š</p>
<blockquote>
<p>ä¸€æ—¦å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å°†çº¦å®šçš„æ–‡ä»¶ä¼ è¾“ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åå‘é€å­—ç¬¦ä¸²ã€ŒThank youã€ç»™æœåŠ¡å™¨ç«¯ã€‚</p>
</blockquote>
<p>æ­¤å¤„ã€ŒThank youã€çš„ä¼ é€’æ˜¯å¤šä½™çš„ï¼Œè¿™åªæ˜¯ç”¨æ¥æ¨¡æ‹Ÿå®¢æˆ·ç«¯æ–­å¼€è¿æ¥å‰è¿˜æœ‰æ•°æ®è¦ä¼ è¾“çš„æƒ…å†µã€‚æ­¤æ—¶ç¨‹åºçš„è¿˜å«Œéš¾åº¦å¹¶ä¸å°ï¼Œå› ä¸ºä¼ è¾“æ–‡ä»¶çš„æœåŠ¡å™¨ç«¯åªéœ€è¿ç»­ä¼ è¾“æ–‡ä»¶æ•°æ®å³å¯ï¼Œè€Œå®¢æˆ·ç«¯æ— æ³•çŸ¥é“éœ€è¦æ¥æ”¶æ•°æ®åˆ°ä½•æ—¶ã€‚å®¢æˆ·ç«¯ä¹Ÿæ²¡åŠæ³•æ— ä¼‘æ­¢çš„è°ƒç”¨è¾“å…¥å‡½æ•°ï¼Œå› ä¸ºè¿™æœ‰å¯èƒ½å¯¼è‡´ç¨‹åº<strong>é˜»å¡</strong>ã€‚</p>
<blockquote>
<p>æ˜¯å¦å¯ä»¥è®©æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çº¦å®šä¸€ä¸ªä»£è¡¨æ–‡ä»¶å°¾çš„å­—ç¬¦ï¼Ÿ</p>
</blockquote>
<p>è¿™ç§æ–¹å¼ä¹Ÿæœ‰é—®é¢˜ï¼Œå› ä¸ºè¿™æ„å‘³è¿™æ–‡ä»¶ä¸­ä¸èƒ½æœ‰ä¸çº¦å®šå­—ç¬¦ç›¸åŒçš„å†…å®¹ã€‚ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒæœåŠ¡ç«¯åº”æœ€åå‘å®¢æˆ·ç«¯ä¼ é€’ EOF è¡¨ç¤ºæ–‡ä»¶ä¼ è¾“ç»“æŸã€‚å®¢æˆ·ç«¯é€šè¿‡å‡½æ•°è¿”å›å€¼æ¥å— EOF ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸æ–‡ä»¶å†…å®¹å†²çªã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒæœåŠ¡ç«¯å¦‚ä½•ä¼ é€’ EOF ï¼Ÿ</p>
<blockquote>
<p>æ–­å¼€è¾“å‡ºæµæ—¶å‘ä¸»æœºä¼ è¾“ EOFã€‚</p>
</blockquote>
<p>å½“ç„¶ï¼Œè°ƒç”¨ close å‡½æ•°çš„åŒæ—¶å…³é—­ I/O æµï¼Œè¿™æ ·ä¹Ÿä¼šå‘å¯¹æ–¹å‘é€ EOF ã€‚ä½†æ­¤æ—¶æ— æ³•å†æ¥å—å¯¹æ–¹ä¼ è¾“çš„æ•°æ®ã€‚æ¢è¨€ä¹‹ï¼Œè‹¥è°ƒç”¨ close å‡½æ•°å…³é—­æµï¼Œå°±æ— æ³•æ¥å—å®¢æˆ·ç«¯æœ€åå‘é€çš„å­—ç¬¦ä¸²ã€ŒThank youã€ã€‚è¿™æ—¶éœ€è¦è°ƒç”¨ shutdown å‡½æ•°ï¼Œåªå…³é—­æœåŠ¡å™¨çš„è¾“å‡ºæµã€‚è¿™æ ·æ—¢å¯ä»¥å‘é€ EOF ï¼ŒåŒæ—¶åˆä¿ç•™äº†è¾“å…¥æµã€‚ä¸‹é¢å®ç°æ”¶å‘æ–‡ä»¶çš„æœåŠ¡å™¨ç«¯/å®¢æˆ·ç«¯ã€‚</p>
<h4>7.1.5 åŸºäºåŠå…³é—­çš„æ–‡ä»¶ä¼ è¾“ç¨‹åº</h4>
<p>ä¸Šè¿°æ–‡ä»¶ä¼ è¾“æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çš„æ•°æ®æµå¯ä»¥æ•´ç†å¦‚å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/01/18/5c41326280ab5.png" alt="" /></p>
<p>ä¸‹é¢çš„ä»£ç ä¸ºç¼–ç¨‹ç®€ä¾¿ï¼Œçœç•¥äº†å¤§é‡é”™è¯¯å¤„ç†ä»£ç ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch07/file_client.c" target="_blank" rel="noopener">file_client.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch07/file_server.c" target="_blank" rel="noopener">file_server.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc file_client.c -o fclient</span><br><span class="line">gcc file_server.c -o fserver</span><br><span class="line">./fserver 9190</span><br><span class="line">./fclient 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/18/5c4140bc8db2f.png" alt="" /></p>
<p>å®¢æˆ·ç«¯æ¥å—å®Œæˆåï¼ŒæœåŠ¡å™¨ä¼šæ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„æ„Ÿè°¢ä¿¡æ¯ã€‚</p>
<h3>7.2 åŸºäº Windows çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>7.3 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆ</p>
</blockquote>
<ol>
<li>
<p><strong>è§£é‡Š TCP ä¸­ã€Œæµã€çš„æ¦‚å¿µã€‚UDP ä¸­èƒ½å¦å½¢æˆæµï¼Ÿè¯·è¯´æ˜åŸå› ã€‚</strong></p>
<p>ç­”ï¼šä¸¤å°ä¸»æœºä¸­é€šè¿‡å¥—æ¥å­—å»ºç«‹è¿æ¥åè¿›å…¥å¯äº¤æ¢æ•°æ®çš„çŠ¶æ€ï¼Œåˆç§°ã€Œæµå½¢æˆçš„çŠ¶æ€ã€ã€‚ä¹Ÿå°±æ˜¯æŠŠå»ºç«‹å¥—æ¥å­—åå¯äº¤æ¢æ•°æ®çš„çŠ¶æ€çœ‹åšä¸€ç§æµã€‚UDP æ²¡æœ‰å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸èƒ½å½¢æˆæµã€‚</p>
</li>
<li>
<p><strong>Linux ä¸­çš„ close å‡½æ•°æˆ– Windows ä¸­çš„ closesocket å‡½æ•°å±äºå•æ–¹é¢æ–­å¼€è¿æ¥çš„æ–¹æ³•ï¼Œæœ‰å¯èƒ½å¸¦æ¥ä¸€äº›é—®é¢˜ã€‚ä»€ä¹ˆæ˜¯å•æ–¹é¢æ–­å¼€è¿æ¥ï¼Ÿä»€ä¹ˆæƒ…å½¢ä¸‹ä¼šå‡ºç°é—®é¢˜ï¼Ÿ</strong></p>
<p>ç­”ï¼šå•æ–¹é¢æ–­å¼€è¿æ¥å°±æ˜¯ä¸¤å°ä¸»æœºæ­£åœ¨é€šä¿¡ï¼Œå…¶ä¸­ä¸€å°ä¸»æœºå…³é—­äº†æ‰€æœ‰è¿æ¥ï¼Œé‚£ä¹ˆä¸€å°ä¸»æœºå‘å¦ä¸€å°ä¸»æœºä¼ è¾“çš„æ•°æ®å¯èƒ½ä¼šæ²¡æœ‰æ¥æ”¶åˆ°è€ŒæŸæ¯ã€‚ä¼ è¾“æ–‡ä»¶çš„æœåŠ¡å™¨åªéœ€è¿ç»­ä¼ è¾“æ–‡ä»¶æ•°æ®å³å¯ï¼Œè€Œå®¢æˆ·ç«¯ä¸çŸ¥é“éœ€è¦æ¥æ”¶æ•°æ®åˆ°ä½•æ—¶ã€‚å®¢æˆ·ç«¯ä¹Ÿæ²¡æœ‰åŠæ³•æ— ä¼‘æ­¢çš„è°ƒç”¨è¾“å…¥å‡½æ•°ã€‚ç°åœ¨éœ€è¦ä¸€ä¸ª EOF ä»£è¡¨æ•°æ®å·²ç»ä¼ è¾“å®Œæ¯•ï¼Œé‚£ä¹ˆè¿™æ—¶å°±éœ€è¦åŠå…³é—­ï¼ŒæœåŠ¡ç«¯æŠŠè‡ªå·±çš„è¾“å‡ºæµå…³äº†ï¼Œè¿™æ—¶å®¢æˆ·ç«¯å°±çŸ¥æ•°æ®å·²ç»ä¼ è¾“å®Œæ¯•ï¼Œå› ä¸ºæœåŠ¡ç«¯çš„è¾“å…¥æµè¿˜æ²¡å…³ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç»™æœåŠ¡å™¨æ±‡æŠ¥ï¼Œæ¥æ”¶å®Œæ¯•ã€‚</p>
</li>
<li>
<p><strong>ä»€ä¹ˆæ˜¯åŠå…³é—­ï¼Ÿé’ˆå¯¹è¾“å‡ºæµæ‰§è¡ŒåŠå…³é—­çš„ä¸»æœºå¤„äºä½•ç§çŠ¶æ€ï¼ŸåŠå…³é—­ä¼šå¯¼è‡´å¯¹æ–¹ä¸»æœºæ¥æ”¶ä»€ä¹ˆæ¶ˆæ¯ï¼Ÿ</strong></p>
<p>ç­”ï¼šåŠå…³é—­å°±æ˜¯æŠŠè¾“å…¥æµæˆ–è€…è¾“å‡ºæµå…³äº†ã€‚é’ˆå¯¹è¾“å‡ºæµæ‰§è¡ŒåŠå…³é—­çš„ä¸»æœºå¤„äºå¯ä»¥æ¥æ”¶æ•°æ®è€Œä¸èƒ½å‘é€æ•°æ®ã€‚åŠå…³é—­ä¼šå¯¼è‡´å¯¹æ–¹ä¸»æœºæ¥æ”¶ä¸€ä¸ª EOF æ–‡ä»¶ç»“æŸç¬¦ã€‚å¯¹æ–¹å°±çŸ¥é“ä½ çš„æ•°æ®å·²ç»ä¼ è¾“å®Œæ¯•ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 8 ç«  åŸŸååŠç½‘ç»œåœ°å€</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>8.1 åŸŸåç³»ç»Ÿ</h3>
<p>DNS æ˜¯å¯¹IPåœ°å€å’ŒåŸŸåè¿›è¡Œç›¸äº’è½¬æ¢çš„ç³»ç»Ÿï¼Œå…¶æ ¸å¿ƒæ˜¯ DNS æœåŠ¡å™¨</p>
<h4>8.1.1 ä»€ä¹ˆæ˜¯åŸŸå</h4>
<p>åŸŸåå°±æ˜¯æˆ‘ä»¬å¸¸å¸¸åœ¨åœ°å€æ é‡Œé¢è¾“å…¥çš„åœ°å€ï¼Œå°†æ¯”è¾ƒéš¾è®°å¿†çš„IPåœ°å€å˜æˆäººç±»å®¹æ˜“ç†è§£çš„ä¿¡æ¯ã€‚</p>
<h4>8.1.2 DNS æœåŠ¡å™¨</h4>
<p>ç›¸å½“äºä¸€ä¸ªå­—å…¸ï¼Œå¯ä»¥æŸ¥è¯¢å‡ºæŸä¸€ä¸ªåŸŸåå¯¹åº”çš„IPåœ°å€</p>
<p><img src="https://i.loli.net/2019/01/18/5c41854859ae3.png" alt="" /></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¾ç¤ºäº† DNS æœåŠ¡å™¨çš„æŸ¥è¯¢è·¯å¾„ã€‚</p>
<h3>8.2 IPåœ°å€å’ŒåŸŸåä¹‹é—´çš„è½¬æ¢</h3>
<h4>8.2.1 ç¨‹åºä¸­æœ‰å¿…è¦ä½¿ç”¨åŸŸåå—ï¼Ÿ</h4>
<p>ä¸€å¥è¯ï¼Œéœ€è¦ï¼Œå› ä¸ºIPåœ°å€å¯èƒ½ç»å¸¸æ”¹å˜ï¼Œè€Œä¸”ä¹Ÿä¸å®¹æ˜“è®°å¿†ï¼Œé€šè¿‡åŸŸåå¯ä»¥éšæ—¶æ›´æ”¹è§£æï¼Œè¾¾åˆ°æ›´æ¢IPçš„ç›®çš„</p>
<h4>8.2.2 åˆ©ç”¨åŸŸåè·å–IPåœ°å€</h4>
<p>ä½¿ç”¨ä»¥ä¸‹å‡½æ•°å¯ä»¥é€šè¿‡ä¼ é€’å­—ç¬¦ä¸²æ ¼å¼çš„åŸŸåè·å–IPåœ°å€</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="function">struct hostent *<span class="title">gethostbyname</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *hostname)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› hostent ç»“æ„ä½“åœ°å€ï¼Œå¤±è´¥æ—¶è¿”å› NULL æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ä½¿ç”¨æ–¹ä¾¿ï¼Œåªè¦ä¼ é€’å­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥è¿”å›åŸŸåå¯¹åº”çš„IPåœ°å€ã€‚åªæ˜¯è¿”å›æ—¶ï¼Œåœ°å€ä¿¡æ¯è£…å…¥ hostent ç»“æ„ä½“ã€‚æ­¤ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hostent</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *h_name;       <span class="comment">/* Official name of host.  */</span></span><br><span class="line">    <span class="keyword">char</span> **h_aliases;   <span class="comment">/* Alias list.  */</span></span><br><span class="line">    <span class="keyword">int</span> h_addrtype;     <span class="comment">/* Host address type.  */</span></span><br><span class="line">    <span class="keyword">int</span> h_length;       <span class="comment">/* Length of address.  */</span></span><br><span class="line">    <span class="keyword">char</span> **h_addr_list; <span class="comment">/* List of addresses from name server.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šè¿°ç»“æ„ä½“å¯ä»¥çœ‹å‡ºï¼Œä¸æ­¢è¿”å›IPä¿¡æ¯ï¼ŒåŒæ—¶è¿˜å¸¦ç€å…¶ä»–ä¿¡æ¯ä¸€èµ·è¿”å›ã€‚åŸŸåè½¬æ¢æˆIPæ—¶åªéœ€è¦å…³æ³¨ h_addr_list ã€‚ä¸‹é¢ç®€è¦è¯´æ˜ä¸Šè¿°ç»“æ„ä½“çš„æˆå‘˜ï¼š</p>
<ul>
<li>h_nameï¼šè¯¥å˜é‡ä¸­å­˜æœ‰å®˜æ–¹åŸŸåï¼ˆOfficial domain nameï¼‰ã€‚å®˜æ–¹åŸŸåä»£è¡¨æŸä¸€ä¸»é¡µï¼Œä½†å®é™…ä¸Šï¼Œä¸€äº›è‘—åå…¬å¸çš„åŸŸåå¹¶æ²¡æœ‰ç”¨å®˜æ–¹åŸŸåæ³¨å†Œã€‚</li>
<li>h_aliasesï¼šå¯ä»¥é€šè¿‡å¤šä¸ªåŸŸåè®¿é—®åŒä¸€ä¸»é¡µã€‚åŒä¸€IPå¯ä»¥ç»‘å®šå¤šä¸ªåŸŸåï¼Œå› æ­¤ï¼Œé™¤å®˜æ–¹åŸŸåå¤–è¿˜å¯ä»¥æŒ‡å®šå…¶ä»–åŸŸåã€‚è¿™äº›ä¿¡æ¯å¯ä»¥é€šè¿‡ h_aliases è·å¾—ã€‚</li>
<li>h_addrtypeï¼šgethostbyname å‡½æ•°ä¸ä»…æ”¯æŒ IPV4 è¿˜æ”¯æŒ IPV6 ã€‚å› æ­¤å¯ä»¥é€šè¿‡æ­¤å˜é‡è·å–ä¿å­˜åœ¨ h_addr_list çš„IPåœ°å€æ—ä¿¡æ¯ã€‚è‹¥æ˜¯ IPV4 ï¼Œåˆ™æ­¤å˜é‡ä¸­å­˜æœ‰ AF_INETã€‚</li>
<li>h_lengthï¼šä¿å­˜IPåœ°å€é•¿åº¦ã€‚è‹¥æ˜¯ IPV4 åœ°å€ï¼Œå› ä¸ºæ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œåˆ™ä¿å­˜4ï¼›IPV6 æ—¶ï¼Œå› ä¸ºæ˜¯ 16 ä¸ªå­—èŠ‚ï¼Œæ•…ä¿å­˜ 16</li>
<li>h_addr_listï¼šè¿™ä¸ªæ˜¯æœ€é‡è¦çš„çš„æˆå‘˜ã€‚é€šè¿‡æ­¤å˜é‡ä»¥æ•´æ•°å½¢å¼ä¿å­˜åŸŸåç›¸å¯¹åº”çš„IPåœ°å€ã€‚å¦å¤–ï¼Œç”¨æˆ·æ¯”è¾ƒå¤šçš„ç½‘ç«™æœ‰å¯èƒ½åˆ†é…å¤šä¸ªIPåœ°å€ç»™åŒä¸€ä¸ªåŸŸåï¼Œåˆ©ç”¨å¤šä¸ªæœåŠ¡å™¨åšè´Ÿè½½å‡è¡¡ï¼Œã€‚æ­¤æ—¶å¯ä»¥é€šè¿‡æ­¤å˜é‡è·å–IPåœ°å€ä¿¡æ¯ã€‚</li>
</ul>
<p>è°ƒç”¨ gethostbyname å‡½æ•°åï¼Œè¿”å›çš„ç»“æ„ä½“å˜é‡å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/18/5c41898ae45e8.png" alt="" /></p>
<p>ä¸‹é¢çš„ä»£ç é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æ¼”ç¤º gethostbyname çš„åº”ç”¨ï¼Œå¹¶è¯´æ˜ hostent ç»“æ„ä½“å˜é‡ç‰¹æ€§ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch08/gethostbyname.c" target="_blank" rel="noopener">gethostbyname.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc gethostbyname.c -o hostname</span><br><span class="line">./hostname www.baidu.com</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/18/5c418faf20495.png" alt="" /></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¾ç¤ºå‡ºäº†å¯¹ç™¾åº¦çš„åŸŸåè§£æ</p>
<p>å¯ä»¥çœ‹å‡ºï¼Œç™¾åº¦æœ‰ä¸€ä¸ªåŸŸåè§£ææ˜¯ CNAME è§£æçš„ï¼ŒæŒ‡å‘äº†<code>shifen.com</code>ï¼Œå…³äºç™¾åº¦å…·ä½“çš„è§£æè¿‡ç¨‹ã€‚</p>
<blockquote>
<p>è¿™ä¸€éƒ¨åˆ†ç‰µæ‰¯åˆ°äº†å¾ˆå¤šå…³äºDNSè§£æçš„è¿‡ç¨‹ï¼Œè¿˜æœ‰ Linux ä¸‹å…³äºåŸŸåè§£æçš„ä¸€äº›å‘½ä»¤ï¼Œæˆ‘æ‰¾äº†ä¸€éƒ¨åˆ†èµ„æ–™ï¼Œå¯ä»¥ç‚¹ä¸‹é¢çš„é“¾æ¥æŸ¥çœ‹æ¯”è¾ƒè¯¦ç»†çš„ï¼š</p>
<ul>
<li><a href="http://zhan.renren.com/starshen?gid=3602888498023142484&amp;checked=true" target="_blank" rel="noopener">å…³äºç™¾åº¦DNSçš„è§£æè¿‡ç¨‹</a></li>
<li><a href="https://www.zhihu.com/question/23042131/answer/66571369" target="_blank" rel="noopener">DNSè§£æçš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Œæ±‚è¯¦ç»†çš„ï¼Ÿ</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/45535596" target="_blank" rel="noopener">Linux DNS æŸ¥è¯¢å‰–æ</a></li>
<li><a href="http://www.live-in.org/archives/1938.html" target="_blank" rel="noopener">Linux DNSæŸ¥è¯¢å‘½ä»¤</a></li>
<li><a href="https://blog.csdn.net/shangdi1988/article/details/65713077" target="_blank" rel="noopener">Linuxä¸­DNSæœåŠ¡å™¨åœ°å€æŸ¥è¯¢å‘½ä»¤nslookupä½¿ç”¨æ•™ç¨‹</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2016/06/dns.html" target="_blank" rel="noopener">DNS åŸç†å…¥é—¨</a></li>
</ul>
</blockquote>
<p>ä»”ç»†é˜…è¯»è¿™ä¸€æ®µä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">inet_ntoa(*(struct in_addr *)host-&gt;h_addr_list[i])</span><br></pre></td></tr></table></figure>
<p>è‹¥åªçœ‹ hostent çš„å®šä¹‰ï¼Œç»“æ„ä½“æˆå‘˜ h_addr_list æŒ‡å‘å­—ç¬¦ä¸²æŒ‡é’ˆæ•°ç»„ï¼ˆç”±å¤šä¸ªå­—ç¬¦ä¸²åœ°å€æ„æˆçš„æ•°ç»„ï¼‰ã€‚ä½†æ˜¯å­—ç¬¦ä¸²æŒ‡é’ˆæ•°ç»„ä¿å­˜çš„å…ƒç´ å®é™…æŒ‡å‘çš„æ˜¯ in_addr ç»“æ„ä½“å˜é‡ä¸­åœ°å€å€¼è€Œéå­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´<code>(struct in_addr *)host-&gt;h_addr_list[i]</code>å…¶å®æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œç„¶åç”¨<code>*</code>ç¬¦å·å–å…·ä½“çš„å€¼ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/18/5c419658a73b8.png" alt="" /></p>
<h4>8.2.3 åˆ©ç”¨IPåœ°å€è·å–åŸŸå</h4>
<p>è¯·çœ‹ä¸‹é¢çš„å‡½æ•°å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="function">struct hostent *<span class="title">gethostbyaddr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *addr, <span class="keyword">socklen_t</span> len, <span class="keyword">int</span> family)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› hostent ç»“æ„ä½“å˜é‡åœ°å€å€¼ï¼Œå¤±è´¥æ—¶è¿”å› NULL æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">addr: å«æœ‰IPåœ°å€ä¿¡æ¯çš„ in_addr ç»“æ„ä½“æŒ‡é’ˆã€‚ä¸ºäº†åŒæ—¶ä¼ é€’ IPV4 åœ°å€ä¹‹å¤–çš„å…¨éƒ¨ä¿¡æ¯ï¼Œè¯¥å˜é‡çš„ç±»å‹å£°æ˜ä¸º char æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">len: å‘ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’çš„åœ°å€ä¿¡æ¯çš„å­—èŠ‚æ•°ï¼ŒIPV4æ—¶ä¸º 4 ï¼ŒIPV6 æ—¶ä¸º16.</span></span><br><span class="line"><span class="comment">family: ä¼ é€’åœ°å€æ—ä¿¡æ¯ï¼Œipv4 æ˜¯ AF_INET ï¼ŒIPV6æ˜¯ AF_INET6</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä»£ç æ¼”ç¤ºä½¿ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch08/gethostbyaddr.c" target="_blank" rel="noopener">gethostbyaddr.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc gethostbyaddr.c -o hostaddr</span><br><span class="line">./hostaddr 8.8.8.8</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/18/5c41a019085d4.png" alt="" /></p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ<code>8.8.8.8</code>è¿™ä¸ªIPåœ°å€æ˜¯è°·æ­Œçš„ã€‚</p>
<h3>8.3 åŸºäº Windows çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>8.4 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>ä¸‹åˆ—å…³äºDNSçš„è¯´æ³•é”™è¯¯çš„æ˜¯ï¼Ÿ</strong></p>
<p>ç­”ï¼šå­—ä½“åŠ ç²—çš„è¡¨ç¤ºæ­£ç¡®ç­”æ¡ˆã€‚</p>
<ol>
<li><strong>å› ä¸ºDNSä»å­˜åœ¨ï¼Œæ•…å¯ä»¥ä½¿ç”¨åŸŸåä»£æ›¿IP</strong></li>
<li>DNSæœåŠ¡å™¨å®é™…ä¸Šæ˜¯è·¯ç”±å™¨ï¼Œå› ä¸ºè·¯ç”±å™¨æ ¹æ®åŸŸåå†³å®šæ•°æ®çš„è·¯å¾„</li>
<li><strong>æ‰€æœ‰åŸŸåä¿¡æ¯å¹¶éé›†ä¸­ä¸ 1 å° DNS æœåŠ¡å™¨ï¼Œä½†å¯ä»¥è·å–æŸä¸€ DNS æœåŠ¡å™¨ä¸­æœªæ³¨å†Œçš„æ‰€æœ‰åœ°å€</strong></li>
<li>DNS æœåŠ¡å™¨æ ¹æ®æ“ä½œç³»ç»Ÿè¿›è¡ŒåŒºåˆ†ï¼ŒWindows ä¸‹çš„ DNS æœåŠ¡å™¨å’Œ Linux ä¸‹çš„ DNS æœåŠ¡å™¨æ˜¯ä¸åŒçš„ã€‚</li>
</ol>
</li>
<li>
<p><strong>é˜…è¯»å¦‚ä¸‹å¯¹è¯ï¼Œå¹¶è¯´æ˜ä¸œç§€çš„æ–¹æ¡ˆæ˜¯å¦å¯è¡Œã€‚ï¼ˆå› ä¸ºå¯¹è¯çš„å­—å¤ªå¤šï¼Œç”¨å›¾ä»£æ›¿ï¼‰</strong></p>
<p><img src="https://i.loli.net/2019/01/18/5c41a22f35390.png" alt="" /></p>
<p>ç­”ï¼šç­”æ¡ˆå°±æ˜¯å¯è¡Œï¼ŒDNS æœåŠ¡å™¨æ˜¯åˆ†å¸ƒå¼çš„ï¼Œä¸€å°åäº†å¯ä»¥æ‰¾å…¶ä»–çš„ã€‚</p>
</li>
<li>
<p><strong>å†æµè§ˆå™¨åœ°å€è¾“å…¥ <a href="http://www.orentec.co.kr" target="_blank" rel="noopener">www.orentec.co.kr</a> ï¼Œå¹¶æ•´ç†å‡ºä¸»é¡µæ˜¾ç¤ºè¿‡ç¨‹ã€‚å‡è®¾æµè§ˆå™¨è®¿é—®é»˜è®¤ DNS æœåŠ¡å™¨ä¸­å¹¶æ²¡æœ‰å…³äº <a href="http://www.orentec.co.kr" target="_blank" rel="noopener">www.orentec.co.kr</a> çš„åœ°å€ä¿¡æ¯.</strong></p>
<p>ç­”ï¼šå¯ä»¥å‚è€ƒä¸€ä¸‹çŸ¥ä¹å›ç­”ï¼Œ<a href="https://www.zhihu.com/question/34873227/answer/518086565" target="_blank" rel="noopener">åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥ä¸€ä¸ªURLåå›è½¦ï¼ŒèƒŒåä¼šè¿›è¡Œå“ªäº›æŠ€æœ¯æ­¥éª¤ï¼Ÿ</a>,æˆ‘ç”¨æˆ‘è‡ªå·±çš„ç†è§£ï¼Œç®€å•è¯´ä¸€ä¸‹ï¼Œé¦–å…ˆä¼šå»å‘ä¸Šä¸€çº§çš„ DNS æœåŠ¡å™¨å»æŸ¥è¯¢ï¼Œé€šè¿‡è¿™ç§æ–¹å¼é€çº§å‘ä¸Šä¼ é€’ä¿¡æ¯ï¼Œä¸€ç›´åˆ°è¾¾æ ¹æœåŠ¡å™¨æ—¶ï¼Œå®ƒçŸ¥é“åº”è¯¥å‘å“ªä¸ª DNS æœåŠ¡å™¨å‘èµ·è¯¢é—®ã€‚å‘ä¸‹ä¼ é€’è§£æè¯·æ±‚ï¼Œå¾—åˆ°IPåœ°å€å€™åŸè·¯è¿”å›ï¼Œæœ€åä¼šå°†è§£æçš„IPåœ°å€ä¼ é€’åˆ°å‘èµ·è¯·æ±‚çš„ä¸»æœºã€‚</p>
</li>
</ol>
<h2>ç¬¬ 9 ç«  å¥—æ¥å­—çš„å¤šç§å¯é€‰é¡¹</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>9.1 å¥—æ¥å­—å¯é€‰é¡¹å’Œ I/O ç¼“å†²å¤§å°</h3>
<p>æˆ‘ä»¬è¿›è¡Œå¥—æ¥å­—ç¼–ç¨‹æ—¶å¾€å¾€åªå…³æ³¨æ•°æ®é€šä¿¡ï¼Œè€Œå¿½ç•¥äº†å¥—æ¥å­—å…·æœ‰çš„ä¸åŒç‰¹æ€§ã€‚ä½†æ˜¯ï¼Œç†è§£è¿™äº›ç‰¹æ€§å¹¶æ ¹æ®å®é™…éœ€è¦è¿›è¡Œæ›´æ”¹ä¹Ÿå¾ˆé‡è¦</p>
<h4>9.1.1 å¥—æ¥å­—å¤šç§å¯é€‰é¡¹</h4>
<p>æˆ‘ä»¬ä¹‹å‰å†™å¾—ç¨‹åºéƒ½æ˜¯åˆ›å»ºå¥½å¥—æ¥å­—ä¹‹åç›´æ¥ä½¿ç”¨çš„ï¼Œæ­¤æ—¶é€šè¿‡é»˜è®¤çš„å¥—æ¥å­—ç‰¹æ€§è¿›è¡Œæ•°æ®é€šä¿¡ï¼Œè¿™é‡Œåˆ—å‡ºäº†ä¸€äº›å¥—æ¥å­—å¯é€‰é¡¹ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">åè®®å±‚</th>
<th style="text-align:center">é€‰é¡¹å</th>
<th style="text-align:center">è¯»å–</th>
<th style="text-align:center">è®¾ç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SOL_SOCKET</td>
<td style="text-align:center">SO_SNDBUF</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">SOL_SOCKET</td>
<td style="text-align:center">SO_RCVBUF</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">SOL_SOCKET</td>
<td style="text-align:center">SO_REUSEADDR</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">SOL_SOCKET</td>
<td style="text-align:center">SO_KEEPALIVE</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">SOL_SOCKET</td>
<td style="text-align:center">SO_BROADCAST</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">SOL_SOCKET</td>
<td style="text-align:center">SO_DONTROUTE</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">SOL_SOCKET</td>
<td style="text-align:center">SO_OOBINLINE</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">SOL_SOCKET</td>
<td style="text-align:center">SO_ERROR</td>
<td style="text-align:center">O</td>
<td style="text-align:center">X</td>
</tr>
<tr>
<td style="text-align:center">SOL_SOCKET</td>
<td style="text-align:center">SO_TYPE</td>
<td style="text-align:center">O</td>
<td style="text-align:center">X</td>
</tr>
<tr>
<td style="text-align:center">IPPROTO_IP</td>
<td style="text-align:center">IP_TOS</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">IPPROTO_IP</td>
<td style="text-align:center">IP_TTL</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">IPPROTO_IP</td>
<td style="text-align:center">IP_MULTICAST_TTL</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">IPPROTO_IP</td>
<td style="text-align:center">IP_MULTICAST_LOOP</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">IPPROTO_IP</td>
<td style="text-align:center">IP_MULTICAST_IF</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">IPPROTO_TCP</td>
<td style="text-align:center">TCP_KEEPALIVE</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">IPPROTO_TCP</td>
<td style="text-align:center">TCP_NODELAY</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
<tr>
<td style="text-align:center">IPPROTO_TCP</td>
<td style="text-align:center">TCP_MAXSEG</td>
<td style="text-align:center">O</td>
<td style="text-align:center">O</td>
</tr>
</tbody>
</table>
<p>ä»è¡¨ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¥—æ¥å­—å¯é€‰é¡¹æ˜¯åˆ†å±‚çš„ã€‚</p>
<ul>
<li>
<p>IPPROTO_IP å¯é€‰é¡¹æ˜¯IPåè®®ç›¸å…³äº‹é¡¹</p>
</li>
<li>
<p>IPPROTO_TCP å±‚å¯é€‰é¡¹æ˜¯ TCP åè®®çš„ç›¸å…³äº‹é¡¹</p>
</li>
<li>
<p>SOL_SOCKET å±‚æ˜¯å¥—æ¥å­—çš„é€šç”¨å¯é€‰é¡¹ã€‚</p>
</li>
</ul>
<h4>9.1.2 <code>getsockopt</code> &amp; <code>setsockopt</code></h4>
<p>å¯é€‰é¡¹çš„è¯»å–å’Œè®¾ç½®é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°æ¥å®Œæˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getsockopt</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> level, <span class="keyword">int</span> optname, <span class="keyword">void</span> *optval, <span class="keyword">socklen_t</span> *optlen)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">sock: ç”¨äºæŸ¥çœ‹é€‰é¡¹å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">level: è¦æŸ¥çœ‹çš„å¯é€‰é¡¹åè®®å±‚</span></span><br><span class="line"><span class="comment">optname: è¦æŸ¥çœ‹çš„å¯é€‰é¡¹å</span></span><br><span class="line"><span class="comment">optval: ä¿å­˜æŸ¥çœ‹ç»“æœçš„ç¼“å†²åœ°å€å€¼</span></span><br><span class="line"><span class="comment">optlen: å‘ç¬¬å››ä¸ªå‚æ•°ä¼ é€’çš„ç¼“å†²å¤§å°ã€‚è°ƒç”¨å‡½æ•°å€™ï¼Œè¯¥å˜é‡ä¸­ä¿å­˜é€šè¿‡ç¬¬å››ä¸ªå‚æ•°è¿”å›çš„å¯é€‰é¡¹ä¿¡æ¯çš„å­—èŠ‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°å‡½æ•°å¯ä»¥ç”¨æ¥è¯»å–å¥—æ¥å­—å¯é€‰é¡¹ï¼Œä¸‹é¢çš„å‡½æ•°å¯ä»¥æ›´æ”¹å¯é€‰é¡¹ï¼šd</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setsockopt</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> level, <span class="keyword">int</span> optname, <span class="keyword">const</span> <span class="keyword">void</span> *optval, <span class="keyword">socklen_t</span> optlen)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">sock: ç”¨äºæ›´æ”¹é€‰é¡¹å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">level: è¦æ›´æ”¹çš„å¯é€‰é¡¹åè®®å±‚</span></span><br><span class="line"><span class="comment">optname: è¦æ›´æ”¹çš„å¯é€‰é¡¹å</span></span><br><span class="line"><span class="comment">optval: ä¿å­˜æ›´æ”¹ç»“æœçš„ç¼“å†²åœ°å€å€¼</span></span><br><span class="line"><span class="comment">optlen: å‘ç¬¬å››ä¸ªå‚æ•°ä¼ é€’çš„ç¼“å†²å¤§å°ã€‚è°ƒç”¨å‡½æ•°å€™ï¼Œè¯¥å˜é‡ä¸­ä¿å­˜é€šè¿‡ç¬¬å››ä¸ªå‚æ•°è¿”å›çš„å¯é€‰é¡¹ä¿¡æ¯çš„å­—èŠ‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä»£ç å¯ä»¥çœ‹å‡º getsockopt çš„ä½¿ç”¨æ–¹æ³•ã€‚ä¸‹é¢ç¤ºä¾‹ç”¨åè®®å±‚ä¸º SOL_SOCKET ã€åä¸º SO_TYPE çš„å¯é€‰é¡¹æŸ¥çœ‹å¥—æ¥å­—ç±»å‹ï¼ˆTCP å’Œ UDP ï¼‰ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch09/sock_type.c" target="_blank" rel="noopener">sock_type.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc sock_type.c -o sock_type</span><br><span class="line">./sock_type</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SOCK_STREAM: 1</span><br><span class="line">SOCK_DGRAM: 2</span><br><span class="line">Socket type one: 1</span><br><span class="line">Socket type two: 2</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª TCP å¥—æ¥å­—å’Œä¸€ä¸ª UDP å¥—æ¥å­—ã€‚ç„¶åé€šè¿‡è°ƒç”¨ getsockopt å‡½æ•°æ¥è·å¾—å½“å‰å¥—æ¥å­—çš„çŠ¶æ€ã€‚</p>
<p>éªŒè¯å¥—æ¥ç±»å‹çš„ SO_TYPE æ˜¯åªè¯»å¯é€‰é¡¹ï¼Œå› ä¸º<strong>å¥—æ¥å­—ç±»å‹åªèƒ½åœ¨åˆ›å»ºæ—¶å†³å®šï¼Œä»¥åä¸èƒ½å†æ›´æ”¹</strong>ã€‚</p>
<h4>9.1.3 <code>SO_SNDBUF</code> &amp; <code>SO_RCVBUF</code></h4>
<p>åˆ›å»ºå¥—æ¥å­—çš„åŒæ—¶ä¼šç”Ÿæˆ I/O ç¼“å†²ã€‚å…³äº I/O ç¼“å†²ï¼Œå¯ä»¥å»çœ‹ç¬¬äº”ç« ã€‚</p>
<p>SO_RCVBUF æ˜¯è¾“å…¥ç¼“å†²å¤§å°ç›¸å…³å¯é€‰é¡¹ï¼ŒSO_SNDBUF æ˜¯è¾“å‡ºç¼“å†²å¤§å°ç›¸å…³å¯é€‰é¡¹ã€‚ç”¨è¿™ 2 ä¸ªå¯é€‰é¡¹æ—¢å¯ä»¥è¯»å–å½“å‰ I/O å¤§å°ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæ›´æ”¹ã€‚é€šè¿‡ä¸‹åˆ—ç¤ºä¾‹è¯»å–åˆ›å»ºå¥—æ¥å­—æ—¶é»˜è®¤çš„ I/O ç¼“å†²å¤§å°ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch09/get_buf.c" target="_blank" rel="noopener">get_buf.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc get_buf.c -o getbuf</span><br><span class="line">./getbuf</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Input buffer size: 87380</span><br><span class="line">Output buffer size: 16384</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºæœ¬æœºçš„è¾“å…¥ç¼“å†²å’Œè¾“å‡ºç¼“å†²å¤§å°ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†ï¼Œé€šè¿‡ç¨‹åºè®¾ç½® I/O ç¼“å†²åŒºçš„å¤§å°</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch09/set_buf.c" target="_blank" rel="noopener">set_buf.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc get_buf.c -o setbuf</span><br><span class="line">./setbuf</span><br></pre></td></tr></table></figure>
<p>ç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Input buffer size: 6144</span><br><span class="line">Output buffer size: 6144</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœå’Œæˆ‘ä»¬é¢„æƒ³çš„ä¸æ˜¯å¾ˆç›¸åŒï¼Œç¼“å†²å¤§å°çš„è®¾ç½®éœ€è°¨æ…å¤„ç†ï¼Œå› æ­¤ä¸ä¼šå®Œå…¨æŒ‰ç…§æˆ‘ä»¬çš„è¦æ±‚è¿›è¡Œã€‚</p>
<h3>9.2 <code>SO_REUSEADDR</code></h3>
<h4>9.2.1 å‘ç”Ÿåœ°å€åˆ†é…é”™è¯¯ï¼ˆBinding Errorï¼‰</h4>
<p>åœ¨å­¦ä¹  SO_REUSEADDR å¯é€‰é¡¹ä¹‹å‰ï¼Œåº”è¯¥å¥½å¥½ç†è§£ Time-wait çŠ¶æ€ã€‚çœ‹ä»¥ä¸‹ä»£ç çš„ç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch09/reuseadr_eserver.c" target="_blank" rel="noopener">reuseadr_eserver.c</a></li>
</ul>
<p>è¿™æ˜¯ä¸€ä¸ªå›å£°æœåŠ¡å™¨çš„æœåŠ¡ç«¯ä»£ç ï¼Œå¯ä»¥é…åˆç¬¬å››ç« çš„ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch04/echo_client.c" target="_blank" rel="noopener">echo_client.c</a> ä½¿ç”¨ï¼Œåœ¨è¿™ä¸ªä»£ç ä¸­ï¼Œå®¢æˆ·ç«¯é€šçŸ¥æœåŠ¡å™¨ç»ˆæ­¢ç¨‹åºã€‚åœ¨å®¢æˆ·ç«¯æ§åˆ¶å°è¾“å…¥ Q å¯ä»¥ç»“æŸç¨‹åºï¼Œå‘æœåŠ¡å™¨å‘é€ FIN æ¶ˆæ¯å¹¶ç»è¿‡å››æ¬¡æ¡æ‰‹è¿‡ç¨‹ã€‚å½“ç„¶ï¼Œè¾“å…¥ CTRL+C ä¹Ÿä¼šå‘æœåŠ¡å™¨ä¼ é€’ FIN ä¿¡æ¯ã€‚å¼ºåˆ¶ç»ˆæ­¢ç¨‹åºæ—¶ï¼Œç”±æ“ä½œç³»ç»Ÿå…³é—­æ–‡ä»¶å¥—æ¥å­—ï¼Œæ­¤è¿‡ç¨‹ç›¸å½“äºè°ƒç”¨ close å‡½æ•°ï¼Œä¹Ÿä¼šå‘æœåŠ¡å™¨å‘é€ FIN æ¶ˆæ¯ã€‚</p>
<p>è¿™æ ·çœ‹ä¸åˆ°æ˜¯ä»€ä¹ˆç‰¹æ®Šç°è±¡ï¼Œè€ƒè™‘ä»¥ä¸‹æƒ…å†µï¼š</p>
<blockquote>
<p>æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯éƒ½å·²ç»å»ºç«‹è¿æ¥çš„çŠ¶æ€ä¸‹ï¼Œå‘æœåŠ¡å™¨æ§åˆ¶å°è¾“å…¥ CTRL+C ï¼Œå¼ºåˆ¶å…³é—­æœåŠ¡ç«¯</p>
</blockquote>
<p>å¦‚æœç”¨è¿™ç§æ–¹å¼ç»ˆæ­¢ç¨‹åºï¼Œå¦‚æœç”¨åŒä¸€ç«¯å£å·å†æ¬¡è¿è¡ŒæœåŠ¡ç«¯ï¼Œå°±ä¼šè¾“å‡ºã€Œbind() errorã€æ¶ˆæ¯ï¼Œå¹¶ä¸”æ— æ³•å†æ¬¡è¿è¡Œã€‚ä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†è¿‡å¤§çº¦ 3 åˆ†é’Ÿå°±å¯ä»¥é‡æ–°è¿è¡ŒæœåŠ¡ç«¯ã€‚</p>
<h4>9.2.2 <code>Time-wait</code> çŠ¶æ€</h4>
<p>è§‚å¯Ÿä»¥ä¸‹è¿‡ç¨‹ï¼š</p>
<p><img src="https://i.loli.net/2019/01/19/5c42db182cade.png" alt="" /></p>
<p>å‡è®¾å›¾ä¸­ä¸»æœº A æ˜¯æœåŠ¡å™¨ï¼Œå› ä¸ºæ˜¯ä¸»æœº A å‘ B å‘é€ FIN æ¶ˆæ¯ï¼Œæ•…å¯æƒ³è±¡æˆæœåŠ¡å™¨ç«¯åœ¨æ§åˆ¶å°ä¸­è¾“å…¥ CTRL+C ã€‚ä½†æ˜¯é—®é¢˜æ˜¯ï¼Œå¥—æ¥å­—ç»è¿‡å››æ¬¡æ¡æ‰‹åå¹¶æ²¡æœ‰ç«‹å³æ¶ˆé™¤ï¼Œè€Œæ˜¯è¦ç»è¿‡ä¸€æ®µæ—¶é—´çš„ Time-wait çŠ¶æ€ã€‚å½“ç„¶ï¼Œåªæœ‰å…ˆæ–­å¼€è¿æ¥çš„ï¼ˆå…ˆå‘é€ FIN æ¶ˆæ¯çš„ï¼‰ä¸»æœºæ‰ç»è¿‡ Time-wait çŠ¶æ€ã€‚å› æ­¤ï¼Œè‹¥æœåŠ¡å™¨ç«¯å…ˆæ–­å¼€è¿æ¥ï¼Œåˆ™æ— æ³•ç«‹å³é‡æ–°è¿è¡Œã€‚å¥—æ¥å­—å¤„åœ¨ Time-wait è¿‡ç¨‹æ—¶ï¼Œç›¸åº”ç«¯å£æ˜¯æ­£åœ¨ä½¿ç”¨çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œå°±åƒä¹‹å‰éªŒè¯è¿‡çš„ï¼Œbind å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿé”™è¯¯ã€‚</p>
<p><strong>å®é™…ä¸Šï¼Œä¸è®ºæ˜¯æœåŠ¡ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Œéƒ½è¦ç»è¿‡ä¸€æ®µæ—¶é—´çš„ Time-wait è¿‡ç¨‹ã€‚å…ˆæ–­å¼€è¿æ¥çš„å¥—æ¥å­—å¿…ç„¶ä¼šç»è¿‡ Time-wait è¿‡ç¨‹ï¼Œä½†æ˜¯ç”±äºå®¢æˆ·ç«¯å¥—æ¥å­—çš„ç«¯å£æ˜¯ä»»æ„åˆ¶å®šçš„ï¼Œæ‰€ä»¥æ— éœ€è¿‡å¤šå…³æ³¨ Time-wait çŠ¶æ€ã€‚</strong></p>
<p>é‚£åˆ°åº•ä¸ºä»€ä¹ˆä¼šæœ‰ Time-wait çŠ¶æ€å‘¢ï¼Œåœ¨å›¾ä¸­å‡è®¾ï¼Œä¸»æœº A å‘ä¸»æœº B ä¼ è¾“ ACK æ¶ˆæ¯ï¼ˆSEQ 5001 , ACK 7502 ï¼‰åç«‹åˆ»æ¶ˆé™¤å¥—æ¥å­—ã€‚ä½†æ˜¯æœ€åè¿™æ¡ ACK æ¶ˆæ¯åœ¨ä¼ é€’è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œæ²¡æœ‰ä¼ é€’ä¸»æœº B ï¼Œè¿™æ—¶ä¸»æœº B å°±ä¼šè¯•å›¾é‡ä¼ ã€‚ä½†æ˜¯æ­¤æ—¶ä¸»æœº A å·²ç»æ˜¯å®Œå…¨ç»ˆæ­¢çŠ¶æ€ï¼Œå› ä¸ºä¸»æœº B æ°¸è¿œæ— æ³•æ”¶åˆ°ä»ä¸»æœº A æœ€åä¼ æ¥çš„ ACK æ¶ˆæ¯ã€‚åŸºäºè¿™äº›é—®é¢˜çš„è€ƒè™‘ï¼Œæ‰€ä»¥è¦è®¾è®¡ Time-wait çŠ¶æ€ã€‚</p>
<h4>9.2.3 åœ°å€å†åˆ†é…</h4>
<p>Time-wait çŠ¶æ€çœ‹ä¼¼é‡è¦ï¼Œä½†æ˜¯ä¸ä¸€å®šè®¨äººå–œæ¬¢ã€‚å¦‚æœç³»ç»Ÿå‘ç”Ÿæ•…éšœç´§æ€¥åœæ­¢ï¼Œè¿™æ—¶éœ€è¦å°½å¿«é‡å¯æœåŠ¡èµ·ä»¥æä¾›æœåŠ¡ï¼Œä½†å› å¤„äº Time-wait çŠ¶æ€è€Œå¿…é¡»ç­‰å¾…å‡ åˆ†é’Ÿã€‚å› æ­¤ï¼ŒTime-wait å¹¶éåªæœ‰ä¼˜ç‚¹ï¼Œè¿™äº›æƒ…å†µä¸‹å®¹æ˜“å¼•å‘å¤§é—®é¢˜ã€‚ä¸‹å›¾ä¸­å±•ç¤ºäº†å››æ¬¡æ¡æ‰‹æ—¶ä¸å¾—ä¸å»¶é•¿ Time-wait è¿‡ç¨‹çš„æƒ…å†µã€‚</p>
<p><img src="https://i.loli.net/2019/01/19/5c42dec2ba42b.png" alt="" /></p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œåœ¨ä¸»æœº A å››æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ€åçš„æ•°æ®ä¸¢å¤±ï¼Œåˆ™ä¸»æœº B ä¼šè®¤ä¸ºä¸»æœº A æœªèƒ½æ”¶åˆ°è‡ªå·±å‘é€çš„ FIN ä¿¡æ¯ï¼Œå› æ­¤é‡ä¼ ã€‚è¿™æ—¶ï¼Œæ”¶åˆ°çš„ FIN æ¶ˆæ¯çš„ä¸»æœº A å°†é‡å¯  Time-wait è®¡æ—¶å™¨ã€‚å› æ­¤ï¼Œå¦‚æœç½‘ç»œçŠ¶å†µä¸ç†æƒ³ï¼Œ Time-wait å°†æŒç»­ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨å¥—æ¥å­—çš„å¯é€‰é¡¹ä¸­æ›´æ”¹ SO_REUSEADDR çš„çŠ¶æ€ã€‚é€‚å½“è°ƒæ•´è¯¥å‚æ•°ï¼Œå¯å°† Time-wait çŠ¶æ€ä¸‹çš„å¥—æ¥å­—ç«¯å£å·é‡æ–°åˆ†é…ç»™æ–°çš„å¥—æ¥å­—ã€‚SO_REUSEADDR çš„é»˜è®¤å€¼ä¸º 0.è¿™å°±æ„å‘³ç€æ— æ³•åˆ†é… Time-wait çŠ¶æ€ä¸‹çš„å¥—æ¥å­—ç«¯å£å·ã€‚å› æ­¤éœ€è¦å°†è¿™ä¸ªå€¼æ”¹æˆ 1 ã€‚å…·ä½“ä½œæ³•å·²åœ¨ç¤ºä¾‹ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch09/reuseadr_eserver.c" target="_blank" rel="noopener">reuseadr_eserver.c</a> ç»™å‡ºï¼Œåªéœ€è¦æŠŠæ³¨é‡Šæ‰çš„ä¸œè¥¿æ¥è§£é™¤æ³¨é‡Šå³å¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">optlen = <span class="keyword">sizeof</span>(option);</span><br><span class="line">option = TRUE;</span><br><span class="line">setsockopt(serv_sock, SOL_SOCKET, SO_REUSEADDR, (<span class="keyword">void</span> *)&amp;option, optlen);</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œå·²ç»è§£å†³äº†ä¸Šè¿°é—®é¢˜ã€‚</p>
<h3>9.3 <code>TCP_NODELAY</code></h3>
<h4>9.3.1 <code>Nagle</code> ç®—æ³•</h4>
<p>ä¸ºäº†é˜²æ­¢å› æ•°æ®åŒ…è¿‡å¤šè€Œå‘ç”Ÿç½‘ç»œè¿‡è½½ï¼Œ<code>Nagle</code> ç®—æ³•è¯ç”Ÿäº†ã€‚å®ƒåº”ç”¨äº TCP å±‚ã€‚å®ƒæ˜¯å¦ä½¿ç”¨ä¼šå¯¼è‡´å¦‚å›¾æ‰€ç¤ºçš„å·®å¼‚ï¼š</p>
<p><img src="https://i.loli.net/2019/01/19/5c42e12abc5b8.png" alt="" /></p>
<p>å›¾ä¸­å±•ç¤ºäº†é€šè¿‡ <code>Nagle</code> ç®—æ³•å‘é€å­—ç¬¦ä¸² <code>Nagle</code> å’Œæœªä½¿ç”¨ <code>Nagle</code> ç®—æ³•çš„å·®åˆ«ã€‚å¯ä»¥å¾—åˆ°ä¸€ä¸ªç»“è®ºã€‚</p>
<p><strong>åªæœ‰æ¥æ”¶åˆ°å‰ä¸€æ•°æ®çš„ ACK æ¶ˆæ¯ï¼Œ <code>Nagle</code> ç®—æ³•æ‰å‘é€ä¸‹ä¸€æ•°æ®ã€‚</strong></p>
<p>TCP å¥—æ¥å­—é»˜è®¤ä½¿ç”¨ <code>Nagle</code> ç®—æ³•äº¤æ¢æ•°æ®ï¼Œå› æ­¤æœ€å¤§é™åº¦çš„è¿›è¡Œç¼“å†²ï¼Œç›´åˆ°æ”¶åˆ° ACK ã€‚å·¦å›¾ä¹Ÿå°±æ˜¯è¯´ä¸€å…±ä¼ é€’ 4 ä¸ªæ•°æ®åŒ…ä»¥ä¼ è¾“ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ä»å³å›¾å¯ä»¥çœ‹å‡ºï¼Œå‘é€æ•°æ®åŒ…ä¸€å…±ä½¿ç”¨äº† 10 ä¸ªæ•°æ®åŒ…ã€‚ç”±æ­¤å¯çŸ¥ï¼Œä¸ä½¿ç”¨ <code>Nagle</code> ç®—æ³•å°†å¯¹ç½‘ç»œæµé‡äº§ç”Ÿè´Ÿé¢å½±å“ã€‚å³ä½¿åªä¼ è¾“ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå…¶å¤´ä¿¡æ¯éƒ½å¯èƒ½æ˜¯å‡ åä¸ªå­—èŠ‚ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼Œå¿…é¡»ä½¿ç”¨ <code>Nagle</code> ç®—æ³•ã€‚</p>
<p><code>Nagle</code> ç®—æ³•å¹¶ä¸æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹éƒ½é€‚ç”¨ï¼Œç½‘ç»œæµé‡æœªå—å¤ªå¤§å½±å“æ—¶ï¼Œä¸ä½¿ç”¨ <code>Nagle</code> ç®—æ³•è¦æ¯”ä½¿ç”¨å®ƒæ—¶ä¼ è¾“é€Ÿåº¦å¿«ã€‚æœ€å…¸å‹çš„å°±æ˜¯ã€Œä¼ è¾“å¤§æ–‡æ•°æ®ã€ã€‚å°†æ–‡ä»¶æ•°æ®ä¼ å…¥è¾“å‡ºç¼“å†²ä¸ä¼šèŠ±å¤ªå¤šæ—¶é—´ï¼Œå› æ­¤ï¼Œä¸ä½¿ç”¨ <code>Nagle</code> ç®—æ³•ï¼Œä¹Ÿä¼šåœ¨è£…æ»¡è¾“å‡ºç¼“å†²æ—¶ä¼ è¾“æ•°æ®åŒ…ã€‚è¿™ä¸ä»…ä¸ä¼šå¢åŠ æ•°æ®åŒ…çš„æ•°é‡ï¼Œåè€Œåœ¨æ— éœ€ç­‰å¾… ACK çš„å‰æä¸‹è¿ç»­ä¼ è¾“ï¼Œå› æ­¤å¯ä»¥å¤§å¤§æé«˜ä¼ è¾“é€Ÿåº¦ã€‚</p>
<p>æ‰€ä»¥ï¼Œæœªå‡†ç¡®åˆ¤æ–­æ•°æ®æ€§è´¨æ—¶ä¸åº”ç¦ç”¨ <code>Nagle</code> ç®—æ³•ã€‚</p>
<h4>9.3.2 ç¦ç”¨ <code>Nagle</code> ç®—æ³•</h4>
<p>ç¦ç”¨ <code>Nagle</code> ç®—æ³•åº”è¯¥ä½¿ç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> opt_val = <span class="number">1</span>;</span><br><span class="line">setsockopt(sock, IPPROTO_TCP, TCP_NODELAY, (<span class="keyword">void</span> *)&amp;opt_val, <span class="keyword">sizeof</span>(opt_val));</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ TCP_NODELAY çš„å€¼æ¥æŸ¥çœ‹<code>Nagle</code> ç®—æ³•çš„è®¾ç½®çŠ¶æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">opt_len = <span class="keyword">sizeof</span>(opt_val);</span><br><span class="line">getsockopt(sock, IPPROTO_TCP, TCP_NODELAY, (<span class="keyword">void</span> *)&amp;opt_val, opt_len);</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ­£åœ¨ä½¿ç”¨<code>Nagle</code> ç®—æ³•ï¼Œé‚£ä¹ˆ opt_val å€¼ä¸º 0ï¼Œå¦‚æœç¦ç”¨åˆ™ä¸º 1.</p>
<p>å…³äºè¿™ä¸ªç®—æ³•ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ªå›ç­”ï¼š<a href="https://www.zhihu.com/question/42308970/answer/246334766" target="_blank" rel="noopener">TCPè¿æ¥ä¸­å¯ç”¨å’Œç¦ç”¨TCP_NODELAYæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</a></p>
<h3>9.4 åŸºäº Windows çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>9.5 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>ä¸‹åˆ—å…³äº Time-wait çŠ¶æ€çš„è¯´æ³•é”™è¯¯çš„æ˜¯ï¼Ÿ</strong></p>
<p>ç­”ï¼šä»¥ä¸‹å­—ä½“åŠ ç²—çš„ä»£è¡¨æ­£ç¡®ã€‚</p>
<ol>
<li>Time-wait çŠ¶æ€åªåœ¨æœåŠ¡å™¨çš„å¥—æ¥å­—ä¸­å‘ç”Ÿ</li>
<li><strong>æ–­å¼€è¿æ¥çš„å››æ¬¡æ¡æ‰‹è¿‡ç¨‹ä¸­ï¼Œå…ˆä¼ è¾“ FIN æ¶ˆæ¯çš„å¥—æ¥å­—å°†è¿›å…¥ Time-wait çŠ¶æ€ã€‚</strong></li>
<li>Time-wait çŠ¶æ€ä¸æ–­å¼€è¿æ¥çš„è¿‡ç¨‹æ— å…³ï¼Œè€Œä¸è¯·æ±‚è¿æ¥è¿‡ç¨‹ä¸­ SYN æ¶ˆæ¯çš„ä¼ è¾“é¡ºåºæœ‰å…³</li>
<li>Time-wait çŠ¶æ€é€šå¸¸å¹¶éå¿…è¦ï¼Œåº”å°½å¯èƒ½é€šè¿‡æ›´æ”¹å¥—æ¥å­—å¯é€‰é¡¹æ¥é˜²æ­¢å…¶å‘ç”Ÿ</li>
</ol>
</li>
<li>
<p><strong>TCP_NODELAY å¯é€‰é¡¹ä¸ Nagle ç®—æ³•æœ‰å…³ï¼Œå¯é€šè¿‡å®ƒç¦ç”¨ Nagle ç®—æ³•ã€‚è¯·é—®ä½•æ—¶åº”è€ƒè™‘ç¦ç”¨ Nagle ç®—æ³•ï¼Ÿç»“åˆæ”¶å‘æ•°æ®çš„ç‰¹æ€§ç»™å‡ºè¯´æ˜ã€‚</strong></p>
<p>ç­”ï¼šå½“ç½‘ç»œæµé‡æœªå—å¤ªå¤§å½±å“æ—¶ï¼Œä¸ä½¿ç”¨ Nagle ç®—æ³•è¦æ¯”ä½¿ç”¨å®ƒæ—¶ä¼ è¾“é€Ÿåº¦å¿«ï¼Œæ¯”å¦‚è¯´åœ¨ä¼ è¾“å¤§æ–‡ä»¶æ—¶ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 10 ç«  å¤šè¿›ç¨‹æœåŠ¡å™¨ç«¯</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>10.1 è¿›ç¨‹æ¦‚å¿µåŠåº”ç”¨</h3>
<h4>10.1.1 å¹¶å‘æœåŠ¡ç«¯çš„å®ç°æ–¹æ³•</h4>
<p>é€šè¿‡æ”¹è¿›æœåŠ¡ç«¯ï¼Œä½¿å…¶åŒæ—¶å‘æ‰€æœ‰å‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œä»¥æé«˜å¹³å‡æ»¡æ„åº¦ã€‚è€Œä¸”ï¼Œç½‘ç»œç¨‹åºä¸­æ•°æ®é€šä¿¡æ—¶é—´æ¯” CPU è¿ç®—æ—¶é—´å æ¯”æ›´å¤§ï¼Œå› æ­¤ï¼Œå‘å¤šä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡æ˜¯ä¸€ç§æœ‰æ•ˆçš„åˆ©ç”¨ CPU çš„æ–¹å¼ã€‚æ¥ä¸‹æ¥è®¨è®ºåŒæ—¶å‘å¤šä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡çš„å¹¶å‘æœåŠ¡å™¨ç«¯ã€‚ä¸‹é¢åˆ—å‡ºçš„æ˜¯å…·æœ‰ä»£è¡¨æ€§çš„å¹¶å‘æœåŠ¡ç«¯çš„å®ç°æ¨¡å‹å’Œæ–¹æ³•ï¼š</p>
<ul>
<li>å¤šè¿›ç¨‹æœåŠ¡å™¨ï¼šé€šè¿‡åˆ›å»ºå¤šä¸ªè¿›ç¨‹æä¾›æœåŠ¡</li>
<li>å¤šè·¯å¤ç”¨æœåŠ¡å™¨ï¼šé€šè¿‡æ†ç»‘å¹¶ç»Ÿä¸€ç®¡ç† I/O å¯¹è±¡æä¾›æœåŠ¡</li>
<li>å¤šçº¿ç¨‹æœåŠ¡å™¨ï¼šé€šè¿‡ç”Ÿæˆä¸å®¢æˆ·ç«¯ç­‰é‡çš„çº¿ç¨‹æä¾›æœåŠ¡</li>
</ul>
<p>å…ˆæ˜¯ç¬¬ä¸€ç§æ–¹æ³•ï¼šå¤šè¿›ç¨‹æœåŠ¡å™¨</p>
<h4>10.1.2 ç†è§£è¿›ç¨‹</h4>
<p>è¿›ç¨‹çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å ç”¨å†…å­˜ç©ºé—´çš„æ­£åœ¨è¿è¡Œçš„ç¨‹åº</p>
</blockquote>
<p>å‡å¦‚ä½ ä¸‹è½½äº†ä¸€ä¸ªæ¸¸æˆåˆ°ç”µè„‘ä¸Šï¼Œæ­¤æ—¶çš„æ¸¸æˆä¸æ˜¯è¿›ç¨‹ï¼Œè€Œæ˜¯ç¨‹åºã€‚åªæœ‰å½“æ¸¸æˆè¢«åŠ è½½åˆ°ä¸»å†…å­˜å¹¶è¿›å…¥è¿è¡ŒçŠ¶æ€ï¼Œè¿™æ˜¯æ‰å¯ç§°ä¸ºè¿›ç¨‹ã€‚</p>
<h4>10.1.3 è¿›ç¨‹ ID</h4>
<p>åœ¨è¯´è¿›ç¨‹åˆ›å»ºæ–¹æ³•ä¹‹å‰ï¼Œå…ˆè¦ç®€è¦è¯´æ˜è¿›ç¨‹ IDã€‚æ— è®ºè¿›ç¨‹æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼šè¢«æ“ä½œç³»ç»Ÿåˆ†é…ä¸€ä¸ª IDã€‚æ­¤ ID è¢«ç§°ä¸ºã€Œè¿›ç¨‹IDã€ï¼Œå…¶å€¼ä¸ºå¤§äº 2 çš„è¯ä¹¦ã€‚1 è¦åˆ†é…ç»™æ“ä½œç³»ç»Ÿå¯åŠ¨åçš„ï¼ˆç”¨äºååŠ©æ“ä½œç³»ç»Ÿï¼‰é¦–ä¸ªè¿›ç¨‹ï¼Œå› æ­¤ç”¨æˆ·æ— æ³•å¾—åˆ° ID å€¼ä¸º 1 ã€‚æ¥ä¸‹æ¥è§‚å¯Ÿåœ¨ Linux ä¸­è¿è¡Œçš„è¿›ç¨‹ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps au</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šé¢çš„å‘½ä»¤å¯æŸ¥çœ‹å½“å‰è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥å‘½ä»¤åŒæ—¶åˆ—å‡ºäº† PIDï¼ˆè¿›ç¨‹IDï¼‰ã€‚å‚æ•° a å’Œ uåˆ—å‡ºäº†æ‰€æœ‰è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
<p><img src="https://i.loli.net/2019/01/20/5c43d7c1f2a8b.png" alt="" /></p>
<h4>10.1.4 é€šè¿‡è°ƒç”¨ fork å‡½æ•°åˆ›å»ºè¿›ç¨‹</h4>
<p>åˆ›å»ºè¿›ç¨‹çš„æ–¹å¼å¾ˆå¤šï¼Œæ­¤å¤„åªä»‹ç»ç”¨äºåˆ›å»ºå¤šè¿›ç¨‹æœåŠ¡ç«¯çš„ fork å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">fork</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="comment">// æˆåŠŸæ—¶è¿”å›è¿›ç¨‹ID,å¤±è´¥æ—¶è¿”å› -1</span></span><br></pre></td></tr></table></figure>
<p>fork å‡½æ•°å°†åˆ›å»ºè°ƒç”¨çš„è¿›ç¨‹å‰¯æœ¬ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶éæ ¹æ®å®Œå…¨ä¸åŒçš„ç¨‹åºåˆ›å»ºè¿›ç¨‹ï¼Œè€Œæ˜¯å¤åˆ¶æ­£åœ¨è¿è¡Œçš„ã€è°ƒç”¨ fork å‡½æ•°çš„è¿›ç¨‹ã€‚å¦å¤–ï¼Œä¸¤ä¸ªè¿›ç¨‹éƒ½æ‰§è¡Œ fork å‡½æ•°è°ƒç”¨åçš„è¯­å¥ï¼ˆå‡†ç¡®çš„è¯´æ˜¯åœ¨ fork å‡½æ•°è¿”å›åï¼‰ã€‚ä½†å› ä¸ºæ˜¯é€šè¿‡åŒä¸€ä¸ªè¿›ç¨‹ã€å¤åˆ¶ç›¸åŒçš„å†…å­˜ç©ºé—´ï¼Œä¹‹åçš„ç¨‹åºæµè¦æ ¹æ® fork å‡½æ•°çš„è¿”å›å€¼åŠ ä»¥åŒºåˆ†ã€‚å³åˆ©ç”¨ fork å‡½æ•°çš„å¦‚ä¸‹ç‰¹ç‚¹åŒºåˆ†ç¨‹åºæ‰§è¡Œæµç¨‹ã€‚</p>
<ul>
<li>çˆ¶è¿›ç¨‹ï¼šfork å‡½æ•°è¿”å›å­è¿›ç¨‹ ID</li>
<li>å­è¿›ç¨‹ï¼šfork å‡½æ•°è¿”å› 0</li>
</ul>
<p>æ­¤å¤„ï¼Œã€Œçˆ¶è¿›ç¨‹ã€ï¼ˆParent Processï¼‰æŒ‡åŸè¿›ç¨‹ï¼Œå³è°ƒç”¨ fork å‡½æ•°çš„ä¸»ä½“ï¼Œè€Œã€Œå­è¿›ç¨‹ã€ï¼ˆChild Processï¼‰æ˜¯é€šè¿‡çˆ¶è¿›ç¨‹è°ƒç”¨ fork å‡½æ•°å¤åˆ¶å‡ºçš„è¿›ç¨‹ã€‚æ¥ä¸‹æ¥æ˜¯è°ƒç”¨ fork å‡½æ•°åçš„ç¨‹åºè¿è¡Œæµç¨‹ã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/20/5c43da5412b90.png" alt="" /></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨ fork å‡½æ•°çš„åŒæ—¶å¤åˆ¶å‡ºå­è¿›ç¨‹ï¼Œå¹¶åˆ†åˆ«å¾—åˆ° fork å‡½æ•°çš„è¿”å›å€¼ã€‚ä½†å¤åˆ¶å‰ï¼Œçˆ¶è¿›ç¨‹å°†å…¨å±€å˜é‡ gval å¢åŠ åˆ° 11,å°†å±€éƒ¨å˜é‡ lval çš„å€¼å¢åŠ åˆ° 25ï¼Œå› æ­¤åœ¨è¿™ç§çŠ¶æ€ä¸‹å®Œæˆè¿›ç¨‹å¤åˆ¶ã€‚å¤åˆ¶å®Œæˆåæ ¹æ® fork å‡½æ•°çš„è¿”å›ç±»å‹åŒºåˆ†çˆ¶å­è¿›ç¨‹ã€‚çˆ¶è¿›ç¨‹çš„ lval çš„å€¼å¢åŠ  1 ï¼Œä½†è¿™ä¸ä¼šå½±å“å­è¿›ç¨‹çš„ lval å€¼ã€‚åŒæ ·å­è¿›ç¨‹å°† gval çš„å€¼å¢åŠ  1 ä¹Ÿä¸ä¼šå½±å“åˆ°çˆ¶è¿›ç¨‹çš„ gval ã€‚å› ä¸º fork å‡½æ•°è°ƒç”¨ååˆ†æˆäº†å®Œå…¨ä¸åŒçš„è¿›ç¨‹ï¼Œåªæ˜¯äºŒè€…å…±äº«åŒä¸€æ®µä»£ç è€Œå·²ã€‚æ¥ä¸‹æ¥ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/fork.c" target="_blank" rel="noopener">fork.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> gval = <span class="number">10</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> lval = <span class="number">20</span>;</span><br><span class="line">    gval++, lval += <span class="number">5</span>;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">        gval += <span class="number">2</span>, lval += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        gval -= <span class="number">2</span>, lval -= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child Proc: [%d,%d] \n"</span>, gval, lval);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Parent Proc: [%d,%d] \n"</span>, gval, lval);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc fork.c -o fork</span><br><span class="line">./fork</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/20/5c43e054e7f6f.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œå½“æ‰§è¡Œäº† fork å‡½æ•°ä¹‹åï¼Œæ­¤åå°±ç›¸å½“äºæœ‰äº†ä¸¤ä¸ªç¨‹åºåœ¨æ‰§è¡Œä»£ç ï¼Œå¯¹äºçˆ¶è¿›ç¨‹æ¥è¯´ï¼Œfork å‡½æ•°è¿”å›çš„æ˜¯å­è¿›ç¨‹çš„IDï¼Œå¯¹äºå­è¿›ç¨‹æ¥è¯´ï¼Œfork å‡½æ•°è¿”å› 0ã€‚æ‰€ä»¥è¿™ä¸¤ä¸ªå˜é‡ï¼Œçˆ¶è¿›ç¨‹è¿›è¡Œäº† +2 æ“ä½œ ï¼Œè€Œå­è¿›ç¨‹è¿›è¡Œäº† -2 æ“ä½œï¼Œæ‰€ä»¥ç»“æœæ˜¯è¿™æ ·ã€‚</p>
<h3>10.2 è¿›ç¨‹å’Œåƒµå°¸è¿›ç¨‹</h3>
<p>æ–‡ä»¶æ“ä½œä¸­ï¼Œå…³é—­æ–‡ä»¶å’Œæ‰“å¼€æ–‡ä»¶åŒç­‰é‡è¦ã€‚åŒæ ·ï¼Œè¿›ç¨‹é”€æ¯å’Œè¿›ç¨‹åˆ›å»ºä¹ŸåŒç­‰é‡è¦ã€‚å¦‚æœæœªè®¤çœŸå¯¹å¾…è¿›ç¨‹é”€æ¯ï¼Œä»–ä»¬å°†å˜æˆåƒµå°¸è¿›ç¨‹ã€‚</p>
<h4>10.2.1 åƒµå°¸ï¼ˆZombieï¼‰è¿›ç¨‹</h4>
<p>è¿›ç¨‹çš„å·¥ä½œå®Œæˆåï¼ˆæ‰§è¡Œå®Œ main å‡½æ•°ä¸­çš„ç¨‹åºåï¼‰åº”è¢«é”€æ¯ï¼Œä½†æœ‰æ—¶è¿™äº›è¿›ç¨‹å°†å˜æˆåƒµå°¸è¿›ç¨‹ï¼Œå ç”¨ç³»ç»Ÿä¸­çš„é‡è¦èµ„æºã€‚è¿™ç§çŠ¶æ€ä¸‹çš„è¿›ç¨‹ç§°ä½œã€Œåƒµå°¸è¿›ç¨‹ã€ï¼Œè¿™ä¹Ÿæ˜¯ç»™ç³»ç»Ÿå¸¦æ¥è´Ÿæ‹…çš„åŸå› ä¹‹ä¸€ã€‚</p>
<blockquote>
<p>åƒµå°¸è¿›ç¨‹æ˜¯å½“å­è¿›ç¨‹æ¯”çˆ¶è¿›ç¨‹å…ˆç»“æŸï¼Œè€Œçˆ¶è¿›ç¨‹åˆæ²¡æœ‰å›æ”¶å­è¿›ç¨‹ï¼Œé‡Šæ”¾å­è¿›ç¨‹å ç”¨çš„èµ„æºï¼Œæ­¤æ—¶å­è¿›ç¨‹å°†æˆä¸ºä¸€ä¸ªåƒµå°¸è¿›ç¨‹ã€‚å¦‚æœçˆ¶è¿›ç¨‹å…ˆé€€å‡º ï¼Œå­è¿›ç¨‹è¢«initæ¥ç®¡ï¼Œå­è¿›ç¨‹é€€å‡ºåinitä¼šå›æ”¶å…¶å ç”¨çš„ç›¸å…³èµ„æº</p>
</blockquote>
<p><strong>ç»´åŸºç™¾ç§‘</strong>ï¼š</p>
<blockquote>
<p>åœ¨ç±»UNIXç³»ç»Ÿä¸­ï¼Œåƒµå°¸è¿›ç¨‹æ˜¯æŒ‡å®Œæˆæ‰§è¡Œï¼ˆé€šè¿‡exitç³»ç»Ÿè°ƒç”¨ï¼Œæˆ–è¿è¡Œæ—¶å‘ç”Ÿè‡´å‘½é”™è¯¯æˆ–æ”¶åˆ°ç»ˆæ­¢ä¿¡å·æ‰€è‡´ï¼‰ä½†åœ¨æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹è¡¨ä¸­ä»ç„¶æœ‰ä¸€ä¸ªè¡¨é¡¹ï¼ˆè¿›ç¨‹æ§åˆ¶å—PCBï¼‰ï¼Œå¤„äº&quot;ç»ˆæ­¢çŠ¶æ€&quot;çš„è¿›ç¨‹ã€‚è¿™å‘ç”Ÿäºå­è¿›ç¨‹éœ€è¦ä¿ç•™è¡¨é¡¹ä»¥å…è®¸å…¶çˆ¶è¿›ç¨‹è¯»å–å­è¿›ç¨‹çš„exit statusï¼šä¸€æ—¦é€€å‡ºæ€é€šè¿‡waitç³»ç»Ÿè°ƒç”¨è¯»å–ï¼Œåƒµå°¸è¿›ç¨‹æ¡ç›®å°±ä»è¿›ç¨‹è¡¨ä¸­åˆ é™¤ï¼Œç§°ä¹‹ä¸º&quot;å›æ”¶ï¼ˆreapedï¼‰&quot;ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ç›´æ¥è¢«å…¶çˆ¶è¿›ç¨‹waitå¹¶ç”±ç³»ç»Ÿå›æ”¶ã€‚è¿›ç¨‹é•¿æ—¶é—´ä¿æŒåƒµå°¸çŠ¶æ€ä¸€èˆ¬æ˜¯é”™è¯¯çš„å¹¶å¯¼è‡´èµ„æºæ³„æ¼ã€‚</p>
<p>è‹±æ–‡æœ¯è¯­zombie processæºè‡ªä¸§å°¸ â€” ä¸æ­»ä¹‹äººï¼Œéšå–»å­è¿›ç¨‹å·²æ­»ä½†ä»ç„¶æ²¡æœ‰è¢«æ”¶å‰²ã€‚ä¸æ­£å¸¸è¿›ç¨‹ä¸åŒï¼Œkillå‘½ä»¤å¯¹åƒµå°¸è¿›ç¨‹æ— æ•ˆã€‚å­¤å„¿è¿›ç¨‹ä¸åŒäºåƒµå°¸è¿›ç¨‹ï¼Œå…¶çˆ¶è¿›ç¨‹å·²ç»æ­»æ‰ï¼Œä½†å­¤å„¿è¿›ç¨‹ä»èƒ½æ­£å¸¸æ‰§è¡Œï¼Œä½†å¹¶ä¸ä¼šå˜ä¸ºåƒµå°¸è¿›ç¨‹ï¼Œå› ä¸ºè¢«initï¼ˆè¿›ç¨‹IDå·ä¸º1ï¼‰æ”¶å…»å¹¶waitå…¶é€€å‡ºã€‚</p>
<p>å­è¿›ç¨‹æ­»åï¼Œç³»ç»Ÿä¼šå‘é€SIGCHLD ä¿¡å·ç»™çˆ¶è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹å¯¹å…¶é»˜è®¤å¤„ç†æ˜¯å¿½ç•¥ã€‚å¦‚æœæƒ³å“åº”è¿™ä¸ªæ¶ˆæ¯ï¼Œçˆ¶è¿›ç¨‹é€šå¸¸åœ¨SIGCHLD ä¿¡å·äº‹ä»¶å¤„ç†ç¨‹åºä¸­ï¼Œä½¿ç”¨waitç³»ç»Ÿè°ƒç”¨æ¥å“åº”å­è¿›ç¨‹çš„ç»ˆæ­¢ã€‚</p>
<p>åƒµå°¸è¿›ç¨‹è¢«æ”¶å‰²åï¼Œå…¶è¿›ç¨‹å·(PID)ä¸åœ¨è¿›ç¨‹è¡¨ä¸­çš„è¡¨é¡¹éƒ½å¯ä»¥è¢«ç³»ç»Ÿé‡ç”¨ã€‚ä½†å¦‚æœçˆ¶è¿›ç¨‹æ²¡æœ‰è°ƒç”¨waitï¼Œåƒµå°¸è¿›ç¨‹å°†ä¿ç•™è¿›ç¨‹è¡¨ä¸­çš„è¡¨é¡¹ï¼Œå¯¼è‡´äº†èµ„æºæ³„æ¼ã€‚æŸäº›æƒ…å†µä¸‹è¿™åå€’æ˜¯æœŸæœ›çš„ï¼šçˆ¶è¿›ç¨‹åˆ›å»ºäº†å¦å¤–ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶å¸Œæœ›å…·æœ‰ä¸åŒçš„è¿›ç¨‹å·ã€‚å¦‚æœçˆ¶è¿›ç¨‹é€šè¿‡è®¾ç½®äº‹ä»¶å¤„ç†å‡½æ•°ä¸ºSIG_IGNæ˜¾å¼å¿½ç•¥SIGCHLDä¿¡å·ï¼Œè€Œä¸æ˜¯éšå¼é»˜è®¤å¿½ç•¥è¯¥ä¿¡å·ï¼Œæˆ–è€…å…·æœ‰SA_NOCLDWAITæ ‡å¿—ï¼Œæ‰€æœ‰å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ä¿¡æ¯å°†è¢«æŠ›å¼ƒå¹¶ä¸”ç›´æ¥è¢«ç³»ç»Ÿå›æ”¶ã€‚</p>
<p>UNIXå‘½ä»¤psåˆ—å‡ºçš„è¿›ç¨‹çš„çŠ¶æ€ï¼ˆâ€œSTATâ€ï¼‰æ æ ‡ç¤ºä¸º &quot;Z&quot;åˆ™ä¸ºåƒµå°¸è¿›ç¨‹ã€‚[1]</p>
<p>æ”¶å‰²åƒµå°¸è¿›ç¨‹çš„æ–¹æ³•æ˜¯é€šè¿‡killå‘½ä»¤æ‰‹å·¥å‘å…¶çˆ¶è¿›ç¨‹å‘é€SIGCHLDä¿¡å·ã€‚å¦‚æœå…¶çˆ¶è¿›ç¨‹ä»ç„¶æ‹’ç»æ”¶å‰²åƒµå°¸è¿›ç¨‹ï¼Œåˆ™ç»ˆæ­¢çˆ¶è¿›ç¨‹ï¼Œä½¿å¾—initè¿›ç¨‹æ”¶å…»åƒµå°¸è¿›ç¨‹ã€‚initè¿›ç¨‹å‘¨æœŸæ‰§è¡Œwaitç³»ç»Ÿè°ƒç”¨æ”¶å‰²å…¶æ”¶å…»çš„æ‰€æœ‰åƒµå°¸è¿›ç¨‹ã€‚</p>
</blockquote>
<h4>10.2.2 äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› </h4>
<p>ä¸ºäº†é˜²æ­¢åƒµå°¸è¿›ç¨‹äº§ç”Ÿï¼Œå…ˆè§£é‡Šäº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„åŸå› ã€‚åˆ©ç”¨å¦‚ä¸‹ä¸¤ä¸ªç¤ºä¾‹å±•ç¤ºè°ƒç”¨ fork å‡½æ•°äº§ç”Ÿå­è¿›ç¨‹çš„ç»ˆæ­¢æ–¹å¼ã€‚</p>
<ul>
<li>ä¼ é€’å‚æ•°å¹¶è°ƒç”¨ exit() å‡½æ•°</li>
<li>main å‡½æ•°ä¸­æ‰§è¡Œ return è¯­å¥å¹¶è¿”å›å€¼</li>
</ul>
<p>**å‘ exit å‡½æ•°ä¼ é€’çš„å‚æ•°å€¼å’Œ main å‡½æ•°çš„ return è¯­å¥è¿”å›çš„å€¼éƒ½å›ä¼ é€’ç»™æ“ä½œç³»ç»Ÿã€‚è€Œæ“ä½œç³»ç»Ÿä¸ä¼šé”€æ¯å­è¿›ç¨‹ï¼Œç›´åˆ°æŠŠè¿™äº›å€¼ä¼ é€’ç»™äº§ç”Ÿè¯¥å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ã€‚å¤„åœ¨è¿™ç§çŠ¶æ€ä¸‹çš„è¿›ç¨‹å°±æ˜¯åƒµå°¸è¿›ç¨‹ã€‚**ä¹Ÿå°±æ˜¯è¯´å°†å­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹çš„æ­£æ˜¯æ“ä½œç³»ç»Ÿã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œåƒµå°¸è¿›ç¨‹ä½•æ—¶è¢«é”€æ¯å‘¢ï¼Ÿ</p>
<blockquote>
<p>åº”è¯¥å‘åˆ›å»ºå­è¿›ç¨‹å†Œçˆ¶è¿›ç¨‹ä¼ é€’å­è¿›ç¨‹çš„ exit å‚æ•°å€¼æˆ– return è¯­å¥çš„è¿”å›å€¼ã€‚</p>
</blockquote>
<p>å¦‚ä½•å‘çˆ¶è¿›ç¨‹ä¼ é€’è¿™äº›å€¼å‘¢ï¼Ÿæ“ä½œç³»ç»Ÿä¸ä¼šä¸»åŠ¨æŠŠè¿™äº›å€¼ä¼ é€’ç»™çˆ¶è¿›ç¨‹ã€‚åªæœ‰çˆ¶è¿›ç¨‹ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼ˆå‡½æ•°è°ƒç”¨ï¼‰çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿæ‰ä¼šä¼ é€’è¯¥å€¼ã€‚æ¢è¨€ä¹‹ï¼Œå¦‚æœçˆ¶è¿›ç¨‹æœªä¸»åŠ¨è¦æ±‚è·å¾—å­è¿›ç¨‹ç»“æŸçŠ¶æ€å€¼ï¼Œæ“ä½œç³»ç»Ÿå°†ä¸€ç›´ä¿å­˜ï¼Œå¹¶è®©å­è¿›ç¨‹é•¿æ—¶é—´å¤„äºåƒµå°¸è¿›ç¨‹çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œçˆ¶æ¯è¦è´Ÿè´£æ”¶å›è‡ªå·±ç”Ÿçš„å­©å­ã€‚æ¥ä¸‹æ¥çš„ç¤ºä¾‹æ˜¯åˆ›å»ºåƒµå°¸è¿›ç¨‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/zombie.c" target="_blank" rel="noopener">zombie.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Hi, I am a child Process"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child Process ID: %d \n"</span>, pid);</span><br><span class="line">        sleep(<span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"End child proess"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"End parent process"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc zombie.c -o zombie</span><br><span class="line">./zombie</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/20/5c443890f1781.png" alt="" /></p>
<p>å› ä¸ºæš‚åœäº† 30 ç§’ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªæ—¶é—´å†…å¯ä»¥éªŒè¯ä¸€ä¸‹å­è¿›ç¨‹æ˜¯å¦ä¸ºåƒµå°¸è¿›ç¨‹ã€‚</p>
<p><img src="https://i.loli.net/2019/01/20/5c4439a751b11.png" alt="" /></p>
<p>é€šè¿‡ <code>ps au</code> å‘½ä»¤å¯ä»¥çœ‹å‡ºï¼Œå­è¿›ç¨‹ä»ç„¶å­˜åœ¨ï¼Œå¹¶æ²¡æœ‰è¢«é”€æ¯ï¼Œåƒµå°¸è¿›ç¨‹åœ¨è¿™é‡Œæ˜¾ç¤ºä¸º <code>Z+</code>.30ç§’åï¼Œçº¢æ¡†é‡Œé¢çš„ä¸¤ä¸ªè¿›ç¨‹ä¼šåŒæ—¶è¢«é”€æ¯ã€‚</p>
<blockquote>
<p>åˆ©ç”¨ <code>./zombie &amp;</code>å¯ä»¥ä½¿ç¨‹åºåœ¨åå°è¿è¡Œï¼Œä¸ç”¨æ‰“å¼€æ–°çš„å‘½ä»¤è¡Œçª—å£ã€‚</p>
</blockquote>
<h4>10.2.3 é”€æ¯åƒµå°¸è¿›ç¨‹ 1ï¼šåˆ©ç”¨ wait å‡½æ•°</h4>
<p>å¦‚å‰æ‰€è¿°ï¼Œä¸ºäº†é”€æ¯å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹åº”è¯¥ä¸»åŠ¨è¯·æ±‚è·å–å­è¿›ç¨‹çš„è¿”å›å€¼ã€‚ä¸‹é¢æ˜¯å‘èµ·è¯·æ±‚çš„å…·ä½“æ–¹æ³•ã€‚æœ‰ä¸¤ç§ï¼Œä¸‹é¢çš„å‡½æ•°æ˜¯å…¶ä¸­ä¸€ç§ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">wait</span><span class="params">(<span class="keyword">int</span> *statloc)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›ç»ˆæ­¢çš„å­è¿›ç¨‹ ID ,å¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨æ­¤å‡½æ•°æ—¶å¦‚æœå·²æœ‰å­è¿›ç¨‹ç»ˆæ­¢ï¼Œé‚£ä¹ˆå­è¿›ç¨‹ç»ˆæ­¢æ—¶ä¼ é€’çš„è¿”å›å€¼ï¼ˆexit å‡½æ•°çš„å‚æ•°è¿”å›å€¼ï¼Œmain å‡½æ•°çš„ return è¿”å›å€¼ï¼‰å°†ä¿å­˜åˆ°è¯¥å‡½æ•°çš„å‚æ•°æ‰€æŒ‡çš„å†…å­˜ç©ºé—´ã€‚ä½†å‡½æ•°å‚æ•°æŒ‡å‘çš„å•å…ƒä¸­è¿˜åŒ…å«å…¶ä»–ä¿¡æ¯ï¼Œå› æ­¤éœ€è¦ç”¨ä¸‹åˆ—å®è¿›è¡Œåˆ†ç¦»ï¼š</p>
<ul>
<li>WIFEXITED å­è¿›ç¨‹æ­£å¸¸ç»ˆæ­¢æ—¶è¿”å›ã€ŒçœŸã€</li>
<li>WEXITSTATUS è¿”å›å­è¿›ç¨‹æ—¶çš„è¿”å›å€¼</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘ wait å‡½æ•°ä¼ é€’å˜é‡ status çš„åœ°å€æ—¶ï¼Œè°ƒç”¨ wait å‡½æ•°ååº”ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Normal termination"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Child pass num: %d"</span>, WEXITSTATUS(status));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä»¥ä¸Šå†…å®¹ï¼Œæœ‰å¦‚ä¸‹ç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/wait.c" target="_blank" rel="noopener">wait.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork(); <span class="comment">//è¿™é‡Œçš„å­è¿›ç¨‹å°†åœ¨ç¬¬13è¡Œé€šè¿‡ return è¯­å¥ç»ˆæ­¢</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child PID: %d \n"</span>, pid);</span><br><span class="line">        pid = fork(); <span class="comment">//è¿™é‡Œçš„å­è¿›ç¨‹å°†åœ¨ 21 è¡Œé€šè¿‡ exit() å‡½æ•°ç»ˆæ­¢</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">7</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Child PID: %d \n"</span>, pid);</span><br><span class="line">            wait(&amp;status);         <span class="comment">//ä¹‹é—´ç»ˆæ­¢çš„å­è¿›ç¨‹ç›¸å…³ä¿¡æ¯å°†è¢«ä¿å­˜åˆ° status ä¸­ï¼ŒåŒæ—¶ç›¸å…³å­è¿›ç¨‹è¢«å®Œå…¨é”€æ¯</span></span><br><span class="line">            <span class="keyword">if</span> (WIFEXITED(status)) <span class="comment">//é€šè¿‡ WIFEXITED æ¥éªŒè¯å­è¿›ç¨‹æ˜¯å¦æ­£å¸¸ç»ˆæ­¢ã€‚å¦‚æœæ­£å¸¸ç»ˆæ­¢ï¼Œåˆ™è°ƒç”¨ WEXITSTATUS å®è¾“å‡ºå­è¿›ç¨‹è¿”å›å€¼</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Child send one: %d \n"</span>, WEXITSTATUS(status));</span><br><span class="line"></span><br><span class="line">            wait(&amp;status); <span class="comment">//å› ä¸ºä¹‹å‰åˆ›å»ºäº†ä¸¤ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥å†æ¬¡è°ƒç”¨ wait å‡½æ•°å’Œå®</span></span><br><span class="line">            <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Child send two: %d \n"</span>, WEXITSTATUS(status));</span><br><span class="line">            sleep(<span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc wait.c -o wait</span><br><span class="line">./wait</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/20/5c4441951df43.png" alt="" /></p>
<p>æ­¤æ—¶ï¼Œç³»ç»Ÿä¸­å¹¶æ²¡æœ‰ä¸Šè¿° PID å¯¹åº”çš„è¿›ç¨‹ï¼Œè¿™æ˜¯å› ä¸ºè°ƒç”¨äº† wait å‡½æ•°ï¼Œå®Œå…¨é”€æ¯äº†è¯¥å­è¿›ç¨‹ã€‚å¦å¤–ä¸¤ä¸ªå­è¿›ç¨‹è¿”å›æ—¶è¿”å›çš„ 3 å’Œ 7 ä¼ é€’åˆ°äº†çˆ¶è¿›ç¨‹ã€‚</p>
<p>è¿™å°±æ˜¯é€šè¿‡ wait å‡½æ•°æ¶ˆç­åƒµå°¸è¿›ç¨‹çš„æ–¹æ³•ï¼Œè°ƒç”¨ wait å‡½æ•°æ—¶ï¼Œå¦‚æœæ²¡æœ‰å·²ç»ç»ˆæ­¢çš„å­è¿›ç¨‹ï¼Œé‚£ä¹ˆç¨‹åºå°†é˜»å¡ï¼ˆBlockingï¼‰ç›´åˆ°æœ‰å­è¿›ç¨‹ç»ˆæ­¢ï¼Œå› æ­¤è¦è°¨æ…è°ƒç”¨è¯¥å‡½æ•°ã€‚</p>
<h4>10.2.4 é”€æ¯åƒµå°¸è¿›ç¨‹ 2ï¼šä½¿ç”¨ waitpid å‡½æ•°</h4>
<p>wait å‡½æ•°ä¼šå¼•èµ·ç¨‹åºé˜»å¡ï¼Œè¿˜å¯ä»¥è€ƒè™‘è°ƒç”¨ waitpid å‡½æ•°ã€‚è¿™æ˜¯é˜²æ­¢åƒµå°¸è¿›ç¨‹çš„ç¬¬äºŒç§æ–¹æ³•ï¼Œä¹Ÿæ˜¯é˜²æ­¢é˜»å¡çš„æ–¹æ³•ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">waitpid</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> *statloc, <span class="keyword">int</span> options)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›ç»ˆæ­¢çš„å­è¿›ç¨‹ID æˆ– 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">pid: ç­‰å¾…ç»ˆæ­¢çš„ç›®æ ‡å­è¿›ç¨‹çš„ID,è‹¥ä¼  -1ï¼Œåˆ™ä¸ wait å‡½æ•°ç›¸åŒï¼Œå¯ä»¥ç­‰å¾…ä»»æ„å­è¿›ç¨‹ç»ˆæ­¢</span></span><br><span class="line"><span class="comment">statloc: ä¸ wait å‡½æ•°çš„ statloc å‚æ•°å…·æœ‰ç›¸åŒå«ä¹‰</span></span><br><span class="line"><span class="comment">options: ä¼ é€’å¤´æ–‡ä»¶ sys/wait.h å£°æ˜çš„å¸¸é‡ WNOHANG ,å³ä½¿æ²¡æœ‰ç»ˆæ­¢çš„å­è¿›ç¨‹ä¹Ÿä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯è¿”å› 0 é€€å‡ºå‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸‹æ˜¯ waitpid çš„ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/waitpid.c" target="_blank" rel="noopener">waitpid.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">15</span>); <span class="comment">//ç”¨ sleep æ¨è¿Ÿå­è¿›ç¨‹çš„æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">24</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨waitpid ä¼ é€’å‚æ•° WNOHANG ï¼Œè¿™æ ·ä¹‹å‰æœ‰æ²¡æœ‰ç»ˆæ­¢çš„å­è¿›ç¨‹åˆ™è¿”å›0</span></span><br><span class="line">        <span class="keyword">while</span> (!waitpid(<span class="number">-1</span>, &amp;status, WNOHANG))</span><br><span class="line">        &#123;</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"sleep 3 sec."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Child send %d \n"</span>, WEXITSTATUS(status));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc waitpid.c -o waitpid</span><br><span class="line">./waitpid</span><br></pre></td></tr></table></figure>
<p>ç»“æœ:</p>
<p><img src="https://i.loli.net/2019/01/20/5c444785a16ae.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨ while å¾ªç¯ä¸­æ­£å¥½æ‰§è¡Œäº† 5 æ¬¡ã€‚è¿™ä¹Ÿè¯æ˜äº† waitpid å‡½æ•°å¹¶æ²¡æœ‰é˜»å¡</p>
<h3>10.3 ä¿¡å·å¤„ç†</h3>
<p>æˆ‘ä»¬å·²ç»çŸ¥é“äº†è¿›ç¨‹çš„åˆ›å»ºåŠé”€æ¯çš„åŠæ³•ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³ã€‚</p>
<blockquote>
<p>å­è¿›ç¨‹ç©¶ç«Ÿä½•æ—¶ç»ˆæ­¢ï¼Ÿè°ƒç”¨ waitpid å‡½æ•°åè¦æ— ä¼‘æ­¢çš„ç­‰å¾…å—ï¼Ÿ</p>
</blockquote>
<h4>10.3.1 å‘æ“ä½œç³»ç»Ÿæ±‚åŠ©</h4>
<p>å­è¿›ç¨‹ç»ˆæ­¢çš„è¯†åˆ«ä¸»é¢˜æ˜¯æ“ä½œç³»ç»Ÿï¼Œå› æ­¤ï¼Œè‹¥æ“ä½œç³»ç»Ÿèƒ½æŠŠå¦‚ä¸‹ä¿¡æ¯å‘Šè¯‰æ­£å¿™äºå·¥ä½œçš„çˆ¶è¿›ç¨‹ï¼Œå°†æœ‰åŠ©äºæ„å»ºæ›´é«˜æ•ˆçš„ç¨‹åº</p>
<p>ä¸ºäº†å®ç°ä¸Šè¿°çš„åŠŸèƒ½ï¼Œå¼•å…¥ä¿¡å·å¤„ç†æœºåˆ¶ï¼ˆSignal Handingï¼‰ã€‚æ­¤å¤„ã€Œä¿¡å·ã€æ˜¯åœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶ç”±æ“ä½œç³»ç»Ÿå‘è¿›ç¨‹å‘é€çš„æ¶ˆæ¯ã€‚å¦å¤–ï¼Œä¸ºäº†å“åº”è¯¥æ¶ˆæ¯ï¼Œæ‰§è¡Œä¸æ¶ˆæ¯ç›¸å…³çš„è‡ªå®šä¹‰æ“ä½œçš„è¿‡ç¨‹è¢«ç§°ä¸ºã€Œå¤„ç†ã€æˆ–ã€Œä¿¡å·å¤„ç†ã€ã€‚</p>
<h4>10.3.2 ä¿¡å·ä¸ signal å‡½æ•°</h4>
<p>ä¸‹é¢è¿›ç¨‹å’Œæ“ä½œç³»ç»Ÿçš„å¯¹è¯å¯ä»¥å¸®åŠ©ç†è§£ä¿¡å·å¤„ç†ã€‚</p>
<blockquote>
<p>è¿›ç¨‹ï¼šæ“ä½œç³»ç»Ÿï¼Œå¦‚æœæˆ‘ä¹‹å‰åˆ›å»ºçš„å­è¿›ç¨‹ç»ˆæ­¢ï¼Œå°±å¸®æˆ‘è°ƒç”¨ zombie_handler å‡½æ•°ã€‚</p>
<p>æ“ä½œç³»ç»Ÿï¼šå¥½çš„ï¼Œå¦‚æœä½ çš„å­è¿›ç¨‹ç»ˆæ­¢ï¼Œæˆ‘èˆ…å¸®ä½ è°ƒç”¨ zombie_handler å‡½æ•°ï¼Œä½ å…ˆæŠŠè¦å‡½æ•°è¦æ‰§è¡Œçš„è¯­å¥å†™å¥½ã€‚</p>
</blockquote>
<p>ä¸Šè¿°çš„å¯¹è¯ï¼Œç›¸å½“äºã€Œæ³¨å†Œä¿¡å·ã€çš„è¿‡ç¨‹ã€‚å³è¿›ç¨‹å‘ç°è‡ªå·±çš„å­è¿›ç¨‹ç»“æŸæ—¶ï¼Œè¯·æ±‚æ“ä½œç³»ç»Ÿè°ƒç”¨çš„ç‰¹å®šå‡½æ•°ã€‚è¯¥è¯·æ±‚å¯ä»¥é€šè¿‡å¦‚ä¸‹å‡½æ•°è°ƒç”¨å®Œæˆï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="keyword">void</span> (*signal(<span class="keyword">int</span> signo, <span class="keyword">void</span> (*func)(<span class="keyword">int</span>)))(<span class="keyword">int</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ä¸ºäº†åœ¨äº§ç”Ÿä¿¡å·æ—¶è°ƒç”¨ï¼Œè¿”å›ä¹‹å‰æ³¨å†Œçš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">å‡½æ•°å: signal</span></span><br><span class="line"><span class="comment">å‚æ•°ï¼šint signo,void(*func)(int)</span></span><br><span class="line"><span class="comment">è¿”å›ç±»å‹ï¼šå‚æ•°ç±»å‹ä¸ºintå‹ï¼Œè¿”å› void å‹å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ä¸Šè¿°å‡½æ•°æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç‰¹æ®Šæƒ…å†µä¿¡æ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç‰¹æ®Šæƒ…å†µä¸‹å°†è¦è°ƒç”¨çš„å‡½æ•°çš„åœ°å€å€¼ï¼ˆæŒ‡é’ˆï¼‰ã€‚å‘ç”Ÿç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨çš„æƒ…å†µæ—¶ï¼Œè°ƒç”¨ç¬¬äºŒä¸ªå‚æ•°æ‰€æŒ‡çš„å‡½æ•°ã€‚ä¸‹é¢ç»™å‡ºå¯ä»¥åœ¨ signal å‡½æ•°ä¸­æ³¨å†Œçš„éƒ¨åˆ†ç‰¹æ®Šæƒ…å†µå’Œå¯¹åº”çš„å‡½æ•°ã€‚</p>
<ul>
<li>SIGALRMï¼šå·²åˆ°é€šè¿‡è°ƒç”¨ alarm å‡½æ•°æ³¨å†Œæ—¶é—´</li>
<li>SIGINTï¼šè¾“å…¥ ctrl+c</li>
<li>SIGCHLDï¼šå­è¿›ç¨‹ç»ˆæ­¢</li>
</ul>
<p>æ¥ä¸‹æ¥ç¼–å†™è°ƒç”¨ signal å‡½æ•°çš„è¯­å¥å®Œæˆå¦‚ä¸‹è¯·æ±‚ï¼š</p>
<blockquote>
<p>ã€Œå­è¿›ç¨‹ç»ˆæ­¢åˆ™è°ƒç”¨ mychild å‡½æ•°ã€</p>
</blockquote>
<p>æ­¤æ—¶ mychild å‡½æ•°çš„å‚æ•°åº”ä¸º int ï¼Œè¿”å›å€¼ç±»å‹åº”ä¸º void ã€‚åªæœ‰è¿™æ ·æ‰èƒ½ç§°ä¸º signal å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚å¦å¤–ï¼Œå¸¸æ•° SIGCHLD å®šä¹‰äº†å­è¿›ç¨‹ç»ˆæ­¢çš„æƒ…å†µï¼Œåº”æˆä¸º signal å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œsignal å‡½æ•°è°ƒç”¨è¯­å¥å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">signal(SIGCHLD , mychild);</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ç¼–å†™ signal å‡½æ•°çš„è°ƒç”¨è¯­å¥ï¼Œåˆ†åˆ«å®Œæˆå¦‚ä¸‹ä¸¤ä¸ªè¯·æ±‚ï¼š</p>
<ol>
<li>å·²åˆ°é€šè¿‡ alarm å‡½æ•°æ³¨å†Œæ—¶é—´ï¼Œè¯·è°ƒç”¨ timeout å‡½æ•°</li>
<li>è¾“å…¥ ctrl+c æ—¶è°ƒç”¨ keycontrol å‡½æ•°</li>
</ol>
<p>ä»£è¡¨è¿™ 2 ç§æƒ…å†µçš„å¸¸æ•°åˆ†åˆ«ä¸º SIGALRM å’Œ SIGINT ï¼Œå› æ­¤æŒ‰å¦‚ä¸‹æ–¹å¼è°ƒç”¨ signal å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">signal(SIGALRM , timeout);</span><br><span class="line">signal(SIGINT , keycontrol);</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå°±æ˜¯ä¿¡å·æ³¨å†Œè¿‡ç¨‹ã€‚æ³¨å†Œå¥½ä¿¡å·ä¹‹åï¼Œå‘ç”Ÿæ³¨å†Œä¿¡å·æ—¶ï¼ˆæ³¨å†Œçš„æƒ…å†µå‘ç”Ÿæ—¶ï¼‰ï¼Œæ“ä½œç³»ç»Ÿå°†è°ƒç”¨è¯¥ä¿¡å·å¯¹åº”çš„å‡½æ•°ã€‚å…ˆä»‹ç» alarm å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">alarm</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> seconds)</span></span>;</span><br><span class="line"><span class="comment">// è¿”å›0æˆ–ä»¥ç§’ä¸ºå•ä½çš„è· SIGALRM ä¿¡å·å‘ç”Ÿæ‰€å‰©æ—¶é—´</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœè°ƒç”¨è¯¥å‡½æ•°çš„åŒæ—¶å‘å®ƒä¼ é€’ä¸€ä¸ªæ­£æ•´å‹å‚æ•°ï¼Œç›¸åº”æ—¶é—´åï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰å°†äº§ç”Ÿ SIGALRM ä¿¡å·ã€‚è‹¥å‘è¯¥å‡½æ•°ä¼ é€’ä¸º 0 ï¼Œåˆ™ä¹‹å‰å¯¹ SIGALRM ä¿¡å·çš„é¢„çº¦å°†å–æ¶ˆã€‚å¦‚æœé€šè¿‡æ”¹å‡½æ•°é¢„çº¦ä¿¡å·åæœªæŒ‡å®šè¯¥ä¿¡å·å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œåˆ™ï¼ˆé€šè¿‡è°ƒç”¨ signal å‡½æ•°ï¼‰ç»ˆæ­¢è¿›ç¨‹ï¼Œä¸åšä»»ä½•å¤„ç†ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/signal.c" target="_blank" rel="noopener">signal.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timeout</span><span class="params">(<span class="keyword">int</span> sig)</span> <span class="comment">//ä¿¡å·å¤„ç†å™¨</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sig == SIGALRM)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Time out!"</span>);</span><br><span class="line">    alarm(<span class="number">2</span>); <span class="comment">//ä¸ºäº†æ¯éš” 2 ç§’é‡å¤äº§ç”Ÿ SIGALRM ä¿¡å·ï¼Œåœ¨ä¿¡å·å¤„ç†å™¨ä¸­è°ƒç”¨ alarm å‡½æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">keycontrol</span><span class="params">(<span class="keyword">int</span> sig)</span> <span class="comment">//ä¿¡å·å¤„ç†å™¨</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sig == SIGINT)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"CTRL+C pressed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    signal(SIGALRM, timeout); <span class="comment">//æ³¨å†Œä¿¡å·åŠç›¸åº”å¤„ç†å™¨</span></span><br><span class="line">    signal(SIGINT, keycontrol);</span><br><span class="line">    alarm(<span class="number">2</span>); <span class="comment">//é¢„çº¦ 2 ç§’å€™å‘ç”Ÿ SIGALRM ä¿¡å·</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"wait..."</span>);</span><br><span class="line">        sleep(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc signal.c -o signal</span><br><span class="line">./signal</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/20/5c446c877acb7.png" alt="" /></p>
<p>ä¸Šè¿°ç»“æœæ˜¯æ²¡æœ‰ä»»ä½•è¾“å…¥çš„è¿è¡Œç»“æœã€‚å½“è¾“å…¥ ctrl+c æ—¶:</p>
<p><img src="https://i.loli.net/2019/01/20/5c446ce0b1143.png" alt="" /></p>
<p>å°±å¯ä»¥çœ‹åˆ° <code>CTRL+C pressed</code> çš„å­—ç¬¦ä¸²ã€‚</p>
<blockquote>
<p>å‘ç”Ÿä¿¡å·æ—¶å°†å”¤é†’ç”±äºè°ƒç”¨ sleep å‡½æ•°è€Œè¿›å…¥é˜»å¡çŠ¶æ€çš„è¿›ç¨‹ã€‚</p>
</blockquote>
<p>è°ƒç”¨å‡½æ•°çš„ä¸»é¢˜çš„ç¡®æ˜¯æ“ä½œç³»ç»Ÿï¼Œä½†æ˜¯è¿›ç¨‹å¤„äºç¡çœ çŠ¶æ€æ—¶æ— æ³•è°ƒç”¨å‡½æ•°ï¼Œå› æ­¤ï¼Œäº§ç”Ÿä¿¡å·æ—¶ï¼Œä¸ºäº†è°ƒç”¨ä¿¡å·å¤„ç†å™¨ï¼Œå°†å”¤é†’ç”±äºè°ƒç”¨ sleep å‡½æ•°è€Œè¿›å…¥é˜»å¡çŠ¶æ€çš„è¿›ç¨‹ã€‚è€Œä¸”ï¼Œè¿›ç¨‹ä¸€æ—¦è¢«å”¤é†’ï¼Œå°±ä¸ä¼šå†è¿›å…¥ç¡çœ çŠ¶æ€ã€‚å³ä½¿è¿˜æœªåˆ° sleep ä¸­è§„å®šçš„æ—¶é—´ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ‰€ä»¥ä¸Šè¿°ç¤ºä¾‹è¿è¡Œä¸åˆ° 10 ç§’åå°±ä¼šç»“æŸï¼Œè¿ç»­è¾“å…¥ CTRL+C å¯èƒ½è¿ä¸€ç§’éƒ½ä¸åˆ°ã€‚</p>
<p><strong>ç®€è¨€ä¹‹ï¼Œå°±æ˜¯æœ¬æ¥ç³»ç»Ÿè¦ç¡çœ 100ç§’ï¼Œä½†æ˜¯åˆ°äº† alarm(2) è§„å®šçš„ä¸¤ç§’ä¹‹åï¼Œå°±ä¼šå”¤é†’ç¡çœ çš„è¿›ç¨‹ï¼Œè¿›ç¨‹è¢«å”¤é†’äº†å°±ä¸ä¼šå†è¿›å…¥ç¡çœ çŠ¶æ€äº†ï¼Œæ‰€ä»¥å°±ä¸ç”¨ç­‰å¾…100ç§’ã€‚å¦‚æœæŠŠ timeout() å‡½æ•°ä¸­çš„ alarm(2) æ³¨é‡Šæ‰ï¼Œå°±ä¼šå…ˆè¾“å‡º<code>wait...</code>ï¼Œç„¶åå†è¾“å‡º<code>Time out!</code> (è¿™æ—¶å·²ç»è·³è¿‡äº†ç¬¬ä¸€æ¬¡çš„ sleep(100) ç§’),ç„¶åå°±çœŸçš„ä¼šç¡çœ 100ç§’ï¼Œå› ä¸ºæ²¡æœ‰å†å‘å‡º alarm(2)  çš„ä¿¡å·ã€‚</strong></p>
<h4>10.3.3 åˆ©ç”¨ sigaction å‡½æ•°è¿›è¡Œä¿¡å·å¤„ç†</h4>
<p>å‰é¢æ‰€å­¦çš„å†…å®¹å¯ä»¥é˜²æ­¢åƒµå°¸è¿›ç¨‹ï¼Œè¿˜æœ‰ä¸€ä¸ªå‡½æ•°ï¼Œå«åš sigaction å‡½æ•°ï¼Œä»–ç±»ä¼¼äº signal å‡½æ•°ï¼Œè€Œä¸”å¯ä»¥å®Œå…¨ä»£æ›¿åè€…ï¼Œä¹Ÿæ›´ç¨³å®šã€‚ä¹‹æ‰€ä»¥ç¨³å®šï¼Œæ˜¯å› ä¸ºï¼š</p>
<blockquote>
<p>signal å‡½æ•°åœ¨ Unix ç³»åˆ—çš„ä¸åŒæ“ä½œç³»ç»Ÿå¯èƒ½å­˜åœ¨åŒºåˆ«ï¼Œä½† sigaction å‡½æ•°å®Œå…¨ç›¸åŒ</p>
</blockquote>
<p>å®é™…ä¸Šç°åœ¨å¾ˆå°‘ç”¨ signal å‡½æ•°ç¼–å†™ç¨‹åºï¼Œä»–åªæ˜¯ä¸ºäº†ä¿æŒå¯¹æ—§ç¨‹åºçš„å…¼å®¹ï¼Œä¸‹é¢ä»‹ç» sigaction å‡½æ•°ï¼Œåªè®²è§£å¯ä»¥æ›¿æ¢ signal å‡½æ•°çš„åŠŸèƒ½ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigaction</span><span class="params">(<span class="keyword">int</span> signo, <span class="keyword">const</span> struct sigaction *act, struct sigaction *oldact)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">act: å¯¹äºç¬¬ä¸€ä¸ªå‚æ•°çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼ˆä¿¡å·å¤„ç†å™¨ï¼‰ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="comment">oldact: é€šè¿‡æ­¤å‚æ•°è·å–ä¹‹å‰æ³¨å†Œçš„ä¿¡å·å¤„ç†å‡½æ•°æŒ‡é’ˆï¼Œè‹¥ä¸éœ€è¦åˆ™ä¼ é€’ 0</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>å£°æ˜å¹¶åˆå§‹åŒ– sigaction ç»“æ„ä½“å˜é‡ä»¥è°ƒç”¨ä¸Šè¿°å‡½æ•°ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> (*sa_handler)(<span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">sigset_t</span> sa_mask;</span><br><span class="line">    <span class="keyword">int</span> sa_flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ­¤ç»“æ„ä½“çš„æˆå‘˜ sa_handler ä¿å­˜ä¿¡å·å¤„ç†çš„å‡½æ•°æŒ‡é’ˆå€¼ï¼ˆåœ°å€å€¼ï¼‰ã€‚sa_mask å’Œ sa_flags çš„æ‰€æœ‰ä½åˆå§‹åŒ– 0 å³å¯ã€‚è¿™ 2 ä¸ªæˆå‘˜ç”¨äºæŒ‡å®šä¿¡å·ç›¸å…³çš„é€‰é¡¹å’Œç‰¹æ€§ï¼Œè€Œæˆ‘ä»¬çš„ç›®çš„ä¸»è¦æ˜¯é˜²æ­¢äº§ç”Ÿåƒµå°¸è¿›ç¨‹ï¼Œæ•…çœç•¥ã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹æ˜¯å…³äº sigaction å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/sigaction.c" target="_blank" rel="noopener">sigaction.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timeout</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sig == SIGALRM)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Time out!"</span>);</span><br><span class="line">    alarm(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">    act.sa_handler = timeout;    <span class="comment">//ä¿å­˜å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">    sigemptyset(&amp;act.sa_mask);   <span class="comment">//å°† sa_mask å‡½æ•°çš„æ‰€æœ‰ä½åˆå§‹åŒ–æˆ0</span></span><br><span class="line">    act.sa_flags = <span class="number">0</span>;            <span class="comment">//sa_flags åŒæ ·åˆå§‹åŒ–æˆ 0</span></span><br><span class="line">    sigaction(SIGALRM, &amp;act, <span class="number">0</span>); <span class="comment">//æ³¨å†Œ SIGALRM ä¿¡å·çš„å¤„ç†å™¨ã€‚</span></span><br><span class="line"></span><br><span class="line">    alarm(<span class="number">2</span>); <span class="comment">//2 ç§’åå‘ç”Ÿ SIGALRM ä¿¡å·</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"wait..."</span>);</span><br><span class="line">        sleep(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc sigaction.c -o sigaction</span><br><span class="line">./sigaction</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wait...</span><br><span class="line">Time out!</span><br><span class="line">wait...</span><br><span class="line">Time out!</span><br><span class="line">wait...</span><br><span class="line">Time out!</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°ï¼Œç»“æœå’Œä¹‹å‰ç”¨ signal å‡½æ•°çš„ç»“æœæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚ä»¥ä¸Šå°±æ˜¯ä¿¡å·å¤„ç†çš„ç›¸å…³ç†è®ºã€‚</p>
<h4>10.3.4 åˆ©ç”¨ä¿¡å·å¤„ç†æŠ€æœ¯æ¶ˆç­åƒµå°¸è¿›ç¨‹</h4>
<p>ä¸‹é¢åˆ©ç”¨å­è¿›ç¨‹ç»ˆæ­¢æ—¶äº§ç”Ÿ SIGCHLD ä¿¡å·è¿™ä¸€ç‚¹ï¼Œæ¥ç”¨ä¿¡å·å¤„ç†æ¥æ¶ˆç­åƒµå°¸è¿›ç¨‹ã€‚çœ‹ä»¥ä¸‹ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/remove_zomebie.c" target="_blank" rel="noopener">remove_zomebie.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_childproc</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> id = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG);</span><br><span class="line">    <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Removed proc id: %d \n"</span>, id);             <span class="comment">//å­è¿›ç¨‹çš„ pid</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child send: %d \n"</span>, WEXITSTATUS(status)); <span class="comment">//å­è¿›ç¨‹çš„è¿”å›å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">    act.sa_handler = read_childproc;</span><br><span class="line">    sigemptyset(&amp;act.sa_mask);</span><br><span class="line">    act.sa_flags = <span class="number">0</span>;</span><br><span class="line">    sigaction(SIGCHLD, &amp;act, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) <span class="comment">//å­è¿›ç¨‹æ‰§è¡Œé˜¶æ®µ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Hi I'm child process"</span>);</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">//çˆ¶è¿›ç¨‹æ‰§è¡Œé˜¶æ®µ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child proc id: %d\n"</span>, pid);</span><br><span class="line">        pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Hi! I'm child process"</span>);</span><br><span class="line">            sleep(<span class="number">10</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">24</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Child proc id: %d \n"</span>, pid);</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"wait"</span>);</span><br><span class="line">                sleep(<span class="number">5</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc remove_zomebie.c -o zombie</span><br><span class="line">./zombie</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Child proc id: 11211</span><br><span class="line">Hi I&#39;m child process</span><br><span class="line">Child proc id: 11212 </span><br><span class="line">wait</span><br><span class="line">Hi! I&#39;m child process</span><br><span class="line"></span><br><span class="line">wait</span><br><span class="line"></span><br><span class="line">wait</span><br><span class="line">Removed proc id: 11211 </span><br><span class="line">Child send: 12 </span><br><span class="line">wait</span><br><span class="line">Removed proc id: 11212 </span><br><span class="line">Child send: 24 </span><br><span class="line">wait</span><br></pre></td></tr></table></figure>
<p>è¯·è‡ªä¹ è§‚å¯Ÿç»“æœï¼Œç»“æœä¸­çš„æ¯ä¸€ä¸ªç©ºè¡Œä»£è¡¨é—´éš”äº†5 ç§’ï¼Œç¨‹åºæ˜¯å…ˆåˆ›å»ºäº†ä¸¤ä¸ªå­è¿›ç¨‹ï¼Œç„¶åå­è¿›ç¨‹ 10  ç§’ä¹‹åä¼šè¿”å›å€¼ï¼Œç¬¬ä¸€ä¸ª wait ç”±äºå­è¿›ç¨‹åœ¨æ‰§è¡Œï¼Œæ‰€ä»¥ç›´æ¥è¢«å”¤é†’ï¼Œç„¶åè¿™ä¸¤ä¸ªå­è¿›ç¨‹æ­£åœ¨ç¡ 10 ç§’ï¼Œæ‰€ä»¥ 5 ç§’ä¹‹åç¬¬äºŒä¸ª wait å¼€å§‹æ‰§è¡Œï¼Œåˆè¿‡äº† 5 ç§’ï¼Œä¸¤ä¸ªå­è¿›ç¨‹åŒæ—¶è¢«å”¤é†’ã€‚æ‰€ä»¥å‰©ä¸‹çš„ wait ä¹Ÿè¢«å”¤é†’ã€‚</p>
<p>æ‰€ä»¥åœ¨æœ¬ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œå½“å­è¿›ç¨‹ç»ˆæ­¢æ—¶å€™ï¼Œä¼šå‘ç³»ç»Ÿå‘é€ä¸€ä¸ªä¿¡å·ï¼Œç„¶åè°ƒç”¨æˆ‘ä»¬æå‰å†™å¥½çš„å¤„ç†å‡½æ•°ï¼Œåœ¨å¤„ç†å‡½æ•°ä¸­ä½¿ç”¨ waitpid æ¥å¤„ç†åƒµå°¸è¿›ç¨‹ï¼Œè·å–å­è¿›ç¨‹è¿”å›å€¼ã€‚</p>
<h3>10.4 åŸºäºå¤šä»»åŠ¡çš„å¹¶å‘æœåŠ¡å™¨</h3>
<h4>10.4.1 åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨æ¨¡å‹</h4>
<p>ä¹‹å‰çš„å›å£°æœåŠ¡å™¨æ¯æ¬¡åªèƒ½åŒæ—¶å‘ 1 ä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚å› æ­¤ï¼Œéœ€è¦æ‰©å±•å›å£°æœåŠ¡å™¨ï¼Œä½¿å…¶å¯ä»¥åŒæ—¶å‘å¤šä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚ä¸‹å›¾æ˜¯åŸºäºå¤šè¿›ç¨‹çš„å›å£°æœåŠ¡å™¨çš„æ¨¡å‹ã€‚</p>
<p><img src="https://i.loli.net/2019/01/21/5c453664cde26.png" alt="" /></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯å½“æœ‰å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼ˆè¿æ¥è¯·æ±‚ï¼‰ï¼Œå›å£°æœåŠ¡å™¨éƒ½åˆ›å»ºå­è¿›ç¨‹ä»¥æä¾›æœåŠ¡ã€‚å¦‚æœè¯·æ±‚çš„å®¢æˆ·ç«¯æœ‰ 5 ä¸ªï¼Œåˆ™å°†åˆ›å»º 5 ä¸ªå­è¿›ç¨‹æ¥æä¾›æœåŠ¡ï¼Œä¸ºäº†å®Œæˆè¿™äº›ä»»åŠ¡ï¼Œéœ€è¦ç»è¿‡å¦‚ä¸‹è¿‡ç¨‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µï¼šå›å£°æœåŠ¡å™¨ç«¯ï¼ˆçˆ¶è¿›ç¨‹ï¼‰é€šè¿‡è°ƒç”¨ accept å‡½æ•°å—ç†è¿æ¥è¯·æ±‚</li>
<li>ç¬¬äºŒé˜¶æ®µï¼šæ­¤æ—¶è·å–çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦åˆ›å»ºå¹¶ä¼ é€’ç»™å­è¿›ç¨‹</li>
<li>ç¬¬ä¸‰é˜¶æ®µï¼šè¿›ç¨‹åˆ©ç”¨ä¼ é€’æ¥çš„æ–‡ä»¶æè¿°ç¬¦æä¾›æœåŠ¡</li>
</ul>
<h4>10.4.2 å®ç°å¹¶å‘æœåŠ¡å™¨</h4>
<p>ä¸‹é¢æ˜¯åŸºäºå¤šè¿›ç¨‹å®ç°çš„å¹¶å‘çš„å›å£°æœåŠ¡å™¨çš„æœåŠ¡ç«¯ï¼Œå¯ä»¥ç»“åˆç¬¬å››ç« çš„ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch04/echo_client.c" target="_blank" rel="noopener">echo_client.c</a> å›å£°å®¢æˆ·ç«¯æ¥è¿è¡Œã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/echo_mpserv.c" target="_blank" rel="noopener">echo_mpserv.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_mpserv.c -o eserver</span><br><span class="line">./eserver</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p>å’Œç¬¬å››ç« çš„å‡ ä¹ä¸€æ ·ï¼Œå¯ä»¥è‡ªå·±æµ‹è¯•ï¼Œæ­¤æ—¶çš„æœåŠ¡ç«¯æ”¯æŒåŒæ—¶ç»™å¤šä¸ªå®¢æˆ·ç«¯è¿›è¡ŒæœåŠ¡ï¼Œæ¯æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ï¼Œå°±ä¼šå¤šå¼€ä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥åŒæ—¶æä¾›æœåŠ¡ã€‚</p>
<h4>10.4.3 é€šè¿‡ fork å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦</h4>
<p>ç¤ºä¾‹ä¸­ç»™å‡ºäº†é€šè¿‡ fork å‡½æ•°å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦çš„è¿‡ç¨‹ã€‚çˆ¶è¿›ç¨‹å°† 2 ä¸ªå¥—æ¥å­—ï¼ˆä¸€ä¸ªæ˜¯æœåŠ¡ç«¯å¥—æ¥å­—å¦ä¸€ä¸ªæ˜¯å®¢æˆ·ç«¯å¥—æ¥å­—ï¼‰æ–‡ä»¶æè¿°ç¬¦å¤åˆ¶ç»™äº†å­è¿›ç¨‹ã€‚</p>
<p>è°ƒç”¨ fork å‡½æ•°æ—¶å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ‰€æœ‰èµ„æºï¼Œä½†æ˜¯å¥—æ¥å­—ä¸æ˜¯å½’è¿›ç¨‹æ‰€æœ‰çš„ï¼Œè€Œæ˜¯å½’æ“ä½œç³»ç»Ÿæ‰€æœ‰ï¼Œåªæ˜¯è¿›ç¨‹æ‹¥æœ‰ä»£è¡¨ç›¸åº”å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><img src="https://s2.ax1x.com/2019/01/21/kP7Rjx.png" alt="" /></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œ1 ä¸ªå¥—æ¥å­—å­˜åœ¨ 2 ä¸ªæ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œåªæœ‰ 2 ä¸ªæ–‡ä»¶æè¿°ç¬¦éƒ½ç»ˆæ­¢ï¼ˆé”€æ¯ï¼‰åï¼Œæ‰èƒ½é”€æ¯å¥—æ¥å­—ã€‚å¦‚æœç»´æŒå›¾ä¸­çš„çŠ¶æ€ï¼Œå³ä½¿å­è¿›ç¨‹é”€æ¯äº†ä¸å®¢æˆ·ç«¯è¿æ¥çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿæ— æ³•é”€æ¯å¥—æ¥å­—ï¼ˆæœåŠ¡å™¨å¥—æ¥å­—åŒæ ·å¦‚æ­¤ï¼‰ã€‚å› æ­¤è°ƒç”¨ fork å‡½æ•°å€™ï¼Œè¦å°†æ— å…³ç´§è¦çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦å…³æ‰ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/21/kPH7ZT.png" alt="" /></p>
<h3>10.5 åˆ†å‰² TCP çš„ I/O ç¨‹åº</h3>
<h4>10.5.1 åˆ†å‰² I/O çš„ä¼˜ç‚¹</h4>
<p>æˆ‘ä»¬å·²ç»å®ç°çš„å›å£°å®¢æˆ·ç«¯çš„æ•°æ®å›å£°æ–¹å¼å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å‘æœåŠ¡å™¨ä¼ è¾“æ•°æ®ï¼Œå¹¶ç­‰å¾…æœåŠ¡å™¨ç«¯å›å¤ã€‚æ— æ¡ä»¶ç­‰å¾…ï¼Œç›´åˆ°æ¥æ”¶å®ŒæœåŠ¡å™¨ç«¯çš„å›å£°æ•°æ®åï¼Œæ‰èƒ½ä¼ è¾“ä¸‹ä¸€æ‰¹æ•°æ®ã€‚</p>
</blockquote>
<p>ä¼ è¾“æ•°æ®åè¦ç­‰å¾…æœåŠ¡å™¨ç«¯è¿”å›çš„æ•°æ®ï¼Œå› ä¸ºç¨‹åºä»£ç ä¸­é‡å¤è°ƒç”¨äº† read å’Œ write å‡½æ•°ã€‚åªèƒ½è¿™ä¹ˆå†™çš„åŸå› ä¹‹ä¸€æ˜¯ï¼Œç¨‹åºåœ¨ 1 ä¸ªè¿›ç¨‹ä¸­è¿è¡Œï¼Œç°åœ¨å¯ä»¥åˆ›å»ºå¤šä¸ªè¿›ç¨‹ï¼Œå› æ­¤å¯ä»¥åˆ†å‰²æ•°æ®æ”¶å‘è¿‡ç¨‹ã€‚é»˜è®¤åˆ†å‰²è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/21/kPbhkD.png" alt="" /></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå®¢æˆ·ç«¯çš„çˆ¶è¿›ç¨‹è´Ÿè´£æ¥æ”¶æ•°æ®ï¼Œé¢å¤–åˆ›å»ºçš„å­è¿›ç¨‹è´Ÿè´£å‘é€æ•°æ®ï¼Œåˆ†å‰²åï¼Œä¸åŒè¿›ç¨‹åˆ†åˆ«è´Ÿè´£è¾“å…¥è¾“å‡ºï¼Œè¿™æ ·ï¼Œæ— è®ºå®¢æˆ·ç«¯æ˜¯å¦ä»æœåŠ¡å™¨ç«¯æ¥æ”¶å®Œæ•°æ®éƒ½å¯ä»¥è¿›ç¨‹ä¼ è¾“ã€‚</p>
<p>åˆ†å‰² I/O ç¨‹åºçš„å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥æé«˜é¢‘ç¹äº¤æ¢æ•°æ®çš„ç¨‹åºæ€§èƒ½ï¼Œå›¾ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/21/kPbvtg.png" alt="" /></p>
<p>æ ¹æ®ä¸Šå›¾æ˜¾ç¤ºå¯ä»¥çœ‹å‡ºï¼Œå†ç½‘ç»œä¸å¥½çš„æƒ…å†µä¸‹ï¼Œæ˜æ˜¾æå‡é€Ÿåº¦ã€‚</p>
<h4>10.5.2 å›å£°å®¢æˆ·ç«¯çš„ I/O ç¨‹åºåˆ†å‰²</h4>
<p>ä¸‹é¢æ˜¯å›å£°å®¢æˆ·ç«¯çš„ I/O åˆ†å‰²çš„ä»£ç å®ç°ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/echo_mpclient.c" target="_blank" rel="noopener">echo_mpclient.c</a></li>
</ul>
<p>å¯ä»¥é…åˆåˆšæ‰çš„å¹¶å‘æœåŠ¡å™¨è¿›è¡Œæ‰§è¡Œã€‚</p>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_mpclient.c -o eclient</span><br><span class="line">./eclient 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/21/kPOcXn.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºï¼ŒåŸºæœ¬å’Œä»¥å‰çš„ä¸€æ ·ï¼Œä½†æ˜¯é‡Œé¢çš„å†…éƒ¨ç»“æ„å´å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–</p>
<h3>10.6 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>ä¸‹åˆ—å…³äºè¿›ç¨‹çš„è¯´æ³•é”™è¯¯çš„æ˜¯ï¼Ÿ</strong></p>
<p>ç­”ï¼šä»¥ä¸‹åŠ ç²—çš„å†…å®¹ä¸ºæ­£ç¡®çš„</p>
<ol>
<li><strong>ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦ä¸Šè¯´ï¼Œè¿›ç¨‹æ˜¯ç¨‹åºè¿è¡Œçš„å•ä½</strong></li>
<li>è¿›ç¨‹æ ¹æ®åˆ›å»ºæ–¹å¼å»ºç«‹çˆ¶å­å…³ç³»</li>
<li><strong>è¿›ç¨‹å¯ä»¥åŒ…å«å…¶ä»–è¿›ç¨‹ï¼Œå³ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ç©ºé—´å¯ä»¥åŒ…å«å…¶ä»–è¿›ç¨‹</strong></li>
<li><strong>å­è¿›ç¨‹å¯ä»¥åˆ›å»ºå…¶ä»–å­è¿›ç¨‹ï¼Œè€Œåˆ›å»ºå‡ºæ¥çš„å­è¿›ç¨‹è¿˜å¯ä»¥åˆ›å»ºå…¶ä»–å­è¿›ç¨‹ï¼Œä½†æ‰€æœ‰è¿™äº›è¿›ç¨‹åªä¸ä¸€ä¸ªçˆ¶è¿›ç¨‹å»ºç«‹çˆ¶å­å…³ç³»ã€‚</strong></li>
</ol>
</li>
<li>
<p><strong>è°ƒç”¨ fork å‡½æ•°å°†åˆ›å»ºå­è¿›ç¨‹ï¼Œä¸€ä¸‹å…³äºå­è¿›ç¨‹é”™è¯¯çš„æ˜¯ï¼Ÿ</strong></p>
<p>ç­”ï¼šä»¥ä¸‹åŠ ç²—çš„å†…å®¹ä¸ºæ­£ç¡®çš„</p>
<ol>
<li><strong>çˆ¶è¿›ç¨‹é”€æ¯æ—¶ä¹Ÿä¼šåŒæ—¶é”€æ¯å­è¿›ç¨‹</strong></li>
<li><strong>å­è¿›ç¨‹æ˜¯å¤åˆ¶çˆ¶è¿›ç¨‹æ‰€æœ‰èµ„æºåˆ›å»ºå‡ºçš„è¿›ç¨‹</strong></li>
<li>çˆ¶å­è¿›ç¨‹å…±äº«å…¨å±€å˜é‡</li>
<li>é€šè¿‡ fork å‡½æ•°åˆ›å»ºçš„å­è¿›ç¨‹å°†æ‰§è¡Œä»å¼€å§‹åˆ° fork å‡½æ•°è°ƒç”¨ä¸ºæ­¢çš„ä»£ç ã€‚</li>
</ol>
</li>
<li>
<p><strong>åˆ›å»ºå­è¿›ç¨‹æ—¶å¤åˆ¶çˆ¶è¿›ç¨‹æ‰€æœ‰å†…å®¹ï¼Œæ­¤æ—¶å¤åˆ¶å¯¹è±¡ä¹ŸåŒ…å«å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚ç¼–å†™ç¨‹åºéªŒè¯å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦æ•´æ•°å€¼æ˜¯å¦ä¸åŸæ–‡ä»¶æè¿°ç¬¦æ•°å€¼ç›¸åŒã€‚</strong></p>
<p>ç­”ï¼šä»£ç ä¸ºå¤šè¿›ç¨‹æœåŠ¡å™¨ä¿®æ”¹è€Œæ¥ï¼Œä»£ç ï¼š<a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/test_server.c" target="_blank" rel="noopener">test_server.c</a></p>
<p>è¿è¡Œæˆªå›¾ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/21/kPj3Md.png" alt="" /></p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œæ•°å€¼ç›¸åŒã€‚</p>
</li>
<li>
<p><strong>è¯·è¯´æ˜è¿›ç¨‹å˜ä¸ºåƒµå°¸è¿›ç¨‹çš„è¿‡ç¨‹ä»¥åŠé¢„é˜²æªæ–½ã€‚</strong></p>
<p>ç­”ï¼šå½“ä¸€ä¸ªçˆ¶è¿›ç¨‹ä»¥fork()ç³»ç»Ÿè°ƒç”¨å»ºç«‹ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹åï¼Œæ ¸å¿ƒè¿›ç¨‹å°±ä¼šåœ¨è¿›ç¨‹è¡¨ä¸­ç»™è¿™ä¸ªå­è¿›ç¨‹åˆ†é…ä¸€ä¸ªè¿›å…¥ç‚¹ï¼Œç„¶åå°†ç›¸å…³ä¿¡æ¯å­˜å‚¨åœ¨è¯¥è¿›å…¥ç‚¹æ‰€å¯¹åº”çš„è¿›ç¨‹è¡¨å†…ã€‚è¿™äº›ä¿¡æ¯ä¸­æœ‰ä¸€é¡¹æ˜¯å…¶çˆ¶è¿›ç¨‹çš„è¯†åˆ«ç ã€‚è€Œå½“è¿™ä¸ªå­è¿›ç¨‹ç»“æŸçš„æ—¶å€™ï¼ˆæ¯”å¦‚è°ƒç”¨exitå‘½ä»¤ç»“æŸï¼‰ï¼Œå…¶å®ä»–å¹¶æ²¡æœ‰çœŸæ­£çš„è¢«é”€æ¯ï¼Œè€Œæ˜¯ç•™ä¸‹ä¸€ä¸ªç§°ä¸ºåƒµå°¸è¿›ç¨‹ï¼ˆZombieï¼‰çš„æ•°æ®ç»“æ„ï¼ˆç³»ç»Ÿè°ƒç”¨exitçš„ä½œç”¨æ˜¯ä½¿è¿›ç¨‹é€€å‡ºï¼Œä½†æ˜¯ä¹Ÿä»…ä»…é™äºä¸€ä¸ªæ­£å¸¸çš„è¿›ç¨‹å˜æˆäº†ä¸€ä¸ªåƒµå°¸è¿›ç¨‹ï¼Œå¹¶ä¸èƒ½å®Œå…¨å°†å…¶é”€æ¯ï¼‰ã€‚<strong>é¢„é˜²æªæ–½</strong>ï¼šé€šè¿‡ wait å’Œ waitpid å‡½æ•°åŠ ä¸Šä¿¡å·å‡½æ•°å†™ä»£ç æ¥é¢„é˜²ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 11 ç«  è¿›ç¨‹é—´é€šä¿¡</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<p>è¿›ç¨‹é—´é€šä¿¡ï¼Œæ„å‘³ç€ä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ä¸­å¯ä»¥äº¤æ¢æ•°æ®</p>
<h3>11.1 è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ¦‚å¿µ</h3>
<h4>11.1.1 é€šè¿‡ç®¡é“å®ç°è¿›ç¨‹é—´é€šä¿¡</h4>
<p>ä¸‹å›¾æ˜¯åŸºäºç®¡é“ï¼ˆPIPEï¼‰çš„è¿›ç¨‹é—´é€šä¿¡çš„æ¨¡å‹ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/22/kFlk0s.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†å®Œæˆè¿›ç¨‹é—´é€šä¿¡ï¼Œéœ€è¦åˆ›å»ºè¿›ç¨‹ã€‚ç®¡é“å¹¶éå±äºè¿›ç¨‹çš„èµ„æºï¼Œè€Œæ˜¯å’Œå¥—æ¥å­—ä¸€æ ·ï¼Œå±äºæ“ä½œç³»ç»Ÿï¼ˆä¹Ÿå°±ä¸æ˜¯ fork å‡½æ•°çš„å¤åˆ¶å¯¹è±¡ï¼‰ã€‚æ‰€ä»¥ï¼Œä¸¤ä¸ªè¿›ç¨‹é€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„å†…å­˜ç©ºé—´è¿›è¡Œé€šä¿¡ã€‚ä¸‹é¢æ˜¯åˆ›å»ºç®¡é“çš„å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pipe</span><span class="params">(<span class="keyword">int</span> filedes[<span class="number">2</span>])</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">filedes[0]: é€šè¿‡ç®¡é“æ¥æ”¶æ•°æ®æ—¶ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå³ç®¡é“å‡ºå£</span></span><br><span class="line"><span class="comment">filedes[1]: é€šè¿‡ç®¡é“ä¼ è¾“æ•°æ®æ—¶ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå³ç®¡é“å…¥å£</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>çˆ¶è¿›ç¨‹åˆ›å»ºå‡½æ•°æ—¶å°†åˆ›å»ºç®¡é“ï¼ŒåŒæ—¶è·å–å¯¹åº”äºå‡ºå…¥å£çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ­¤æ—¶çˆ¶è¿›ç¨‹å¯ä»¥è¯»å†™åŒä¸€ç®¡é“ã€‚ä½†çˆ¶è¿›ç¨‹çš„ç›®çš„æ˜¯ä¸å­è¿›ç¨‹è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œå› æ­¤éœ€è¦å°†å…¥å£æˆ–å‡ºå£ä¸­çš„ 1 ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™å­è¿›ç¨‹ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¯å…³äºè¯¥å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch11/pipe1.c" target="_blank" rel="noopener">pipe1.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 30</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fds[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">char</span> str[] = <span class="string">"Who are you?"</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="comment">// è°ƒç”¨  pipe å‡½æ•°åˆ›å»ºç®¡é“ï¼Œfds æ•°ç»„ä¸­ä¿å­˜ç”¨äº I/O çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    pipe(fds);</span><br><span class="line">    pid = fork(); <span class="comment">//å­è¿›ç¨‹å°†åŒæ—¶æ‹¥æœ‰åˆ›å»ºç®¡é“è·å–çš„2ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¤åˆ¶çš„å¹¶éç®¡é“ï¼Œè€Œæ˜¯æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">write</span>(fds[<span class="number">1</span>], str, <span class="keyword">sizeof</span>(str));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">read</span>(fds[<span class="number">0</span>], buf, BUF_SIZE);</span><br><span class="line">        <span class="built_in">puts</span>(buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc pipe1.c -o pipe1</span><br><span class="line">./pipe1</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Who are you?</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä»ç¨‹åºä¸­çœ‹å‡ºï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªç®¡é“ï¼Œå­è¿›ç¨‹é€šè¿‡ fds[1] æŠŠæ•°æ®å†™å…¥ç®¡é“ï¼Œçˆ¶è¿›ç¨‹ä» fds[0] å†æŠŠæ•°æ®è¯»å‡ºæ¥ã€‚å¯ä»¥ä»ä¸‹å›¾çœ‹å‡ºï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/22/kF8A7d.png" alt="" /></p>
<h4>11.1.2 é€šè¿‡ç®¡é“è¿›è¡Œè¿›ç¨‹é—´åŒå‘é€šä¿¡</h4>
<p>ä¸‹å›¾å¯ä»¥çœ‹å‡ºåŒå‘é€šä¿¡æ¨¡å‹ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/22/kF84De.png" alt="" /></p>
<p>ä¸‹é¢æ˜¯åŒå‘é€šä¿¡çš„ç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch11/pipe2.c" target="_blank" rel="noopener">pipe2.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 30</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fds[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">char</span> str1[] = <span class="string">"Who are you?"</span>;</span><br><span class="line">    <span class="keyword">char</span> str2[] = <span class="string">"Thank you for your message"</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    pipe(fds);</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">write</span>(fds[<span class="number">1</span>], str1, <span class="keyword">sizeof</span>(str1));</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">read</span>(fds[<span class="number">0</span>], buf, BUF_SIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child proc output: %s \n"</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">read</span>(fds[<span class="number">0</span>], buf, BUF_SIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Parent proc output: %s \n"</span>, buf);</span><br><span class="line">        <span class="built_in">write</span>(fds[<span class="number">1</span>], str2, <span class="keyword">sizeof</span>(str2));</span><br><span class="line">        sleep(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc pipe2.c -o pipe2</span><br><span class="line">./pipe2</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Parent proc output: Who are you?</span><br><span class="line">Child proc output: Thank you for your message</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœæ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å¦‚æœæ³¨é‡Šæ‰ç¬¬18è¡Œçš„ä»£ç ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œå¯¼è‡´ä¸€ç›´ç­‰å¾…ä¸‹å»ã€‚å› ä¸ºæ•°æ®è¿›å…¥ç®¡é“åå˜æˆäº†æ— ä¸»æ•°æ®ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡ read å‡½æ•°å…ˆè¯»å–æ•°æ®çš„è¿›ç¨‹å°†å¾—åˆ°æ•°æ®ï¼Œå³ä½¿è¯¥è¿›ç¨‹å°†æ•°æ®ä¼ åˆ°äº†ç®¡é“ã€‚å› ä¸ºï¼Œæ³¨é‡Šç¬¬18è¡Œä¼šäº§ç”Ÿé—®é¢˜ã€‚ç¬¬19è¡Œï¼Œè‡ªå·±æˆå°†è¯»å›è‡ªå·±åœ¨ç¬¬ 17 è¡Œå‘ç®¡é“å‘é€çš„æ•°æ®ã€‚ç»“æœçˆ¶è¿›ç¨‹è°ƒç”¨ read å‡½æ•°åï¼Œæ— é™æœŸç­‰å¾…æ•°æ®è¿›å…¥ç®¡é“ã€‚</p>
<p>å½“ä¸€ä¸ªç®¡é“ä¸æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå°±éœ€è¦åˆ›å»ºä¸¤ä¸ªç®¡é“ï¼Œå„è‡ªè´Ÿè´£ä¸åŒçš„æ•°æ®æµåŠ¨ï¼Œè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/22/kFJW0e.png" alt="" /></p>
<p>ä¸‹é¢é‡‡ç”¨ä¸Šè¿°æ¨¡å‹æ”¹è¿› <code>pipe2.c</code> ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch11/pipe3.c" target="_blank" rel="noopener">pipe3.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 30</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fds1[<span class="number">2</span>], fds2[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">char</span> str1[] = <span class="string">"Who are you?"</span>;</span><br><span class="line">    <span class="keyword">char</span> str2[] = <span class="string">"Thank you for your message"</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    pipe(fds1), pipe(fds2);</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">write</span>(fds1[<span class="number">1</span>], str1, <span class="keyword">sizeof</span>(str1));</span><br><span class="line">        <span class="built_in">read</span>(fds2[<span class="number">0</span>], buf, BUF_SIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Child proc output: %s \n"</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">read</span>(fds1[<span class="number">0</span>], buf, BUF_SIZE);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Parent proc output: %s \n"</span>, buf);</span><br><span class="line">        <span class="built_in">write</span>(fds2[<span class="number">1</span>], str2, <span class="keyword">sizeof</span>(str2));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢é€šè¿‡åˆ›å»ºä¸¤ä¸ªç®¡é“å®ç°äº†åŠŸèƒ½ï¼Œæ­¤æ—¶ï¼Œä¸éœ€è¦é¢å¤–å†ä½¿ç”¨ sleep å‡½æ•°ã€‚è¿è¡Œç»“æœå’Œä¸Šé¢ä¸€æ ·ã€‚</p>
<h3>11.2 è¿ç”¨è¿›ç¨‹é—´é€šä¿¡</h3>
<h4>11.2.1 ä¿å­˜æ¶ˆæ¯çš„å›å£°æœåŠ¡å™¨</h4>
<p>ä¸‹é¢å¯¹ç¬¬ 10 ç« çš„ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/echo_mpserv.c" target="_blank" rel="noopener">echo_mpserv.c</a> è¿›è¡Œæ”¹è¿›ï¼Œæ·»åŠ ä¸€ä¸ªåŠŸèƒ½ï¼š</p>
<blockquote>
<p>å°†å›å£°å®¢æˆ·ç«¯ä¼ è¾“çš„å­—ç¬¦ä¸²æŒ‰åºä¿å­˜åˆ°æ–‡ä»¶ä¸­</p>
</blockquote>
<p>å®ç°è¯¥ä»»åŠ¡å°†åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œä»å‘å®¢æˆ·ç«¯æä¾›æœåŠ¡çš„è¿›ç¨‹è¯»å–å­—ç¬¦ä¸²ä¿¡æ¯ï¼Œä¸‹é¢æ˜¯ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch11/echo_storeserv.c" target="_blank" rel="noopener">echo_storeserv.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_storeserv.c -o serv</span><br><span class="line">./serv 9190</span><br></pre></td></tr></table></figure>
<p>æ­¤æœåŠ¡ç«¯é…åˆç¬¬ 10 ç« çš„å®¢æˆ·ç«¯ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/echo_mpclient.c" target="_blank" rel="noopener">echo_mpclient.c</a> ä½¿ç”¨ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹å›¾:</p>
<p><img src="https://s2.ax1x.com/2019/01/22/kFUCct.png" alt="" /></p>
<p><img src="https://s2.ax1x.com/2019/01/22/kFUAHS.png" alt="" /></p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯å·²ç»ç”Ÿæˆäº†æ–‡ä»¶ï¼ŒæŠŠå®¢æˆ·ç«¯çš„æ¶ˆæ¯ä¿å­˜å¯ä¸‹æ¥ï¼Œåªä¿å­˜äº†10æ¬¡æ¶ˆæ¯ã€‚</p>
<h3>11.3 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>ä»€ä¹ˆæ˜¯è¿›ç¨‹é—´é€šä¿¡ï¼Ÿåˆ†åˆ«ä»æ¦‚å¿µå’Œå†…å­˜çš„è§’åº¦è¿›è¡Œè¯´æ˜ã€‚</strong></p>
<p>ç­”ï¼šè¿›ç¨‹é—´é€šä¿¡æ„å‘³ç€ä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹é—´å¯ä»¥äº¤æ¢æ•°æ®ã€‚ä»å†…å­˜ä¸Šæ¥è¯´ï¼Œå°±æ˜¯ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œç„¶åé€šè¿‡è¿™ä¸ªå†…å­˜åŒºåŸŸæ•°æ®çš„å˜åŒ–æ¥è¿›è¡Œé€šä¿¡ã€‚</p>
</li>
<li>
<p><strong>è¿›ç¨‹é—´é€šä¿¡éœ€è¦ç‰¹æ®Šçš„ IPC æœºåˆ¶ï¼Œè¿™æ˜¯ç”±äºæ“ä½œç³»ç»Ÿæä¾›çš„ã€‚è¿›ç¨‹é—´é€šä¿¡æ—¶ä¸ºä½•éœ€è¦æ“ä½œç³»ç»Ÿçš„å¸®åŠ©ï¼Ÿ</strong></p>
<p>ç­”ï¼šä¸ºäº†è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼Œéœ€è¦ç®¡é“çš„å¸®åŠ©ï¼Œä½†æ˜¯ç®¡é“ä¸æ˜¯è¿›ç¨‹çš„èµ„æºï¼Œå®ƒå±äºä»æ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥ï¼Œä¸¤ä¸ªè¿›ç¨‹é€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„å†…å­˜ç©ºé—´è¿›è¡Œé€šä¿¡ã€‚</p>
</li>
<li>
<p><strong>ã€Œç®¡é“ã€æ˜¯å…¸å‹çš„ IPC æŠ€æ³•ã€‚å…³äºç®¡é“ï¼Œè¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š</strong></p>
<ol>
<li>
<p><strong>ç®¡é“æ˜¯è¿›ç¨‹é—´äº¤æ¢æ•°æ®çš„è·¯å¾„ã€‚å¦‚ä½•åˆ›å»ºæ­¤è·¯å¾„ï¼Ÿç”±è°åˆ›å»ºï¼Ÿ</strong></p>
<p>ç­”ï¼šä½¿ç”¨ pipe å‡½æ•°è¿›è¡Œåˆ›å»ºï¼Œç”±æ“ä½œç³»ç»Ÿåˆ›å»ºã€‚çˆ¶è¿›ç¨‹è°ƒç”¨è¯¥å‡½æ•°æ—¶å°†åˆ›å»ºç®¡é“ã€‚</p>
</li>
<li>
<p><strong>ä¸ºäº†å®Œæˆè¿›ç¨‹é—´é€šä¿¡ã€‚2 ä¸ªè¿›ç¨‹è¦åŒæ—¶è¿æ¥ç®¡é“ã€‚é‚£2 ä¸ªè¿›ç¨‹å¦‚ä½•è¿æ¥åˆ°åŒä¸€ç®¡é“ï¼Ÿ</strong></p>
<p>ç­”ï¼šæ•°ç»„ä¸­æœ‰ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œçˆ¶å­è¿›ç¨‹è°ƒç”¨ç›¸å…³å‡½æ•°æ—¶ï¼Œé€šè¿‡ fork å‡½æ•°ï¼ŒæŠŠ 1 ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™å­è¿›ç¨‹ã€‚</p>
</li>
<li>
<p><strong>ç®¡é“å…è®¸ 2 ä¸ªè¿›ç¨‹é—´çš„åŒå‘é€šä¿¡ã€‚åŒå‘é€šä¿¡ä¸­éœ€è¦æ³¨æ„å“ªäº›å†…å®¹ï¼Ÿ</strong></p>
<p>ç­”ï¼šå‘ç®¡é“ä¼ è¾“æ•°æ®æ—¶ï¼Œå…ˆè¯»çš„è¿›ç¨‹ä¼šæŠŠæ•°æ®å–èµ°ã€‚ç®€è¨€ä¹‹ï¼Œå°±æ˜¯æ•°æ®è¿›å…¥ç®¡é“å€™ä¼šå˜æˆæ— ä¸»æ•°æ®ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¸ºäº†é˜²æ­¢é”™è¯¯ï¼Œéœ€è¦å¤šä¸ªç®¡é“æ¥è¿›ç¨‹é€šä¿¡ã€‚</p>
</li>
</ol>
</li>
</ol>
<h2>ç¬¬ 12 ç«  I/O å¤ç”¨</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>12.1 åŸºäº I/O å¤ç”¨çš„æœåŠ¡å™¨ç«¯</h3>
<h4>12.1.1 å¤šè¿›ç¨‹æœåŠ¡ç«¯çš„ç¼ºç‚¹å’Œè§£å†³æ–¹æ³•</h4>
<p>ä¸ºäº†æ„å»ºå¹¶å‘æœåŠ¡å™¨ï¼Œåªè¦æœ‰å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚å°±ä¼šåˆ›å»ºæ–°è¿›ç¨‹ã€‚è¿™çš„ç¡®æ˜¯å®é™…æ“ä½œä¸­é‡‡ç”¨çš„ä¸€ç§æ–¹æ¡ˆï¼Œä½†å¹¶éåå…¨åç¾ï¼Œå› ä¸ºåˆ›å»ºè¿›ç¨‹è¦ä»˜å‡ºå¾ˆå¤§çš„ä»£ä»·ã€‚è¿™éœ€è¦å¤§é‡çš„è¿ç®—å’Œå†…å­˜ç©ºé—´ï¼Œç”±äºæ¯ä¸ªè¿›ç¨‹éƒ½å…·æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥ç›¸äº’é—´çš„æ•°æ®äº¤æ¢ä¹Ÿè¦é‡‡ç”¨ç›¸å¯¹å¤æ‚çš„æ–¹æ³•ï¼ˆIPC å±äºç›¸å¯¹å¤æ‚çš„é€šä¿¡æ–¹æ³•ï¼‰</p>
<p>I/O å¤ç”¨æŠ€æœ¯å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h4>12.1.2 ç†è§£å¤ç”¨</h4>
<p>ã€Œå¤ç”¨ã€åœ¨ç”µå­åŠé€šä¿¡å·¥ç¨‹é¢†åŸŸå¾ˆå¸¸è§ï¼Œå‘è¿™äº›é¢†åŸŸçš„ä¸“å®¶è¯¢é—®å…¶æ¦‚å¿µï¼Œå¯èƒ½ä¼šå¾—åˆ°å¦‚ä¸‹ç­”å¤ï¼š</p>
<blockquote>
<p>åœ¨ 1 ä¸ªé€šä¿¡é¢‘é“ä¸­ä¼ é€’å¤šä¸ªæ•°æ®ï¼ˆä¿¡å·ï¼‰çš„æŠ€æœ¯</p>
</blockquote>
<p>ã€Œå¤ç”¨ã€çš„å«ä¹‰ï¼š</p>
<blockquote>
<p>ä¸ºäº†æé«˜ç‰©ç†è®¾å¤‡çš„æ•ˆç‡ï¼Œåªç”¨æœ€å°‘çš„ç‰©ç†è¦ç´ ä¼ é€’æœ€å¤šæ•°æ®æ—¶ä½¿ç”¨çš„æŠ€æœ¯</p>
</blockquote>
<p>ä¸Šè¿°ä¸¤ç§æ–¹æ³•çš„å†…å®¹å®Œå…¨ä¸€è‡´ã€‚å¯ä»¥ç”¨çº¸ç”µè¯æ¨¡å‹åšä¸€ä¸ªç±»æ¯”ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kA8H81.png" alt="" /></p>
<p>ä¸Šå›¾æ˜¯ä¸€ä¸ªçº¸æ¯ç”µè¯ç³»ç»Ÿï¼Œä¸ºäº†ä½¿å¾—ä¸‰äººåŒæ—¶é€šè¯ï¼Œè¯´è¯æ—¶è¦åŒæ—¶å¯¹ç€ä¸¤ä¸ªçº¸æ¯ï¼Œæ¥å¬æ—¶ä¹Ÿéœ€è¦è€³æœµåŒæ—¶å¯¹å‡†ä¸¤ä¸ªçº¸æ¯ã€‚ä¸ºäº†å®Œæˆ 3 äººé€šè¯ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹å›¾çš„æ”¹è¿›ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kA8bgx.png" alt="" /></p>
<p>å¦‚å›¾åšå‡ºæ”¹è¿›ï¼Œå°±æ˜¯å¼•å…¥äº†å¤ç”¨æŠ€æœ¯ã€‚</p>
<p>å¤ç”¨æŠ€æœ¯çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å‡å°‘è¿çº¿é•¿åº¦</li>
<li>å‡å°‘çº¸æ¯ä¸ªæ•°</li>
</ul>
<p>å³ä½¿å‡å°‘äº†è¿çº¿å’Œçº¸æ¯çš„é‡ä»ç„¶å¯ä»¥è¿›è¡Œä¸‰äººåŒæ—¶è¯´è¯ï¼Œä½†æ˜¯å¦‚æœç¢°åˆ°ä»¥ä¸‹æƒ…å†µï¼š</p>
<blockquote>
<p>ã€Œå¥½åƒä¸èƒ½åŒæ—¶è¯´è¯ï¼Ÿã€</p>
</blockquote>
<p>å®é™…ä¸Šï¼Œå› ä¸ºæ˜¯åœ¨è¿›è¡Œå¯¹è¯ï¼Œæ‰€ä»¥å¾ˆå°‘å‘ç”ŸåŒæ—¶è¯´è¯çš„æƒ…å†µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šè¿°ç³»ç»Ÿé‡‡ç”¨çš„æ˜¯**ã€Œæ—¶åˆ†å¤ç”¨ã€**æŠ€æœ¯ã€‚å› ä¸ºè¯´è¯äººå£°é¢‘ç‡ä¸åŒï¼Œå³ä½¿åœ¨åŒæ—¶è¯´è¯ä¹Ÿèƒ½è¿›è¡Œä¸€å®šç¨‹åº¦ä¸Šçš„åŒºåˆ†ï¼ˆæ‚éŸ³ä¹Ÿéšä¹‹å¢å¤šï¼‰ã€‚å› æ­¤ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ã€Œé¢‘åˆ†å¤ç”¨æŠ€æœ¯ã€ã€‚</p>
<h4>12.1.3 å¤ç”¨æŠ€æœ¯åœ¨æœåŠ¡å™¨ç«¯çš„åº”ç”¨</h4>
<p>çº¸æ¯ç”µè¯ç³»ç»Ÿå¼•å…¥å¤ç”¨æŠ€æœ¯ä¹‹åå¯ä»¥å‡å°‘çº¸æ¯æ•°é‡å’Œè¿çº¿é•¿åº¦ã€‚æœåŠ¡å™¨ç«¯å¼•å…¥å¤ç”¨æŠ€æœ¯å¯ä»¥å‡å°‘æ‰€éœ€è¿›ç¨‹æ•°ã€‚ä¸‹å›¾æ˜¯å¤šè¿›ç¨‹æœåŠ¡ç«¯çš„æ¨¡å‹ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kAGBM6.png" alt="" /></p>
<p>ä¸‹å›¾æ˜¯å¼•å…¥å¤ç”¨æŠ€æœ¯ä¹‹åçš„æ¨¡å‹ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kAGrqO.png" alt="" /></p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œå¼•å…¥å¤ç”¨æŠ€æœ¯ä¹‹åï¼Œå¯ä»¥å‡å°‘è¿›ç¨‹æ•°ã€‚é‡è¦çš„æ˜¯ï¼Œæ— è®ºè¿æ¥å¤šå°‘å®¢æˆ·ç«¯ï¼Œæä¾›æœåŠ¡çš„è¿›ç¨‹åªæœ‰ä¸€ä¸ªã€‚</p>
<h3>12.2 ç†è§£ select å‡½æ•°å¹¶å®ç°æœåŠ¡ç«¯</h3>
<p>select å‡½æ•°æ˜¯æœ€å…·ä»£è¡¨æ€§çš„å®ç°å¤ç”¨æœåŠ¡å™¨çš„æ–¹æ³•ã€‚åœ¨ Windows å¹³å°ä¸‹ä¹Ÿæœ‰åŒåå‡½æ•°ï¼Œæ‰€ä»¥å…·æœ‰å¾ˆå¥½çš„ç§»æ¤æ€§ã€‚</p>
<h4>12.2.1 select å‡½æ•°çš„åŠŸèƒ½å’Œè°ƒç”¨é¡ºåº</h4>
<p>ä½¿ç”¨ select å‡½æ•°æ—¶å¯ä»¥å°†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦é›†ä¸­åˆ°ä¸€èµ·ç»Ÿä¸€ç›‘è§†ï¼Œé¡¹ç›®å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ˜¯å¦å­˜åœ¨å¥—æ¥å­—æ¥æ”¶æ•°æ®ï¼Ÿ</li>
<li>æ— éœ€é˜»å¡ä¼ è¾“æ•°æ®çš„å¥—æ¥å­—æœ‰å“ªäº›ï¼Ÿ</li>
<li>å“ªäº›å¥—æ¥å­—å‘ç”Ÿäº†å¼‚å¸¸ï¼Ÿ</li>
</ul>
<blockquote>
<p>æœ¯è¯­ï¼šã€Œäº‹ä»¶ã€ã€‚å½“å‘ç”Ÿç›‘è§†é¡¹å¯¹åº”æƒ…å†µæ—¶ï¼Œç§°ã€Œå‘ç”Ÿäº†äº‹ä»¶ã€ã€‚</p>
</blockquote>
<p>select å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ä¸ä¸€èˆ¬å‡½æ•°çš„åŒºåˆ«å¹¶ä¸å¤§ï¼Œæ›´å‡†ç¡®çš„è¯´ï¼Œä»–å¾ˆéš¾ä½¿ç”¨ã€‚ä½†æ˜¯ä¸ºäº†å®ç° I/O å¤ç”¨æœåŠ¡å™¨ç«¯ï¼Œæˆ‘ä»¬åº”è¯¥æŒæ¡ select å‡½æ•°ï¼Œå¹¶è¿ç”¨äºå¥—æ¥å­—ç¼–ç¨‹å½“ä¸­ã€‚è®¤ä¸ºã€Œselect å‡½æ•°æ˜¯ I/O å¤ç”¨çš„å…¨éƒ¨å†…å®¹ã€ä¹Ÿå¹¶ä¸ä¸ºè¿‡ã€‚select å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kAtdRs.png" alt="" /></p>
<h4>12.2.2 è®¾ç½®æ–‡ä»¶æè¿°ç¬¦</h4>
<p>åˆ©ç”¨ select å‡½æ•°å¯ä»¥åŒæ—¶ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚å½“ç„¶ï¼Œç›‘è§†æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è§†ä¸ºç›‘è§†å¥—æ¥å­—ã€‚æ­¤æ—¶é¦–å…ˆéœ€è¦å°†è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦é›†ä¸­åœ¨ä¸€èµ·ã€‚é›†ä¸­æ—¶ä¹Ÿè¦æŒ‰ç…§ç›‘è§†é¡¹ï¼ˆæ¥æ”¶ã€ä¼ è¾“ã€å¼‚å¸¸ï¼‰è¿›è¡ŒåŒºåˆ†ï¼Œå³æŒ‰ç…§ä¸Šè¿° 3 ç§ç›‘è§†é¡¹åˆ†æˆ 3 ç±»ã€‚</p>
<p>åˆ©ç”¨ fd_set æ•°ç»„å˜é‡æ‰§è¡Œæ­¤æ“ä½œï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œè¯¥æ•°ç»„æ˜¯å­˜æœ‰0å’Œ1çš„ä½æ•°ç»„ã€‚</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kAt2i4.png" alt="" /></p>
<p>å›¾ä¸­æœ€å·¦ç«¯çš„ä½è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦ 0ï¼ˆæ‰€åœ¨ä½ç½®ï¼‰ã€‚å¦‚æœè¯¥ä½è®¾ç½®ä¸º 1ï¼Œåˆ™è¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦æ˜¯ç›‘è§†å¯¹è±¡ã€‚é‚£ä¹ˆå›¾ä¸­å“ªäº›æ–‡ä»¶æè¿°ç¬¦æ˜¯ç›‘è§†å¯¹è±¡å‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œæ˜¯æè¿°ç¬¦ 1 å’Œ 3ã€‚åœ¨ fd_set å˜é‡ä¸­æ³¨å†Œæˆ–æ›´æ”¹å€¼çš„æ“ä½œéƒ½ç”±ä¸‹åˆ—å®å®Œæˆã€‚</p>
<ul>
<li><code>FD_ZERO(fd_set *fdset)</code>ï¼šå°† fd_set å˜é‡æ‰€æŒ‡çš„ä½å…¨éƒ¨åˆå§‹åŒ–æˆ0</li>
<li><code>FD_SET(int fd,fd_set *fdset)</code>ï¼šåœ¨å‚æ•° fdset æŒ‡å‘çš„å˜é‡ä¸­æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦ fd çš„ä¿¡æ¯</li>
<li><code>FD_SLR(int fd,fd_set *fdset)</code>ï¼šä»å‚æ•° fdset æŒ‡å‘çš„å˜é‡ä¸­æ¸…é™¤æ–‡ä»¶æè¿°ç¬¦ fd çš„ä¿¡æ¯</li>
<li><code>FD_ISSET(int fd,fd_set *fdset)</code>ï¼šè‹¥å‚æ•° fdset æŒ‡å‘çš„å˜é‡ä¸­åŒ…å«æ–‡ä»¶æè¿°ç¬¦ fd çš„ä¿¡æ¯ï¼Œåˆ™è¿”å›ã€ŒçœŸã€</li>
</ul>
<p>ä¸Šè¿°å‡½æ•°ä¸­ï¼ŒFD_ISSET ç”¨äºéªŒè¯ select å‡½æ•°çš„è°ƒç”¨ç»“æœï¼Œé€šè¿‡ä¸‹å›¾è§£é‡Šè¿™äº›å‡½æ•°çš„åŠŸèƒ½ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kANR78.png" alt="" /></p>
<h4>12.2.3 è®¾ç½®æ£€æŸ¥ï¼ˆç›‘è§†ï¼‰èŒƒå›´åŠè¶…æ—¶</h4>
<p>ä¸‹é¢æ˜¯ select å‡½æ•°çš„å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> maxfd, fd_set *readset, fd_set *writeset,</span></span></span><br><span class="line"><span class="function"><span class="params">           fd_set *exceptset, <span class="keyword">const</span> struct timeval *timeout)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›å¤§äº 0 çš„å€¼ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">maxfd: ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦æ•°é‡</span></span><br><span class="line"><span class="comment">readset: å°†æ‰€æœ‰å…³æ³¨ã€Œæ˜¯å¦å­˜åœ¨å¾…è¯»å–æ•°æ®ã€çš„æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ° fd_set å‹å˜é‡ï¼Œå¹¶ä¼ é€’å…¶åœ°å€å€¼ã€‚</span></span><br><span class="line"><span class="comment">writeset: å°†æ‰€æœ‰å…³æ³¨ã€Œæ˜¯å¦å¯ä¼ è¾“æ— é˜»å¡æ•°æ®ã€çš„æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ° fd_set å‹å˜é‡ï¼Œå¹¶ä¼ é€’å…¶åœ°å€å€¼ã€‚</span></span><br><span class="line"><span class="comment">exceptset: å°†æ‰€æœ‰å…³æ³¨ã€Œæ˜¯å¦å‘ç”Ÿå¼‚å¸¸ã€çš„æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ° fd_set å‹å˜é‡ï¼Œå¹¶ä¼ é€’å…¶åœ°å€å€¼ã€‚</span></span><br><span class="line"><span class="comment">timeout: è°ƒç”¨ select å‡½æ•°åï¼Œä¸ºé˜²æ­¢é™·å…¥æ— é™é˜»å¡çš„çŠ¶æ€ï¼Œä¼ é€’è¶…æ—¶(time-out)ä¿¡æ¯</span></span><br><span class="line"><span class="comment">è¿”å›å€¼: å‘ç”Ÿé”™è¯¯æ—¶è¿”å› -1,è¶…æ—¶æ—¶è¿”å›0,ã€‚å› å‘ç”Ÿå…³æ³¨çš„æ—¶é—´è¿”å›æ—¶ï¼Œè¿”å›å¤§äº0çš„å€¼ï¼Œè¯¥å€¼æ˜¯å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦æ•°ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šæ‰€è¿°ï¼Œselect å‡½æ•°ç”¨æ¥éªŒè¯ 3 ç§ç›‘è§†çš„å˜åŒ–æƒ…å†µï¼Œæ ¹æ®ç›‘è§†é¡¹å£°æ˜ 3 ä¸ª fd_set å‹å˜é‡ï¼Œåˆ†åˆ«å‘å…¶æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œå¹¶æŠŠå˜é‡çš„åœ°å€å€¼ä¼ é€’åˆ°ä¸Šè¿°å‡½æ•°çš„ç¬¬äºŒåˆ°ç¬¬å››ä¸ªå‚æ•°ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼ˆè°ƒç”¨ select å‡½æ•°ä¹‹å‰ï¼‰éœ€è¦å†³å®šä¸‹é¢ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>æ–‡ä»¶æè¿°ç¬¦çš„ç›‘è§†ï¼ˆæ£€æŸ¥ï¼‰èŒƒå›´æ˜¯ï¼Ÿ</li>
<li>å¦‚ä½•è®¾å®š select å‡½æ•°çš„è¶…æ—¶æ—¶é—´ï¼Ÿ</li>
</ol>
<p>ç¬¬ä¸€ï¼Œæ–‡ä»¶æè¿°ç¬¦çš„ç›‘è§†èŒƒå›´å’Œ select çš„ç¬¬ä¸€ä¸ªå‚æ•°æœ‰å…³ã€‚å®é™…ä¸Šï¼Œselect å‡½æ•°è¦æ±‚é€šè¿‡ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚å› æ­¤ï¼Œéœ€è¦å¾—åˆ°æ³¨å†Œåœ¨ fd_set å˜é‡ä¸­çš„æ–‡ä»¶æè¿°ç¬¦æ•°ã€‚ä½†æ¯æ¬¡æ–°å»ºæ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œå…¶å€¼å°±ä¼šå¢åŠ  1 ï¼Œæ•…åªéœ€å°†æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦å€¼åŠ  1 å†ä¼ é€’ç»™ select å‡½æ•°å³å¯ã€‚åŠ  1 æ˜¯å› ä¸ºæ–‡ä»¶æè¿°ç¬¦çš„å€¼æ˜¯ä» 0 å¼€å§‹çš„ã€‚</p>
<p>ç¬¬äºŒï¼Œselect å‡½æ•°çš„è¶…æ—¶æ—¶é—´ä¸ select å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°æœ‰å…³ï¼Œå…¶ä¸­ timeval ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> tv_sec;</span><br><span class="line">    <span class="keyword">long</span> tv_usec;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æœ¬æ¥ select å‡½æ•°åªæœ‰åœ¨ç›‘è§†æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿå˜åŒ–æ—¶æ‰è¿”å›ã€‚å¦‚æœæœªå‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚æŒ‡å®šè¶…æ—¶æ—¶é—´å°±æ˜¯ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚é€šè¿‡ä¸Šè¿°ç»“æ„ä½“å˜é‡ï¼Œå°†ç§’æ•°å¡«å…¥ tv_sec çš„æˆå‘˜ï¼Œå°†å¾®å¦™æ•°å¡«å…¥ tv_usec çš„æˆå‘˜ï¼Œç„¶åå°†ç»“æ„ä½“çš„åœ°å€å€¼ä¼ é€’åˆ° select å‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°ã€‚æ­¤æ—¶ï¼Œå³ä½¿æ–‡ä»¶æè¿°ç¬¦æœªå‘ç”Ÿå˜åŒ–ï¼Œåªè¦è¿‡äº†æŒ‡å®šæ—¶é—´ï¼Œä¹Ÿå¯ä»¥ä»å‡½æ•°ä¸­è¿”å›ã€‚ä¸è¿‡è¿™ç§æƒ…å†µä¸‹ï¼Œ select å‡½æ•°è¿”å› 0 ã€‚å› æ­¤ï¼Œå¯ä»¥é€šè¿‡è¿”å›å€¼äº†è§£åŸå› ã€‚å¦‚æœä¸å‘è®¾ç½®è¶…æ—¶ï¼Œåˆ™ä¼ é€’ NULL å‚æ•°ã€‚</p>
<h4>12.2.4 è°ƒç”¨ select å‡½æ•°æŸ¥çœ‹ç»“æœ</h4>
<p>select è¿”å›æ­£æ•´æ•°æ—¶ï¼Œæ€æ ·è·çŸ¥å“ªäº›æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿäº†å˜åŒ–ï¼Ÿå‘ select å‡½æ•°çš„ç¬¬äºŒåˆ°ç¬¬å››ä¸ªå‚æ•°ä¼ é€’çš„ fd_set å˜é‡ä¸­å°†äº§ç”Ÿå¦‚å›¾æ‰€ç¤ºçš„å˜åŒ–ï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kA06dx.png" alt="" /></p>
<p>ç”±å›¾å¯çŸ¥ï¼Œselect å‡½æ•°è°ƒç”¨å®Œæˆå€™ï¼Œå‘å…¶ä¼ é€’çš„ fd_set å˜é‡å°†å‘ç”Ÿå˜åŒ–ã€‚åŸæ¥ä¸º 1 çš„æ‰€æœ‰ä½å°†å˜æˆ 0ï¼Œä½†æ˜¯å‘ç”Ÿäº†å˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦é™¤å¤–ã€‚å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºå€¼ä»ä¸º 1 çš„ä½ç½®ä¸Šçš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<h4>12.2.5 select å‡½æ•°è°ƒç”¨ç¤ºä¾‹</h4>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ª select å‡½æ•°çš„ä¾‹å­ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch12/select.c" target="_blank" rel="noopener">select.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc select.c -o select</span><br><span class="line">./select</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kAjgW6.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœè¿è¡Œååœ¨æ ‡å‡†è¾“å…¥æµè¾“å…¥æ•°æ®ï¼Œå°±ä¼šåœ¨æ ‡å‡†è¾“å‡ºæµè¾“å‡ºæ•°æ®ï¼Œä½†æ˜¯å¦‚æœ 5 ç§’æ²¡æœ‰è¾“å…¥æ•°æ®ï¼Œå°±æç¤ºè¶…æ—¶ã€‚</p>
<h4>12.2.6 å®ç° I/O å¤ç”¨æœåŠ¡å™¨ç«¯</h4>
<p>ä¸‹é¢é€šè¿‡ select å‡½æ•°å®ç° I/O å¤ç”¨æœåŠ¡å™¨ç«¯ã€‚ä¸‹é¢æ˜¯åŸºäº I/O å¤ç”¨çš„å›å£°æœåŠ¡å™¨ç«¯ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch12/echo_selectserv.c" target="_blank" rel="noopener">echo_selectserv.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_selectserv.c -o selserv</span><br><span class="line">./selserv 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://s2.ax1x.com/2019/01/23/kEkV8H.png" alt="" /></p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶åªç”¨äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯å´å®ç°äº†å¯ä»¥å’Œå¤šä¸ªå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ï¼Œè¿™éƒ½æ˜¯åˆ©ç”¨äº† select çš„ç‰¹ç‚¹ã€‚</p>
<h3>12.3 åŸºäº Windows çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>12.4 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>è¯·è§£é‡Šå¤ç”¨æŠ€æœ¯çš„é€šç”¨å«ä¹‰ï¼Œå¹¶è¯´æ˜ä½•ä¸º I/O å¤ç”¨ã€‚</strong></p>
<p>ç­”ï¼šé€šç”¨å«ä¹‰ï¼šåœ¨ 1 ä¸ªé€šä¿¡é¢‘é“ä¸­ä¼ é€’å¤šä¸ªæ•°æ®ï¼ˆä¿¡å·ï¼‰çš„æŠ€æœ¯ã€‚IOå¤ç”¨å°±æ˜¯è¿›ç¨‹é¢„å…ˆå‘Šè¯‰å†…æ ¸éœ€è¦ç›‘è§†çš„IOæ¡ä»¶ï¼Œä½¿å¾—å†…æ ¸ä¸€æ—¦å‘ç°è¿›ç¨‹æŒ‡å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªIOæ¡ä»¶å°±ç»ªï¼Œå°±é€šè¿‡è¿›ç¨‹è¿›ç¨‹å¤„ç†ï¼Œä»è€Œä¸ä¼šåœ¨å•ä¸ªIOä¸Šé˜»å¡äº†ã€‚</p>
<p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/luoxn28/p/6220372.html" target="_blank" rel="noopener">Linuxç½‘ç»œç¼–ç¨‹-IOå¤ç”¨æŠ€æœ¯</a></p>
</li>
<li>
<p><strong>å¤šè¿›ç¨‹å¹¶å‘æœåŠ¡å™¨çš„ç¼ºç‚¹æœ‰å“ªäº›ï¼Ÿå¦‚ä½•åœ¨ I/O å¤ç”¨æœåŠ¡å™¨ä¸­å¼¥è¡¥ï¼Ÿ</strong></p>
<p>ç­”ï¼šå¤šè¿›ç¨‹éœ€è¦è¿›è¡Œå¤§é‡çš„è¿ç®—å’Œå¤§é‡çš„å†…å­˜ç©ºé—´ã€‚åœ¨ I/O å¤ç”¨æœåŠ¡å™¨ä¸­é€šè¿‡ select å‡½æ•°ç›‘è§†æ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡åˆ¤æ–­å˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¥å¾—çŸ¥å˜åŒ–çš„å¥—æ¥å­—æ˜¯å“ªä¸ªï¼Œä»è€Œå®æ—¶åº”ç­”æ¥è‡ªå¤šä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p>
</li>
<li>
<p><strong>å¤ç”¨æœåŠ¡å™¨ç«¯éœ€è¦ select å‡½æ•°ã€‚ä¸‹åˆ—å…³äº select  å‡½æ•°ä½¿ç”¨æ–¹æ³•çš„æè¿°é”™è¯¯çš„æ˜¯ï¼Ÿ</strong></p>
<p>ç­”ï¼šä»¥ä¸‹åŠ ç²—çš„ä¸ºæ­£ç¡®çš„æè¿°ã€‚</p>
<ol>
<li>è°ƒç”¨ select å‡½æ•°å‰éœ€è¦é›†ä¸­ I/O ç›‘è§†å¯¹è±¡çš„æ–‡ä»¶æè¿°ç¬¦</li>
<li><strong>è‹¥å·²é€šè¿‡ select å‡½æ•°æ³¨å†Œä¸ºç›‘è§†å¯¹è±¡ï¼Œåˆ™åç»­è°ƒç”¨ select å‡½æ•°æ—¶æ— éœ€é‡å¤æ³¨å†Œ</strong></li>
<li>å¤ç”¨æœåŠ¡å™¨ç«¯åŒä¸€æ—¶é—´åªèƒ½æœåŠ¡äº 1 ä¸ªå®¢æˆ·ç«¯ï¼Œå› æ­¤ï¼Œéœ€è¦æœåŠ¡çš„å®¢æˆ·ç«¯æ¥å…¥æœåŠ¡å™¨ç«¯ååªèƒ½ç­‰å¾…</li>
<li><strong>ä¸å¤šçº¿ç¨‹æœåŠ¡ç«¯ä¸åŒï¼ŒåŸºäº select çš„å¤ç”¨æœåŠ¡å™¨åªéœ€è¦ 1 ä¸ªè¿›ç¨‹ã€‚å› æ­¤ï¼Œå¯ä»¥å‡å°‘å› åˆ›å»ºå¤šè¿›ç¨‹äº§ç”Ÿçš„æœåŠ¡å™¨ç«¯çš„è´Ÿæ‹…</strong>ã€‚</li>
</ol>
</li>
<li>
<p><strong>select å‡½æ•°çš„è§‚å¯Ÿå¯¹è±¡ä¸­åº”åŒ…å«æœåŠ¡ç«¯å¥—æ¥å­—ï¼ˆç›‘å¬å¥—æ¥å­—ï¼‰ï¼Œé‚£ä¹ˆåº”å°†å…¶åŒ…å«åˆ°å“ªä¸€ç±»ç›‘å¬å¯¹è±¡é›†åˆï¼Ÿè¯·è¯´æ˜åŸå› </strong>ã€‚</p>
<p>ç­”ï¼šåº”è¯¥åŒ…å«åˆ°ã€Œæ˜¯å¦å­˜åœ¨å¾…è¯»å–æ•°æ®ã€ï¼Œå› ä¸ºæœåŠ¡å™¨ç«¯éœ€è¦æŸ¥çœ‹å¥—æ¥å­—ä¸­æœ‰æ²¡æœ‰å¯ä»¥è¯»å–çš„æ•°æ®ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 13 ç«  å¤šç§ I/O å‡½æ•°</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>13.1 send &amp; recv å‡½æ•°</h3>
<h4>13.1.1 Linux ä¸­çš„ send &amp; recv</h4>
<p>é¦–å…ˆçœ‹ sned å‡½æ•°å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">send</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›å‘é€çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">sockfd: è¡¨ç¤ºä¸æ•°æ®ä¼ è¾“å¯¹è±¡çš„è¿æ¥çš„å¥—æ¥å­—å’Œæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">buf: ä¿å­˜å¸¦ä¼ è¾“æ•°æ®çš„ç¼“å†²åœ°å€å€¼</span></span><br><span class="line"><span class="comment">nbytes: å¾…ä¼ è¾“å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment">flags: ä¼ è¾“æ•°æ®æ—¶æŒ‡å®šçš„å¯é€‰é¡¹ä¿¡æ¯</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ recv å‡½æ•°çš„å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbytes, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›æ¥æ”¶çš„å­—èŠ‚æ•°ï¼ˆæ”¶åˆ° EOF è¿”å› 0ï¼‰ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">sockfd: è¡¨ç¤ºæ•°æ®æ¥å—å¯¹è±¡çš„è¿æ¥çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">buf: ä¿å­˜æ¥å—æ•°æ®çš„ç¼“å†²åœ°å€å€¼</span></span><br><span class="line"><span class="comment">nbytes: å¯æ¥æ”¶çš„æœ€å¤§å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment">flags: æ¥æ”¶æ•°æ®æ—¶æŒ‡å®šçš„å¯é€‰é¡¹å‚æ•°</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>send å’Œ recv å‡½æ•°éƒ½æ˜¯æœ€åä¸€ä¸ªå‚æ•°æ˜¯æ”¶å‘æ•°æ®çš„å¯é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å¯ä»¥ç”¨ä½æˆ–ï¼ˆbit ORï¼‰è¿ç®—ç¬¦ï¼ˆ| è¿ç®—ç¬¦ï¼‰åŒæ—¶ä¼ é€’å¤šä¸ªä¿¡æ¯ã€‚</p>
<p>send &amp; recv å‡½æ•°çš„å¯é€‰é¡¹æ„ä¹‰ï¼š</p>
<table>
<thead>
<tr>
<th>å¯é€‰é¡¹ï¼ˆOptionï¼‰</th>
<th>å«ä¹‰</th>
<th>send</th>
<th>recv</th>
</tr>
</thead>
<tbody>
<tr>
<td>MSG_OOB</td>
<td>ç”¨äºä¼ è¾“å¸¦å¤–æ•°æ®ï¼ˆOut-of-band dataï¼‰</td>
<td>O</td>
<td>O</td>
</tr>
<tr>
<td>MSG_PEEK</td>
<td>éªŒè¯è¾“å…¥ç¼“å†²ä¸­æ˜¯å¦å­˜åœ¨æ¥å—çš„æ•°æ®</td>
<td>X</td>
<td>O</td>
</tr>
<tr>
<td>MSG_DONTROUTE</td>
<td>æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ä¸å‚ç…§æœ¬åœ°è·¯ç”±ï¼ˆRoutingï¼‰è¡¨ï¼Œåœ¨æœ¬åœ°ï¼ˆLocalï¼‰ç½‘ç»œä¸­å¯»æ‰¾ç›®çš„åœ°</td>
<td>O</td>
<td>X</td>
</tr>
<tr>
<td>MSG_DONTWAIT</td>
<td>è°ƒç”¨ I/O å‡½æ•°æ—¶ä¸é˜»å¡ï¼Œç”¨äºä½¿ç”¨éé˜»å¡ï¼ˆNon-blockingï¼‰I/O</td>
<td>O</td>
<td>O</td>
</tr>
<tr>
<td>MSG_WAITALL</td>
<td>é˜²æ­¢å‡½æ•°è¿”å›ï¼Œç›´åˆ°æ¥æ”¶åˆ°å…¨éƒ¨è¯·æ±‚çš„å­—èŠ‚æ•°</td>
<td>X</td>
<td>O</td>
</tr>
</tbody>
</table>
<h4>13.1.2 MSG_OOBï¼šå‘é€ç´§æ€¥æ¶ˆæ¯</h4>
<p>MSG_OOB å¯é€‰é¡¹ç”¨äºåˆ›å»ºç‰¹æ®Šå‘é€æ–¹æ³•å’Œé€šé“ä»¥å‘é€ç´§æ€¥æ¶ˆæ¯ã€‚ä¸‹é¢ä¸º MSG_OOB çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/oob_recv.c" target="_blank" rel="noopener">oob_recv.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/oob_send.c" target="_blank" rel="noopener">oob_send.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc oob_send.c -o send</span><br><span class="line">gcc oob_recv.c -o recv</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/26/5c4bda167ae08.png" alt="" /></p>
<p><img src="https://i.loli.net/2019/01/26/5c4bdb4d99823.png" alt="" /></p>
<p>ä»è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œsend æ˜¯å®¢æˆ·ç«¯ï¼Œrecv æ˜¯æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯æ¥æ”¶å®Œæ¶ˆæ¯ä¹‹åæ˜¾ç¤ºå‡ºæ¥ã€‚å¯ä»¥ä»å›¾ä¸­çœ‹å‡ºï¼Œæ¯æ¬¡è¿è¡Œçš„æ•ˆæœï¼Œå¹¶ä¸æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>ä»£ç ä¸­å…³äº:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fcntl(recv_sock, F_SETOWN, getpid());</span><br></pre></td></tr></table></figure>
<p>çš„æ„æ€æ˜¯ï¼š</p>
<blockquote>
<p>æ–‡ä»¶æè¿°ç¬¦ recv_sock æŒ‡å‘çš„å¥—æ¥å­—å¼•å‘çš„ SIGURG ä¿¡å·å¤„ç†è¿›ç¨‹å˜ä¸º getpid å‡½æ•°è¿”å›å€¼ç”¨ä½œ ID è¿›ç¨‹.</p>
</blockquote>
<p>ä¸Šè¿°æè¿°ä¸­çš„ã€Œå¤„ç† SIGURG ä¿¡å·ã€æŒ‡çš„æ˜¯ã€Œè°ƒç”¨ SIGURG ä¿¡å·å¤„ç†å‡½æ•°ã€ã€‚ä½†æ˜¯ä¹‹å‰è®²è¿‡ï¼Œå¤šä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰ 1 ä¸ªå¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡è°ƒç”¨ fork å‡½æ•°åˆ›å»ºå­è¿›ç¨‹å¹¶åŒæ—¶å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ã€‚æ­¤æ—¶å¦‚æœå‘ç”Ÿ SIGURG ä¿¡å·ï¼Œåº”è¯¥è°ƒç”¨å“ªä¸ªè¿›ç¨‹çš„ä¿¡å·å¤„ç†å‡½æ•°å‘¢ï¼Ÿå¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œä¸ä¼šè°ƒç”¨æ‰€æœ‰è¿›ç¨‹çš„ä¿¡å·å¤„ç†å‡½æ•°ã€‚å› æ­¤ï¼Œå¤„ç† SIGURG ä¿¡å·æ—¶å¿…é¡»æŒ‡å®šå¤„ç†ä¿¡å·æ‰€ç”¨çš„è¿›ç¨‹ï¼Œè€Œ getpid è¿”å›çš„æ˜¯è°ƒç”¨æ­¤å‡½æ•°çš„è¿›ç¨‹ ID ã€‚ä¸Šè¿°è°ƒç”¨è¯­å¥æŒ‡å½“å‰ä¸ºå¤„ç† SIGURG ä¿¡å·çš„ä¸»ä½“ã€‚</p>
<p>è¾“å‡ºç»“æœï¼Œå¯èƒ½å‡ºä¹æ„æ–™ï¼š</p>
<blockquote>
<p>é€šè¿‡ MSG_OOB å¯é€‰é¡¹ä¼ é€’æ•°æ®æ—¶åªè¿”å› 1 ä¸ªå­—èŠ‚ï¼Œè€Œä¸”ä¹Ÿä¸å¿«</p>
</blockquote>
<p>çš„ç¡®ï¼Œé€šè¿‡ MSG_OOB å¹¶ä¸ä¼šåŠ å¿«ä¼ è¾“é€Ÿåº¦ï¼Œè€Œé€šè¿‡ä¿¡å·å¤„ç†å‡½æ•° urg_handler ä¹Ÿåªèƒ½è¯»å–ä¸€ä¸ªå­—èŠ‚ã€‚å‰©ä½™æ•°æ®åªèƒ½é€šè¿‡æœªè®¾ç½® MSG_OOB å¯é€‰é¡¹çš„æ™®é€šè¾“å…¥å‡½æ•°è¯»å–ã€‚å› ä¸º TCP ä¸å­˜åœ¨çœŸæ­£æ„ä¹‰ä¸Šçš„ã€Œå¤–å¸¦æ•°æ®ã€ã€‚å®é™…ä¸Šï¼ŒMSG_OOB ä¸­çš„ OOB æŒ‡çš„æ˜¯ Out-of-band ï¼Œè€Œã€Œå¤–å¸¦æ•°æ®ã€çš„å«ä¹‰æ˜¯ï¼š</p>
<blockquote>
<p>é€šè¿‡å»å®Œå…¨ä¸åŒçš„é€šä¿¡è·¯å¾„ä¼ è¾“çš„æ•°æ®</p>
</blockquote>
<p>å³çœŸæ­£æ„ä¹‰ä¸Šçš„ Out-of-band éœ€è¦é€šè¿‡å•ç‹¬çš„é€šä¿¡è·¯å¾„é«˜é€Ÿä¼ è¾“æ•°æ®ï¼Œä½†æ˜¯ TCP ä¸å¦å¤–æä¾›ï¼Œåªåˆ©ç”¨ TCP çš„ç´§æ€¥æ¨¡å¼ï¼ˆUrgent modeï¼‰è¿›è¡Œä¼ è¾“ã€‚</p>
<h4>13.1.3 ç´§æ€¥æ¨¡å¼å·¥ä½œåŸç†</h4>
<p>MSG_OOB çš„çœŸæ­£æ„ä¹‰åœ¨äºç£ä¿ƒæ•°æ®æ¥æ”¶å¯¹è±¡å°½å¿«å¤„ç†æ•°æ®ã€‚è¿™æ˜¯ç´§æ€¥æ¨¡å¼çš„å…¨éƒ¨å†…å®¹ï¼Œè€Œ TCP ã€Œä¿æŒä¼ è¾“é¡ºåºã€çš„ä¼ è¾“ç‰¹æ€§ä¾ç„¶æˆç«‹ã€‚TCP çš„ç´§æ€¥æ¶ˆæ¯æ— æ³•ä¿è¯åŠæ—¶åˆ°è¾¾ï¼Œä½†æ˜¯å¯ä»¥è¦æ±‚æ€¥æ•‘ã€‚ä¸‹é¢æ˜¯ MSG_OOB å¯é€‰é¡¹çŠ¶æ€ä¸‹çš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ï¼Œå¦‚å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/01/26/5c4be222845cc.png" alt="" /></p>
<p>ä¸Šé¢æ˜¯:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">send(sock, <span class="string">"890"</span>, <span class="built_in">strlen</span>(<span class="string">"890"</span>), MSG_OOB);</span><br></pre></td></tr></table></figure>
<p>å›¾ä¸Šæ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„ç¼“å†²çŠ¶æ€ã€‚å¦‚æœç¼“å†²æœ€å·¦ç«¯çš„ä½ç½®è§†ä½œåç§»é‡ 0 ã€‚å­—ç¬¦ 0 ä¿å­˜äºåç§»é‡ 2 çš„ä½ç½®ã€‚å¦å¤–ï¼Œå­—ç¬¦ 0 å³ä¾§åç§»é‡ä¸º 3 çš„ä½ç½®å­˜æœ‰ç´§æ€¥æŒ‡é’ˆï¼ˆUrgent Pointerï¼‰ã€‚ç´§æ€¥æŒ‡é’ˆæŒ‡å‘ç´§æ€¥æ¶ˆæ¯çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼ˆåç§»é‡åŠ ä¸€ï¼‰ï¼ŒåŒæ—¶å‘å¯¹æ–¹ä¸»æœºä¼ é€’ä¸€ä¸‹ä¿¡æ¯ï¼š</p>
<blockquote>
<p>ç´§æ€¥æŒ‡é’ˆæŒ‡å‘çš„åç§»é‡ä¸º 3 ä¹‹å‰çš„éƒ¨åˆ†å°±æ˜¯ç´§æ€¥æ¶ˆæ¯ã€‚</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™…ä¸Šåªç”¨äº†ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºç´§æ€¥æ¶ˆæ¯ã€‚è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡å›¾ä¸­ç”¨äºä¼ è¾“æ•°æ®çš„ TCP æ•°æ®åŒ…ï¼ˆæ®µï¼‰çš„ç»“æ„çœ‹å¾—æ›´æ¸…æ¥šï¼Œå¦‚å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/01/26/5c4beeae46b4e.png" alt="" /></p>
<p>TCP æ•°æ®åŒ…å®é™…åŒ…å«æ›´å¤šä¿¡æ¯ã€‚TCP å¤´éƒ¨åŒ…å«å¦‚ä¸‹ä¸¤ç§ä¿¡æ¯ï¼š</p>
<ul>
<li>URG=1ï¼šè½½æœ‰ç´§æ€¥æ¶ˆæ¯çš„æ•°æ®åŒ…</li>
<li>URGæŒ‡é’ˆï¼šç´§æ€¥æŒ‡é’ˆä½äºåç§»é‡ä¸º 3 çš„ä½ç½®ã€‚</li>
</ul>
<p>æŒ‡å®š MSG_OOB é€‰é¡¹çš„æ•°æ®åŒ…æœ¬èº«å°±æ˜¯ç´§æ€¥æ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡ç´§æ€¥æŒ‡é’ˆè¡¨ç¤ºç´§æ€¥æ¶ˆæ¯æ‰€åœ¨çš„ä½ç½®ã€‚</p>
<p>ç´§æ€¥æ¶ˆæ¯çš„æ„ä¹‰åœ¨äºç£ä¿ƒæ¶ˆæ¯å¤„ç†ï¼Œè€Œéç´§æ€¥ä¼ è¾“å½¢å¼å—é™çš„ä¿¡æ¯ã€‚</p>
<h4>13.1.4 æ£€æŸ¥è¾“å…¥ç¼“å†²</h4>
<p>åŒæ—¶è®¾ç½® MSG_PEEK é€‰é¡¹å’Œ MSG_DONTWAIT é€‰é¡¹ï¼Œä»¥éªŒè¯è¾“å…¥ç¼“å†²æ˜¯å¦å­˜åœ¨æ¥æ”¶çš„æ•°æ®ã€‚è®¾ç½® MSG_PEEK é€‰é¡¹å¹¶è°ƒç”¨ recv å‡½æ•°æ—¶ï¼Œå³ä½¿è¯»å–äº†è¾“å…¥ç¼“å†²çš„æ•°æ®ä¹Ÿä¸ä¼šåˆ é™¤ã€‚å› æ­¤ï¼Œè¯¥é€‰é¡¹é€šå¸¸ä¸ MSG_DONTWAIT åˆä½œï¼Œç”¨äºè°ƒç”¨ä»¥éé˜»å¡æ–¹å¼éªŒè¯å¾…è¯»æ•°æ®å­˜ä¸å¦çš„å‡½æ•°ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ˜¯äºŒè€…çš„å«ä¹‰ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/peek_recv.c" target="_blank" rel="noopener">peek_recv.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/peek_send.c" target="_blank" rel="noopener">peek_send.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc peek_recv.c -o recv</span><br><span class="line">gcc peek_send.c -o send</span><br><span class="line">.&#x2F;recv 9190</span><br><span class="line">.&#x2F;send 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/26/5c4c0d1dc83af.png" alt="" /></p>
<p>å¯ä»¥é€šè¿‡ç»“æœéªŒè¯ï¼Œä»…å‘é€äº†ä¸€æ¬¡çš„æ•°æ®è¢«è¯»å–äº† 2 æ¬¡ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡è°ƒç”¨ recv å‡½æ•°æ—¶è®¾ç½®äº† MSG_PEEK å¯é€‰é¡¹ã€‚</p>
<h3>13.2 readv &amp; writev å‡½æ•°</h3>
<h4>13.2.1 ä½¿ç”¨ readv &amp; writev å‡½æ•°</h4>
<p>readv &amp; writev å‡½æ•°çš„åŠŸèƒ½å¯æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å¯¹æ•°æ®è¿›è¡Œæ•´åˆä¼ è¾“åŠå‘é€çš„å‡½æ•°</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡ writev å‡½æ•°å¯ä»¥å°†åˆ†æ•£ä¿å­˜åœ¨å¤šä¸ªç¼“å†²ä¸­çš„æ•°æ®ä¸€å¹¶å‘é€ï¼Œé€šè¿‡ readv å‡½æ•°å¯ä»¥ç”±å¤šä¸ªç¼“å†²åˆ†åˆ«æ¥æ”¶ã€‚å› æ­¤ï¼Œé€‚ç”¨è¿™ 2 ä¸ªå‡½æ•°å¯ä»¥å‡å°‘ I/O å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ã€‚ä¸‹é¢å…ˆä»‹ç» writev å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writev</span><span class="params">(<span class="keyword">int</span> filedes, <span class="keyword">const</span> struct iovec *iov, <span class="keyword">int</span> iovcnt)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›å‘é€çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">filedes: è¡¨ç¤ºæ•°æ®ä¼ è¾“å¯¹è±¡çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚ä½†è¯¥å‡½æ•°å¹¶ä¸ä»…é™äºå¥—æ¥å­—ï¼Œå› æ­¤ï¼Œå¯ä»¥åƒ read ä¸€æ ·å‘å‘å…¶ä¼ é€’æ–‡ä»¶æˆ–æ ‡å‡†è¾“å‡ºæè¿°ç¬¦.</span></span><br><span class="line"><span class="comment">iov: iovec ç»“æ„ä½“æ•°ç»„çš„åœ°å€å€¼ï¼Œç»“æ„ä½“ iovec ä¸­åŒ…å«å¾…å‘é€æ•°æ®çš„ä½ç½®å’Œå¤§å°ä¿¡æ¯</span></span><br><span class="line"><span class="comment">iovcnt: å‘ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’æ•°ç»„é•¿åº¦</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ç¬¬äºŒä¸ªå‚æ•°ä¸­å‡ºç°çš„æ•°ç»„ iovec ç»“æ„ä½“çš„å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *iov_base; <span class="comment">//ç¼“å†²åœ°å€</span></span><br><span class="line">    <span class="keyword">size_t</span> iov_len; <span class="comment">//ç¼“å†²å¤§å°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸‹å›¾æ˜¯è¯¥å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ï¼š</p>
<p><img src="https://i.loli.net/2019/01/26/5c4c61b07d207.png" alt="" /></p>
<p>writev çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤å‘æ§åˆ¶å°è¾“å‡ºæ•°æ®ï¼Œptr æ˜¯å­˜æœ‰å¾…å‘é€æ•°æ®ä¿¡æ¯çš„ iovec æ•°ç»„æŒ‡é’ˆã€‚ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º 2ï¼Œå› æ­¤ï¼Œä» ptr æŒ‡å‘çš„åœ°å€å¼€å§‹ï¼Œå…±æµè§ˆ 2 ä¸ª iovec ç»“æ„ä½“å˜é‡ï¼Œå‘é€è¿™äº›æŒ‡é’ˆæŒ‡å‘çš„ç¼“å†²æ•°æ®ã€‚</p>
<p>ä¸‹é¢æ˜¯ writev å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/writev.c" target="_blank" rel="noopener">writev.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vec</span>[2];</span></span><br><span class="line">    <span class="keyword">char</span> buf1[] = <span class="string">"ABCDEFG"</span>;</span><br><span class="line">    <span class="keyword">char</span> buf2[] = <span class="string">"1234567"</span>;</span><br><span class="line">    <span class="keyword">int</span> str_len;</span><br><span class="line"></span><br><span class="line">    vec[<span class="number">0</span>].iov_base = buf1;</span><br><span class="line">    vec[<span class="number">0</span>].iov_len = <span class="number">3</span>;</span><br><span class="line">    vec[<span class="number">1</span>].iov_base = buf2;</span><br><span class="line">    vec[<span class="number">1</span>].iov_len = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    str_len = writev(<span class="number">1</span>, vec, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Write bytes: %d \n"</span>, str_len);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc writev.c -o writev</span><br><span class="line">./writevi</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ABC1234</span><br><span class="line">Write bytes: 7</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢ä»‹ç» readv å‡½æ•°ï¼ŒåŠŸèƒ½å’Œ writev å‡½æ•°æ­£å¥½ç›¸å.å‡½æ•°ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readv</span><span class="params">(<span class="keyword">int</span> filedes, <span class="keyword">const</span> struct iovc *iov, <span class="keyword">int</span> iovcnt)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›æ¥æ”¶çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">filedes: è¡¨ç¤ºæ•°æ®ä¼ è¾“å¯¹è±¡çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚ä½†è¯¥å‡½æ•°å¹¶ä¸ä»…é™äºå¥—æ¥å­—ï¼Œå› æ­¤ï¼Œå¯ä»¥åƒ read ä¸€æ ·å‘å‘å…¶ä¼ é€’æ–‡ä»¶æˆ–æ ‡å‡†è¾“å‡ºæè¿°ç¬¦.</span></span><br><span class="line"><span class="comment">iov: iovec ç»“æ„ä½“æ•°ç»„çš„åœ°å€å€¼ï¼Œç»“æ„ä½“ iovec ä¸­åŒ…å«å¾…å‘é€æ•°æ®çš„ä½ç½®å’Œå¤§å°ä¿¡æ¯</span></span><br><span class="line"><span class="comment">iovcnt: å‘ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’æ•°ç»„é•¿åº¦</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ç¤ºä¾‹ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch13/readv.c" target="_blank" rel="noopener">readv.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vec</span>[2];</span></span><br><span class="line">    <span class="keyword">char</span> buf1[BUF_SIZE] = &#123;</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">char</span> buf2[BUF_SIZE] = &#123;</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> str_len;</span><br><span class="line"></span><br><span class="line">    vec[<span class="number">0</span>].iov_base = buf1;</span><br><span class="line">    vec[<span class="number">0</span>].iov_len = <span class="number">5</span>;</span><br><span class="line">    vec[<span class="number">1</span>].iov_base = buf2;</span><br><span class="line">    vec[<span class="number">1</span>].iov_len = BUF_SIZE;</span><br><span class="line"></span><br><span class="line">    str_len = readv(<span class="number">0</span>, vec, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Read bytes: %d \n"</span>, str_len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"First message: %s \n"</span>, buf1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Second message: %s \n"</span>, buf2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc readv.c -o rv</span><br><span class="line">./rv</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/26/5c4c718555398.png" alt="" /></p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆæˆªå–äº†é•¿åº¦ä¸º 5 çš„æ•°æ®è¾“å‡ºï¼Œç„¶åå†è¾“å‡ºå‰©ä¸‹çš„ã€‚</p>
<h4>13.2.2 åˆç†ä½¿ç”¨ readv &amp; writev å‡½æ•°</h4>
<p>å®é™…ä¸Šï¼Œèƒ½ä½¿ç”¨è¯¥å‡½æ•°çš„æ‰€æœ‰æƒ…å†µéƒ½é€‚ç”¨ã€‚ä¾‹å¦‚ï¼Œéœ€è¦ä¼ è¾“çš„æ•°æ®åˆ†åˆ«ä½äºä¸åŒç¼“å†²ï¼ˆæ•°ç»„ï¼‰æ—¶ï¼Œéœ€è¦å¤šæ¬¡è°ƒç”¨ write å‡½æ•°ã€‚æ­¤æ—¶å¯é€šè¿‡ 1 æ¬¡ writev å‡½æ•°è°ƒç”¨æ›¿ä»£æ“ä½œï¼Œå½“ç„¶ä¼šæé«˜æ•ˆç‡ã€‚åŒæ ·ï¼Œéœ€è¦å°†è¾“å…¥ç¼“å†²ä¸­çš„æ•°æ®è¯»å…¥ä¸åŒä½ç½®æ—¶ï¼Œå¯ä»¥ä¸å¿…å¤šæ¬¡è°ƒç”¨ read å‡½æ•°ï¼Œè€Œæ˜¯åˆ©ç”¨ 1 æ¬¡ readv å‡½æ•°å°±èƒ½å¤§å¤§æé«˜æ•ˆç‡ã€‚</p>
<p>å…¶æ„ä¹‰åœ¨äºå‡å°‘æ•°æ®åŒ…ä¸ªæ•°ã€‚å‡è®¾ä¸ºäº†æé«˜æ•ˆç‡åœ¨æœåŠ¡å™¨ç«¯æ˜ç¡®ç¦ç”¨äº† Nagle ç®—æ³•ã€‚å…¶å® writev å‡½æ•°åœ¨ä¸é‡‡ç”¨ Nagle ç®—æ³•æ—¶æ›´æœ‰ä»·å€¼ï¼Œå¦‚å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/01/26/5c4c731323e19.png" alt="" /></p>
<h3>13.3 åŸºäº Windows çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>13.4 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>ä¸‹åˆ—å…³äº MSG_OOB å¯é€‰é¡¹çš„è¯´æ³•é”™è¯¯çš„æ˜¯</strong>ï¼Ÿ</p>
<p>ç­”ï¼šä»¥ä¸‹åŠ ç²—çš„å­—ä½“ä»£è¡¨è¯´æ³•æ­£ç¡®ã€‚</p>
<ol>
<li>MSG_OOB æŒ‡ä¼ è¾“ Out-of-band æ•°æ®ï¼Œæ˜¯é€šè¿‡å…¶ä»–è·¯å¾„é«˜é€Ÿä¼ è¾“æ•°æ®</li>
<li>MSG_OOB æŒ‡é€šè¿‡å…¶ä»–è·¯å¾„é«˜é€Ÿä¼ è¾“æ•°æ®ï¼Œå› æ­¤ TCP ä¸­è®¾ç½®è¯¥é€‰é¡¹çš„æ•°æ®å…ˆåˆ°è¾¾å¯¹æ–¹ä¸»æœº</li>
<li><strong>è®¾ç½® MSG_OOB æ˜¯æ•°æ®å…ˆåˆ°è¾¾å¯¹æ–¹ä¸»æœºåï¼Œä»¥æ™®é€šæ•°æ®çš„å½¢å¼å’Œé¡ºåºè¯»å–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæ˜¯æé«˜äº†ä¼ è¾“é€Ÿåº¦ï¼Œæ¥æ”¶æ–¹æ— æ³•è¯†åˆ«è¿™ä¸€ç‚¹</strong>ã€‚</li>
<li><strong>MSG_OOB æ— æ³•è„±ç¦» TCP çš„é»˜è®¤æ•°æ®ä¼ è¾“æ–¹å¼ï¼Œå³ä½¿è„±ç¦»äº† MSG_OOB ï¼Œä¹Ÿä¼šä¿æŒåŸæœ‰çš„ä¼ è¾“é¡ºåºã€‚è¯¥é€‰é¡¹åªç”¨äºè¦æ±‚æ¥æ”¶æ–¹ç´§æ€¥å¤„ç†</strong>ã€‚</li>
</ol>
</li>
<li>
<p><strong>åˆ©ç”¨ readv &amp; writev å‡½æ•°æ”¶å‘æ•°æ®æœ‰ä½•ä¼˜ç‚¹ï¼Ÿåˆ†åˆ«ä»å‡½æ•°è°ƒç”¨æ¬¡æ•°å’Œ I/O ç¼“å†²çš„è§’åº¦ç»™å‡ºè¯´æ˜</strong>ã€‚</p>
<p>ç­”ï¼šéœ€è¦ä¼ è¾“çš„æ•°æ®åˆ†åˆ«ä½äºä¸åŒç¼“å†²ï¼ˆæ•°ç»„ï¼‰æ—¶ï¼Œéœ€è¦å¤šæ¬¡è°ƒç”¨ write å‡½æ•°ã€‚æ­¤æ—¶å¯é€šè¿‡ 1 æ¬¡ writev å‡½æ•°è°ƒç”¨æ›¿ä»£æ“ä½œï¼Œå½“ç„¶ä¼šæé«˜æ•ˆç‡ã€‚åŒæ ·ï¼Œéœ€è¦å°†è¾“å…¥ç¼“å†²ä¸­çš„æ•°æ®è¯»å…¥ä¸åŒä½ç½®æ—¶ï¼Œå¯ä»¥ä¸å¿…å¤šæ¬¡è°ƒç”¨ read å‡½æ•°ï¼Œè€Œæ˜¯åˆ©ç”¨ 1 æ¬¡ readv å‡½æ•°å°±èƒ½å¤§å¤§æé«˜æ•ˆç‡ã€‚</p>
</li>
<li>
<p><strong>é€šè¿‡ recv å‡½æ•°éªŒè¯è¾“å…¥ç¼“å†²ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®æ—¶ï¼ˆç¡®è®¤åç«‹å³è¿”å›æ—¶ï¼‰ï¼Œå¦‚ä½•è®¾ç½® recv å‡½æ•°æœ€åä¸€ä¸ªå‚æ•°ä¸­çš„å¯é€‰é¡¹ï¼Ÿåˆ†åˆ«è¯´æ˜å„å¯é€‰é¡¹çš„å«ä¹‰</strong>ã€‚</p>
<p>ç­”ï¼šä½¿ç”¨ MSG_PEEK æ¥éªŒè¯è¾“å…¥ç¼“å†²ä¸­æ˜¯å¦å­˜åœ¨å¾…æ¥æ”¶çš„æ•°æ®ã€‚å„ä¸ªå¯é€‰é¡¹çš„æ„ä¹‰å‚è§ä¸Šé¢å¯¹åº”ç« èŠ‚çš„è¡¨æ ¼ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 14 ç«  å¤šæ’­ä¸å¹¿æ’­</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>14.1 å¤šæ’­</h3>
<p>å¤šæ’­ï¼ˆMulticastï¼‰æ–¹å¼çš„æ•°æ®ä¼ è¾“æ˜¯åŸºäº UDP å®Œæˆçš„ã€‚å› æ­¤ ï¼Œä¸ UDP æœåŠ¡å™¨ç«¯/å®¢æˆ·ç«¯çš„å®ç°æ–¹å¼éå¸¸æ¥è¿‘ã€‚åŒºåˆ«åœ¨äºï¼ŒUDP æ•°æ®ä¼ è¾“ä»¥å•ä¸€ç›®æ ‡è¿›è¡Œï¼Œè€Œå¤šæ’­æ•°æ®åŒæ—¶ä¼ é€’åˆ°åŠ å…¥ï¼ˆæ³¨å†Œï¼‰ç‰¹å®šç»„çš„å¤§é‡ä¸»æœºã€‚æ¢è¨€ä¹‹ï¼Œé‡‡ç”¨å¤šæ’­æ–¹å¼æ—¶ï¼Œå¯ä»¥åŒæ—¶å‘å¤šä¸ªä¸»æœºä¼ é€’æ•°æ®ã€‚</p>
<h4>14.1.1 å¤šæ’­çš„æ•°æ®ä¼ è¾“æ–¹å¼ä»¥åŠæµé‡æ–¹é¢çš„ä¼˜ç‚¹</h4>
<p>å¤šæ’­çš„æ•°æ®ä¼ è¾“ç‰¹ç‚¹å¯æ•´ç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¤šæ’­æœåŠ¡å™¨ç«¯é’ˆå¯¹ç‰¹å®šå¤šæ’­ç»„ï¼Œåªå‘é€ 1 æ¬¡æ•°æ®ã€‚</li>
<li>å³ä½¿åªå‘é€ 1 æ¬¡æ•°æ®ï¼Œä½†è¯¥ç»„å†…çš„æ‰€æœ‰å®¢æˆ·ç«¯éƒ½ä¼šæ¥æ”¶æ•°æ®</li>
<li>å¤šæ’­ç»„æ•°å¯ä»¥åœ¨ IP åœ°å€èŒƒå›´å†…ä»»æ„å¢åŠ </li>
</ul>
<p>å¤šæ’­ç»„æ˜¯ D ç±»IPåœ°å€ï¼ˆ224.0.0.0~239.255.255.255ï¼‰ï¼Œã€ŒåŠ å…¥å¤šæ’­ç»„ã€å¯ä»¥ç†è§£ä¸ºé€šè¿‡ç¨‹åºå®Œæˆå¦‚ä¸‹å£°æ˜ï¼š</p>
<blockquote>
<p>åœ¨ D ç±»IPåœ°å€ä¸­ï¼Œæˆ‘å¸Œæœ›æ¥æ”¶å‘å¾€ç›®æ ‡ 239.234.218.234 çš„å¤šæ’­æ•°æ®</p>
</blockquote>
<p>å¤šæ’­æ˜¯åŸºäº UDP å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šæ’­æ•°æ®åŒ…çš„æ ¼å¼ä¸ UDP æ•°æ®åŒ…ç›¸åŒã€‚åªæ˜¯ä¸ä¸€èˆ¬çš„ UDP æ•°æ®åŒ…ä¸åŒã€‚å‘ç½‘ç»œä¼ é€’ 1 ä¸ªå¤šæ’­æ•°æ®åŒ…æ—¶ï¼Œè·¯ç”±å™¨å°†å¤åˆ¶è¯¥æ•°æ®åŒ…å¹¶ä¼ é€’åˆ°å¤šä¸ªä¸»æœºã€‚åƒè¿™æ ·ï¼Œå¤šæ’­éœ€è¦å€ŸåŠ©è·¯ç”±å™¨å®Œæˆã€‚å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/27/5c4d310daa6be.png" alt="" /></p>
<p>è‹¥é€šè¿‡ TCP æˆ– UDP å‘ 1000 ä¸ªä¸»æœºå‘é€æ–‡ä»¶ï¼Œåˆ™å…±éœ€è¦ä¼ é€’ 1000 æ¬¡ã€‚ä½†æ˜¯æ­¤æ—¶å¦‚æœç”¨å¤šæ’­ç½‘ç»œä¼ è¾“æ–‡ä»¶ï¼Œåˆ™åªéœ€è¦å‘é€ä¸€æ¬¡ã€‚è¿™æ—¶ç”± 1000 å°ä¸»æœºæ„æˆçš„ç½‘ç»œä¸­çš„è·¯ç”±å™¨è´Ÿè´£å¤åˆ¶æ–‡ä»¶å¹¶ä¼ é€’åˆ°ä¸»æœºã€‚å°±å› ä¸ºè¿™ç§ç‰¹æ€§ï¼Œå¤šæ’­ä¸»è¦ç”¨äºã€Œå¤šåª’ä½“æ•°æ®å®æ—¶ä¼ è¾“ã€ã€‚</p>
<p>å¦å¤–ï¼Œç†è®ºä¸Šå¯ä»¥å®Œæˆå¤šæ’­é€šä¿¡ï¼Œä½†æ˜¯ä¸å°‘è·¯ç”±å™¨å¹¶ä¸æ”¯æŒå¤šæ’­ï¼Œæˆ–å³ä¾¿æ”¯æŒä¹Ÿå› ç½‘ç»œæ‹¥å µé—®é¢˜æ•…æ„é˜»æ–­å¤šæ’­ã€‚å› æ­¤ï¼Œä¸ºäº†åœ¨ä¸æ”¯æŒå¤šæ’­çš„è·¯ç”±å™¨ä¸­å®Œæˆå¤šæ’­é€šä¿¡ï¼Œä¹Ÿä¼šä½¿ç”¨éš§é“ï¼ˆTunnelingï¼‰æŠ€æœ¯ã€‚</p>
<h4>14.1.2 è·¯ç”±ï¼ˆRoutingï¼‰å’Œ TTLï¼ˆTime to Live,ç”Ÿå­˜æ—¶é—´ï¼‰ï¼Œä»¥åŠåŠ å…¥ç»„çš„åŠæ³•</h4>
<p>ä¸ºäº†ä¼ é€’å¤šæ’­æ•°æ®åŒ…ï¼Œå¿…é¡»è®¾ç½® TTL ã€‚TTL æ˜¯ Time to Liveçš„ç®€å†™ï¼Œæ˜¯å†³å®šã€Œæ•°æ®åŒ…ä¼ é€’è·ç¦»ã€çš„ä¸»è¦å› ç´ ã€‚TTL ç”¨æ•´æ•°è¡¨ç¤ºï¼Œå¹¶ä¸”æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨å°±å‡ä¸€ã€‚TTL å˜ä¸º 0 æ—¶ï¼Œè¯¥æ•°æ®åŒ…å°±æ— æ³•å†è¢«ä¼ é€’ï¼Œåªèƒ½é”€æ¯ã€‚å› æ­¤ï¼ŒTTL çš„å€¼è®¾ç½®è¿‡å¤§å°†å½±å“ç½‘ç»œæµé‡ã€‚å½“ç„¶ï¼Œè®¾ç½®è¿‡å°ï¼Œä¹Ÿæ— æ³•ä¼ é€’åˆ°ç›®æ ‡ã€‚</p>
<p><img src="https://i.loli.net/2019/01/27/5c4d3960001eb.png" alt="" /></p>
<p>æ¥ä¸‹æ¥æ˜¯ TTL çš„è®¾ç½®æ–¹æ³•ã€‚TTL æ˜¯å¯ä»¥é€šè¿‡ç¬¬ä¹ç« çš„å¥—æ¥å­—å¯é€‰é¡¹å®Œæˆçš„ã€‚ä¸è®¾ç½® TTL ç›¸å…³çš„åè®®å±‚ä¸º IPPROTO_IP ï¼Œé€‰é¡¹åä¸º IP_MULTICAST_TTLã€‚å› æ­¤ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹ä»£ç æŠŠ TTL è®¾ç½®ä¸º 64</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> send_sock;</span><br><span class="line"><span class="keyword">int</span> time_live = <span class="number">64</span>;</span><br><span class="line">...</span><br><span class="line">send_sock=socket(PF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">setsockopt(send_sock,IPPROTO_IP,IP_MULTICAST_TTL,(<span class="keyword">void</span>*)&amp;time_live,<span class="keyword">sizeof</span>(time_live);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>åŠ å…¥å¤šæ’­ç»„ä¹Ÿé€šè¿‡è®¾ç½®è®¾ç½®å¥—æ¥å­—å¯é€‰é¡¹æ¥å®Œæˆã€‚åŠ å…¥å¤šæ’­ç»„ç›¸å…³çš„åè®®å±‚ä¸º IPPROTO_IPï¼Œé€‰é¡¹åä¸º IP_ADD_MEMBERSHIP ã€‚å¯é€šè¿‡å¦‚ä¸‹ä»£ç åŠ å…¥å¤šæ’­ç»„ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> recv_sock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq</span> <span class="title">join_adr</span>;</span></span><br><span class="line">...</span><br><span class="line">recv_sock=socket(PF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">...</span><br><span class="line">join_adr.imr_multiaddr.s_addr=<span class="string">"å¤šæ’­ç»„åœ°å€ä¿¡æ¯"</span>;</span><br><span class="line">join_adr.imr_interface.s_addr=<span class="string">"åŠ å…¥å¤šæ’­ç»„çš„ä¸»æœºåœ°å€ä¿¡æ¯"</span>;</span><br><span class="line">setsockopt(recv_sock,IPPROTO_IP,IP_ADD_MEMBERSHIP,(<span class="keyword">void</span>*)&amp;join_adr,<span class="keyword">sizeof</span>(time_live);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ ip_mreq ç»“æ„ä½“çš„å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">imr_multiaddr</span>;</span> <span class="comment">//å†™å…¥åŠ å…¥ç»„çš„IPåœ°å€</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">imr_interface</span>;</span> <span class="comment">//åŠ å…¥è¯¥ç»„çš„å¥—æ¥å­—æ‰€å±ä¸»æœºçš„IPåœ°å€</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4>14.1.3 å®ç°å¤šæ’­ Sender å’Œ Receiver</h4>
<p>å¤šæ’­ä¸­ç”¨ã€Œå‘é€è€…ã€ï¼ˆä»¥ä¸‹ç§°ä¸º Senderï¼‰ å’Œã€Œæ¥æ”¶è€…ã€ï¼ˆä»¥ä¸‹ç§°ä¸º Receiverï¼‰æ›¿ä»£æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ã€‚é¡¾åæ€ä¹‰ï¼Œæ­¤å¤„çš„ Sender æ˜¯å¤šæ’­æ•°æ®çš„å‘é€ä¸»ä½“ï¼ŒReceiver æ˜¯éœ€è¦å¤šæ’­ç»„åŠ å…¥è¿‡ç¨‹çš„æ•°æ®æ¥æ”¶ä¸»ä½“ã€‚ä¸‹é¢æ˜¯ç¤ºä¾‹ï¼Œç¤ºä¾‹çš„è¿è¡Œåœºæ™¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>Sender : å‘ AAA ç»„å¹¿æ’­ï¼ˆBroadcastingï¼‰æ–‡ä»¶ä¸­ä¿å­˜çš„æ–°é—»ä¿¡æ¯</li>
<li>Receiver : æ¥æ”¶ä¼ é€’åˆ° AAA ç»„çš„æ–°é—»ä¿¡æ¯ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯ä¸¤ä¸ªä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch14/news_sender.c" target="_blank" rel="noopener">news_sender.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch14/news_receiver.c" target="_blank" rel="noopener">news_receiver.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc news_sender.c -o sender</span><br><span class="line">gcc news_receiver.c -o receiver</span><br><span class="line">.&#x2F;sender 224.1.1.2 9190</span><br><span class="line">.&#x2F;receiver 224.1.1.2 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/28/5c4e85a9aabcc.png" alt="" /></p>
<p>é€šè¿‡ç»“æœå¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ sender å¤šæ’­ä¿¡æ¯ï¼Œé€šè¿‡ receiver æ¥æ”¶å¹¿æ’­ï¼Œå¦‚æœå»¶è¿Ÿè¿è¡Œ receiver å°†æ— æ³•æ¥å—ä¹‹å‰å‘é€çš„ä¿¡æ¯ã€‚</p>
<h3>14.2 å¹¿æ’­</h3>
<p>å¹¿æ’­ï¼ˆBroadcastï¼‰åœ¨ã€Œä¸€æ¬¡æ€§å‘å¤šä¸ªä¸»æœºå‘é€æ•°æ®ã€è¿™ä¸€ç‚¹ä¸Šä¸å¤šæ’­ç±»ä¼¼ï¼Œä½†ä¼ è¾“æ•°æ®çš„èŒƒå›´æœ‰åŒºåˆ«ã€‚å¤šæ’­å³ä½¿åœ¨è·¨è¶Šä¸åŒç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œåªè¦åŠ å…¥å¤šæ’­ç»„å°±èƒ½æ¥å—æ•°æ®ã€‚ç›¸åï¼Œå¹¿æ’­åªèƒ½å‘åŒä¸€ç½‘ç»œä¸­çš„ä¸»æœºä¼ è¾“æ•°æ®ã€‚</p>
<h4>14.2.1 å¹¿æ’­çš„ç†è§£å’Œå®ç°æ–¹æ³•</h4>
<p>å¹¿æ’­æ˜¯å‘åŒä¸€ç½‘ç»œä¸­çš„æ‰€æœ‰ä¸»æœºä¼ è¾“æ•°æ®çš„æ–¹æ³•ã€‚ä¸å¤šæ’­ç›¸åŒï¼Œå¹¿æ’­ä¹Ÿæ˜¯é€šè¿‡ UDP æ¥å®Œæˆçš„ã€‚æ ¹æ®ä¼ è¾“æ•°æ®æ—¶ä½¿ç”¨çš„IPåœ°å€å½¢å¼ï¼Œå¹¿æ’­åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š</p>
<ul>
<li>ç›´æ¥å¹¿æ’­ï¼ˆDirected Broadcastï¼‰</li>
<li>æœ¬åœ°å¹¿æ’­ï¼ˆLocal Broadcastï¼‰</li>
</ul>
<p>äºŒè€…åœ¨å®ç°ä¸Šçš„å·®åˆ«ä¸»è¦åœ¨äºIPåœ°å€ã€‚ç›´æ¥å¹¿æ’­çš„IPåœ°å€ä¸­é™¤äº†ç½‘ç»œåœ°å€å¤–ï¼Œå…¶ä½™ä¸»æœºåœ°å€å…¨éƒ¨è®¾ç½®æˆ 1ã€‚ä¾‹å¦‚ï¼Œå¸Œæœ›å‘ç½‘ç»œåœ°å€ 192.12.34 ä¸­çš„æ‰€æœ‰ä¸»æœºä¼ è¾“æ•°æ®æ—¶ï¼Œå¯ä»¥å‘ 192.12.34.255 ä¼ è¾“ã€‚æ¢è¨€ä¹‹ï¼Œå¯ä»¥é‡‡å–ç›´æ¥å¹¿æ’­çš„æ–¹å¼å‘ç‰¹å®šåŒºåŸŸå†…æ‰€æœ‰ä¸»æœºä¼ è¾“æ•°æ®ã€‚</p>
<p>åä¹‹ï¼Œæœ¬åœ°å¹¿æ’­ä¸­ä½¿ç”¨çš„IPåœ°å€é™å®šä¸º 255.255.255.255 ã€‚ä¾‹å¦‚ï¼Œ192.32.24 ç½‘ç»œä¸­çš„ä¸»æœºå‘ 255.255.255.255 ä¼ è¾“æ•°æ®æ—¶ï¼Œæ•°æ®å°†ä¼ è¾“åˆ° 192.32.24 ç½‘ç»œä¸­æ‰€æœ‰ä¸»æœºã€‚</p>
<p><strong>æ•°æ®é€šä¿¡ä¸­ä½¿ç”¨çš„IPåœ°å€æ˜¯ä¸ UDP ç¤ºä¾‹çš„å”¯ä¸€åŒºåˆ«ã€‚é»˜è®¤ç”Ÿæˆçš„å¥—æ¥å­—ä¼šé˜»æ­¢å¹¿æ’­ï¼Œå› æ­¤ï¼Œåªéœ€é€šè¿‡å¦‚ä¸‹ä»£ç æ›´æ”¹é»˜è®¤è®¾ç½®ã€‚</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> send_sock;</span><br><span class="line"><span class="keyword">int</span> bcast;</span><br><span class="line">...</span><br><span class="line">send_sock=socket(PF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">...</span><br><span class="line">setsockopt(send_sock,SOL_SOCKET,SO_BROADCAST,(<span class="keyword">void</span>*)&amp;bcast,<span class="keyword">sizeof</span>(bcast));</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3>14.2.2 å®ç°å¹¿æ’­æ•°æ®çš„ Sender å’Œ Receiver</h3>
<p>ä¸‹é¢æ˜¯å¹¿æ’­æ•°æ®çš„ Sender å’Œ Receiverçš„ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch14/news_sender_brd.c" target="_blank" rel="noopener">news_sender_brd.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch14/news_receiver_brd.c" target="_blank" rel="noopener">news_receiver_brd.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc news_receiver_brd.c -o receiver</span><br><span class="line">gcc news_sender_brd.c -o sender</span><br><span class="line">.&#x2F;sender 255.255.255.255 9190</span><br><span class="line">.&#x2F;receiver 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/28/5c4e9113368dd.png" alt="" /></p>
<h3>14.3 åŸºäº Windows çš„å®ç°</h3>
<p>æš‚ç•¥</p>
<h3>14.4 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>TTL çš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿè¯·ä»è·¯ç”±å™¨çš„è§’åº¦è¯´æ˜è¾ƒå¤§çš„ TTL å€¼ä¸è¾ƒå°çš„ TTL å€¼ä¹‹é—´çš„åŒºåˆ«åŠé—®é¢˜ã€‚</strong></p>
<p>ç­”ï¼šTTL æ˜¯å†³å®šã€Œæ•°æ®åŒ…ä¼ é€’è·ç¦»ã€çš„ä¸»è¦å› ç´ ã€‚TTL æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨å°±å‡ä¸€ã€‚TTL å˜ä¸º 0 æ—¶ï¼Œæ•°æ®åŒ…å°±æ— æ³•å†è¢«ä¼ é€’ï¼Œåªèƒ½é”€æ¯ã€‚å› æ­¤ï¼ŒTTLè®¾ç½®è¿‡å¤§ä¼šå½±å“ç½‘ç»œæµé‡ã€‚å½“ç„¶ï¼Œè®¾ç½®è¿‡å°æ— æ³•ä¼ é€’åˆ°ç›®æ ‡ã€‚</p>
</li>
<li>
<p><strong>å¤šæ’­ä¸å¹¿æ’­çš„å¼‚åŒç‚¹æ˜¯ä»€ä¹ˆï¼Ÿè¯·ä»æ•°æ®é€šä¿¡çš„è§’åº¦è¿›è¡Œè¯´æ˜</strong>ã€‚</p>
<p>ç­”ï¼šåœ¨ã€Œä¸€æ¬¡æ€§å‘å¤šä¸ªä¸»æœºå‘é€æ•°æ®ã€è¿™ä¸€ç‚¹ä¸Šä¸å¤šæ’­ç±»ä¼¼ï¼Œä½†ä¼ è¾“çš„æ•°æ®èŒƒå›´æœ‰åŒºåˆ«ã€‚å¤šæ’­å³ä½¿åœ¨è·¨è¶Šä¸åŒç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œåªè¦åŠ å…¥å¤šæ’­ç»„å°±èƒ½æ¥å—æ•°æ®ã€‚ç›¸åï¼Œå¹¿æ’­åªèƒ½å‘åŒæ„ç½‘ç»œä¸­çš„ä¸»æœºä¼ è¾“æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>ä¸‹é¢å…³äºå¤šæ’­çš„è¯´æ³•æè¿°é”™è¯¯çš„æ˜¯</strong>ï¼Ÿ</p>
<p>ç­”ï¼šä»¥ä¸‹å†…å®¹åŠ ç²—çš„ä¸ºæè¿°æ­£ç¡®</p>
<ol>
<li>å¤šæ’­æ˜¯ç”¨æ¥åŠ å…¥å¤šæ’­ç»„çš„æ‰€æœ‰ä¸»æœºä¼ è¾“æ•°æ®çš„åè®®</li>
<li>ä¸»æœºè¿æ¥åˆ°åŒä¸€ç½‘ç»œæ‰èƒ½åŠ å…¥åˆ°å¤šæ’­ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šæ’­ç»„æ— æ³•è·¨è¶Šå¤šä¸ªç½‘ç»œ</li>
<li><strong>èƒ½å¤ŸåŠ å…¥å¤šæ’­ç»„çš„ä¸»æœºæ•°å¹¶æ— é™åˆ¶ï¼Œä½†åªèƒ½æœ‰ 1ä¸ªä¸»æœºï¼ˆSenderï¼‰å‘è¯¥ç»„å‘é€æ•°æ®</strong></li>
<li><strong>å¤šæ’­æ—¶ä½¿ç”¨çš„å¥—æ¥å­—æ˜¯ UDP å¥—æ¥å­—ï¼Œå› ä¸ºå¤šæ’­æ˜¯åŸºäº UDP è¿›è¡Œæ•°æ®é€šä¿¡çš„ã€‚</strong></li>
</ol>
</li>
<li>
<p><strong>å¤šæ’­ä¹Ÿå¯¹ç½‘ç»œæµé‡æœ‰åˆ©ï¼Œè¯·æ¯”è¾ƒ TCP äº¤æ¢æ–¹å¼è§£é‡Šå…¶åŸå› </strong></p>
<p>ç­”ï¼šTCP æ˜¯å¿…é¡»å»ºç«‹ä¸€å¯¹ä¸€çš„è¿æ¥ï¼Œå¦‚æœè¦å‘1000ä¸ªä¸»æœºå‘é€æ–‡ä»¶ï¼Œå°±å¾—ä¼ é€’1000æ¬¡ã€‚ä½†æ˜¯æ­¤æ—¶ç”¨å¤šæ’­æ–¹å¼ä¼ è¾“æ•°æ®ï¼Œå°±åªéœ€è¦å‘é€ä¸€æ¬¡ã€‚</p>
</li>
<li>
<p><strong>å¤šæ’­æ–¹å¼çš„æ•°æ®é€šä¿¡éœ€è¦ MBone è™šæ‹Ÿç½‘ç»œã€‚æ¢è¨€ä¹‹ï¼ŒMBone æ˜¯ç”¨äºå¤šæ’­çš„ç½‘ç»œï¼Œä½†å®ƒæ˜¯è™šæ‹Ÿç½‘ç»œã€‚è¯·è§£é‡Šæ­¤å¤„çš„ã€Œè™šæ‹Ÿç½‘ç»œã€</strong></p>
<p>ç­”ï¼šå¯ä»¥ç†è§£ä¸ºã€Œé€šè¿‡ç½‘ç»œä¸­çš„ç‰¹æ®Šåè®®å·¥ä½œçš„è½¯ä»¶æ¦‚å¿µä¸Šçš„ç½‘ç»œã€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ MBone å¹¶éå¯ä»¥è§¦åŠçš„ç‰©ç†ç½‘ç»œã€‚ä»–æ˜¯ä»¥ç‰©ç†ç½‘ç»œä¸ºåŸºç¡€ï¼Œé€šè¿‡è½¯ä»¶æ–¹æ³•å®ç°çš„å¤šæ’­é€šä¿¡å¿…å¤‡è™šæ‹Ÿç½‘ç»œã€‚</p>
</li>
</ol>
<h2>ç¬¬ 15 ç«  å¥—æ¥å­—å’Œæ ‡å‡†I/O</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>15.1 æ ‡å‡† I/O çš„ä¼˜ç‚¹</h3>
<h4>15.1.1 æ ‡å‡† I/O å‡½æ•°çš„ä¸¤ä¸ªä¼˜ç‚¹</h4>
<p>ä¸‹é¢æ˜¯æ ‡å‡† I/O å‡½æ•°çš„ä¸¤ä¸ªä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ ‡å‡† I/O å‡½æ•°å…·æœ‰è‰¯å¥½çš„ç§»æ¤æ€§</li>
<li>æ ‡å‡† I/O å‡½æ•°å¯ä»¥åˆ©ç”¨ç¼“å†²æé«˜æ€§èƒ½</li>
</ul>
<p>åˆ›å»ºå¥—æ¥å­—æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå‡†å¤‡ I/O ç¼“å†²ã€‚æ­¤ç¼“å†²åœ¨æ‰§è¡Œ TCP åè®®æ—¶å‘æŒ¥ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚æ­¤æ—¶è‹¥ä½¿ç”¨æ ‡å‡† I/O å‡½æ•°ï¼Œå°†å¾—åˆ°é¢å¤–çš„ç¼“å†²æ”¯æŒã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/01/29/5c500e53ad9aa.png" alt="" /></p>
<p>å‡è®¾ä½¿ç”¨ fputs å‡½æ•°è¿›è¡Œä¼ è¾“å­—ç¬¦ä¸² ã€ŒHelloã€æ—¶ï¼Œé¦–å…ˆå°†æ•°æ®ä¼ é€’åˆ°æ ‡å‡† I/O ç¼“å†²ï¼Œç„¶åå°†æ•°æ®ç§»åŠ¨åˆ°å¥—æ¥å­—è¾“å‡ºç¼“å†²ï¼Œæœ€åå°†å­—ç¬¦ä¸²å‘é€åˆ°å¯¹æ–¹ä¸»æœºã€‚</p>
<p>è®¾ç½®ç¼“å†²çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ã€‚ä»ä»¥ä¸‹ä¸¤ç‚¹å¯ä»¥è¯´æ˜æ€§èƒ½çš„æé«˜ï¼š</p>
<ul>
<li>ä¼ è¾“çš„æ•°æ®é‡</li>
<li>æ•°æ®å‘è¾“å‡ºç¼“å†²ç§»åŠ¨çš„æ¬¡æ•°ã€‚</li>
</ul>
<p>æ¯”è¾ƒ 1 ä¸ªå­—èŠ‚çš„æ•°æ®å‘é€ 10 æ¬¡çš„æƒ…å†µå’Œ 10 ä¸ªæ•°æ®åŒ…å‘é€ 1 æ¬¡çš„æƒ…å†µã€‚å‘é€æ•°æ®æ—¶ï¼Œæ•°æ®åŒ…ä¸­å«æœ‰å¤´ä¿¡æ¯ã€‚å¤´ä¿¡ä¸æ•°æ®å¤§å°æ— å…³ï¼Œæ˜¯æŒ‰ç…§ä¸€å®šçš„æ ¼å¼å¡«å…¥çš„ã€‚å‡è®¾å¤´ä¿¡æ¯å  40 ä¸ªå­—èŠ‚ï¼Œéœ€è¦ä¼ è¾“çš„æ•°æ®é‡ä¹Ÿå­˜åœ¨è¾ƒå¤§åŒºåˆ«ï¼š</p>
<ul>
<li>1 ä¸ªå­—èŠ‚ 10 æ¬¡ï¼š40*10=400 å­—èŠ‚</li>
<li>10ä¸ªå­—èŠ‚ 1 æ¬¡ï¼š40*1=40 å­—èŠ‚ã€‚</li>
</ul>
<h4>15.1.2 æ ‡å‡† I/O å‡½æ•°å’Œç³»ç»Ÿå‡½æ•°ä¹‹é—´çš„æ€§èƒ½å¯¹æ¯”</h4>
<p>ä¸‹é¢æ˜¯åˆ©ç”¨ç³»ç»Ÿå‡½æ•°çš„ç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch15/syscpy.c" target="_blank" rel="noopener">syscpy.c</a></li>
</ul>
<p>ä¸‹é¢æ˜¯ä½¿ç”¨æ ‡å‡† I/O å‡½æ•°å¤åˆ¶æ–‡ä»¶</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch15/stdcpy.c" target="_blank" rel="noopener">stdcpy.c</a></li>
</ul>
<p>å¯¹äºä»¥ä¸Šä¸¤ä¸ªä»£ç è¿›è¡Œæµ‹è¯•ï¼Œæ˜æ˜¾åŸºäºæ ‡å‡† I/O å‡½æ•°çš„ä»£ç è·‘çš„æ›´å¿«</p>
<h4>15.1.3 æ ‡å‡† I/O å‡½æ•°çš„å‡ ä¸ªç¼ºç‚¹</h4>
<p>æ ‡å‡† I/O å‡½æ•°å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¸å®¹æ˜“è¿›è¡ŒåŒå‘é€šä¿¡</li>
<li>æœ‰æ—¶å¯èƒ½é¢‘ç¹è°ƒç”¨ fflush å‡½æ•°</li>
<li>éœ€è¦ä»¥ FILE ç»“æ„ä½“æŒ‡é’ˆçš„å½¢å¼è¿”å›æ–‡ä»¶æè¿°ç¬¦ã€‚</li>
</ul>
<h3>15.2 ä½¿ç”¨æ ‡å‡† I/O å‡½æ•°</h3>
<h4>15.2.1 åˆ©ç”¨ fdopen å‡½æ•°è½¬æ¢ä¸º FILE ç»“æ„ä½“æŒ‡é’ˆ</h4>
<p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function">FILE *<span class="title">fdopen</span><span class="params">(<span class="keyword">int</span> fildes, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›è½¬æ¢çš„ FILE ç»“æ„ä½“æŒ‡é’ˆï¼Œå¤±è´¥æ—¶è¿”å› NULL</span></span><br><span class="line"><span class="comment">fildes ï¼š éœ€è¦è½¬æ¢çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">mode ï¼š å°†è¦åˆ›å»ºçš„ FILE ç»“æ„ä½“æŒ‡é’ˆçš„æ¨¡å¼ä¿¡æ¯</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸‹ä¸ºç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch15/desto.c" target="_blank" rel="noopener">desto.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"data.dat"</span>, O_WRONLY | O_CREAT | O_TRUNC); <span class="comment">//åˆ›å»ºæ–‡ä»¶å¹¶è¿”å›æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"file open error"</span>, <span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fd = fdopen(fd, <span class="string">"w"</span>); <span class="comment">//è¿”å› å†™ æ¨¡å¼çš„ FILE æŒ‡é’ˆ</span></span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">"NetWork C programming \n"</span>, fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc desto.c -o desto</span><br><span class="line">.&#x2F;desto</span><br><span class="line">cat data.dat</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/29/5c5018ff07b29.png" alt="" /></p>
<p>æ–‡ä»¶æè¿°ç¬¦è½¬æ¢ä¸º FILE æŒ‡é’ˆï¼Œå¹¶å¯ä»¥é€šè¿‡è¯¥æŒ‡é’ˆè°ƒç”¨æ ‡å‡† I/O å‡½æ•°ã€‚</p>
<h4>15.2.2 åˆ©ç”¨ fileno å‡½æ•°è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦</h4>
<p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fileno</span><span class="params">(FILE *stream)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch15/todes.c" target="_blank" rel="noopener">todes.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"data.dat"</span>, O_WRONLY | O_CREAT | O_TRUNC);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"file open error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"First file descriptor : %d \n"</span>, fd);</span><br><span class="line">    fp = fdopen(fd, <span class="string">"w"</span>); <span class="comment">//è½¬æˆ file æŒ‡é’ˆ</span></span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">"TCP/IP SOCKET PROGRAMMING \n"</span>, fp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Second file descriptor: %d \n"</span>, fileno(fp)); <span class="comment">//è½¬å›æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>15.3 åŸºäºå¥—æ¥å­—çš„æ ‡å‡† I/O å‡½æ•°ä½¿ç”¨</h3>
<p>æŠŠç¬¬å››ç« çš„å›å£°å®¢æˆ·ç«¯å’Œå›å£°æœåŠ¡ç«¯çš„å†…å®¹æ”¹ä¸ºåŸºäºæ ‡å‡† I/O å‡½æ•°çš„æ•°æ®äº¤æ¢å½¢å¼ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch15/echo_client.c" target="_blank" rel="noopener">echo_client.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch15/echo_stdserv.c" target="_blank" rel="noopener">echo_stdserv.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_client.c -o eclient</span><br><span class="line">gcc echo_stdserv.c -o eserver</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/29/5c502001581bc.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œè¿è¡Œç»“æœå’Œç¬¬å››ç« ç›¸åŒï¼Œè¿™æ˜¯åˆ©ç”¨æ ‡å‡† I/O å®ç°çš„ã€‚</p>
<h3>15.4 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>è¯·è¯´æ˜æ ‡å‡† I/O çš„ 2 ä¸ªä¼˜ç‚¹ã€‚ä»–ä¸ºä½•æ‹¥æœ‰è¿™ 2 ä¸ªä¼˜ç‚¹ï¼Ÿ</strong></p>
<p>ç­”ï¼šâ‘ å…·æœ‰å¾ˆé«˜çš„ç§»æ¤æ€§â‘¡æœ‰è‰¯å¥½çš„ç¼“å†²æé«˜æ€§èƒ½ã€‚å› ä¸ºè¿™äº›å‡½æ•°æ˜¯ç”± ANSI C æ ‡å‡†å®šä¹‰çš„ã€‚é€‚åˆæ‰€æœ‰ç¼–ç¨‹é¢†åŸŸã€‚</p>
</li>
<li>
<p><strong>åˆ©ç”¨æ ‡å‡† I/O å‡½æ•°ä¼ è¾“æ•°æ®æ—¶ï¼Œä¸‹é¢çš„è¯´æ³•æ˜¯é”™è¯¯çš„</strong>ï¼š</p>
<blockquote>
<p>è°ƒç”¨ fputs å‡½æ•°ä¼ è¾“æ•°æ®æ—¶ï¼Œè°ƒç”¨ååº”ç«‹å³å¼€å§‹å‘é€ï¼</p>
</blockquote>
<p><strong>ä¸ºä½•ä¸Šè¿°è¯´æ³•æ˜¯é”™è¯¯çš„ï¼Ÿä¸ºè¾¾åˆ°è¿™ç§æ•ˆæœåº”è¯¥æ·»åŠ å“ªäº›å¤„ç†è¿‡ç¨‹ï¼Ÿ</strong></p>
<p>ç­”ï¼šåªæ˜¯ä¼ è¾“åˆ°äº†ç¼“å†²ä¸­ï¼Œåº”è¯¥åˆ©ç”¨ fflush æ¥åˆ·æ–°ç¼“å†²åŒºã€‚</p>
</li>
</ol>
<h2>ç¬¬ 16 ç«  å…³äº I/O æµåˆ†ç¦»çš„å…¶ä»–å†…å®¹</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>16.1 åˆ†ç¦» I/O æµ</h3>
<p>ã€Œåˆ†ç¦» I/O æµã€æ˜¯ä¸€ç§å¸¸ç”¨è¡¨è¾¾ã€‚æœ‰ I/O å·¥å…·å¯åŒºåˆ†äºŒè€…ï¼Œæ— è®ºé‡‡ç”¨å“ªç§æ–¹æ³•ï¼Œéƒ½å¯ä»¥è®¤ä¸ºæ˜¯åˆ†ç¦»äº† I/O æµã€‚</p>
<h4>16.1.1 2æ¬¡  I/O æµåˆ†ç¦»</h4>
<p>ä¹‹å‰æœ‰ä¸¤ç§åˆ†ç¦»æ–¹æ³•ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§æ˜¯ç¬¬ 10 ç« çš„ã€ŒTCP I/O è¿‡ç¨‹ã€åˆ†ç¦»ã€‚é€šè¿‡è°ƒç”¨ fork å‡½æ•°å¤åˆ¶å‡ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä»¥åŒºåˆ†è¾“å…¥å’Œè¾“å‡ºä¸­ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è™½ç„¶æ–‡ä»¶æè¿°ç¬¦æœ¬èº«ä¸ä¼šæ ¹æ®è¾“å…¥å’Œè¾“å‡ºè¿›è¡ŒåŒºåˆ†ï¼Œä½†æˆ‘ä»¬åˆ†å¼€äº† 2 ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„ç”¨é€”ï¼Œå› æ­¤ï¼Œè¿™ä¹Ÿå±äºã€Œæµã€çš„åˆ†ç¦»ã€‚</li>
<li>ç¬¬äºŒç§åˆ†ç¦»æ˜¯åœ¨ç¬¬ 15 ç« ã€‚é€šè¿‡ 2 æ¬¡ fdopen å‡½æ•°çš„è°ƒç”¨ï¼Œåˆ›å»ºè¯»æ¨¡å¼ FILE æŒ‡é’ˆï¼ˆFILE ç»“æ„ä½“æŒ‡é’ˆï¼‰å’Œå†™æ¨¡å¼ FILE æŒ‡é’ˆã€‚æ¢è¨€ä¹‹ï¼Œæˆ‘ä»¬åˆ†ç¦»äº†è¾“å…¥å·¥å…·å’Œè¾“å‡ºå·¥å…·ï¼Œå› æ­¤ä¹Ÿå¯è§†ä¸ºã€Œæµã€çš„åˆ†ç¦»ã€‚ä¸‹é¢æ˜¯åˆ†ç¦»çš„ç†ç”±ã€‚</li>
</ul>
<h4>16.1.2 åˆ†ç¦»ã€Œæµã€çš„å¥½å¤„</h4>
<p>é¦–å…ˆæ˜¯ç¬¬ 10 ç« ã€Œæµã€çš„åˆ†ç¦»ç›®çš„ï¼š</p>
<ul>
<li>é€šè¿‡åˆ†å¼€è¾“å…¥è¿‡ç¨‹ï¼ˆä»£ç ï¼‰å’Œè¾“å‡ºè¿‡ç¨‹é™ä½å®ç°éš¾åº¦</li>
<li>ä¸è¾“å…¥æ— å…³çš„è¾“å‡ºæ“ä½œå¯ä»¥æé«˜é€Ÿåº¦</li>
</ul>
<p>ä¸‹é¢æ˜¯ç¬¬ 15 ç« ã€Œæµã€åˆ†ç¦»çš„ç›®çš„ï¼š</p>
<ul>
<li>ä¸ºäº†å°† FILE æŒ‡é’ˆæŒ‰è¯»æ¨¡å¼å’Œå†™æ¨¡å¼åŠ ä»¥åŒºåˆ†</li>
<li>å¯ä»¥é€šè¿‡åŒºåˆ†è¯»å†™æ¨¡å¼é™ä½å®ç°éš¾åº¦</li>
<li>é€šè¿‡åŒºåˆ† I/O ç¼“å†²æé«˜ç¼“å†²æ€§èƒ½</li>
</ul>
<h4>16.1.3 ã€Œæµã€åˆ†ç¦»å¸¦æ¥çš„ EOF é—®é¢˜</h4>
<p>ç¬¬ 7 ç« ä»‹ç»è¿‡ EOF çš„ä¼ é€’æ–¹æ³•å’ŒåŠå…³é—­çš„å¿…è¦æ€§ã€‚æœ‰ä¸€ä¸ªè¯­å¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">shutdown</span>(sock,SHUT_WR);</span><br></pre></td></tr></table></figure>
<p>å½“æ—¶è¯´è¿‡è°ƒç”¨ shutdown å‡½æ•°çš„åŸºäºåŠå…³é—­çš„ EOF ä¼ é€’æ–¹æ³•ã€‚ç¬¬åç« çš„ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch10/echo_mpclient.c" target="_blank" rel="noopener">echo_mpclient.c</a> æ·»åŠ äº†åŠå…³é—­çš„ç›¸å…³ä»£ç ã€‚ä½†æ˜¯è¿˜æ²¡æœ‰è®²é‡‡ç”¨ fdopen å‡½æ•°æ€ä¹ˆåŠå…³é—­ã€‚é‚£ä¹ˆæ˜¯å¦æ˜¯é€šè¿‡ fclose å‡½æ•°å…³é—­æµå‘¢ï¼Ÿæˆ‘ä»¬å…ˆè¯•è¯•</p>
<p>ä¸‹é¢æ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch16/sep_clnt.c" target="_blank" rel="noopener">sep_clnt.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch16/sep_serv.c" target="_blank" rel="noopener">sep_serv.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc sep_clnt.c -o clnt</span><br><span class="line">gcc sep_serv.c -o serv</span><br><span class="line">./serv 9190</span><br><span class="line">./clnt 127.0.0.1 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/30/5c512086a75d9.png" alt="" /></p>
<p>ä»è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯æœ€ç»ˆæ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯ã€‚é‚£ä¹ˆè¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ</p>
<p>åŸå› æ˜¯ï¼šæœåŠ¡ç«¯ä»£ç çš„ <code>fclose(writefp);</code> è¿™ä¸€å¥ï¼Œå®Œå…¨å…³é—­äº†å¥—æ¥å­—è€Œä¸æ˜¯åŠå…³é—­ã€‚è¿™æ‰æ˜¯è¿™ä¸€ç« éœ€è¦è§£å†³çš„é—®é¢˜ã€‚</p>
<h3>16.2 æ–‡ä»¶æè¿°ç¬¦çš„çš„å¤åˆ¶å’ŒåŠå…³é—­</h3>
<h4>16.2.1 ç»ˆæ­¢ã€Œæµã€æ—¶æ— æ³•åŠå…³é—­åŸå› </h4>
<p>ä¸‹é¢çš„å›¾æè¿°çš„æ˜¯æœåŠ¡ç«¯ä»£ç ä¸­çš„ä¸¤ä¸ªFILE æŒ‡é’ˆã€æ–‡ä»¶æè¿°ç¬¦å’Œå¥—æ¥å­—ä¸­çš„å…³ç³»ã€‚</p>
<p><img src="https://i.loli.net/2019/01/30/5c5121da89955.png" alt="" /></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªæŒ‡é’ˆéƒ½æ˜¯åŸºäºåŒä¸€æ–‡ä»¶æè¿°ç¬¦åˆ›å»ºçš„ã€‚å› æ­¤ï¼Œé’ˆå¯¹äºä»»ä½•ä¸€ä¸ª FILE æŒ‡é’ˆè°ƒç”¨ fclose å‡½æ•°éƒ½ä¼šå…³é—­æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/30/5c51224051802.png" alt="" /></p>
<p>ä»å›¾ä¸­çœ‹åˆ°ï¼Œé”€æ¯å¥—æ¥å­—æ—¶å†ä¹Ÿæ— æ³•è¿›è¡Œæ•°æ®äº¤æ¢ã€‚é‚£å¦‚ä½•è¿›å…¥å¯ä»¥è¿›å…¥ä½†æ˜¯æ— æ³•è¾“å‡ºçš„åŠå…³é—­çŠ¶æ€å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/30/5c5122a45c5f1.png" alt="" /></p>
<p>åªéœ€è¦åˆ›å»º FILE æŒ‡é’ˆå‰å…ˆå¤åˆ¶æ–‡ä»¶æè¿°ç¬¦å³å¯ã€‚å¤åˆ¶åå¦å¤–åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶ååˆ©ç”¨å„è‡ªçš„æ–‡ä»¶æè¿°ç¬¦ç”Ÿæˆè¯»æ¨¡å¼çš„ FILE æŒ‡é’ˆå’Œå†™æ¨¡å¼çš„ FILE æŒ‡é’ˆã€‚è¿™å°±ä¸ºåŠå…³é—­åˆ›é€ å¥½äº†ç¯å¢ƒï¼Œå› ä¸ºå¥—æ¥å­—å’Œæ–‡ä»¶æè¿°ç¬¦å…·æœ‰å¦‚ä¸‹å…³ç³»ï¼š</p>
<blockquote>
<p>é”€æ¯æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦å€™æ‰èƒ½é”€æ¯å¥—æ¥å­—</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé’ˆå¯¹å†™æ¨¡å¼ FILE æŒ‡é’ˆè°ƒç”¨ fclose å‡½æ•°æ—¶ï¼Œåªèƒ½é”€æ¯ä¸è¯¥ FILE æŒ‡é’ˆç›¸å…³çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ— æ³•é”€æ¯å¥—æ¥å­—ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/01/30/5c5123ad7df31.png" alt="" /></p>
<p>é‚£ä¹ˆè°ƒç”¨ fclose å‡½æ•°å€™è¿˜å‰©ä¸‹ 1 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤æ²¡æœ‰é”€æ¯å¥—æ¥å­—ã€‚é‚£æ­¤æ—¶çš„çŠ¶æ€æ˜¯å¦ä¸ºåŠå…³é—­çŠ¶æ€ï¼Ÿä¸æ˜¯ï¼åªæ˜¯å‡†å¤‡å¥½äº†è¿›å…¥åŠå…³é—­çŠ¶æ€ï¼Œè€Œä¸æ˜¯å·²ç»è¿›å…¥äº†åŠå…³é—­çŠ¶æ€ã€‚ä»”ç»†è§‚å¯Ÿï¼Œè¿˜å‰©ä¸‹ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚è€Œè¯¥æ–‡ä»¶æè¿°ç¬¦å¯ä»¥åŒæ—¶è¿›è¡Œ I/O ã€‚å› æ­¤ï¼Œä¸ä½†æ²¡æœ‰å‘é€ EOF ï¼Œè€Œä¸”ä»ç„¶å¯ä»¥åˆ©ç”¨æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œè¾“å‡ºã€‚</p>
<h4>16.2.2 å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦</h4>
<p>ä¸è°ƒç”¨ fork å‡½æ•°ä¸åŒï¼Œè°ƒç”¨ fork å‡½æ•°å°†å¤åˆ¶æ•´ä¸ªè¿›ç¨‹ï¼Œæ­¤å¤„è®¨è®ºçš„æ˜¯åŒä¸€è¿›ç¨‹å†…å®Œæˆå¯¹å®Œæˆæè¿°ç¬¦çš„å¤åˆ¶ã€‚å¦‚å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/01/30/5c512579c45b6.png" alt="" /></p>
<p>å¤åˆ¶å®Œæˆåï¼Œä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦éƒ½å¯ä»¥è®¿é—®æ–‡ä»¶ï¼Œä½†æ˜¯ç¼–å·ä¸åŒã€‚</p>
<h4>16.2.3 dup å’Œ dup2</h4>
<p>ä¸‹é¢ç»™å‡ºä¸¤ä¸ªå‡½æ•°åŸå‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dup</span><span class="params">(<span class="keyword">int</span> fildes)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dup2</span><span class="params">(<span class="keyword">int</span> fildes, <span class="keyword">int</span> fildes2)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">fildes : éœ€è¦å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">fildes2 : æ˜ç¡®æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦çš„æ•´æ•°å€¼ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>dup2 å‡½æ•°æ˜ç¡®æŒ‡å®šå¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•´æ•°å€¼ã€‚å‘å…¶ä¼ é€’å¤§äº 0 ä¸”å°äºè¿›ç¨‹èƒ½ç”Ÿæˆçš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å€¼æ—¶ï¼Œè¯¥å€¼å°†æˆä¸ºå¤åˆ¶å‡ºçš„æ–‡ä»¶æè¿°ç¬¦å€¼ã€‚ä¸‹é¢æ˜¯ä»£ç ç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch16/dup.c" target="_blank" rel="noopener">dup.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cfd1, cfd2;</span><br><span class="line">    <span class="keyword">char</span> str1[] = <span class="string">"Hi~ \n"</span>;</span><br><span class="line">    <span class="keyword">char</span> str2[] = <span class="string">"It's nice day~ \n"</span>;</span><br><span class="line"></span><br><span class="line">    cfd1 = dup(<span class="number">1</span>);        <span class="comment">//å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ 1</span></span><br><span class="line">    cfd2 = dup2(cfd1, <span class="number">7</span>); <span class="comment">//å†æ¬¡å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦,å®šä¸ºæ•°å€¼ 7</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"fd1=%d , fd2=%d \n"</span>, cfd1, cfd2);</span><br><span class="line">    <span class="built_in">write</span>(cfd1, str1, <span class="keyword">sizeof</span>(str1));</span><br><span class="line">    <span class="built_in">write</span>(cfd2, str2, <span class="keyword">sizeof</span>(str2));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(cfd1);</span><br><span class="line">    <span class="built_in">close</span>(cfd2); <span class="comment">//ç»ˆæ­¢å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯ä»æœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>, str1, <span class="keyword">sizeof</span>(str1));</span><br><span class="line">    <span class="built_in">close</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>, str2, <span class="keyword">sizeof</span>(str2)); <span class="comment">//æ— æ³•å®Œæˆè¾“å‡º</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc dup.c -o dup</span><br><span class="line">.&#x2F;dup</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/01/30/5c5135574d89a.png" alt="" /></p>
<h4>16.2.4 å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦åã€Œæµã€çš„åˆ†ç¦»</h4>
<p>ä¸‹é¢æ›´æ”¹ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch16/sep_clnt.c" target="_blank" rel="noopener">sep_clnt.c</a> å’Œ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch16/sep_serv.c" target="_blank" rel="noopener">sep_serv.c</a> å¯ä»¥ä½¿å¾—è®©å®ƒæ­£å¸¸å·¥ä½œï¼Œæ­£å¸¸å·¥ä½œæ˜¯æŒ‡é€šè¿‡æœåŠ¡å™¨çš„åŠå…³é—­çŠ¶æ€æ¥æ”¶å®¢æˆ·ç«¯æœ€åå‘é€çš„å­—ç¬¦ä¸²ã€‚</p>
<p>ä¸‹é¢æ˜¯ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch16/sep_serv2.c" target="_blank" rel="noopener">sep_serv2.c</a></li>
</ul>
<p>è¿™ä¸ªä»£ç å¯ä»¥ä¸ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch16/sep_clnt.c" target="_blank" rel="noopener">sep_clnt.c</a> é…åˆèµ·æ¥é£Ÿç”¨ï¼Œç¼–è¯‘è¿‡ç¨‹å’Œä¸Šé¢ä¸€æ ·ï¼Œè¿è¡Œç»“æœä¸ºï¼š</p>
<p><img src="https://i.loli.net/2019/01/30/5c513d54a27e0.png" alt="" /></p>
<h3>16.3 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>ä¸‹åˆ—å…³äº FILE ç»“æ„ä½“æŒ‡é’ˆå’Œæ–‡ä»¶æè¿°ç¬¦çš„è¯´æ³•é”™è¯¯çš„æ˜¯</strong>ï¼Ÿ</p>
<p>ç­”ï¼šä»¥ä¸‹åŠ ç²—å†…å®¹ä»£è¡¨è¯´æ³•æ­£ç¡®ã€‚</p>
<ol>
<li>ä¸ FILE ç»“æ„ä½“æŒ‡é’ˆç›¸åŒï¼Œæ–‡ä»¶æè¿°ç¬¦ä¹Ÿåˆ†è¾“å…¥æè¿°ç¬¦å’Œè¾“å‡ºæè¿°ç¬¦</li>
<li>å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦æ—¶å°†ç”Ÿæˆç›¸åŒå€¼çš„æè¿°ç¬¦ï¼Œå¯ä»¥é€šè¿‡è¿™ 2 ä¸ªæè¿°ç¬¦è¿›è¡Œ I/O</li>
<li><strong>å¯ä»¥åˆ©ç”¨åˆ›å»ºå¥—æ¥å­—æ—¶è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œ I/O ï¼Œä¹Ÿå¯ä»¥ä¸é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ï¼Œç›´æ¥é€šè¿‡ FILE ç»“æ„ä½“æŒ‡é’ˆå®Œæˆ</strong></li>
<li><strong>å¯ä»¥ä»æ–‡ä»¶æè¿°ç¬¦ç”Ÿæˆ FILE ç»“æ„ä½“æŒ‡é’ˆï¼Œè€Œä¸”å¯ä»¥åˆ©ç”¨è¿™ç§ FILE ç»“æ„ä½“æŒ‡é’ˆè¿›è¡Œå¥—æ¥å­— I/O</strong></li>
<li>è‹¥æ–‡ä»¶æè¿°ç¬¦ä¸ºè¯»æ¨¡å¼ï¼Œåˆ™åŸºäºè¯¥æè¿°ç¬¦ç”Ÿæˆçš„ FILE ç»“æ„ä½“æŒ‡é’ˆåŒæ ·æ˜¯è¯»æ¨¡å¼ï¼›è‹¥æ–‡ä»¶æè¿°ç¬¦ä¸ºå†™æ¨¡å¼ï¼Œåˆ™åŸºäºè¯¥æè¿°ç¬¦ç”Ÿæˆçš„ FILE ç»“æ„ä½“æŒ‡é’ˆåŒæ ·æ˜¯å†™æ¨¡å¼</li>
</ol>
</li>
<li>
<p><strong>EOF çš„å‘é€ç›¸å…³æè¿°ä¸­é”™è¯¯çš„æ˜¯</strong>ï¼Ÿ</p>
<p>ç­”ï¼šä»¥ä¸‹åŠ ç²—å†…å®¹ä»£è¡¨è¯´æ³•æ­£ç¡®ã€‚</p>
<ol>
<li>ç»ˆæ­¢æ–‡ä»¶æè¿°ç¬¦æ—¶å‘é€ EOF</li>
<li><strong>å³ä½¿æœªå®Œæˆç»ˆæ­¢æ–‡ä»¶æè¿°ç¬¦ï¼Œå…³é—­è¾“å‡ºæµæ—¶ä¹Ÿä¼šå‘é€ EOF</strong></li>
<li>å¦‚æœå¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ™åŒ…æ‹¬å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦åœ¨å†…ï¼Œæ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦éƒ½ç»ˆæ­¢æ—¶æ‰ä¼šå‘é€ EOF</li>
<li><strong>å³ä½¿å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ shutdown å‡½æ•°è¿›å…¥åŠå…³é—­çŠ¶æ€å¹¶å‘é€ EOF</strong></li>
</ol>
</li>
</ol>
<h2>ç¬¬ 17 ç«  ä¼˜äº select çš„ epoll</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>17.1 epoll ç†è§£åŠåº”ç”¨</h3>
<p>select å¤ç”¨æ–¹æ³•ç”±æ¥å·²ä¹…ï¼Œå› æ­¤ï¼Œåˆ©ç”¨è¯¥æŠ€æœ¯åï¼Œæ— è®ºå¦‚ä½•ä¼˜åŒ–ç¨‹åºæ€§èƒ½ä¹Ÿæ— æ³•åŒæ—¶ä»‹å…¥ä¸Šç™¾ä¸ªå®¢æˆ·ç«¯ã€‚è¿™ç§ select æ–¹å¼å¹¶ä¸é€‚åˆä»¥ web æœåŠ¡å™¨ç«¯å¼€å‘ä¸ºä¸»æµçš„ç°ä»£å¼€å‘ç¯å¢ƒï¼Œæ‰€ä»¥éœ€è¦å­¦ä¹  Linux ç¯å¢ƒä¸‹çš„ epoll</p>
<h4>17.1.1 åŸºäº select çš„ I/O å¤ç”¨æŠ€æœ¯é€Ÿåº¦æ…¢çš„åŸå› </h4>
<p>ç¬¬ 12 ç« å®ç°äº†åŸºäº select çš„ I/O å¤ç”¨æŠ€æœ¯æœåŠ¡ç«¯ï¼Œå…¶ä¸­æœ‰ä¸åˆç†çš„è®¾è®¡å¦‚ä¸‹ï¼š</p>
<ul>
<li>è°ƒç”¨ select å‡½æ•°åå¸¸è§çš„é’ˆå¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„å¾ªç¯è¯­å¥</li>
<li>æ¯æ¬¡è°ƒç”¨ select å‡½æ•°æ—¶éƒ½éœ€è¦å‘è¯¥å‡½æ•°ä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯</li>
</ul>
<p>ä¸Šè¿°ä¸¤ç‚¹å¯ä»¥ä» <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch12/echo_selectserv.c" target="_blank" rel="noopener">echo_selectserv.c</a> å¾—åˆ°ç¡®è®¤ï¼Œè°ƒç”¨ select å‡½æ•°åï¼Œå¹¶ä¸æ˜¯æŠŠå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦å•ç‹¬é›†ä¸­åœ¨ä¸€èµ·ï¼Œè€Œæ˜¯é€šè¿‡ä½œä¸ºç›‘è§†å¯¹è±¡çš„ fd_set å˜é‡çš„å˜åŒ–ï¼Œæ‰¾å‡ºå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆ54,56è¡Œï¼‰ï¼Œå› æ­¤æ— æ³•é¿å…é’ˆå¯¹æ‰€æœ‰ç›‘è§†å¯¹è±¡çš„å¾ªç¯è¯­å¥ã€‚è€Œä¸”ï¼Œä½œä¸ºç›‘è§†å¯¹è±¡çš„ fd_set ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥è°ƒç”¨ select å‡½æ•°å‰åº”è¯¥å¤åˆ¶å¹¶ä¿å­˜åŸæœ‰ä¿¡æ¯ï¼Œå¹¶åœ¨æ¯æ¬¡è°ƒç”¨ select å‡½æ•°æ—¶ä¼ é€’æ–°çš„ç›‘è§†å¯¹è±¡ä¿¡æ¯ã€‚</p>
<p>select æ€§èƒ½ä¸Šæœ€å¤§çš„å¼±ç‚¹æ˜¯ï¼šæ¯æ¬¡ä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯ï¼Œå‡†ç¡®çš„è¯´ï¼Œselect æ˜¯ç›‘è§†å¥—æ¥å­—å˜åŒ–çš„å‡½æ•°ã€‚è€Œå¥—æ¥å­—æ˜¯æ“ä½œç³»ç»Ÿç®¡ç†çš„ï¼Œæ‰€ä»¥ select å‡½æ•°è¦å€ŸåŠ©æ“ä½œç³»ç»Ÿæ‰èƒ½å®ŒæˆåŠŸèƒ½ã€‚select å‡½æ•°çš„è¿™ä¸€ç¼ºç‚¹å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å¼¥è¡¥ï¼š</p>
<blockquote>
<p>ä»…å‘æ“ä½œç³»ç»Ÿä¼ é€’ä¸€æ¬¡ç›‘è§†å¯¹è±¡ï¼Œç›‘è§†èŒƒå›´æˆ–å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶åªé€šçŸ¥å‘ç”Ÿå˜åŒ–çš„äº‹é¡¹</p>
</blockquote>
<p>è¿™æ ·å°±æ— éœ€æ¯æ¬¡è°ƒç”¨ select å‡½æ•°æ—¶éƒ½æƒ³æ“ä½œç³»ç»Ÿä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯ï¼Œä½†æ˜¯å‰ææ“ä½œç³»ç»Ÿæ”¯æŒè¿™ç§å¤„ç†æ–¹å¼ã€‚Linux çš„æ”¯æŒæ–¹å¼æ˜¯ epoll ï¼ŒWindows çš„æ”¯æŒæ–¹å¼æ˜¯ IOCPã€‚</p>
<h4>17.1.2 select ä¹Ÿæœ‰æœ‰ç‚¹</h4>
<p>select çš„å…¼å®¹æ€§æ¯”è¾ƒé«˜ï¼Œè¿™æ ·å°±å¯ä»¥æ”¯æŒå¾ˆå¤šçš„æ“ä½œç³»ç»Ÿï¼Œä¸å—å¹³å°çš„é™åˆ¶ï¼Œä½¿ç”¨ select å‡½æ•°æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>æœåŠ¡å™¨æ¥å…¥è€…å°‘</li>
<li>ç¨‹åºåº”è¯¥å…·æœ‰å…¼å®¹æ€§</li>
</ul>
<h4>17.1.3 å®ç° epoll æ—¶å¿…è¦çš„å‡½æ•°å’Œç»“æ„ä½“</h4>
<p>èƒ½å¤Ÿå…‹æœ select å‡½æ•°ç¼ºç‚¹çš„ epoll å‡½æ•°å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼Œè¿™äº›ä¼˜ç‚¹æ­£å¥½ä¸ä¹‹å‰çš„ select å‡½æ•°ç¼ºç‚¹ç›¸åã€‚</p>
<ul>
<li>æ— éœ€ç¼–å†™ä»¥ç›‘è§†çŠ¶æ€å˜åŒ–ä¸ºç›®çš„çš„é’ˆå¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„å¾ªç¯è¯­å¥</li>
<li>è°ƒç”¨å¯¹åº”äº select å‡½æ•°çš„ epoll_wait å‡½æ•°æ—¶æ— éœ€æ¯æ¬¡ä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯ epoll å‡½æ•°çš„åŠŸèƒ½ï¼š</p>
<ul>
<li>epoll_createï¼šåˆ›å»ºä¿å­˜ epoll æ–‡ä»¶æè¿°ç¬¦çš„ç©ºé—´</li>
<li>epoll_ctlï¼šå‘ç©ºé—´æ³¨å†Œå¹¶æ³¨é”€æ–‡ä»¶æè¿°ç¬¦</li>
<li>epoll_waitï¼šä¸ select å‡½æ•°ç±»ä¼¼ï¼Œç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿå˜åŒ–</li>
</ul>
<p>select å‡½æ•°ä¸­ä¸ºäº†ä¿å­˜ç›‘è§†å¯¹è±¡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç›´æ¥å£°æ˜äº† fd_set å˜é‡ï¼Œä½† epoll æ–¹å¼ä¸‹çš„æ“ä½œç³»ç»Ÿè´Ÿè´£ä¿å­˜ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤éœ€è¦å‘æ“ä½œç³»ç»Ÿè¯·æ±‚åˆ›å»ºä¿å­˜æ–‡ä»¶æè¿°ç¬¦çš„ç©ºé—´ï¼Œæ­¤æ—¶ç”¨çš„å‡½æ•°å°±æ˜¯ epoll_create ã€‚</p>
<p>æ­¤å¤–ï¼Œä¸ºäº†æ·»åŠ å’Œåˆ é™¤ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦ï¼Œselect æ–¹å¼ä¸­éœ€è¦ FD_SETã€FD_CLR å‡½æ•°ã€‚ä½†åœ¨ epoll æ–¹å¼ä¸­ï¼Œé€šè¿‡ epoll_ctl å‡½æ•°è¯·æ±‚æ“ä½œç³»ç»Ÿå®Œæˆã€‚æœ€åï¼Œselect æ–¹å¼ä¸‹è°ƒç”¨ select å‡½æ•°ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦çš„å˜åŒ–ï¼Œè€Œ epoll_wait è°ƒç”¨ epoll_wait å‡½æ•°ã€‚è¿˜æœ‰ï¼Œselect æ–¹å¼ä¸­é€šè¿‡ fd_set å˜é‡æŸ¥çœ‹ç›‘è§†å¯¹è±¡çš„çŠ¶æ€å˜åŒ–ï¼Œè€Œ epoll æ–¹å¼é€šè¿‡å¦‚ä¸‹ç»“æ„ä½“ epoll_event å°†å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦å•ç‹¬é›†ä¸­åœ¨ä¸€èµ·ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">__uint32_t</span> events;</span><br><span class="line">    <span class="keyword">epoll_data_t</span> data;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> epoll_data &#123;</span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">__uint32_t</span> u32;</span><br><span class="line">    <span class="keyword">__uint64_t</span> u64;</span><br><span class="line">&#125; <span class="keyword">epoll_data_t</span>;</span><br></pre></td></tr></table></figure>
<p>å£°æ˜è¶³å¤Ÿå¤§çš„ epoll_event ç»“æ„ä½“æ•°ç»„å€™ï¼Œä¼ é€’ç»™ epoll_wait å‡½æ•°æ—¶ï¼Œå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯å°†è¢«å¡«å…¥æ•°ç»„ã€‚å› æ­¤ï¼Œæ— éœ€åƒ select å‡½æ•°é‚£æ ·é’ˆå¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œå¾ªç¯ã€‚</p>
<h4>17.1.4 epoll_create</h4>
<p>epoll æ˜¯ä» Linux çš„ 2.5.44 ç‰ˆå†…æ ¸å¼€å§‹å¼•å…¥çš„ã€‚é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ Linux å†…æ ¸ç‰ˆæœ¬ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /proc/sys/kernel/osrelease</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ epoll_create å‡½æ•°çš„åŸå‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> <span class="built_in">size</span>)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› epoll çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">sizeï¼šepoll å®ä¾‹çš„å¤§å°</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ epoll_create å‡½æ•°æ—¶åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦ä¿å­˜ç©ºé—´ç§°ä¸ºã€Œepoll ä¾‹ç¨‹ã€ï¼Œä½†æœ‰äº›æƒ…å†µä¸‹åç§°ä¸åŒï¼Œéœ€è¦ç¨åŠ æ³¨æ„ã€‚é€šè¿‡å‚æ•° size ä¼ é€’çš„å€¼å†³å®š epoll ä¾‹ç¨‹çš„å¤§å°ï¼Œä½†è¯¥å€¼åªæ˜¯å‘æ“ä½œç³»ç»Ÿæå‡ºçš„å»ºè®®ã€‚æ¢è¨€ä¹‹ï¼Œsize å¹¶ä¸ç”¨æ¥å†³å®š epoll çš„å¤§å°ï¼Œè€Œä»…ä¾›æ“ä½œç³»ç»Ÿå‚è€ƒã€‚</p>
<blockquote>
<p>Linux 2.6.8 ä¹‹åçš„å†…æ ¸å°†å®Œå…¨ä¼ å…¥ epoll_create å‡½æ•°çš„ size å‡½æ•°ï¼Œå› æ­¤å†…æ ¸ä¼šæ ¹æ®æƒ…å†µè°ƒæ•´ epoll ä¾‹ç¨‹å¤§å°ã€‚ä½†æ˜¯æœ¬ä¹¦ç¨‹åºå¹¶æ²¡æœ‰å¿½ç•¥ size</p>
</blockquote>
<p>epoll_create å‡½æ•°åˆ›å»ºçš„èµ„æºä¸å¥—æ¥å­—ç›¸åŒï¼Œä¹Ÿç”±æ“ä½œç³»ç»Ÿç®¡ç†ã€‚å› æ­¤ï¼Œè¯¥å‡½æ•°å’Œåˆ›å»ºå¥—æ¥å­—çš„æƒ…å†µç›¸åŒï¼Œä¹Ÿä¼šè¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ä¸»è¦ç”¨äºåŒºåˆ† epoll ä¾‹ç¨‹ã€‚éœ€è¦ç»ˆæ­¢æ—¶ï¼Œä¸å…¶ä»–æ–‡ä»¶æè¿°ç¬¦ç›¸åŒï¼Œä¹Ÿè¦è°ƒç”¨ close å‡½æ•°</p>
<h4>17.1.5 epoll_ctl</h4>
<p>ç”Ÿæˆä¾‹ç¨‹åï¼Œåº”åœ¨å…¶å†…éƒ¨æ³¨å†Œç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦ï¼Œæ­¤æ—¶ä½¿ç”¨ epoll_ctl å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event *event)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">epfdï¼šç”¨äºæ³¨å†Œç›‘è§†å¯¹è±¡çš„ epoll ä¾‹ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">opï¼šç”¨äºåˆ¶å®šç›‘è§†å¯¹è±¡çš„æ·»åŠ ã€åˆ é™¤æˆ–æ›´æ”¹ç­‰æ“ä½œ</span></span><br><span class="line"><span class="comment">fdï¼šéœ€è¦æ³¨å†Œçš„ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">eventï¼šç›‘è§†å¯¹è±¡çš„äº‹ä»¶ç±»å‹</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸å…¶ä»– epoll å‡½æ•°ç›¸æ¯”ï¼Œè¯¥å‡½æ•°çœ‹èµ·æ¥æœ‰äº›å¤æ‚ï¼Œä½†é€šè¿‡è°ƒç”¨è¯­å¥å°±å¾ˆå®¹æ˜“ç†è§£ï¼Œå‡è®¾æŒ‰ç…§å¦‚ä¸‹å½¢å¼è°ƒç”¨ epoll_ctl å‡½æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">epoll_ctl(A,EPOLL_CTL_ADD,B,C);</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªå‚æ•° EPOLL_CTL_ADD æ„å‘³ç€ã€Œæ·»åŠ ã€ï¼Œä¸Šè¿°è¯­å¥æœ‰å¦‚ä¸‹æ„ä¹‰ï¼š</p>
<blockquote>
<p>epoll  ä¾‹ç¨‹ A ä¸­æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦ B ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç›‘è§†å‚æ•° C ä¸­çš„äº‹ä»¶</p>
</blockquote>
<p>å†ä»‹ç»ä¸€ä¸ªè°ƒç”¨è¯­å¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">epoll_ctl(A,EPOLL_CTL_DEL,B,<span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°è¯­å¥ä¸­ç¬¬äºŒä¸ªå‚æ•°æ„å‘³è¿™ã€Œåˆ é™¤ã€ï¼Œæœ‰ä»¥ä¸‹å«ä¹‰ï¼š</p>
<blockquote>
<p>ä» epoll ä¾‹ç¨‹ A ä¸­åˆ é™¤æ–‡ä»¶æè¿°ç¬¦ B</p>
</blockquote>
<p>ä»ä¸Šè¿°ç¤ºä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œä»ç›‘è§†å¯¹è±¡ä¸­åˆ é™¤æ—¶ï¼Œä¸éœ€è¦ç›‘è§†ç±»å‹ï¼Œå› æ­¤å‘ç¬¬å››ä¸ªå‚æ•°å¯ä»¥ä¼ é€’ä¸º NULL</p>
<p>ä¸‹é¢æ˜¯ç¬¬äºŒä¸ªå‚æ•°çš„å«ä¹‰ï¼š</p>
<ul>
<li>EPOLL_CTL_ADDï¼šå°†æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ° epoll ä¾‹ç¨‹</li>
<li>EPOLL_CTL_DELï¼šä» epoll ä¾‹ç¨‹ä¸­åˆ é™¤æ–‡ä»¶æè¿°ç¬¦</li>
<li>EPOLL_CTL_MODï¼šæ›´æ”¹æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦çš„å…³æ³¨äº‹ä»¶å‘ç”Ÿæƒ…å†µ</li>
</ul>
<p>epoll_event ç»“æ„ä½“ç”¨äºä¿å­˜äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ç»“åˆã€‚ä½†ä¹Ÿå¯ä»¥åœ¨ epoll ä¾‹ç¨‹ä¸­æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œç”¨äºæ³¨å†Œå…³æ³¨çš„äº‹ä»¶ã€‚è¯¥å‡½æ•°ä¸­ epoll_event ç»“æ„ä½“çš„å®šä¹‰å¹¶ä¸æ˜¾çœ¼ï¼Œå› æ­¤é€šè¿‡æ‰è‹±è¯­å‰§è¯´æ˜è¯¥ç»“æ„ä½“åœ¨ epoll_ctl å‡½æ•°ä¸­çš„åº”ç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span>;</span></span><br><span class="line">...</span><br><span class="line">event.events=EPOLLIN;<span class="comment">//å‘ç”Ÿéœ€è¦è¯»å–æ•°æ®çš„æƒ…å†µæ—¶</span></span><br><span class="line">event.data.fd=sockfd;</span><br><span class="line">epoll_ctl(epfd,EPOLL_CTL_ADD,sockfd,&amp;event);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç å°† epfd æ³¨å†Œåˆ° epoll ä¾‹ç¨‹ epfd ä¸­ï¼Œå¹¶åœ¨éœ€è¦è¯»å–æ•°æ®çš„æƒ…å†µä¸‹äº§ç”Ÿç›¸åº”äº‹ä»¶ã€‚æ¥ä¸‹æ¥ç»™å‡º epoll_event çš„æˆå‘˜ events ä¸­å¯ä»¥ä¿å­˜çš„å¸¸é‡åŠæ‰€æŒ‡çš„äº‹ä»¶ç±»å‹ã€‚</p>
<ul>
<li>EPOLLINï¼šéœ€è¦è¯»å–æ•°æ®çš„æƒ…å†µ</li>
<li>EPOLLOUTï¼šè¾“å‡ºç¼“å†²ä¸ºç©ºï¼Œå¯ä»¥ç«‹å³å‘é€æ•°æ®çš„æƒ…å†µ</li>
<li>EPOLLPRIï¼šæ”¶åˆ° OOB æ•°æ®çš„æƒ…å†µ</li>
<li>EPOLLRDHUPï¼šæ–­å¼€è¿æ¥æˆ–åŠå…³é—­çš„æƒ…å†µï¼Œè¿™åœ¨è¾¹ç¼˜è§¦å‘æ–¹å¼ä¸‹éå¸¸æœ‰ç”¨</li>
<li>EPOLLERRï¼šå‘ç”Ÿé”™è¯¯çš„æƒ…å†µ</li>
<li>EPOLLETï¼šä»¥è¾¹ç¼˜è§¦å‘çš„æ–¹å¼å¾—åˆ°äº‹ä»¶é€šçŸ¥</li>
<li>EPOLLONESHOTï¼šå‘ç”Ÿä¸€æ¬¡äº‹ä»¶åï¼Œç›¸åº”æ–‡ä»¶æè¿°ç¬¦ä¸å†æ”¶åˆ°äº‹ä»¶é€šçŸ¥ã€‚å› æ­¤éœ€è¦å‘ epoll_ctl å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ EPOLL_CTL_MOD ï¼Œå†æ¬¡è®¾ç½®äº‹ä»¶ã€‚</li>
</ul>
<p>å¯é€šè¿‡ä½è¿ç®—åŒæ—¶ä¼ é€’å¤šä¸ªä¸Šè¿°å‚æ•°ã€‚</p>
<h4>17.1.6 epoll_wait</h4>
<p>ä¸‹é¢æ˜¯å‡½æ•°åŸå‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event *events, <span class="keyword">int</span> maxevents, <span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å›å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">epfd : è¡¨ç¤ºäº‹ä»¶å‘ç”Ÿç›‘è§†èŒƒå›´çš„ epoll ä¾‹ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">events : ä¿å­˜å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆçš„ç»“æ„ä½“åœ°å€å€¼</span></span><br><span class="line"><span class="comment">maxevents : ç¬¬äºŒä¸ªå‚æ•°ä¸­å¯ä»¥ä¿å­˜çš„æœ€å¤§äº‹ä»¶æ•°</span></span><br><span class="line"><span class="comment">timeout : ä»¥ 1/1000 ç§’ä¸ºå•ä½çš„ç­‰å¾…æ—¶é—´ï¼Œä¼ é€’ -1 æ—¶ï¼Œä¸€ç›´ç­‰å¾…ç›´åˆ°å‘ç”Ÿäº‹ä»¶</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°è°ƒç”¨æ–¹å¼å¦‚ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬äºŒä¸ªå‚æ•°æ‰€æŒ‡ç¼“å†²éœ€è¦åŠ¨æ€åˆ†é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> event_cnt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> *<span class="title">ep_events</span>;</span></span><br><span class="line">...</span><br><span class="line">ep_events=<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct epoll_event)*EPOLL_SIZE);<span class="comment">//EPOLL_SIZEæ˜¯å®å¸¸é‡</span></span><br><span class="line">...</span><br><span class="line">event_cnt=epoll_wait(epfd,ep_events,EPOLL_SIZE,<span class="number">-1</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨å‡½æ•°åï¼Œè¿”å›å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼ŒåŒæ—¶åœ¨ç¬¬äºŒä¸ªå‚æ•°æŒ‡å‘çš„ç¼“å†²ä¸­ä¿å­˜å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚å› æ­¤ï¼Œæ— éœ€åƒ select ä¸€æ ·æ’å…¥é’ˆå¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„å¾ªç¯ã€‚</p>
<h4>17.1.7 åŸºäº epoll çš„å›å£°æœåŠ¡å™¨ç«¯</h4>
<p>ä¸‹é¢æ˜¯å›å£°æœåŠ¡å™¨ç«¯çš„ä»£ç ï¼ˆä¿®æ”¹è‡ªç¬¬ 12 ç«  <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch12/echo_selectserv.c" target="_blank" rel="noopener">echo_selectserv.c</a>ï¼‰ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch17/echo_epollserv.c" target="_blank" rel="noopener">echo_epollserv.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_epollserv.c -o serv</span><br><span class="line">./serv 9190</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/01/5c53f5b6d4acf.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºè¿è¡Œç»“æœå’Œä»¥å‰ select å®ç°çš„å’Œ fork å®ç°çš„ç»“æœä¸€æ ·ï¼Œéƒ½å¯ä»¥æ”¯æŒå¤šå®¢æˆ·ç«¯åŒæ—¶è¿è¡Œã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œè¿ç”¨äº† epoll æ•ˆç‡é«˜äº select</p>
<p>æ€»ç»“ä¸€ä¸‹ epoll çš„æµç¨‹ï¼š</p>
<ol>
<li>epoll_create åˆ›å»ºä¸€ä¸ªä¿å­˜ epoll æ–‡ä»¶æè¿°ç¬¦çš„ç©ºé—´ï¼Œå¯ä»¥æ²¡æœ‰å‚æ•°</li>
<li>åŠ¨æ€åˆ†é…å†…å­˜ï¼Œç»™å°†è¦ç›‘è§†çš„ epoll_wait</li>
<li>åˆ©ç”¨ epoll_ctl æ§åˆ¶ æ·»åŠ  åˆ é™¤ï¼Œç›‘å¬äº‹ä»¶</li>
<li>åˆ©ç”¨ epoll_wait æ¥è·å–æ”¹å˜çš„æ–‡ä»¶æè¿°ç¬¦,æ¥æ‰§è¡Œç¨‹åº</li>
</ol>
<p>select å’Œ epoll çš„åŒºåˆ«ï¼š</p>
<ul>
<li>æ¯æ¬¡è°ƒç”¨ select å‡½æ•°éƒ½ä¼šå‘æ“ä½œç³»ç»Ÿä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯ï¼Œæµªè´¹å¤§é‡æ—¶é—´</li>
<li>epoll ä»…å‘æ“ä½œç³»ç»Ÿä¼ é€’ä¸€æ¬¡ç›‘è§†å¯¹è±¡ï¼Œç›‘è§†èŒƒå›´æˆ–å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶åªé€šçŸ¥å‘ç”Ÿå˜åŒ–çš„äº‹é¡¹</li>
</ul>
<h3>17.2 æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘</h3>
<p>å­¦ä¹  epoll æ—¶è¦äº†è§£æ¡ä»¶è§¦å‘ï¼ˆLevel Triggerï¼‰å’Œè¾¹ç¼˜è§¦å‘ï¼ˆEdge Triggerï¼‰ã€‚</p>
<h4>17.2.1 æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘çš„åŒºåˆ«åœ¨äºå‘ç”Ÿäº‹ä»¶çš„æ—¶é—´ç‚¹</h4>
<p><strong>æ¡ä»¶è§¦å‘çš„ç‰¹æ€§</strong>ï¼š</p>
<blockquote>
<p>æ¡ä»¶è§¦å‘æ–¹å¼ä¸­ï¼Œåªè¦è¾“å…¥ç¼“å†²æœ‰æ•°æ®å°±ä¼šä¸€ç›´é€šçŸ¥è¯¥äº‹ä»¶</p>
</blockquote>
<p>ä¾‹å¦‚ï¼ŒæœåŠ¡å™¨ç«¯è¾“å…¥ç¼“å†²æ”¶åˆ° 50 å­—èŠ‚æ•°æ®æ—¶ï¼ŒæœåŠ¡å™¨ç«¯æ“ä½œç³»ç»Ÿå°†é€šçŸ¥è¯¥äº‹ä»¶ï¼ˆæ³¨å†Œåˆ°å‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦ï¼‰ã€‚ä½†æ˜¯æœåŠ¡å™¨ç«¯è¯»å– 20 å­—èŠ‚åè¿˜å‰©ä¸‹ 30 å­—èŠ‚çš„æƒ…å†µä¸‹ï¼Œä»ä¼šæ³¨å†Œäº‹ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¡ä»¶è§¦å‘æ–¹å¼ä¸­ï¼Œåªè¦è¾“å…¥ç¼“å†²ä¸­è¿˜å‰©æœ‰æ•°æ®ï¼Œå°±å°†ä»¥äº‹ä»¶æ–¹å¼å†æ¬¡æ³¨å†Œã€‚</p>
<p><strong>è¾¹ç¼˜è§¦å‘ç‰¹æ€§</strong>ï¼š</p>
<p>è¾¹ç¼˜è§¦å‘ä¸­è¾“å…¥ç¼“å†²æ”¶åˆ°æ•°æ®æ—¶ä»…æ³¨å†Œ 1 æ¬¡è¯¥äº‹ä»¶ã€‚å³ä½¿è¾“å…¥ç¼“å†²ä¸­è¿˜ç•™æœ‰æ•°æ®ï¼Œä¹Ÿä¸ä¼šå†è¿›è¡Œæ³¨å†Œã€‚</p>
<h4>17.2.2 æŒæ¡æ¡ä»¶è§¦å‘çš„äº‹ä»¶ç‰¹æ€§</h4>
<p>ä¸‹é¢ä»£ç ä¿®æ”¹è‡ª <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch17/echo_epollserv.c" target="_blank" rel="noopener">echo_epollserv.c</a> ã€‚epoll é»˜è®¤ä»¥æ¡ä»¶è§¦å‘çš„æ–¹å¼å·¥ä½œï¼Œå› æ­¤å¯ä»¥é€šè¿‡è¯¥ç¤ºä¾‹éªŒè¯æ¡ä»¶è§¦å‘çš„ç‰¹æ€§ã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch17/echo_EPLTserv.c" target="_blank" rel="noopener">echo_EPLTserv.c</a></li>
</ul>
<p>ä¸Šé¢çš„ä»£ç æŠŠè°ƒç”¨ read å‡½æ•°æ—¶ä½¿ç”¨çš„ç¼“å†²å¤§å°ç¼©å°åˆ°äº† 4 ä¸ªå­—èŠ‚ï¼Œæ’å…¥äº†éªŒè¯ epoll_wait è°ƒç”¨æ¬¡æ•°çš„éªŒè¯å‡½æ•°ã€‚å‡å°‘ç¼“å†²å¤§å°æ˜¯ä¸ºäº†é˜»æ­¢æœåŠ¡å™¨ç«¯ä¸€æ¬¡æ€§è¯»å–æ¥æ”¶çš„æ•°æ®ã€‚æ¢è¨€ä¹‹ï¼Œè°ƒç”¨ read å‡½æ•°åï¼Œè¾“å…¥ç¼“å†²ä¸­ä»æœ‰æ•°æ®è¦è¯»å–ï¼Œè€Œä¸”ä¼šå› æ­¤æ³¨å†Œæ–°çš„äº‹ä»¶å¹¶ä» epoll_wait å‡½æ•°è¿”å›æ—¶å°†å¾ªç¯è¾“å‡ºã€Œreturn epoll_waitã€å­—ç¬¦ä¸²ã€‚</p>
<p>ç¼–è¯‘è¿è¡Œ:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_EPLTserv.c -o serv</span><br><span class="line">./serv 9190</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/01/5c540825ae415.png" alt="" /></p>
<p>ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ¯å½“æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®æ—¶ï¼Œéƒ½å›æ³¨å†Œè¯¥äº‹ä»¶ï¼Œå¹¶å› æ­¤è°ƒç”¨ epoll_wait å‡½æ•°ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç æ˜¯ä¿®æ”¹åçš„è¾¹ç¼˜è§¦å‘æ–¹å¼çš„ä»£ç ï¼Œä»…ä»…æ˜¯æŠŠä¸Šé¢çš„ä»£ç æ”¹ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">event.events = EPOLLIN | EPOLLET;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch17/echo_EDGEserv.c" target="_blank" rel="noopener">echo_EDGEserv.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_EDGEserv.c -o serv</span><br><span class="line">./serv 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/01/5c54097b6469f.png" alt="" /></p>
<p>ä»ä¸Šé¢çš„ä¾‹å­çœ‹å‡ºï¼Œæ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¶ˆæ¯æ—¶ï¼Œåªè¾“å‡ºä¸€æ¬¡ã€Œreturn epoll_waitã€å­—ç¬¦ä¸²ï¼Œè¿™è¯æ˜ä»…æ³¨å†Œäº†ä¸€æ¬¡äº‹ä»¶ã€‚</p>
<p><strong>select æ¨¡å‹æ˜¯ä»¥æ¡ä»¶è§¦å‘çš„æ–¹å¼å·¥ä½œçš„</strong>ã€‚</p>
<h4>17.2.3 è¾¹ç¼˜è§¦å‘çš„æœåŠ¡å™¨ç«¯å¿…çŸ¥çš„ä¸¤ç‚¹</h4>
<ul>
<li>é€šè¿‡ errno å˜é‡éªŒè¯é”™è¯¯åŸå› </li>
<li>ä¸ºäº†å®Œæˆéé˜»å¡ï¼ˆNon-blockingï¼‰I/O ï¼Œæ›´æ”¹äº†å¥—æ¥å­—ç‰¹æ€§ã€‚</li>
</ul>
<p>Linux å¥—æ¥å­—ç›¸å…³å‡½æ•°ä¸€èˆ¬é€šè¿‡ -1 é€šçŸ¥å‘ç”Ÿäº†é”™è¯¯ã€‚è™½ç„¶çŸ¥é“å‘ç”Ÿäº†é”™è¯¯ï¼Œä½†ä»…å‡­è¿™äº›å†…å®¹æ— æ³•å¾—çŸ¥äº§ç”Ÿé”™è¯¯çš„åŸå› ã€‚å› æ­¤ï¼Œä¸ºäº†åœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™æé¢å¤–çš„ä¿¡æ¯ï¼ŒLinux å£°æ˜äº†å¦‚ä¸‹å…¨å±€å˜é‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> errno;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†è®¿é—®è¯¥å˜é‡ï¼Œéœ€è¦å¼•å…¥ <code>error.h</code> å¤´æ–‡ä»¶ï¼Œå› æ­¤æ­¤å¤´æ–‡ä»¶æœ‰ä¸Šè¿°å˜é‡çš„ extren å£°æ˜ã€‚å¦å¤–ï¼Œæ¯ç§å‡½æ•°å‘ç”Ÿé”™è¯¯æ—¶ï¼Œä¿å­˜åœ¨ errno å˜é‡ä¸­çš„å€¼éƒ½ä¸åŒã€‚</p>
<blockquote>
<p>read å‡½æ•°å‘ç°è¾“å…¥ç¼“å†²ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶è¿”å› -1ï¼ŒåŒæ—¶åœ¨ errno ä¸­ä¿å­˜ EAGAIN å¸¸é‡</p>
</blockquote>
<p>ä¸‹é¢æ˜¯ Linux ä¸­æä¾›çš„æ”¹å˜å’Œæ›´æ”¹æ–‡ä»¶å±æ€§çš„åŠæ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fcntl</span><span class="params">(<span class="keyword">int</span> fields, <span class="keyword">int</span> cmd, ...)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› cmd å‚æ•°ç›¸å…³å€¼ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">filedes : å±æ€§æ›´æ”¹ç›®æ ‡çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">cmd : è¡¨ç¤ºå‡½æ•°è°ƒç”¨ç›®çš„</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šè¿°å£°æ˜å¯ä»¥çœ‹å‡º fcntl æœ‰å¯å˜å‚æ•°çš„å½¢å¼ã€‚å¦‚æœå‘ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ F_GETFL ï¼Œå¯ä»¥è·å¾—ç¬¬ä¸€ä¸ªå‚æ•°æ‰€æŒ‡çš„æ–‡ä»¶æè¿°ç¬¦å±æ€§ï¼ˆint å‹ï¼‰ã€‚åä¹‹ï¼Œå¦‚æœä¼ é€’ F_SETFL ï¼Œå¯ä»¥æ›´æ”¹æ–‡ä»¶æè¿°ç¬¦å±æ€§ã€‚è‹¥å¸Œæœ›å°†æ–‡ä»¶ï¼ˆå¥—æ¥å­—ï¼‰æ”¹ä¸ºéé˜»å¡æ¨¡å¼ï¼Œéœ€è¦å¦‚ä¸‹  2 æ¡è¯­å¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> flag = fcntl(fd,F_GETFL,<span class="number">0</span>);</span><br><span class="line">fcntl(fd,F_SETFL | O_NONBLOCK)</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ç¬¬ä¸€æ¡è¯­å¥ï¼Œè·å–ä¹‹å‰è®¾ç½®çš„å±æ€§ä¿¡æ¯ï¼Œé€šè¿‡ç¬¬äºŒæ¡è¯­å¥åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ éé˜»å¡ O_NONBLOCK æ ‡å¿—ã€‚è°ƒç”¨ read/write å‡½æ•°æ—¶ï¼Œæ— è®ºæ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œéƒ½ä¼šå½¢æˆéé˜»å¡æ–‡ä»¶ï¼ˆå¥—æ¥å­—ï¼‰ã€‚fcntl å‡½æ•°çš„é€‚ç”¨èŒƒå›´å¾ˆå¹¿ã€‚</p>
<h4>17.2.4 å®ç°è¾¹ç¼˜è§¦å‘å›å£°æœåŠ¡å™¨ç«¯</h4>
<p>é€šè¿‡ errno ç¡®è®¤é”™è¯¯çš„åŸå› æ˜¯ï¼šè¾¹ç¼˜è§¦å‘æ–¹å¼ä¸­ï¼Œæ¥æ”¶æ•°æ®ä»…æ³¨å†Œä¸€æ¬¡è¯¥äº‹ä»¶ã€‚</p>
<p>å› ä¸ºè¿™ç§ç‰¹ç‚¹ï¼Œä¸€æ—¦å‘ç”Ÿè¾“å…¥ç›¸å…³äº‹ä»¶æ—¶ï¼Œå°±åº”è¯¥è¯»å–è¾“å…¥ç¼“å†²ä¸­çš„å…¨éƒ¨æ•°æ®ã€‚å› æ­¤éœ€è¦éªŒè¯è¾“å…¥ç¼“å†²æ˜¯å¦ä¸ºç©ºã€‚</p>
<blockquote>
<p>read å‡½æ•°è¿”å› -1ï¼Œå˜é‡ errno ä¸­çš„å€¼å˜æˆ EAGAIN æ—¶ï¼Œè¯´æ˜æ²¡æœ‰æ•°æ®å¯è¯»ã€‚</p>
</blockquote>
<p>æ—¢ç„¶å¦‚æ­¤ï¼Œä¸ºä»€ä¹ˆè¦å°†å¥—æ¥å­—å˜æˆéé˜»å¡æ¨¡å¼ï¼Ÿè¾¹ç¼˜è§¦å‘æ¡ä»¶ä¸‹ï¼Œä»¥é˜»å¡æ–¹å¼å·¥ä½œçš„ read &amp; write å‡½æ•°æœ‰å¯èƒ½å¼•èµ·æœåŠ¡ç«¯çš„é•¿æ—¶é—´åœé¡¿ã€‚å› æ­¤ï¼Œè¾¹ç¼˜è§¦å‘æ–¹å¼ä¸­ä¸€å®šè¦é‡‡ç”¨éé˜»å¡ read &amp; write å‡½æ•°ã€‚</p>
<p>ä¸‹é¢æ˜¯ä»¥è¾¹ç¼˜è§¦å‘æ–¹å¼å·¥ä½œçš„å›å£°æœåŠ¡ç«¯ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch17/echo_EPETserv.c" target="_blank" rel="noopener">echo_EPETserv.c</a></li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc echo_EPETserv.c -o serv</span><br><span class="line">./serv</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/01/5c542149c0cee.png" alt="" /></p>
<h4>17.2.5 æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘å­°ä¼˜å­°åŠ£</h4>
<p>è¾¹ç¼˜è§¦å‘æ–¹å¼å¯ä»¥åšåˆ°è¿™ç‚¹ï¼š</p>
<blockquote>
<p>å¯ä»¥åˆ†ç¦»æ¥æ”¶æ•°æ®å’Œå¤„ç†æ•°æ®çš„æ—¶é—´ç‚¹ï¼</p>
</blockquote>
<p>ä¸‹é¢æ˜¯è¾¹ç¼˜è§¦å‘çš„å›¾</p>
<p><img src="https://i.loli.net/2019/02/01/5c5421e3b3f2b.png" alt="" /></p>
<p>è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æœåŠ¡å™¨ç«¯åˆ†åˆ«ä» A B C æ¥æ”¶æ•°æ®</li>
<li>æœåŠ¡å™¨ç«¯æŒ‰ç…§  A B C çš„é¡ºåºé‡æ–°ç»„åˆæ¥æ”¶åˆ°çš„æ•°æ®</li>
<li>ç»„åˆçš„æ•°æ®å°†å‘é€ç»™ä»»æ„ä¸»æœºã€‚</li>
</ul>
<p>ä¸ºäº†å®Œæˆè¿™ä¸ªè¿‡ç¨‹ï¼Œå¦‚æœå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æµç¨‹è¿è¡Œï¼ŒæœåŠ¡ç«¯çš„å®ç°å¹¶ä¸éš¾ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯æŒ‰ç…§ A B C çš„é¡ºåºè¿æ¥æœåŠ¡å™¨ï¼Œå¹¶ä¸”æŒ‰ç…§æ¬¡åºå‘æœåŠ¡å™¨å‘é€æ•°æ®</li>
<li>éœ€è¦æ¥æ”¶æ•°æ®çš„å®¢æˆ·ç«¯åº”åœ¨å®¢æˆ·ç«¯ A B C ä¹‹å‰è¿æ¥åˆ°æœåŠ¡å™¨ç«¯å¹¶ç­‰å¾…</li>
</ul>
<p>ä½†æ˜¯å®é™…æƒ…å†µä¸­å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯ C å’Œ B æ­£åœ¨å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œä½†æ˜¯ A å¹¶æ²¡æœ‰è¿æ¥åˆ°æœåŠ¡å™¨</li>
<li>å®¢æˆ·ç«¯ A B C ä¹±åºå‘é€æ•°æ®</li>
<li>æœåŠ¡ç«¯å·²ç»æ¥æ”¶åˆ°æ•°æ®ï¼Œä½†æ˜¯è¦æ¥æ”¶æ•°æ®çš„ç›®æ ‡å®¢æˆ·ç«¯å¹¶æ²¡æœ‰è¿æ¥åˆ°æœåŠ¡å™¨ç«¯ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œå³ä½¿è¾“å…¥ç¼“å†²æ”¶åˆ°æ•°æ®ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿèƒ½å†³å®šè¯»å–å’Œå¤„ç†è¿™äº›æ•°æ®çš„æ—¶é—´ç‚¹ï¼Œè¿™æ ·å°±ç»™æœåŠ¡å™¨ç«¯çš„å®ç°å¸¦æ¥å¾ˆå¤§çµæ´»æ€§ã€‚</p>
<h3>17.3 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p>åˆ©ç”¨ select å‡½æ•°å®ç°æœåŠ¡å™¨ç«¯æ—¶ï¼Œä»£ç å±‚é¢å­˜åœ¨çš„ä¸¤ä¸ªç¼ºç‚¹æ˜¯ï¼Ÿ</p>
<p>ç­”ï¼šâ‘ è°ƒç”¨ select å‡½æ•°åå¸¸è§çš„é’ˆå¯¹æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„å¾ªç¯è¯­å¥â‘¡æ¯æ¬¡è°ƒç”¨ select å‡½æ•°æ—¶éƒ½è¦ä¼ é€’ç›‘è§†å¯¹è±¡ä¿¡æ¯ã€‚</p>
</li>
<li>
<p>æ— è®ºæ˜¯ select æ–¹å¼è¿˜æ˜¯ epoll æ–¹å¼ï¼Œéƒ½éœ€è¦å°†ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯é€šè¿‡å‡½æ•°è°ƒç”¨ä¼ é€’ç»™æ“ä½œç³»ç»Ÿã€‚è¯·è§£é‡Šä¼ é€’è¯¥ä¿¡æ¯çš„åŸå› ã€‚</p>
<p>ç­”ï¼šæ–‡ä»¶æè¿°ç¬¦æ˜¯ç”±æ“ä½œç³»ç»Ÿç®¡ç†çš„ï¼Œæ‰€ä»¥å¿…é¡»è¦å€ŸåŠ©æ“ä½œç³»ç»Ÿæ‰èƒ½å®Œæˆã€‚</p>
</li>
<li>
<p>select æ–¹å¼å’Œ epoll æ–¹å¼çš„æœ€å¤§å·®å¼‚åœ¨äºç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™æ“ä½œç³»ç»Ÿçš„æ–¹å¼ã€‚è¯·è¯´æ˜å…·ä½“å·®å¼‚ï¼Œå¹¶è§£é‡Šä¸ºä½•å­˜åœ¨è¿™ç§å·®å¼‚ã€‚</p>
<p>ç­”ï¼šselect å‡½æ•°æ¯æ¬¡è°ƒç”¨éƒ½è¦ä¼ é€’æ‰€æœ‰çš„ç›‘è§†å¯¹è±¡ä¿¡æ¯ï¼Œè€Œ epoll å‡½æ•°ä»…å‘æ“ä½œç³»ç»Ÿä¼ é€’ 1 æ¬¡ç›‘è§†å¯¹è±¡ï¼Œç›‘è§†èŒƒå›´æˆ–å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶åªé€šçŸ¥å‘ç”Ÿå˜åŒ–çš„äº‹é¡¹ã€‚select é‡‡ç”¨è¿™ç§æ–¹æ³•æ˜¯ä¸ºäº†ä¿æŒå…¼å®¹æ€§ã€‚</p>
</li>
<li>
<p>è™½ç„¶ epoll æ˜¯ select çš„æ”¹è¿›åæ„Ÿï¼Œä½† select ä¹Ÿæœ‰è‡ªå·±çš„ä¼˜ç‚¹ã€‚åœ¨ä½•ç§æƒ…å†µä¸‹ä½¿ç”¨ select æ›´åŠ åˆç†ã€‚</p>
<p>ç­”ï¼šâ‘ æœåŠ¡å™¨ç«¯æ¥å…¥è€…å°‘â‘¡ç¨‹åºåº”å…·æœ‰å…¼å®¹æ€§ã€‚</p>
</li>
<li>
<p>epoll æ˜¯ä»¥æ¡ä»¶è§¦å‘å’Œè¾¹ç¼˜è§¦å‘æ–¹å¼å·¥ä½œã€‚äºŒè€…æœ‰ä½•å·®åˆ«ï¼Ÿä»è¾“å…¥ç¼“å†²çš„è§’åº¦è¯´æ˜è¿™ä¸¤ç§æ–¹å¼é€šçŸ¥äº‹ä»¶çš„æ—¶é—´ç‚¹å·®å¼‚ã€‚</p>
<p>ç­”ï¼šåœ¨æ¡ä»¶è§¦å‘ä¸­ï¼Œåªè¦è¾“å…¥ç¼“å†²æœ‰æ•°æ®ï¼Œå°±ä¼šä¸€ç›´é€šçŸ¥è¯¥äº‹ä»¶ã€‚è¾¹ç¼˜è§¦å‘ä¸­è¾“å…¥ç¼“å†²æ”¶åˆ°æ•°æ®æ—¶ä»…æ³¨å†Œ 1 æ¬¡è¯¥äº‹ä»¶ï¼Œå³ä½¿è¾“å…¥ç¼“å†²ä¸­è¿˜ç•™æœ‰æ•°æ®ï¼Œä¹Ÿä¸ä¼šå†è¿›è¡Œæ³¨å†Œã€‚</p>
</li>
<li>
<p>é‡‡ç”¨è¾¹ç¼˜è§¦å‘æ—¶å¯ä»¥åˆ†ç¦»æ•°æ®çš„æ¥æ”¶å’Œå¤„ç†æ—¶é—´ç‚¹ã€‚è¯·è¯´æ˜å…¶ä¼˜ç‚¹å’ŒåŸå› ã€‚</p>
<p>ç­”ï¼šåˆ†ç¦»æ¥æ”¶æ•°æ®å’Œå¤„ç†æ•°æ®çš„æ—¶é—´ç‚¹ï¼Œç»™æœåŠ¡ç«¯çš„å®ç°å¸¦æ¥å¾ˆå¤§çµæ´»æ€§ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 18 ç«  å¤šçº¿ç¨‹æœåŠ¡å™¨ç«¯çš„å®ç°</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>18.1 ç†è§£çº¿ç¨‹çš„æ¦‚å¿µ</h3>
<h4>18.1.1 å¼•å…¥çº¿ç¨‹èƒŒæ™¯</h4>
<p>ç¬¬ 10 ç« ä»‹ç»äº†å¤šè¿›ç¨‹æœåŠ¡ç«¯çš„å®ç°æ–¹æ³•ã€‚å¤šè¿›ç¨‹æ¨¡å‹ä¸ select å’Œ epoll ç›¸æ¯”çš„ç¡®æœ‰è‡ªèº«çš„ä¼˜ç‚¹ï¼Œä½†åŒæ—¶ä¹Ÿæœ‰é—®é¢˜ã€‚å¦‚å‰æ‰€è¿°ï¼Œåˆ›å»ºï¼ˆå¤åˆ¶ï¼‰è¿›ç¨‹çš„å·¥ä½œæœ¬èº«ä¼šç»™æ“ä½œç³»ç»Ÿå¸¦æ¥ç›¸å½“æ²‰é‡çš„è´Ÿæ‹…ã€‚è€Œä¸”ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½å…·æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥è¿›ç¨‹é—´é€šä¿¡çš„å®ç°éš¾åº¦ä¹Ÿä¼šéšä¹‹æé«˜ã€‚æ¢è¨€ä¹‹ï¼Œå¤šè¿›ç¨‹çš„ç¼ºç‚¹å¯æ¦‚æ‹¬ä¸ºï¼š</p>
<ul>
<li>åˆ›å»ºè¿›ç¨‹çš„è¿‡ç¨‹ä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€</li>
<li>ä¸ºäº†å®Œæˆè¿›ç¨‹é—´æ•°æ®äº¤æ¢ï¼Œéœ€è¦ç‰¹æ®Šçš„ IPC æŠ€æœ¯ã€‚</li>
</ul>
<p>ä½†æ˜¯æ›´å¤§çš„ç¼ºç‚¹æ˜¯ä¸‹é¢çš„ï¼š</p>
<ul>
<li>æ¯ç§’å°‘åˆ™ 10 æ¬¡ï¼Œå¤šåˆ™åƒæ¬¡çš„ã€Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€æ˜¯åˆ›å»ºè¿›ç¨‹çš„æœ€å¤§å¼€é”€</li>
</ul>
<p>åªæœ‰ä¸€ä¸ª CPU çš„ç³»ç»Ÿæ˜¯å°†æ—¶é—´åˆ†æˆå¤šä¸ªå¾®å°çš„å—ååˆ†é…ç»™äº†å¤šä¸ªè¿›ç¨‹ã€‚ä¸ºäº†åˆ†æ—¶ä½¿ç”¨ CPU ï¼Œéœ€è¦ã€Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€çš„è¿‡ç¨‹ã€‚ã€Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€æ˜¯æŒ‡è¿è¡Œç¨‹åºå‰éœ€è¦å°†ç›¸åº”è¿›ç¨‹ä¿¡æ¯è¯»å…¥å†…å­˜ï¼Œå¦‚æœè¿è¡Œè¿›ç¨‹ A åç´§æ¥ç€éœ€è¦è¿è¡Œè¿›ç¨‹ B ï¼Œå°±åº”è¯¥å°†è¿›ç¨‹ A ç›¸å…³ä¿¡æ¯ç§»å‡ºå†…å­˜ï¼Œå¹¶è¯»å…¥è¿›ç¨‹ B ç›¸å…³ä¿¡æ¯ã€‚è¿™å°±æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä½†æ˜¯æ­¤æ—¶è¿›ç¨‹ A çš„æ•°æ®å°†è¢«ç§»åŠ¨åˆ°ç¡¬ç›˜ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡åˆ‡æ¢è¦å¾ˆé•¿æ—¶é—´ï¼Œå³ä½¿é€šè¿‡ä¼˜åŒ–åŠ å¿«é€Ÿåº¦ï¼Œä¹Ÿä¼šå­˜åœ¨ä¸€å®šçš„å±€é™ã€‚</p>
<p>ä¸ºäº†ä¿æŒå¤šè¿›ç¨‹çš„ä¼˜ç‚¹ï¼ŒåŒæ—¶åœ¨ä¸€å®šç¨‹åº¦ä¸Šå…‹æœå…¶ç¼ºç‚¹ï¼Œäººä»¬å¼•å…¥çš„çº¿ç¨‹ï¼ˆThreadï¼‰çš„æ¦‚å¿µã€‚è¿™æ˜¯ä¸ºäº†å°†è¿›ç¨‹çš„å„ç§åŠ£åŠ¿é™è‡³æœ€ä½ç¨‹åº¦ï¼ˆä¸æ˜¯ç›´æ¥æ¶ˆé™¤ï¼‰è€Œè®¾ç«‹çš„ä¸€ç§ã€Œè½»é‡çº§è¿›ç¨‹ã€ã€‚çº¿ç¨‹æ¯”è¿›ç¨‹å…·æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul>
<li>çº¿ç¨‹çš„åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¿›ç¨‹çš„åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ›´å¿«</li>
<li>çº¿ç¨‹é—´äº¤æ¢æ•°æ®æ— éœ€ç‰¹æ®ŠæŠ€æœ¯</li>
</ul>
<h4>18.1.2 çº¿ç¨‹å’Œè¿›ç¨‹çš„å·®å¼‚</h4>
<p>çº¿ç¨‹æ˜¯ä¸ºäº†è§£å†³ï¼šä¸ºäº†å¾—åˆ°å¤šæ¡ä»£ç æ‰§è¡Œæµè€Œå¤åˆ¶æ•´ä¸ªå†…å­˜åŒºåŸŸçš„è´Ÿæ‹…å¤ªé‡ã€‚</p>
<p>æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜ç©ºé—´éƒ½ç”±ä¿å­˜å…¨å±€å˜é‡çš„ã€Œæ•°æ®åŒºã€ã€å‘ malloc ç­‰å‡½æ•°åŠ¨æ€åˆ†é…æä¾›ç©ºé—´çš„å †ï¼ˆHeapï¼‰ã€å‡½æ•°è¿è¡Œæ—¶é—´ä½¿ç”¨çš„æ ˆï¼ˆStackï¼‰æ„æˆã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„è¿™ç§ç©ºé—´ï¼Œå¤šä¸ªè¿›ç¨‹çš„å†…å­˜ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/02/02/5c55aa57db3c7.png" alt="" /></p>
<p>ä½†å¦‚æœä»¥è·å¾—å¤šä¸ªä»£ç æ‰§è¡Œæµä¸ºç›®çš„ï¼Œåˆ™ä¸åº”è¯¥åƒä¸Šå›¾é‚£æ ·å®Œå…¨åˆ†ç¦»å†…å­˜ç»“æ„ï¼Œè€Œåªéœ€åˆ†ç¦»æ ˆåŒºåŸŸã€‚é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥è·å¾—å¦‚ä¸‹ä¼˜åŠ¿ï¼š</p>
<ul>
<li>ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ä¸éœ€è¦åˆ‡æ¢æ•°æ®åŒºå’Œå †</li>
<li>å¯ä»¥åˆ©ç”¨æ•°æ®åŒºå’Œå †äº¤æ¢æ•°æ®</li>
</ul>
<p>å®é™…ä¸Šè¿™å°±æ˜¯çº¿ç¨‹ã€‚çº¿ç¨‹ä¸ºäº†ä¿æŒå¤šæ¡ä»£ç æ‰§è¡Œæµè€Œéš”å¼€äº†æ ˆåŒºåŸŸï¼Œå› æ­¤å…·æœ‰å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å†…å­˜ç»“æ„ï¼š</p>
<p><img src="https://i.loli.net/2019/02/02/5c55ab455e399.png" alt="" /></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«æ•°æ®åŒºå’Œå †ã€‚ä¸ºäº†ä¿æŒè¿™ç§ç»“æ„ï¼Œçº¿ç¨‹å°†åœ¨è¿›ç¨‹å†…åˆ›å»ºå¹¶è¿è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿›ç¨‹å’Œçº¿ç¨‹å¯ä»¥å®šä¹‰ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p>
<ul>
<li>è¿›ç¨‹ï¼šåœ¨æ“ä½œç³»ç»Ÿæ„æˆå•ç‹¬æ‰§è¡Œæµçš„å•ä½</li>
<li>çº¿ç¨‹ï¼šåœ¨è¿›ç¨‹æ„æˆå•ç‹¬æ‰§è¡Œæµçš„å•ä½</li>
</ul>
<p>å¦‚æœè¯´è¿›ç¨‹åœ¨æ“ä½œç³»ç»Ÿå†…éƒ¨ç”Ÿæˆå¤šä¸ªæ‰§è¡Œæµï¼Œé‚£ä¹ˆçº¿ç¨‹å°±åœ¨åŒä¸€è¿›ç¨‹å†…éƒ¨åˆ›å»ºå¤šæ¡æ‰§è¡Œæµã€‚å› æ­¤ï¼Œæ“ä½œç³»ç»Ÿã€è¿›ç¨‹ã€çº¿ç¨‹ä¹‹é—´çš„å…³ç³»å¯ä»¥è¡¨ç¤ºä¸ºä¸‹å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/02/02/5c55ac20aa776.png" alt="" /></p>
<h3>18.2 çº¿ç¨‹åˆ›å»ºåŠè¿è¡Œ</h3>
<p>å¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£ï¼ˆè‹±è¯­ï¼šPortable Operating System Interfaceï¼Œç¼©å†™ä¸ºPOSIXï¼‰æ˜¯IEEEä¸ºè¦åœ¨å„ç§UNIXæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œè½¯ä»¶ï¼Œè€Œå®šä¹‰APIçš„ä¸€ç³»åˆ—äº’ç›¸å…³è”çš„æ ‡å‡†çš„æ€»ç§°ï¼Œå…¶æ­£å¼ç§°å‘¼ä¸ºIEEE Std 1003ï¼Œè€Œå›½é™…æ ‡å‡†åç§°ä¸ºISO/IEC 9945ã€‚æ­¤æ ‡å‡†æºäºä¸€ä¸ªå¤§çº¦å¼€å§‹äº1985å¹´çš„é¡¹ç›®ã€‚POSIXè¿™ä¸ªåç§°æ˜¯ç”±ç†æŸ¥å¾·Â·æ–¯æ‰˜æ›¼ï¼ˆRMSï¼‰åº”IEEEçš„è¦æ±‚è€Œæè®®çš„ä¸€ä¸ªæ˜“äºè®°å¿†çš„åç§°ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯Portable Operating System Interfaceï¼ˆå¯ç§»æ¤æ“ä½œç³»ç»Ÿæ¥å£ï¼‰çš„ç¼©å†™ï¼Œè€ŒXåˆ™è¡¨æ˜å…¶å¯¹Unix APIçš„ä¼ æ‰¿ã€‚</p>
<p>LinuxåŸºæœ¬ä¸Šé€æ­¥å®ç°äº†POSIXå…¼å®¹ï¼Œä½†å¹¶æ²¡æœ‰å‚åŠ æ­£å¼çš„POSIXè®¤è¯ã€‚</p>
<p>å¾®è½¯çš„Windows NTå£°ç§°éƒ¨åˆ†å®ç°äº†POSIXæ ‡å‡†ã€‚</p>
<p>å½“å‰çš„POSIXä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼šBase Definitionsã€System Interfacesã€Shell and Utilitieså’ŒRationaleã€‚</p>
<h4>18.2.1 çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹</h4>
<p>çº¿ç¨‹å…·æœ‰å•ç‹¬çš„æ‰§è¡Œæµï¼Œå› æ­¤éœ€è¦å•ç‹¬å®šä¹‰çº¿ç¨‹çš„ main å‡½æ•°ï¼Œè¿˜éœ€è¦è¯·æ±‚æ“ä½œç³»ç»Ÿåœ¨å•ç‹¬çš„æ‰§è¡Œæµä¸­æ‰§è¡Œè¯¥å‡½æ•°ï¼Œå®Œæˆå‡½æ•°åŠŸèƒ½çš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span><span class="params">(<span class="keyword">pthread_t</span> *<span class="keyword">restrict</span> thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *<span class="keyword">restrict</span> attr,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">void</span> *(*start_routine)(<span class="keyword">void</span> *),</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">void</span> *<span class="keyword">restrict</span> arg)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">thread : ä¿å­˜æ–°åˆ›å»ºçº¿ç¨‹ ID çš„å˜é‡åœ°å€å€¼ã€‚çº¿ç¨‹ä¸è¿›ç¨‹ç›¸åŒï¼Œä¹Ÿéœ€è¦ç”¨äºåŒºåˆ†ä¸åŒçº¿ç¨‹çš„ ID</span></span><br><span class="line"><span class="comment">attr : ç”¨äºä¼ é€’çº¿ç¨‹å±æ€§çš„å‚æ•°ï¼Œä¼ é€’ NULL æ—¶ï¼Œåˆ›å»ºé»˜è®¤å±æ€§çš„çº¿ç¨‹</span></span><br><span class="line"><span class="comment">start_routine : ç›¸å½“äºçº¿ç¨‹ main å‡½æ•°çš„ã€åœ¨å•ç‹¬æ‰§è¡Œæµä¸­æ‰§è¡Œçš„å‡½æ•°åœ°å€å€¼ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰</span></span><br><span class="line"><span class="comment">arg : é€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’çš„è°ƒç”¨å‡½æ•°æ—¶åŒ…å«ä¼ é€’å‚æ•°ä¿¡æ¯çš„å˜é‡åœ°å€å€¼</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢é€šè¿‡ç®€å•ç¤ºä¾‹äº†è§£è¯¥å‡½æ•°åŠŸèƒ½ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/thread1.c" target="_blank" rel="noopener">thread1.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_main</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> t_id;</span><br><span class="line">    <span class="keyword">int</span> thread_param = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">// è¯·æ±‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä» thread_main è°ƒç”¨å¼€å§‹ï¼Œåœ¨å•ç‹¬çš„æ‰§è¡Œæµä¸­è¿è¡Œã€‚åŒæ—¶ä¼ é€’å‚æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;t_id, <span class="literal">NULL</span>, thread_main, (<span class="keyword">void</span> *)&amp;thread_param) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"pthread_create() error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">10</span>); <span class="comment">//å»¶è¿Ÿè¿›ç¨‹ç»ˆæ­¢æ—¶é—´</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"end of main"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_main</span><span class="params">(<span class="keyword">void</span> *arg)</span> <span class="comment">//ä¼ å…¥çš„å‚æ•°æ˜¯ pthread_create çš„ç¬¬å››ä¸ª</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> cnt = *((<span class="keyword">int</span> *)arg);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cnt; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"running thread"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc thread1.c -o tr1 -lpthread # çº¿ç¨‹ç›¸å…³ä»£ç ç¼–è¯‘æ—¶éœ€è¦æ·»åŠ  -lpthread é€‰é¡¹å£°æ˜éœ€è¦è¿æ¥åˆ°çº¿ç¨‹åº“</span><br><span class="line">./tr1</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/02/5c55b5eb4daf6.png" alt="" /></p>
<p>ä¸Šè¿°ç¨‹åºçš„æ‰§è¡Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2019/02/02/5c55b6943255b.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œç¨‹åºåœ¨ä¸»è¿›ç¨‹æ²¡æœ‰ç»“æŸæ—¶ï¼Œç”Ÿæˆçš„çº¿ç¨‹æ¯éš”ä¸€ç§’è¾“å‡ºä¸€æ¬¡ <code>running thread</code> ï¼Œä½†æ˜¯å¦‚æœä¸»è¿›ç¨‹æ²¡æœ‰ç­‰å¾…åç§’ï¼Œè€Œæ˜¯ç›´æ¥ç»“æŸï¼Œè¿™æ ·ä¹Ÿä¼šå¼ºåˆ¶ç»“æŸçº¿ç¨‹ï¼Œä¸è®ºçº¿ç¨‹æœ‰æ²¡æœ‰è¿è¡Œå®Œæ¯•ã€‚</p>
<p>é‚£æ˜¯å¦æ„å‘³ç€ä¸»è¿›ç¨‹å¿…é¡»æ¯æ¬¡éƒ½ sleep æ¥ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Ÿå¹¶ä¸éœ€è¦ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‡½æ•°è§£å†³ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_join</span><span class="params">(<span class="keyword">pthread_t</span> thread, <span class="keyword">void</span> **status)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å› -1</span></span><br><span class="line"><span class="comment">thread : è¯¥å‚æ•°å€¼ ID çš„çº¿ç¨‹ç»ˆæ­¢åæ‰ä¼šä»è¯¥å‡½æ•°è¿”å›</span></span><br><span class="line"><span class="comment">status : ä¿å­˜çº¿ç¨‹çš„ main å‡½æ•°è¿”å›å€¼çš„æŒ‡é’ˆçš„å˜é‡åœ°å€å€¼</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä½œç”¨å°±æ˜¯è°ƒç”¨è¯¥å‡½æ•°çš„è¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼‰å°†è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ŒçŸ¥é“ç¬¬ä¸€ä¸ªå‚æ•°ä¸º ID çš„çº¿ç¨‹ç»ˆæ­¢ä¸ºæ­¢ã€‚è€Œä¸”å¯ä»¥å¾—åˆ°çº¿ç¨‹çš„ main å‡½æ•°çš„è¿”å›å€¼ã€‚ä¸‹é¢æ˜¯è¯¥å‡½æ•°çš„ç”¨æ³•ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/thread2.c" target="_blank" rel="noopener">thread2.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_main</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> t_id;</span><br><span class="line">    <span class="keyword">int</span> thread_param = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">void</span> *thr_ret;</span><br><span class="line">    <span class="comment">// è¯·æ±‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä» thread_main è°ƒç”¨å¼€å§‹ï¼Œåœ¨å•ç‹¬çš„æ‰§è¡Œæµä¸­è¿è¡Œã€‚åŒæ—¶ä¼ é€’å‚æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;t_id, <span class="literal">NULL</span>, thread_main, (<span class="keyword">void</span> *)&amp;thread_param) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"pthread_create() error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//mainå‡½æ•°å°†ç­‰å¾… ID ä¿å­˜åœ¨ t_id å˜é‡ä¸­çš„çº¿ç¨‹ç»ˆæ­¢</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_join(t_id, &amp;thr_ret) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"pthread_join() error"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Thread return message : %s \n"</span>, (<span class="keyword">char</span> *)thr_ret);</span><br><span class="line">    <span class="built_in">free</span>(thr_ret);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_main</span><span class="params">(<span class="keyword">void</span> *arg)</span> <span class="comment">//ä¼ å…¥çš„å‚æ•°æ˜¯ pthread_create çš„ç¬¬å››ä¸ª</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> cnt = *((<span class="keyword">int</span> *)arg);</span><br><span class="line">    <span class="keyword">char</span> *msg = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">50</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(msg, <span class="string">"Hello,I'am thread~ \n"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cnt; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"running thread"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)msg; <span class="comment">//è¿”å›å€¼æ˜¯ thread_main å‡½æ•°ä¸­å†…éƒ¨åŠ¨æ€åˆ†é…çš„å†…å­˜ç©ºé—´åœ°å€å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc thread2.c -o tr2 -lpthread </span><br><span class="line">./tr2</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/02/5c55bd6032f1e.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œçº¿ç¨‹è¾“å‡ºäº†5æ¬¡å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æŠŠè¿”å›å€¼ç»™äº†ä¸»è¿›ç¨‹</p>
<p>ä¸‹é¢æ˜¯è¯¥å‡½æ•°çš„æ‰§è¡Œæµç¨‹å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/02/02/5c55bdd3bb3c8.png" alt="" /></p>
<h4>18.2.2 å¯åœ¨ä¸´ç•ŒåŒºå†…è°ƒç”¨çš„å‡½æ•°</h4>
<p>åœ¨åŒæ­¥çš„ç¨‹åºè®¾è®¡ä¸­ï¼Œä¸´ç•ŒåŒºå—ï¼ˆCritical sectionï¼‰æŒ‡çš„æ˜¯ä¸€ä¸ªè®¿é—®å…±äº«èµ„æºï¼ˆä¾‹å¦‚ï¼šå…±äº«è®¾å¤‡æˆ–æ˜¯å…±äº«å­˜å‚¨å™¨ï¼‰çš„ç¨‹åºç‰‡æ®µï¼Œè€Œè¿™äº›å…±äº«èµ„æºæœ‰æ— æ³•åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®çš„ç‰¹æ€§ã€‚</p>
<p>å½“æœ‰çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºå—æ—¶ï¼Œå…¶ä»–çº¿ç¨‹æˆ–æ˜¯è¿›ç¨‹å¿…é¡»ç­‰å¾…ï¼ˆä¾‹å¦‚ï¼šbounded waiting ç­‰å¾…æ³•ï¼‰ï¼Œæœ‰ä¸€äº›åŒæ­¥çš„æœºåˆ¶å¿…é¡»åœ¨ä¸´ç•ŒåŒºå—çš„è¿›å…¥ç‚¹ä¸ç¦»å¼€ç‚¹å®ç°ï¼Œä»¥ç¡®ä¿è¿™äº›å…±äº«èµ„æºæ˜¯è¢«å¼‚æˆ–çš„ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼šsemaphoreã€‚</p>
<p>åªèƒ½è¢«å•ä¸€çº¿ç¨‹è®¿é—®çš„è®¾å¤‡ï¼Œä¾‹å¦‚ï¼šæ‰“å°æœºã€‚</p>
<p>ä¸€ä¸ªæœ€ç®€å•çš„å®ç°æ–¹æ³•å°±æ˜¯å½“çº¿ç¨‹ï¼ˆThreadï¼‰è¿›å…¥ä¸´ç•ŒåŒºå—æ—¶ï¼Œç¦æ­¢æ”¹å˜å¤„ç†å™¨ï¼›åœ¨uni-processorç³»ç»Ÿä¸Šï¼Œå¯ä»¥ç”¨â€œç¦æ­¢ä¸­æ–­ï¼ˆCLIï¼‰â€æ¥å®Œæˆï¼Œé¿å…å‘ç”Ÿç³»ç»Ÿè°ƒç”¨ï¼ˆSystem Callï¼‰å¯¼è‡´çš„ä¸Šä¸‹æ–‡äº¤æ¢ï¼ˆContext switchingï¼‰ï¼›å½“ç¦»å¼€ä¸´ç•ŒåŒºå—æ—¶ï¼Œå¤„ç†å™¨æ¢å¤åŸå…ˆçš„çŠ¶æ€ã€‚</p>
<p>æ ¹æ®ä¸´ç•ŒåŒºæ˜¯å¦å¼•èµ·é—®é¢˜ï¼Œå‡½æ•°å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ 2 ç±»ï¼š</p>
<ul>
<li>çº¿ç¨‹å®‰å…¨å‡½æ•°ï¼ˆThread-safe functionï¼‰</li>
<li>éçº¿ç¨‹å®‰å…¨å‡½æ•°ï¼ˆThread-unsafe functionï¼‰</li>
</ul>
<p>çº¿ç¨‹å®‰å…¨å‡½æ•°è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ä¹Ÿä¸ä¼šå‘ç”Ÿé—®é¢˜ã€‚åä¹‹ï¼Œéçº¿ç¨‹å®‰å…¨å‡½æ•°è¢«åŒæ—¶è°ƒç”¨æ—¶ä¼šå¼•å‘é—®é¢˜ã€‚ä½†è¿™å¹¶éæœ‰å…³äºä¸´ç•ŒåŒºçš„è®¨è®ºï¼Œçº¿ç¨‹å®‰å…¨çš„å‡½æ•°ä¸­åŒæ ·å¯èƒ½å­˜åœ¨ä¸´ç•ŒåŒºã€‚åªæ˜¯åœ¨çº¿ç¨‹å®‰å…¨çš„å‡½æ•°ä¸­ï¼ŒåŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨æ—¶å¯é€šè¿‡ä¸€äº›æªæ–½é¿å…é—®é¢˜ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼Œå¤§å¤šæ•°æ ‡å‡†å‡½æ•°éƒ½æ˜¯çº¿ç¨‹å®‰å…¨å‡½æ•°ã€‚æ“ä½œç³»ç»Ÿåœ¨å®šä¹‰éçº¿ç¨‹å®‰å…¨å‡½æ•°çš„åŒæ—¶ï¼Œæä¾›äº†å…·æœ‰ç›¸åŒåŠŸèƒ½çš„çº¿ç¨‹å®‰å…¨çš„å‡½æ•°ã€‚æ¯”å¦‚ï¼Œç¬¬ 8 ç« çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">struct hostent *<span class="title">gethostbyname</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *hostname)</span></span>;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ï¼Œä¹Ÿæä¾›äº†åŒä¸€åŠŸèƒ½çš„å®‰å…¨å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">struct hostent *<span class="title">gethostbyname_r</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                struct hostent *result,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">char</span> *<span class="built_in">buffer</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">int</span> intbuflen,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">int</span> *h_errnop)</span></span>;</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹å®‰å…¨å‡½æ•°ç»“å°¾é€šå¸¸æ˜¯ <code>_r</code> ã€‚ä½†æ˜¯ä½¿ç”¨çº¿ç¨‹å®‰å…¨å‡½æ•°ä¼šç»™ç¨‹åºå‘˜å¸¦æ¥é¢å¤–çš„è´Ÿæ‹…ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•è‡ªåŠ¨å°† gethostbyname å‡½æ•°è°ƒç”¨æ”¹ä¸º gethostbyname_r å‡½æ•°è°ƒç”¨ã€‚</p>
<blockquote>
<p>å£°æ˜å¤´æ–‡ä»¶å‰å®šä¹‰ <code>_REENTRANT</code> å®ã€‚</p>
</blockquote>
<p>æ— éœ€ç‰¹æ„æ›´æ”¹æºä»£ç åŠ ï¼Œå¯ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™æŒ‡å®šç¼–è¯‘å‚æ•°å®šä¹‰å®ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc -D_REENTRANT mythread.c -o mthread -lpthread</span><br></pre></td></tr></table></figure>
<h4>18.2.3 å·¥ä½œï¼ˆWorkerï¼‰çº¿ç¨‹æ¨¡å‹</h4>
<p>ä¸‹é¢çš„ç¤ºä¾‹æ˜¯è®¡ç®—ä» 1 åˆ° 10 çš„å’Œï¼Œä½†å¹¶ä¸æ˜¯é€šè¿‡ main å‡½æ•°è¿›è¡Œè¿ç®—ï¼Œè€Œæ˜¯åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹è®¡ç®— 1 åˆ° 5 çš„å’Œï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è®¡ç®— 6 åˆ° 10 çš„å’Œï¼Œmain å‡½æ•°åªè´Ÿè´£è¾“å‡ºè¿ç®—ç»“æœã€‚è¿™ç§æ–¹å¼çš„çº¿ç¨‹æ¨¡å‹ç§°ä¸ºã€Œå·¥ä½œçº¿ç¨‹ã€ã€‚æ˜¾ç¤ºè¯¥ç¨‹åºçš„æ‰§è¡Œæµç¨‹å›¾ï¼š</p>
<p><img src="https://i.loli.net/2019/02/03/5c55c330e8b5b.png" alt="" /></p>
<p>ä¸‹é¢æ˜¯ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/thread3.c" target="_blank" rel="noopener">thread3.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_summation</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> id_t1, id_t2;</span><br><span class="line">    <span class="keyword">int</span> range1[] = &#123;<span class="number">1</span>, <span class="number">5</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> range2[] = &#123;<span class="number">6</span>, <span class="number">10</span>&#125;;</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;id_t1, <span class="literal">NULL</span>, thread_summation, (<span class="keyword">void</span> *)range1);</span><br><span class="line">    pthread_create(&amp;id_t2, <span class="literal">NULL</span>, thread_summation, (<span class="keyword">void</span> *)range2);</span><br><span class="line"></span><br><span class="line">    pthread_join(id_t1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(id_t2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"result: %d \n"</span>, sum);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_summation</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = ((<span class="keyword">int</span> *)arg)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">end</span> = ((<span class="keyword">int</span> *)arg)[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span> (start &lt;= <span class="built_in">end</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sum += start;</span><br><span class="line">        start++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc thread3.c -D_REENTRANT -o tr3 -lpthread</span><br><span class="line">./tr3</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/03/5c55c53d70494.png" alt="" /></p>
<p>å¯ä»¥çœ‹å‡ºè®¡ç®—ç»“æœæ­£ç¡®ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½ç”¨äº†å…¨å±€å˜é‡ sum ,è¯æ˜äº† 2 ä¸ªçº¿ç¨‹å…±äº«ä¿å­˜å…¨å±€å˜é‡çš„æ•°æ®åŒºã€‚</p>
<p>ä½†æ˜¯æœ¬ä¾‹å­æœ¬èº«å­˜åœ¨é—®é¢˜ã€‚å­˜åœ¨ä¸´ç•ŒåŒºç›¸å…³é—®é¢˜ï¼Œå¯ä»¥ä»ä¸‹é¢çš„ä»£ç çœ‹å‡ºï¼Œä¸‹é¢çš„ä»£ç å’Œä¸Šé¢çš„ä»£ç ç›¸ä¼¼ï¼Œåªæ˜¯å¢åŠ äº†å‘ç”Ÿä¸´ç•ŒåŒºé”™è¯¯çš„å¯èƒ½æ€§ï¼Œå³ä½¿åœ¨é«˜é…ç½®ç³»ç»Ÿç¯å¢ƒä¸‹ä¹Ÿå®¹æ˜“äº§ç”Ÿçš„é”™è¯¯ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/thread4.c" target="_blank" rel="noopener">thread4.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_THREAD 100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_inc</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_des</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> num = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thread_id[NUM_THREAD];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"sizeof long long: %d \n"</span>, <span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span>));</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_THREAD; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span>)</span><br><span class="line">            pthread_create(&amp;(thread_id[i]), <span class="literal">NULL</span>, thread_inc, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pthread_create(&amp;(thread_id[i]), <span class="literal">NULL</span>, thread_des, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_THREAD; i++)</span><br><span class="line">        pthread_join(thread_id[i], <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"result: %lld \n"</span>, num);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_inc</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">50000000</span>; i++)</span><br><span class="line">        num += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_des</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">50000000</span>; i++)</span><br><span class="line">        num -= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc thread4.c -D_REENTRANT -o tr4 -lpthread</span><br><span class="line">./tr4</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/03/5c55c884e7c11.png" alt="" /></p>
<p>ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œæ¯æ¬¡è¿è¡Œçš„ç»“æœç«Ÿç„¶ä¸ä¸€æ ·ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œä¸Šé¢ä»£ç çš„æœ€åç»“æœåº”è¯¥æ˜¯ 0 ã€‚åŸå› æš‚æ—¶ä¸å¾—è€ŒçŸ¥ï¼Œä½†æ˜¯å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œè¿™å¯¹äºçº¿ç¨‹çš„åº”ç”¨æ˜¯ä¸ªå¤§é—®é¢˜ã€‚</p>
<h3>18.3 çº¿ç¨‹å­˜åœ¨çš„é—®é¢˜å’Œä¸´ç•ŒåŒº</h3>
<p>ä¸‹é¢åˆ†æ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/thread4.c" target="_blank" rel="noopener">thread4.c</a> ä¸­äº§ç”Ÿé—®é¢˜çš„åŸå› ï¼Œå¹¶ç»™å‡ºè§£å†³æ–¹æ¡ˆã€‚</p>
<h4>18.3.1 å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€å˜é‡æ˜¯é—®é¢˜</h4>
<p><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/thread4.c" target="_blank" rel="noopener">thread4.c</a> çš„é—®é¢˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>2 ä¸ªçº¿ç¨‹æ­£åœ¨åŒæ—¶è®¿é—®å…¨å±€å˜é‡ num</p>
</blockquote>
<p>ä»»ä½•å†…å­˜ç©ºé—´ï¼Œåªè¦è¢«åŒæ—¶è®¿é—®ï¼Œéƒ½æœ‰å¯èƒ½å‘ç”Ÿé—®é¢˜ã€‚</p>
<p>å› æ­¤ï¼Œçº¿ç¨‹è®¿é—®å˜é‡ num æ—¶åº”è¯¥é˜»æ­¢å…¶ä»–çº¿ç¨‹è®¿é—®ï¼Œç›´åˆ°çº¿ç¨‹ 1 è¿ç®—å®Œæˆã€‚è¿™å°±æ˜¯åŒæ­¥ï¼ˆSynchronizationï¼‰</p>
<h4>18.3.2 ä¸´ç•ŒåŒºä½ç½®</h4>
<p>é‚£ä¹ˆåœ¨åˆšæ‰ä»£ç ä¸­çš„ä¸´ç•ŒåŒºä½ç½®æ˜¯ï¼š</p>
<blockquote>
<p>å‡½æ•°å†…åŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹æ—¶å¼•å‘é—®é¢˜çš„å¤šæ¡è¯­å¥æ„æˆçš„ä»£ç å—</p>
</blockquote>
<p>å…¨å±€å˜é‡ num ä¸èƒ½è§†ä¸ºä¸´ç•ŒåŒºï¼Œå› ä¸ºä»–ä¸æ˜¯å¼•èµ·é—®é¢˜çš„è¯­å¥ï¼Œåªæ˜¯ä¸€ä¸ªå†…å­˜åŒºåŸŸçš„å£°æ˜ã€‚ä¸‹é¢æ˜¯åˆšæ‰ä»£ç çš„ä¸¤ä¸ª main å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_inc</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">50000000</span>; i++)</span><br><span class="line">        num += <span class="number">1</span>;<span class="comment">//ä¸´ç•ŒåŒº</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_des</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">50000000</span>; i++)</span><br><span class="line">        num -= <span class="number">1</span>;<span class="comment">//ä¸´ç•ŒåŒº</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä¸Šè¿°ä»£ç å¯çŸ¥ï¼Œä¸´ç•ŒåŒºå¹¶é num æœ¬èº«ï¼Œè€Œæ˜¯è®¿é—® num çš„ä¸¤æ¡è¯­å¥ï¼Œè¿™ä¸¤æ¡è¯­å¥å¯èƒ½ç”±å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œä¹Ÿæ˜¯å¼•èµ·è¿™ä¸ªé—®é¢˜çš„ç›´æ¥åŸå› ã€‚äº§ç”Ÿé—®é¢˜çš„åŸå› å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li>2 ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ thread_inc å‡½æ•°</li>
<li>2 ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ thread_des å‡½æ•°</li>
<li>2 ä¸ªçº¿ç¨‹åˆ†åˆ«æ‰§è¡Œ thread_inc å’Œ thread_des å‡½æ•°</li>
</ul>
<p>æ¯”å¦‚å‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š</p>
<blockquote>
<p>çº¿ç¨‹ 1 æ‰§è¡Œ thread_inc çš„ num+=1 è¯­å¥çš„åŒæ—¶ï¼Œçº¿ç¨‹ 2  æ‰§è¡Œ thread_des å‡½æ•°çš„ num-=1 è¯­å¥</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸¤æ¡ä¸åŒçš„è¯­å¥ç”±ä¸åŒçš„çº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œä¹Ÿæœ‰å¯èƒ½æ„æˆä¸´ç•ŒåŒºã€‚å‰ææ˜¯è¿™ 2 æ¡è¯­å¥è®¿é—®åŒä¸€å†…å­˜ç©ºé—´ã€‚</p>
<h3>18.4 çº¿ç¨‹åŒæ­¥</h3>
<p>å‰é¢è®¨è®ºäº†çº¿ç¨‹ä¸­å­˜åœ¨çš„é—®é¢˜ï¼Œä¸‹é¢å°±æ˜¯è§£å†³æ–¹æ³•ï¼Œçº¿ç¨‹åŒæ­¥ã€‚</p>
<h4>18.4.1 åŒæ­¥çš„ä¸¤é¢æ€§</h4>
<p>çº¿ç¨‹åŒæ­¥ç”¨äºè§£å†³çº¿ç¨‹è®¿é—®é¡ºåºå¼•å‘çš„é—®é¢˜ã€‚éœ€è¦åŒæ­¥çš„æƒ…å†µå¯ä»¥ä»å¦‚ä¸‹ä¸¤æ–¹é¢è€ƒè™‘ã€‚</p>
<ul>
<li>åŒæ—¶è®¿é—®åŒä¸€å†…å­˜ç©ºé—´æ—¶å‘ç”Ÿçš„æƒ…å†µ</li>
<li>éœ€è¦æŒ‡å®šè®¿é—®åŒä¸€å†…å­˜ç©ºé—´çš„çº¿ç¨‹é¡ºåºçš„æƒ…å†µ</li>
</ul>
<p>æƒ…å†µä¸€ä¹‹å‰å·²ç»è§£é‡Šè¿‡ï¼Œä¸‹é¢è®¨è®ºæƒ…å†µäºŒã€‚è¿™æ˜¯ã€Œæ§åˆ¶çº¿ç¨‹æ‰§è¡Œçš„é¡ºåºã€çš„ç›¸å…³å†…å®¹ã€‚å‡è®¾æœ‰ A B ä¸¤ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹ A è´Ÿè´£å‘æŒ‡å®šçš„å†…å­˜ç©ºé—´å†…å†™å…¥æ•°æ®ï¼Œçº¿ç¨‹ B è´Ÿè´£å–èµ°è¯¥æ•°æ®ã€‚æ‰€ä»¥è¿™æ˜¯æœ‰é¡ºåºçš„ï¼Œä¸æŒ‰ç…§é¡ºåºå°±å¯èƒ½å‘ç”Ÿé—®é¢˜ã€‚æ‰€ä»¥è¿™ç§ä¹Ÿéœ€è¦è¿›è¡ŒåŒæ­¥ã€‚</p>
<h4>18.4.2 äº’æ–¥é‡</h4>
<p>äº’æ–¥é”ï¼ˆè‹±è¯­ï¼šè‹±è¯­ï¼šMutual exclusionï¼Œç¼©å†™ Mutexï¼‰æ˜¯ä¸€ç§ç”¨äºå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé˜²æ­¢ä¸¤æ¡çº¿ç¨‹åŒæ—¶å¯¹åŒä¸€å…¬å…±èµ„æºï¼ˆæ¯”å¦‚å…¨åŸŸå˜é‡ï¼‰è¿›è¡Œè¯»å†™çš„æœºåˆ¶ã€‚è¯¥ç›®çš„é€šè¿‡å°†ä»£ç åˆ‡ç‰‡æˆä¸€ä¸ªä¸€ä¸ªçš„ä¸´ç•ŒåŒºåŸŸï¼ˆcritical sectionï¼‰è¾¾æˆã€‚ä¸´ç•ŒåŒºåŸŸæŒ‡çš„æ˜¯ä¸€å—å¯¹å…¬å…±èµ„æºè¿›è¡Œè®¿é—®çš„ä»£ç ï¼Œå¹¶éä¸€ç§æœºåˆ¶æˆ–æ˜¯ç®—æ³•ã€‚ä¸€ä¸ªç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªä¸´ç•ŒåŒºåŸŸï¼Œä½†æ˜¯å¹¶ä¸ä¸€å®šä¼šåº”ç”¨äº’æ–¥é”ã€‚</p>
<p>é€šä¿—çš„è¯´å°±äº’æ–¥é‡å°±æ˜¯ä¸€æŠŠä¼˜ç§€çš„é”ï¼Œå½“ä¸´ç•ŒåŒºè¢«å æ®çš„æ—¶å€™å°±ä¸Šé”ï¼Œç­‰å ç”¨å®Œæ¯•ç„¶åå†æ”¾å¼€ã€‚</p>
<p>ä¸‹é¢æ˜¯äº’æ–¥é‡çš„åˆ›å»ºåŠé”€æ¯å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_init</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">const</span> <span class="keyword">pthread_mutexattr_t</span> *attr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_destroy</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼</span></span><br><span class="line"><span class="comment">mutex : åˆ›å»ºäº’æ–¥é‡æ—¶ä¼ é€’ä¿å­˜äº’æ–¥é‡çš„å˜é‡åœ°å€å€¼ï¼Œé”€æ¯æ—¶ä¼ é€’éœ€è¦é”€æ¯çš„äº’æ–¥é‡åœ°å€</span></span><br><span class="line"><span class="comment">attr : ä¼ é€’å³å°†åˆ›å»ºçš„äº’æ–¥é‡å±æ€§ï¼Œæ²¡æœ‰ç‰¹åˆ«éœ€è¦æŒ‡å®šçš„å±æ€§æ—¶ä¼ é€’ NULL</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šè¿°å‡½æ•°å£°æ˜ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†åˆ›å»ºç›¸å½“äºé”ç³»ç»Ÿçš„äº’æ–¥é‡ï¼Œéœ€è¦å£°æ˜å¦‚ä¸‹ pthread_mutex_t å‹å˜é‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">pthread_mutex_t</span> mutex</span><br></pre></td></tr></table></figure>
<p>è¯¥å˜é‡çš„åœ°å€å€¼ä¼ é€’ç»™ pthread_mutex_init å‡½æ•°ï¼Œç”¨æ¥ä¿å­˜æ“ä½œç³»ç»Ÿåˆ›å»ºçš„äº’æ–¥é‡ï¼ˆé”ç³»ç»Ÿï¼‰ã€‚è°ƒç”¨ pthread_mutex_destroy å‡½æ•°æ—¶åŒæ ·éœ€è¦è¯¥ä¿¡æ¯ã€‚å¦‚æœä¸éœ€è¦é…ç½®ç‰¹æ®Šçš„äº’æ–¥é‡å±æ€§ï¼Œåˆ™å‘ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ NULL æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ PTHREAD_MUTEX_INITIALIZER è¿›è¡Œå¦‚ä¸‹å£°æ˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br></pre></td></tr></table></figure>
<p>æ¨èå°½å¯èƒ½çš„ä½¿ç”¨ pthread_mutex_init å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œå› ä¸ºé€šè¿‡å®è¿›è¡Œåˆå§‹åŒ–æ—¶å¾ˆéš¾å‘ç°å‘ç”Ÿçš„é”™è¯¯ã€‚</p>
<p>ä¸‹é¢æ˜¯åˆ©ç”¨äº’æ–¥é‡é”ä½æˆ–é‡Šæ”¾ä¸´ç•ŒåŒºæ—¶ä½¿ç”¨çš„å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_lock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_unlock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>å‡½æ•°æœ¬èº«å«æœ‰ lock unlock ç­‰è¯æ±‡ï¼Œå¾ˆå®¹æ˜“ç†è§£å…¶å«ä¹‰ã€‚è¿›å…¥ä¸´ç•ŒåŒºå‰è°ƒç”¨çš„å‡½æ•°å°±æ˜¯ pthread_mutex_lock ã€‚è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œå‘ç°æœ‰å…¶ä»–çº¿ç¨‹å·²ç»è¿›å…¥ä¸´ç•ŒåŒºï¼Œåˆ™ pthread_mutex_lock å‡½æ•°ä¸ä¼šè¿”å›ï¼Œç›´åˆ°é‡Œé¢çš„çº¿ç¨‹è°ƒç”¨ pthread_mutex_unlock å‡½æ•°é€€å‡ºä¸´ç•ŒåŒºä½ç½®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶ä»–çº¿ç¨‹è®©å‡ºä¸´ç•ŒåŒºä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ã€‚æ¥ä¸‹æ¥æ•´ç†ä¸€ä¸‹ä»£ç çš„ç¼–å†™æ–¹å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pthread_mutex_lock(&amp;mutex);</span><br><span class="line"><span class="comment">//ä¸´ç•ŒåŒºå¼€å§‹</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//ä¸´ç•ŒåŒºç»“æŸ</span></span><br><span class="line">pthread_mutex_unlock(&amp;mutex);</span><br></pre></td></tr></table></figure>
<p>ç®€è¨€ä¹‹ï¼Œå°±æ˜¯åˆ©ç”¨ lock å’Œ unlock å‡½æ•°å›´ä½ä¸´ç•ŒåŒºçš„ä¸¤ç«¯ã€‚æ­¤æ—¶äº’æ–¥é‡ç›¸å½“äºä¸€æŠŠé”ï¼Œé˜»æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œè¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œçº¿ç¨‹é€€å‡ºä¸´ç•ŒåŒºæ—¶ï¼Œå¦‚æœå¿˜äº†è°ƒç”¨ pthread_mutex_unlock å‡½æ•°ï¼Œé‚£ä¹ˆå…¶ä»–ä¸ºäº†è¿›å…¥ä¸´ç•ŒåŒºè€Œè°ƒç”¨ pthread_mutex_lock çš„å‡½æ•°æ— æ³•æ‘†è„±é˜»å¡çŠ¶æ€ã€‚è¿™ç§æƒ…å†µç§°ä¸ºã€Œæ­»é”ã€ã€‚éœ€è¦æ ¼å¤–æ³¨æ„ï¼Œä¸‹é¢æ˜¯åˆ©ç”¨äº’æ–¥é‡è§£å†³ç¤ºä¾‹ <a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/thread4.c" target="_blank" rel="noopener">thread4.c</a> ä¸­é‡åˆ°çš„é—®é¢˜ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/mutex.c" target="_blank" rel="noopener">mutex.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_THREAD 100</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_inc</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_des</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> num = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex; <span class="comment">//ä¿å­˜äº’æ–¥é‡è¯»å–å€¼çš„å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thread_id[NUM_THREAD];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;mutex, <span class="literal">NULL</span>); <span class="comment">//åˆ›å»ºäº’æ–¥é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_THREAD; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span>)</span><br><span class="line">            pthread_create(&amp;(thread_id[i]), <span class="literal">NULL</span>, thread_inc, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pthread_create(&amp;(thread_id[i]), <span class="literal">NULL</span>, thread_des, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_THREAD; i++)</span><br><span class="line">        pthread_join(thread_id[i], <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"result: %lld \n"</span>, num);</span><br><span class="line">    pthread_mutex_destroy(&amp;mutex); <span class="comment">//é”€æ¯äº’æ–¥é‡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_inc</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    pthread_mutex_lock(&amp;mutex); <span class="comment">//ä¸Šé”</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">50000000</span>; i++)</span><br><span class="line">        num += <span class="number">1</span>;</span><br><span class="line">    pthread_mutex_unlock(&amp;mutex); <span class="comment">//è§£é”</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_des</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">50000000</span>; i++)</span><br><span class="line">        num -= <span class="number">1</span>;</span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc mutex.c -D_REENTRANT -o mutex -lpthread</span><br><span class="line">./mutex</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/03/5c567e4aafbb8.png" alt="" /></p>
<p>ä»è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡äº’æ–¥é‡æœºåˆ¶å¾—å‡ºäº†æ­£ç¡®çš„è¿è¡Œç»“æœã€‚</p>
<p>åœ¨ä»£ç ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_inc</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    pthread_mutex_lock(&amp;mutex); <span class="comment">//ä¸Šé”</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">50000000</span>; i++)</span><br><span class="line">        num += <span class="number">1</span>;</span><br><span class="line">    pthread_mutex_unlock(&amp;mutex); <span class="comment">//è§£é”</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä»£ç çš„ä¸´ç•ŒåŒºåˆ’åˆ†èŒƒå›´è¾ƒå¤§ï¼Œä½†è¿™æ˜¯è€ƒè™‘å¦‚ä¸‹ä¼˜ç‚¹æ‰€åšçš„å†³å®š:</p>
<blockquote>
<p>æœ€å¤§é™åº¦å‡å°‘äº’æ–¥é‡ lock unlock å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°</p>
</blockquote>
<h4>18.4.3 ä¿¡å·é‡</h4>
<p>ä¿¡å·é‡ï¼ˆè‹±è¯­ï¼šSemaphoreï¼‰åˆç§°ä¸ºä¿¡å·æ ‡ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥å¯¹è±¡ï¼Œç”¨äºä¿æŒåœ¨0è‡³æŒ‡å®šæœ€å¤§å€¼ä¹‹é—´çš„ä¸€ä¸ªè®¡æ•°å€¼ã€‚å½“çº¿ç¨‹å®Œæˆä¸€æ¬¡å¯¹è¯¥semaphoreå¯¹è±¡çš„ç­‰å¾…ï¼ˆwaitï¼‰æ—¶ï¼Œè¯¥è®¡æ•°å€¼å‡ä¸€ï¼›å½“çº¿ç¨‹å®Œæˆä¸€æ¬¡å¯¹semaphoreå¯¹è±¡çš„é‡Šæ”¾ï¼ˆreleaseï¼‰æ—¶ï¼Œè®¡æ•°å€¼åŠ ä¸€ã€‚å½“è®¡æ•°å€¼ä¸º0ï¼Œåˆ™çº¿ç¨‹ç­‰å¾…è¯¥semaphoreå¯¹è±¡ä¸å†èƒ½æˆåŠŸç›´è‡³è¯¥semaphoreå¯¹è±¡å˜æˆsignaledçŠ¶æ€ã€‚semaphoreå¯¹è±¡çš„è®¡æ•°å€¼å¤§äº0ï¼Œä¸ºsignaledçŠ¶æ€ï¼›è®¡æ•°å€¼ç­‰äº0ï¼Œä¸ºnonsignaledçŠ¶æ€.</p>
<p>semaphoreå¯¹è±¡é€‚ç”¨äºæ§åˆ¶ä¸€ä¸ªä»…æ”¯æŒæœ‰é™ä¸ªç”¨æˆ·çš„å…±äº«èµ„æºï¼Œæ˜¯ä¸€ç§ä¸éœ€è¦ä½¿ç”¨å¿™ç¢Œç­‰å¾…ï¼ˆbusy waitingï¼‰çš„æ–¹æ³•ã€‚</p>
<p>ä¿¡å·é‡çš„æ¦‚å¿µæ˜¯ç”±è·å…°è®¡ç®—æœºç§‘å­¦å®¶è‰¾å…¹èµ«å°”Â·æˆ´å…‹æ–¯ç‰¹æ‹‰ï¼ˆEdsger W. Dijkstraï¼‰å‘æ˜çš„ï¼Œå¹¿æ³›çš„åº”ç”¨äºä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­ã€‚åœ¨ç³»ç»Ÿä¸­ï¼Œç»™äºˆæ¯ä¸€ä¸ªè¿›ç¨‹ä¸€ä¸ªä¿¡å·é‡ï¼Œä»£è¡¨æ¯ä¸ªè¿›ç¨‹å½“å‰çš„çŠ¶æ€ï¼Œæœªå¾—åˆ°æ§åˆ¶æƒçš„è¿›ç¨‹ä¼šåœ¨ç‰¹å®šåœ°æ–¹è¢«å¼ºè¿«åœä¸‹æ¥ï¼Œç­‰å¾…å¯ä»¥ç»§ç»­è¿›è¡Œçš„ä¿¡å·åˆ°æ¥ã€‚å¦‚æœä¿¡å·é‡æ˜¯ä¸€ä¸ªä»»æ„çš„æ•´æ•°ï¼Œé€šå¸¸è¢«ç§°ä¸ºè®¡æ•°ä¿¡å·é‡ï¼ˆCounting semaphoreï¼‰ï¼Œæˆ–ä¸€èˆ¬ä¿¡å·é‡ï¼ˆgeneral semaphoreï¼‰ï¼›å¦‚æœä¿¡å·é‡åªæœ‰äºŒè¿›åˆ¶çš„0æˆ–1ï¼Œç§°ä¸ºäºŒè¿›åˆ¶ä¿¡å·é‡ï¼ˆbinary semaphoreï¼‰ã€‚åœ¨linuxç³»ç»Ÿä¸­ï¼ŒäºŒè¿›åˆ¶ä¿¡å·é‡ï¼ˆbinary semaphoreï¼‰åˆç§°äº’æ–¥é”ï¼ˆMutexï¼‰ã€‚</p>
<p>ä¸‹é¢ä»‹ç»ä¿¡å·é‡ï¼Œåœ¨äº’æ–¥é‡çš„åŸºç¡€ä¸Šï¼Œå¾ˆå®¹æ˜“ç†è§£ä¿¡å·é‡ã€‚æ­¤å¤„åªæ¶‰åŠåˆ©ç”¨ã€ŒäºŒè¿›åˆ¶ä¿¡å·é‡ã€ï¼ˆåªç”¨ 0 å’Œ 1ï¼‰å®Œæˆã€Œæ§åˆ¶çº¿ç¨‹é¡ºåºã€ä¸ºä¸­å¿ƒçš„åŒæ­¥æ–¹æ³•ã€‚ä¸‹é¢æ˜¯ä¿¡å·é‡çš„åˆ›å»ºåŠé”€æ¯æ–¹æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_init</span><span class="params">(<span class="keyword">sem_t</span> *sem, <span class="keyword">int</span> pshared, <span class="keyword">unsigned</span> <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_destroy</span><span class="params">(<span class="keyword">sem_t</span> *sem)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼</span></span><br><span class="line"><span class="comment">sem : åˆ›å»ºä¿¡å·é‡æ—¶ä¿å­˜ä¿¡å·é‡çš„å˜é‡åœ°å€å€¼ï¼Œé”€æ¯æ—¶ä¼ é€’éœ€è¦é”€æ¯çš„ä¿¡å·é‡å˜é‡åœ°å€å€¼</span></span><br><span class="line"><span class="comment">pshared : ä¼ é€’å…¶ä»–å€¼æ—¶ï¼Œåˆ›å»ºå¯ç”±å¤šä¸ªç»§æ‰¿å…±äº«çš„ä¿¡å·é‡ï¼›ä¼ é€’ 0 æ—¶ï¼Œåˆ›å»ºåªå…è®¸ 1 ä¸ªè¿›ç¨‹å†…éƒ¨ä½¿ç”¨çš„ä¿¡å·é‡ã€‚éœ€è¦å®ŒæˆåŒä¸€è¿›ç¨‹çš„çº¿ç¨‹åŒæ­¥ï¼Œæ•…ä¸º0</span></span><br><span class="line"><span class="comment">value : æŒ‡å®šåˆ›å»ºä¿¡å·é‡çš„åˆå§‹å€¼</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°çš„ shared å‚æ•°è¶…å‡ºäº†æˆ‘ä»¬çš„å…³æ³¨èŒƒå›´ï¼Œæ•…é»˜è®¤å‘å…¶ä¼ é€’ä¸º 0 ã€‚ä¸‹é¢æ˜¯ä¿¡å·é‡ä¸­ç›¸å½“äºäº’æ–¥é‡ lock unlock çš„å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_post</span><span class="params">(<span class="keyword">sem_t</span> *sem)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sem_wait</span><span class="params">(<span class="keyword">sem_t</span> *sem)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼</span></span><br><span class="line"><span class="comment">sem : ä¼ é€’ä¿å­˜ä¿¡å·é‡è¯»å–å€¼çš„å˜é‡åœ°å€å€¼ï¼Œä¼ é€’ç»™ sem_post çš„ä¿¡å·é‡å¢1ï¼Œä¼ é€’ç»™ sem_wait æ—¶ä¿¡å·é‡å‡ä¸€</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ sem_init å‡½æ•°æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°†åˆ›å»ºä¿¡å·é‡å¯¹è±¡ï¼Œæ­¤å¯¹è±¡ä¸­è®°å½•è¿™ã€Œä¿¡å·é‡å€¼ã€ï¼ˆSemaphore Valueï¼‰æ•´æ•°ã€‚è¯¥å€¼åœ¨è°ƒç”¨ sem_post å‡½æ•°æ—¶å¢åŠ  1 ï¼Œè°ƒç”¨ wait_wait å‡½æ•°æ—¶å‡ä¸€ã€‚ä½†ä¿¡å·é‡çš„å€¼ä¸èƒ½å°äº 0 ï¼Œå› æ­¤ï¼Œåœ¨ä¿¡å·é‡ä¸º 0 çš„æƒ…å†µä¸‹è°ƒç”¨ sem_wait å‡½æ•°æ—¶ï¼Œè°ƒç”¨çš„çº¿ç¨‹å°†è¿›å…¥é˜»å¡çŠ¶æ€ï¼ˆå› ä¸ºå‡½æ•°æœªè¿”å›ï¼‰ã€‚å½“ç„¶ï¼Œæ­¤æ—¶å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨ sem_post å‡½æ•°ï¼Œä¿¡å·é‡çš„å€¼å°†å˜ä¸º 1 ï¼Œè€ŒåŸæœ¬é˜»å¡çš„çº¿ç¨‹å¯ä»¥å°†è¯¥ä¿¡å·é‡æ–°å‡ä¸º 0 å¹¶è·³å‡ºé˜»å¡çŠ¶æ€ã€‚å®é™…ä¸Šå°±æ˜¯é€šè¿‡è¿™ç§ç‰¹æ€§å®Œæˆä¸´ç•ŒåŒºçš„åŒæ­¥æ“ä½œï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å½¢å¼åŒæ­¥ä¸´ç•ŒåŒºï¼ˆå‡è®¾ä¿¡å·é‡çš„åˆå§‹å€¼ä¸º 1ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sem_wait(&amp;sem);<span class="comment">//ä¿¡å·é‡å˜ä¸º0...</span></span><br><span class="line"><span class="comment">// ä¸´ç•ŒåŒºçš„å¼€å§‹</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//ä¸´ç•ŒåŒºçš„ç»“æŸ</span></span><br><span class="line">sem_post(&amp;sem);<span class="comment">//ä¿¡å·é‡å˜ä¸º1...</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç ç»“æ„ä¸­ï¼Œè°ƒç”¨ sem_wait å‡½æ•°è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹åœ¨è°ƒç”¨ sem_post å‡½æ•°å‰ä¸å…è®¸å…¶ä»–çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºã€‚ä¿¡å·é‡çš„å€¼åœ¨ 0 å’Œ  1 ä¹‹é—´è·³è½¬ï¼Œå› æ­¤ï¼Œå…·æœ‰è¿™ç§ç‰¹æ€§çš„æœºåˆ¶ç§°ä¸ºã€ŒäºŒè¿›åˆ¶ä¿¡å·é‡ã€ã€‚æ¥ä¸‹æ¥çš„ä»£ç æ˜¯ä¿¡å·é‡æœºåˆ¶çš„ä»£ç ã€‚ä¸‹é¢ä»£ç å¹¶éæ˜¯åŒæ—¶è®¿é—®çš„åŒæ­¥ï¼Œè€Œæ˜¯å…³äºæ§åˆ¶è®¿é—®é¡ºåºçš„åŒæ­¥ï¼Œè¯¥åœºæ™¯ä¸ºï¼š</p>
<blockquote>
<p>çº¿ç¨‹  A ä»ç”¨æˆ·è¾“å…¥å¾—åˆ°å€¼åå­˜å…¥å…¨å±€å˜é‡ num ï¼Œæ­¤æ—¶çº¿ç¨‹ B å°†å–èµ°è¯¥å€¼å¹¶ç´¯åŠ ã€‚è¯¥è¿‡ç¨‹ä¸€å…±è¿›è¡Œ 5 æ¬¡ï¼Œå®Œæˆåè¾“å‡ºæ€»å’Œå¹¶é€€å‡ºç¨‹åºã€‚</p>
</blockquote>
<p>ä¸‹é¢æ˜¯ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/semaphore.c" target="_blank" rel="noopener">semaphore.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">read</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">accu</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">sem_t</span> sem_one;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">sem_t</span> sem_two;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> num;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> id_t1, id_t2;</span><br><span class="line">    sem_init(&amp;sem_one, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    sem_init(&amp;sem_two, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;id_t1, <span class="literal">NULL</span>, <span class="built_in">read</span>, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;id_t2, <span class="literal">NULL</span>, accu, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(id_t1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(id_t2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    sem_destroy(&amp;sem_one);</span><br><span class="line">    sem_destroy(&amp;sem_two);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">read</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"Input num: "</span>, <span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">        sem_wait(&amp;sem_two);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;num);</span><br><span class="line">        sem_post(&amp;sem_one);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">accu</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>, i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sem_wait(&amp;sem_one);</span><br><span class="line">        sum += num;</span><br><span class="line">        sem_post(&amp;sem_two);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Result: %d \n"</span>, sum);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc semaphore.c -D_REENTRANT -o sema -lpthread</span><br><span class="line">./sema</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/03/5c568c2717d1e.png" alt="" /></p>
<p>ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè®¾ç½®äº†ä¸¤ä¸ªä¿¡å·é‡ one çš„åˆå§‹å€¼ä¸º 0 ï¼Œtwo çš„åˆå§‹å€¼ä¸º 1ï¼Œç„¶ååœ¨è°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œã€Œè¯»ã€çš„å‰ææ˜¯ two å¯ä»¥å‡ä¸€ï¼Œå¦‚æœä¸èƒ½å‡ä¸€å°±ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œä¸€ç›´ç­‰åˆ°ã€Œè®¡ç®—ã€æ“ä½œå®Œæ¯•åï¼Œç»™ two åŠ ä¸€ï¼Œç„¶åå°±å¯ä»¥ç»§ç»­æ‰§è¡Œä¸‹ä¸€å¥è¾“å…¥ã€‚å¯¹äºã€Œè®¡ç®—ã€å‡½æ•°ï¼Œä¹Ÿä¸€æ ·ã€‚</p>
<h3>18.5 çº¿ç¨‹çš„é”€æ¯å’Œå¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°</h3>
<p>å…ˆä»‹ç»çº¿ç¨‹çš„é”€æ¯ï¼Œç„¶åå†ä»‹ç»å¤šçº¿ç¨‹æœåŠ¡ç«¯</p>
<h4>18.5.1 é”€æ¯çº¿ç¨‹çš„ 3 ç§æ–¹æ³•</h4>
<p>Linux çš„çº¿ç¨‹å¹¶ä¸æ˜¯åœ¨é¦–æ¬¡è°ƒç”¨çš„çº¿ç¨‹ main å‡½æ•°è¿”å›æ—¶è‡ªåŠ¨é”€æ¯ï¼Œæ‰€ä»¥åˆ©ç”¨å¦‚ä¸‹æ–¹æ³•ä¹‹ä¸€åŠ ä»¥æ˜ç¡®ã€‚å¦åˆ™ç”±çº¿ç¨‹åˆ›å»ºçš„å†…å­˜ç©ºé—´å°†ä¸€ç›´å­˜åœ¨ã€‚</p>
<ul>
<li>è°ƒç”¨ pthread_join å‡½æ•°</li>
<li>è°ƒç”¨ pthread_detach å‡½æ•°</li>
</ul>
<p>ä¹‹å‰è°ƒç”¨è¿‡ pthread_join å‡½æ•°ã€‚è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œä¸ä»…ä¼šç­‰å¾…çº¿ç¨‹ç»ˆæ­¢ï¼Œè¿˜ä¼šå¼•å¯¼çº¿ç¨‹é”€æ¯ã€‚ä½†è¯¥å‡½æ•°çš„é—®é¢˜æ˜¯ï¼Œçº¿ç¨‹ç»ˆæ­¢å‰ï¼Œè°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹å°†è¿›å…¥é˜»å¡çŠ¶æ€ã€‚å› æ­¤ï¼Œé€šè¿‡å¦‚ä¸‹å‡½æ•°è°ƒç”¨å¼•å¯¼çº¿ç¨‹é”€æ¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_detach</span><span class="params">(<span class="keyword">pthread_t</span> th)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æˆåŠŸæ—¶è¿”å› 0 ï¼Œå¤±è´¥æ—¶è¿”å›å…¶ä»–å€¼</span></span><br><span class="line"><span class="comment">thread : ç»ˆæ­¢çš„åŒæ—¶éœ€è¦é”€æ¯çš„çº¿ç¨‹ ID</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ä¸Šè¿°å‡½æ•°ä¸ä¼šå¼•èµ·çº¿ç¨‹ç»ˆæ­¢æˆ–è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡è¯¥å‡½æ•°å¼•å¯¼é”€æ¯çº¿ç¨‹åˆ›å»ºçš„å†…å­˜ç©ºé—´ã€‚è°ƒç”¨è¯¥å‡½æ•°åä¸èƒ½å†é’ˆå¯¹ç›¸åº”çº¿ç¨‹è°ƒç”¨ pthread_join å‡½æ•°ã€‚</p>
<h4>18.5.2 å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ç«¯çš„å®ç°</h4>
<p>ä¸‹é¢æ˜¯å¤šä¸ªå®¢æˆ·ç«¯ä¹‹é—´å¯ä»¥äº¤æ¢ä¿¡æ¯çš„ç®€å•èŠå¤©ç¨‹åºã€‚</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/chat_server.c" target="_blank" rel="noopener">chat_server.c</a></li>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch18/chat_clnt.c" target="_blank" rel="noopener">chat_clnt.c</a></li>
</ul>
<p>ä¸Šé¢çš„æœåŠ¡ç«¯ç¤ºä¾‹ä¸­ï¼Œéœ€è¦æŒæ¡ä¸´ç•ŒåŒºçš„æ„æˆï¼Œè®¿é—®å…¨å±€å˜é‡ clnt_cnt å’Œæ•°ç»„ clnt_socks çš„ä»£ç å°†æ„æˆä¸´ç•ŒåŒºï¼Œæ·»åŠ å’Œåˆ é™¤å®¢æˆ·ç«¯æ—¶ï¼Œå˜é‡ clnt_cnt å’Œæ•°ç»„ clnt_socks å°†åŒæ—¶å‘ç”Ÿå˜åŒ–ã€‚å› æ­¤ä¸‹åˆ—æƒ…å½¢ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œä»è€Œå¼•å‘é”™è¯¯ï¼š</p>
<ul>
<li>çº¿ç¨‹ A ä»æ•°ç»„ clnt_socks ä¸­åˆ é™¤å¥—æ¥å­—ä¿¡æ¯ï¼ŒåŒæ—¶çº¿ç¨‹ B è¯»å– clnt_cnt å˜é‡</li>
<li>çº¿ç¨‹ A è¯»å–å˜é‡ clnt_cnt ï¼ŒåŒæ—¶çº¿ç¨‹ B å°†å¥—æ¥å­—ä¿¡æ¯æ·»åŠ åˆ° clnt_socks æ•°ç»„</li>
</ul>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc chat_server.c -D_REENTRANT -o cserv -lpthread</span><br><span class="line">gcc chat_clnt.c -D_REENTRANT -o cclnt -lpthread</span><br><span class="line">./cserv 9191</span><br><span class="line">./cclnt 127.0.0.1 9191 å¼ ä¸‰</span><br><span class="line">./cclnt 127.0.0.1 9191 æå››</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/03/5c569b70634ff.png" alt="" /></p>
<h3>18.6 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>å• CPU ç³»ç»Ÿä¸­å¦‚ä½•åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿè¯·è§£é‡Šè¯¥è¿‡ç¨‹ä¸­å‘ç”Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ã€‚</p>
<p>ç­”ï¼šç³»ç»Ÿå°† CPU æ—¶é—´åˆ†æˆå¤šä¸ªå¾®ç¬‘çš„å—ååˆ†é…ç»™äº†å¤šä¸ªè¿›ç¨‹ã€‚ä¸ºäº†åˆ†æ—¶ä½¿ç”¨ CPU ï¼Œéœ€è¦ã€Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€è¿‡ç¨‹ã€‚è¿è¡Œç¨‹åºå‰éœ€è¦å°†ç›¸åº”è¿›ç¨‹ä¿¡æ¯è¯»å…¥å†…å­˜ï¼Œå¦‚æœè¿è¡Œè¿›ç¨‹ A åéœ€è¦ç´§æ¥ç€è¿è¡Œè¿›ç¨‹ B ï¼Œå°±åº”è¯¥å°†è¿›ç¨‹ A ç›¸å…³ä»Šå¤•ç§»å‡ºå†…å­˜ï¼Œå¹¶è¯»å…¥è¿›ç¨‹ B çš„ä¿¡æ¯ã€‚è¿™å°±æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢</p>
</li>
<li>
<p><strong>ä¸ºä½•çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢é€Ÿåº¦ç›¸å¯¹æ›´å¿«ï¼Ÿçº¿ç¨‹é—´æ•°æ®äº¤æ¢ä¸ºä½•ä¸éœ€è¦ç±»ä¼¼ IPC ç‰¹åˆ«æŠ€æœ¯</strong>ã€‚</p>
<p>ç­”ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è¿‡ç¨‹ä¸éœ€è¦åˆ‡æ¢æ•°æ®åŒºå’Œå †ã€‚å¯ä»¥åˆ©ç”¨æ•°æ®åŒºå’Œå †äº¤æ¢æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>è¯·ä»æ‰§è¡Œæµè§’åº¦è¯´æ˜è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«</strong>ã€‚</p>
<p>ç­”ï¼šè¿›ç¨‹ï¼šåœ¨æ“ä½œç³»ç»Ÿæ„æˆå•ç‹¬æ‰§è¡Œæµçš„å•ä½ã€‚çº¿ç¨‹ï¼šåœ¨è¿›ç¨‹å†…éƒ¨æ„æˆå•ç‹¬æ‰§è¡Œæµçš„å•ä½ã€‚çº¿ç¨‹ä¸ºäº†ä¿æŒå¤šæ¡ä»£ç æ‰§è¡Œæµè€Œéš”å¼€äº†æ ˆåŒºåŸŸã€‚</p>
</li>
<li>
<p><strong>ä¸‹é¢å…³äºä¸´ç•ŒåŒºçš„è¯´æ³•é”™è¯¯çš„æ˜¯</strong>ï¼Ÿ</p>
<p>ç­”ï¼šä¸‹é¢åŠ ç²—çš„é€‰é¡¹ä¸ºè¯´æ³•æ­£ç¡®ã€‚ï¼ˆå…¨é”™ï¼‰</p>
<ol>
<li>ä¸´ç•ŒåŒºæ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ—¶å‘ç”Ÿé—®é¢˜çš„åŒºåŸŸ</li>
<li>çº¿ç¨‹å®‰å…¨çš„å‡½æ•°ä¸­ä¸å­˜åœ¨ä¸´ç•ŒåŒºï¼Œå³ä¾¿å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ä¹Ÿä¸ä¼šå‘ç”Ÿé—®é¢˜</li>
<li>1 ä¸ªä¸´ç•ŒåŒºåªèƒ½ç”± 1 ä¸ªä»£ç å—ï¼Œè€Œéå¤šä¸ªä»£ç å—æ„æˆã€‚æ¢è¨€ä¹‹ï¼Œçº¿ç¨‹ A æ‰§è¡Œçš„ä»£ç å— A å’Œçº¿ç¨‹ B æ‰§è¡Œçš„ä»£ç å— B ä¹‹é—´ç»å¯¹ä¸ä¼šæ„æˆä¸´ç•ŒåŒºã€‚</li>
<li>ä¸´ç•ŒåŒºç”±è®¿é—®å…¨å±€å˜é‡çš„ä»£ç æ„æˆã€‚å…¶ä»–å˜é‡ä¸­ä¸ä¼šå‘ç”Ÿé—®é¢˜ã€‚</li>
</ol>
</li>
<li>
<p><strong>ä¸‹åˆ—å…³äºçº¿ç¨‹åŒæ­¥çš„è¯´æ³•é”™è¯¯çš„æ˜¯</strong>ï¼Ÿ</p>
<p>ç­”ï¼šä¸‹é¢åŠ ç²—çš„é€‰é¡¹ä¸ºè¯´æ³•æ­£ç¡®ã€‚</p>
<ol>
<li>çº¿ç¨‹åŒæ­¥å°±æ˜¯é™åˆ¶è®¿é—®ä¸´ç•ŒåŒº</li>
<li><strong>çº¿ç¨‹åŒæ­¥ä¹Ÿå…·æœ‰æ§åˆ¶çº¿ç¨‹æ‰§è¡Œé¡ºåºçš„å«ä¹‰</strong></li>
<li><strong>äº’æ–¥é‡å’Œä¿¡å·é‡æ˜¯å…¸å‹çš„åŒæ­¥æŠ€æœ¯</strong></li>
<li>çº¿ç¨‹åŒæ­¥æ˜¯ä»£æ›¿è¿›ç¨‹ IPC çš„æŠ€æœ¯ã€‚</li>
</ol>
</li>
<li>
<p><strong>è¯·è¯´æ˜å®Œå…¨é”€æ¯ Linux çº¿ç¨‹çš„ 2 ç§åŠæ³•</strong></p>
<p>ç­”ï¼šâ‘ è°ƒç”¨ pthread_join å‡½æ•°â‘¡è°ƒç”¨ pthread_detach å‡½æ•°ã€‚ç¬¬ä¸€ä¸ªä¼šé˜»å¡è°ƒç”¨çš„çº¿ç¨‹ï¼Œè€Œç¬¬äºŒä¸ªä¸é˜»å¡ã€‚éƒ½å¯ä»¥å¼•å¯¼çº¿ç¨‹é”€æ¯ã€‚</p>
</li>
</ol>
<h2>ç¬¬ 19 ç«  Windows å¹³å°ä¸‹çº¿ç¨‹çš„ä½¿ç”¨</h2>
<p>æš‚ç•¥</p>
<h2>ç¬¬ 20 ç«  Windows ä¸­çš„çº¿ç¨‹åŒæ­¥</h2>
<p>æš‚ç•¥</p>
<h2>ç¬¬ 21 ç«  å¼‚æ­¥é€šçŸ¥ I/O æ¨¡å‹</h2>
<p>æš‚ç•¥</p>
<h2>ç¬¬ 22 ç«  é‡å  I/O æ¨¡å‹</h2>
<p>æš‚ç•¥</p>
<h2>ç¬¬ 23 ç«  IOCP</h2>
<p>æš‚ç•¥</p>
<h2>ç¬¬ 24 ç«  åˆ¶ä½œ HTTP æœåŠ¡å™¨ç«¯</h2>
<p>æœ¬ç« ä»£ç ï¼Œåœ¨<a href="https://github.com/riba2534/TCP-IP-NetworkNote" target="_blank" rel="noopener">TCP-IP-NetworkNote</a>ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3>24.1 HTTP æ¦‚è¦</h3>
<p>æœ¬ç« å°†ç¼–å†™ HTTPï¼ˆHyperText Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰æœåŠ¡å™¨ç«¯ï¼Œå³ Web æœåŠ¡å™¨ç«¯ã€‚</p>
<h4>24.1.1 ç†è§£ Web æœåŠ¡å™¨ç«¯</h4>
<p>webæœåŠ¡å™¨ç«¯å°±æ˜¯è¦åŸºäº HTTP åè®®ï¼Œå°†ç½‘é¡µå¯¹åº”æ–‡ä»¶ä¼ è¾“ç»™å®¢æˆ·ç«¯çš„æœåŠ¡å™¨ç«¯ã€‚</p>
<h4>24.1.2 HTTP</h4>
<p>æ— çŠ¶æ€çš„ Stateless åè®®</p>
<p><img src="https://i.loli.net/2019/02/07/5c5bc6973a4d0.png" alt="" /></p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡å™¨ç«¯ç›¸åº”å®¢æˆ·ç«¯è¯·æ±‚åç«‹å³æ–­å¼€è¿æ¥ã€‚æ¢è¨€ä¹‹ï¼ŒæœåŠ¡å™¨ç«¯ä¸ä¼šç»´æŒå®¢æˆ·ç«¯çŠ¶æ€ã€‚å³ä½¿åŒä¸€å®¢æˆ·ç«¯å†æ¬¡å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿæ— æ³•è¾¨è®¤å‡ºæ˜¯åŸå…ˆé‚£ä¸ªï¼Œè€Œä¼šä»¥ç›¸åŒæ–¹å¼å¤„ç†æ–°è¯·æ±‚ã€‚å› æ­¤ï¼ŒHTTP åˆç§°ã€Œæ— çŠ¶æ€çš„ Stateless åè®®ã€</p>
<h4>24.1.3 è¯·æ±‚æ¶ˆæ¯ï¼ˆRequest Messageï¼‰çš„ç»“æ„</h4>
<p>ä¸‹é¢æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚æ¶ˆæ¯çš„ç»“æ„ï¼š</p>
<p><img src="https://i.loli.net/2019/02/07/5c5bcbb75202f.png" alt="" /></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¯·æ±‚æ¶ˆæ¯å¯ä»¥åˆ†ä¸ºè¯·æ±‚å¤´ã€æ¶ˆæ¯å¤´ã€æ¶ˆæ¯ä½“ 3 ä¸ªéƒ¨åˆ†ã€‚å…¶ä¸­ï¼Œè¯·æ±‚è¡Œå«æœ‰è¯·æ±‚æ–¹å¼ï¼ˆè¯·æ±‚ç›®çš„ï¼‰ä¿¡æ¯ã€‚å…¸å‹çš„è¯·æ±‚æ–¹å¼æœ‰ GET å’Œ POST ï¼ŒGET ä¸»è¦ç”¨äºè¯·æ±‚æ•°æ®ï¼ŒPOST ä¸»è¦ç”¨äºä¼ è¾“æ•°æ®ã€‚ä¸ºäº†é™ä½å¤æ‚åº¦ï¼Œæˆ‘ä»¬å®ç°åªèƒ½å“åº” GET è¯·æ±‚çš„ Web æœåŠ¡å™¨ç«¯ï¼Œä¸‹é¢è§£é‡Šå›¾ä¸­çš„è¯·æ±‚è¡Œä¿¡æ¯ã€‚å…¶ä¸­ã€ŒGET/index.html HTTP/1.1ã€ å…·æœ‰å¦‚ä¸‹å«ä¹‰ï¼š</p>
<blockquote>
<p>è¯·æ±‚ï¼ˆGETï¼‰index.html æ–‡ä»¶ï¼Œé€šå¸¸ä»¥ 1.1 ç‰ˆæœ¬çš„ HTTP åè®®è¿›è¡Œé€šä¿¡ã€‚</p>
</blockquote>
<p>è¯·æ±‚è¡Œåªèƒ½é€šè¿‡  1 è¡Œï¼ˆlineï¼‰å‘é€ï¼Œå› æ­¤ï¼ŒæœåŠ¡å™¨ç«¯å¾ˆå®¹æ˜“ä» HTTP è¯·æ±‚ä¸­æå–ç¬¬ä¸€è¡Œï¼Œå¹¶åˆ†åˆ«åˆ†æè¯·æ±‚è¡Œä¸­çš„ä¿¡æ¯ã€‚</p>
<p>è¯·æ±‚è¡Œä¸‹é¢çš„æ¶ˆæ¯å¤´ä¸­åŒ…å«å‘é€è¯·æ±‚çš„æµè§ˆå™¨ä¿¡æ¯ã€ç”¨æˆ·è®¤è¯ä¿¡æ¯ç­‰å…³äº HTTP æ¶ˆæ¯çš„é™„åŠ ä¿¡æ¯ã€‚æœ€åçš„æ¶ˆæ¯ä½“ä¸­è£…æœ‰å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä¼ è¾“çš„æ•°æ®ï¼Œä¸ºäº†è£…å…¥æ•°æ®ï¼Œéœ€è¦ä»¥ POST æ–¹å¼å‘é€è¯·æ±‚ã€‚ä½†æ˜¯æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å®ç° GET æ–¹å¼çš„æœåŠ¡å™¨ç«¯ï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥è¿™éƒ¨åˆ†å†…å®¹ã€‚å¦å¤–ï¼Œæ¶ˆæ¯ä½“å’Œæ¶ˆæ¯å¤´ä¸ä¹‹é—´ä»¥ç©ºè¡Œéš”å¼€ï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿè¾¹ç•Œé—®é¢˜</p>
<h4>24.1.4 å“åº”æ¶ˆæ¯ï¼ˆResponse Messageï¼‰çš„ç»“æ„</h4>
<p>ä¸‹é¢æ˜¯ Web æœåŠ¡å™¨ç«¯å‘å®¢æˆ·ç«¯ä¼ é€’çš„å“åº”ä¿¡æ¯çš„ç»“æ„ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¯¥å“åº”æ¶ˆæ¯ç”±çŠ¶æ€è¡Œã€å¤´ä¿¡æ¯ã€æ¶ˆæ¯ä½“ç­‰ 3 ä¸ªéƒ¨åˆ†ç»„æˆã€‚çŠ¶æ€è¡Œä¸­æœ‰å…³äºè¯·æ±‚çš„çŠ¶æ€ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸è¯·æ±‚æ¶ˆæ¯ç›¸æ¯”æœ€ä¸ºæ˜¾è‘—åœ°åŒºåˆ«ã€‚</p>
<p><img src="https://i.loli.net/2019/02/07/5c5bf9ad1b5f9.png" alt="" /></p>
<p>ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²çŠ¶æ€è¡Œä¸­å«æœ‰å…³äºå®¢æˆ·ç«¯è¯·æ±‚çš„å¤„ç†ç»“æœã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯è¯·æ±‚ index.html æ–‡ä»¶æ—¶ï¼Œè¡¨ç¤º index.html æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€æœåŠ¡ç«¯æ˜¯å¦å‘ç”Ÿé—®é¢˜è€Œæ— æ³•å“åº”ç­‰ä¸åŒæƒ…å†µçš„ä¿¡æ¯å†™å…¥çŠ¶æ€è¡Œã€‚å›¾ä¸­çš„ã€ŒHTTP/1.1 200 OKã€å…·æœ‰å¦‚ä¸‹å«ä¹‰ï¼š</p>
<ul>
<li>200 OK : æˆåŠŸå¤„ç†äº†è¯·æ±‚!</li>
<li>404 Not Found : è¯·æ±‚çš„æ–‡ä»¶ä¸å­˜åœ¨!</li>
<li>400 Bad Request : è¯·æ±‚æ–¹å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼</li>
</ul>
<p>æ¶ˆæ¯å¤´ä¸­å«æœ‰ä¼ è¾“çš„æ•°æ®ç±»å‹å’Œé•¿åº¦ç­‰ä¿¡æ¯ã€‚å›¾ä¸­çš„æ¶ˆæ¯å¤´å«æœ‰å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<blockquote>
<p>æœåŠ¡ç«¯åä¸º SimpleWebServer ï¼Œä¼ è¾“çš„æ•°æ®ç±»å‹ä¸º text/htmlã€‚æ•°æ®é•¿åº¦ä¸è¶…è¿‡ 2048 ä¸ªå­—èŠ‚ã€‚</p>
</blockquote>
<p>æœ€åæ’å…¥ä¸€ä¸ªç©ºè¡Œåï¼Œé€šè¿‡æ¶ˆæ¯ä½“å‘é€å®¢æˆ·ç«¯è¯·æ±‚çš„æ–‡ä»¶æ•°æ®ã€‚ä»¥ä¸Šå°±æ˜¯å®ç° Web æœåŠ¡ç«¯è¿‡ç¨‹ä¸­å¿…è¦çš„ HTTP åè®®ã€‚</p>
<h3>24.2 å®ç°ç®€å•çš„ Web æœåŠ¡å™¨ç«¯</h3>
<h4>24.2.1 å®ç°åŸºäº Windows çš„å¤šçº¿ç¨‹ Web æœåŠ¡å™¨ç«¯</h4>
<p>æš‚ç•¥</p>
<h4>24.2.2 å®ç°åŸºäº Linux çš„å¤šçº¿ç¨‹ Web æœåŠ¡å™¨ç«¯</h4>
<p>ä¸‹é¢æ˜¯ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/riba2534/TCP-IP-NetworkNote/blob/master/ch24/webserv_linux.c" target="_blank" rel="noopener">webserv_linux.c</a></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SMALL_BUF 100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">request_handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_data</span><span class="params">(FILE *fp, <span class="keyword">char</span> *ct, <span class="keyword">char</span> *file_name)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">content_type</span><span class="params">(<span class="keyword">char</span> *file)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_error</span><span class="params">(FILE *fp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> serv_sock, clnt_sock;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_adr</span>, <span class="title">clnt_adr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> clnt_adr_size;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="keyword">pthread_t</span> t_id;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serv_sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_adr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_adr));</span><br><span class="line">    serv_adr.sin_family = AF_INET;</span><br><span class="line">    serv_adr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serv_adr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">    <span class="keyword">if</span> (bind(serv_sock, (struct sockaddr *)&amp;serv_adr, <span class="keyword">sizeof</span>(serv_adr)) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"bind() error"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(serv_sock, <span class="number">20</span>) == <span class="number">-1</span>)</span><br><span class="line">        error_handling(<span class="string">"listen() error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        clnt_adr_size = <span class="keyword">sizeof</span>(clnt_adr);</span><br><span class="line">        clnt_sock = accept(serv_sock, (struct sockaddr *)&amp;clnt_adr, &amp;clnt_adr_size);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Connection Request : %s:%d\n"</span>,</span><br><span class="line">               inet_ntoa(clnt_adr.sin_addr), ntohs(clnt_adr.sin_port));</span><br><span class="line">        pthread_create(&amp;t_id, <span class="literal">NULL</span>, request_handler, &amp;clnt_sock);</span><br><span class="line">        pthread_detach(t_id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(serv_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">request_handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> clnt_sock = *((<span class="keyword">int</span> *)arg);</span><br><span class="line">    <span class="keyword">char</span> req_line[SMALL_BUF];</span><br><span class="line">    FILE *clnt_read;</span><br><span class="line">    FILE *clnt_write;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> method[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">char</span> ct[<span class="number">15</span>];</span><br><span class="line">    <span class="keyword">char</span> file_name[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line">    clnt_read = fdopen(clnt_sock, <span class="string">"r"</span>);</span><br><span class="line">    clnt_write = fdopen(dup(clnt_sock), <span class="string">"w"</span>);</span><br><span class="line">    fgets(req_line, SMALL_BUF, clnt_read);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(req_line, <span class="string">"HTTP/"</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        send_error(clnt_write);</span><br><span class="line">        fclose(clnt_read);</span><br><span class="line">        fclose(clnt_write);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(method, strtok(req_line, <span class="string">" /"</span>));</span><br><span class="line">    <span class="built_in">strcpy</span>(file_name, strtok(<span class="literal">NULL</span>, <span class="string">" /"</span>));</span><br><span class="line">    <span class="built_in">strcpy</span>(ct, content_type(file_name));</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(method, <span class="string">"GET"</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        send_error(clnt_write);</span><br><span class="line">        fclose(clnt_read);</span><br><span class="line">        fclose(clnt_write);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(clnt_read);</span><br><span class="line">    send_data(clnt_write, ct, file_name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_data</span><span class="params">(FILE *fp, <span class="keyword">char</span> *ct, <span class="keyword">char</span> *file_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> protocol[] = <span class="string">"HTTP/1.0 200 OK\r\n"</span>;</span><br><span class="line">    <span class="keyword">char</span> server[] = <span class="string">"Server:Linux Web Server \r\n"</span>;</span><br><span class="line">    <span class="keyword">char</span> cnt_len[] = <span class="string">"Content-length:2048\r\n"</span>;</span><br><span class="line">    <span class="keyword">char</span> cnt_type[SMALL_BUF];</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    FILE *send_file;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(cnt_type, <span class="string">"Content-type:%s\r\n\r\n"</span>, ct);</span><br><span class="line">    send_file = fopen(file_name, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (send_file == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        send_error(fp);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¼ è¾“å¤´ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">fputs</span>(protocol, fp);</span><br><span class="line">    <span class="built_in">fputs</span>(server, fp);</span><br><span class="line">    <span class="built_in">fputs</span>(cnt_len, fp);</span><br><span class="line">    <span class="built_in">fputs</span>(cnt_type, fp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¼ è¾“è¯·æ±‚æ•°æ®</span></span><br><span class="line">    <span class="keyword">while</span> (fgets(buf, BUF_SIZE, send_file) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(buf, fp);</span><br><span class="line">        fflush(fp);</span><br><span class="line">    &#125;</span><br><span class="line">    fflush(fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">content_type</span><span class="params">(<span class="keyword">char</span> *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> extension[SMALL_BUF];</span><br><span class="line">    <span class="keyword">char</span> file_name[SMALL_BUF];</span><br><span class="line">    <span class="built_in">strcpy</span>(file_name, file);</span><br><span class="line">    strtok(file_name, <span class="string">"."</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(extension, strtok(<span class="literal">NULL</span>, <span class="string">"."</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(extension, <span class="string">"html"</span>) || !<span class="built_in">strcmp</span>(extension, <span class="string">"htm"</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"text/html"</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"text/plain"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_error</span><span class="params">(FILE *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> protocol[] = <span class="string">"HTTP/1.0 400 Bad Request\r\n"</span>;</span><br><span class="line">    <span class="keyword">char</span> server[] = <span class="string">"Server:Linux Web Server \r\n"</span>;</span><br><span class="line">    <span class="keyword">char</span> cnt_len[] = <span class="string">"Content-length:2048\r\n"</span>;</span><br><span class="line">    <span class="keyword">char</span> cnt_type[] = <span class="string">"Content-type:text/html\r\n\r\n"</span>;</span><br><span class="line">    <span class="keyword">char</span> content[] = <span class="string">"&lt;html&gt;&lt;head&gt;&lt;title&gt;NETWORK&lt;/title&gt;&lt;/head&gt;"</span></span><br><span class="line">                     <span class="string">"&lt;body&gt;&lt;font size=+5&gt;&lt;br&gt;å‘ç”Ÿé”™è¯¯ï¼ æŸ¥çœ‹è¯·æ±‚æ–‡ä»¶åå’Œè¯·æ±‚æ–¹å¼!"</span></span><br><span class="line">                     <span class="string">"&lt;/font&gt;&lt;/body&gt;&lt;/html&gt;"</span>;</span><br><span class="line">    <span class="built_in">fputs</span>(protocol, fp);</span><br><span class="line">    <span class="built_in">fputs</span>(server, fp);</span><br><span class="line">    <span class="built_in">fputs</span>(cnt_len, fp);</span><br><span class="line">    <span class="built_in">fputs</span>(cnt_type, fp);</span><br><span class="line">    fflush(fp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handling</span><span class="params">(<span class="keyword">char</span> *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc webserv_linux.c -D_REENTRANT -o web_serv -lpthread</span><br><span class="line">./web_serv 9190</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<p><img src="https://i.loli.net/2019/02/07/5c5c107deba11.png" alt="" /></p>
<p><img src="https://i.loli.net/2019/02/07/5c5c19cbb3718.png" alt="" /></p>
<p>ç»è¿‡æµ‹è¯•ï¼Œè¿™ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨å¯ä»¥æ­£å¸¸çš„æ˜¾ç¤ºå‡ºé¡µé¢ã€‚</p>
<h3>24.3 ä¹ é¢˜</h3>
<blockquote>
<p>ä»¥ä¸‹ç­”æ¡ˆä»…ä»£è¡¨æœ¬äººä¸ªäººè§‚ç‚¹ï¼Œå¯èƒ½ä¸æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚</p>
</blockquote>
<ol>
<li>
<p><strong>ä¸‹åˆ—å…³äº Web æœåŠ¡å™¨ç«¯å’Œ Web æµè§ˆå™¨ç«¯çš„è¯´æ³•é”™è¯¯çš„æ˜¯</strong>ï¼Ÿ</p>
<p>ç­”ï¼šä»¥ä¸‹åŠ ç²—é€‰é¡¹ä»£è¡¨æ­£ç¡®ã€‚</p>
<ol>
<li><strong>Web æµè§ˆå™¨å¹¶ä¸æ˜¯é€šè¿‡è‡ªèº«åˆ›å»ºçš„å¥—æ¥å­—è¿æ¥æœåŠ¡ç«¯çš„å®¢æˆ·ç«¯</strong></li>
<li>Web æœåŠ¡å™¨ç«¯é€šè¿‡ TCP å¥—æ¥å­—æä¾›æœåŠ¡ï¼Œå› ä¸ºå®ƒå°†ä¿æŒè¾ƒé•¿çš„å®¢æˆ·ç«¯è¿æ¥å¹¶äº¤æ¢æ•°æ®</li>
<li>è¶…æ–‡æœ¬ä¸æ™®é€šæ–‡æœ¬çš„æœ€å¤§åŒºåˆ«æ˜¯å…¶å…·æœ‰å¯è·³è½¬çš„ç‰¹æ€§</li>
<li>Web æµè§ˆå™¨å¯è§†ä¸ºå‘æµè§ˆå™¨æä¾›è¯·æ±‚æ–‡ä»¶çš„æ–‡ä»¶ä¼ è¾“æœåŠ¡å™¨ç«¯</li>
<li>é™¤ Web æµè§ˆå™¨å¤–ï¼Œå…¶ä»–å®¢æˆ·ç«¯éƒ½æ— æ³•è®¿é—® Web æœåŠ¡å™¨ç«¯ã€‚</li>
</ol>
</li>
<li>
<p><strong>ä¸‹åˆ—å…³äº HTTP åè®®çš„æè¿°é”™è¯¯çš„æ˜¯</strong>ï¼Ÿ</p>
<p>ç­”ï¼šä»¥ä¸‹åŠ ç²—é€‰é¡¹ä»£è¡¨æ­£ç¡®ã€‚</p>
<ol>
<li>HTTP åè®®æ˜¯æ— çŠ¶æ€çš„ Stateless åè®®ï¼Œä¸ä»…å¯ä»¥é€šè¿‡ TCP å®ç°ï¼Œè¿˜å¯ä»¥é€šè¿‡ UDP æ¥å®ç°</li>
<li><strong>HTTP åè®®æ˜¯æ— çŠ¶æ€çš„ Stateless åè®®ï¼Œå› ä¸ºå…¶åœ¨ 1 æ¬¡è¯·æ±‚å’Œå“åº”è¿‡ç¨‹å®Œæˆåç«‹å³æ–­å¼€è¿æ¥ã€‚å› æ­¤ï¼Œå¦‚æœåŒä¸€æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯éœ€è¦  3 æ¬¡è¯·æ±‚åŠå“åº”ï¼Œåˆ™æ„å‘³ç€éœ€è¦ç»è¿‡ 3 æ¬¡å¥—æ¥å­—çš„åˆ›å»ºè¿‡ç¨‹</strong>ã€‚</li>
<li><strong>æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯ä¼ é€’çš„çŠ¶æ€ç ä¸­å«æœ‰è¯·æ±‚å¤„ç†ç»“æœçš„ä¿¡æ¯</strong>ã€‚</li>
<li><strong>HTTP åè®®æ˜¯åŸºäºå› ç‰¹ç½‘çš„åè®®ï¼Œå› æ­¤ï¼Œä¸ºäº†åŒæ—¶å‘å¤§é‡å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼ŒHTTP åè®®è¢«è®¾è®¡ä¸º Stateless åè®®</strong>ã€‚</li>
</ol>
</li>
</ol>
<p><strong>æˆ‘çš„ç¬”è®°åˆ°æ­¤ç»“æŸ</strong> ğŸ˜</p>
<h2>ğŸ“License</h2>
<p>æœ¬ä»“åº“éµå¾ª CC BY-NC-SA 4.0ï¼ˆç½²å - éå•†ä¸šæ€§ä½¿ç”¨ï¼‰ åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
<p><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener"><img src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" alt="CC BY-NC-SA 4.0" /></a></p>
]]></content>
      <categories>
        <category>ç¬”è®°</category>
      </categories>
      <tags>
        <tag>tcp/ip</tag>
      </tags>
  </entry>
</search>
